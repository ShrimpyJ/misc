    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2007/9/18/40">First message in thread</a></li><li><a href="/lkml/2007/9/20/399">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2007/9/20/417">Thomas Gleixner</a><ul><li><a href="/lkml/2007/9/20/429">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2007/9/20/435">Thomas Gleixner</a><ul><li><a href="/lkml/2007/9/20/454">"Rafael J. Wysocki"</a></li><li><a href="/lkml/2007/9/21/54">"Rafael J. Wysocki"</a></li></ul></li></ul></li><li class="origin"><a href="/lkml/2007/9/20/433">Linus Torvalds</a><ul><li><a href="/lkml/2007/9/20/433">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2007/9/20/452">Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2007/9/20/437">Linus Torvalds</a><ul><li><a href="/lkml/2007/9/20/443">Thomas Gleixner</a></li><li><a href="/lkml/2007/9/20/468">Len Brown</a></li><li><a href="/lkml/2007/9/21/12">Paul Mackerras</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 20 Sep 2007 14:35:22 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 2.6.23-rc6-mm1: failure to boot on HP nx6325, no sound when booted, USB-related WARNING</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 20 Sep 2007, Thomas Gleixner wrote:<br />&gt; <br />&gt; In meantime I figured out what's happening. The ordering in<br />&gt; hibernate_snapshot() is wrong. It does:<br /><br />Hmm. This is close to the ordering we have in STR too.<br /><br />I have some dim memory of there being some ACPI reason why it had to be <br />done that way.<br /><br />In fact, this was done in commit e3c7db621bed4afb8e231cb005057f2feb5db557, <br />long ago, by Rafael:<br /><br />    As indicated in a recent thread on Linux-PM, it's necessary to call<br />    pm_ops-&gt;finish() before devce_resume(), but enable_nonboot_cpus() has to be<br />    called before pm_ops-&gt;finish() (cf.<br />    <a href="http://lists.osdl.org/pipermail/linux-pm/2006-November/004164.html">http://lists.osdl.org/pipermail/linux-pm/2006-November/004164.html</a>).  For<br />    consistency, it seems reasonable to call disable_nonboot_cpus() after<br />    device_suspend().<br /><br />    This way the suspend code will remain symmetrical with respect to the resume<br />    code and it may allow us to speed up things in the future by suspending and<br />    resuming devices and/or saving the suspend image in many threads.<br /><br />    The following series of patches reorders the suspend and resume code so that<br />    nonboot CPUs are disabled after devices have been suspended and enabled before<br />    the devices are resumed.  It also causes pm_ops-&gt;finish() to be called after<br />    enable_nonboot_cpus() wherever necessary.<br /><br />Hmm?<br /><br />It's entirely possible that that commit was simply just buggy, and we <br />should indeed move the CPU down/up to be early/late - we've fixed other <br />ordering issues since that commit went in. But this whole area is very <br />murky.<br /><br />(Btw, the above commit message points to just my response with a testing <br />patch to the real email: the actual explanation of the INSANE ordering is <br />from Len Brown in<br /><br />	<a href="https://lists.linux-foundation.org/pipermail/linux-pm/2006-November/004161.html">https://lists.linux-foundation.org/pipermail/linux-pm/2006-November/004161.html</a><br /><br />and there Len claims that we *must* wake up CPU's early).<br /><br />I personally think that the whole ACPI ordering requirements are just <br />insane, but the point of this email is to point these different <br />requirements out, and hopefully we can get something that works for <br />everybody.<br /><br />Len added to Cc.<br /><br />Len? Thomas wants to call 'disable_nonboot_cpus()' early, and <br />'enable_nonboot_cpus()' late. Can you explain why that is wrong?<br /><br />			Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
