    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2007/10/25/468">First message in thread</a></li><li><a href="/lkml/2007/10/30/231">Linus Torvalds</a><ul><li><a href="/lkml/2007/10/30/285">Arjan van de Ven</a><ul><li class="origin"><a href="/lkml/2007/10/30/300">Linus Torvalds</a><ul><li><a href="/lkml/2007/10/30/300">Arjan van de Ven</a><ul><li><a href="/lkml/2007/10/30/312">Linus Torvalds</a></li><li><a href="/lkml/2007/11/1/68">Martin Mares</a></li></ul></li><li><a href="/lkml/2007/10/30/473">Jesse Barnes</a><ul><li><a href="/lkml/2007/10/30/486">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2007/10/30/519">Robert Hancock</a><ul><li><a href="/lkml/2007/10/30/533">Arjan van de Ven</a></li><li><a href="/lkml/2007/10/30/535">Linus Torvalds</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2007/10/30/341">Andi Kleen</a><ul><li><a href="/lkml/2007/10/30/346">Linus Torvalds</a><ul><li><a href="/lkml/2007/10/30/393">Andi Kleen</a></li></ul></li><li><a href="/lkml/2007/10/30/458">David Miller</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 30 Oct 2007 10:07:48 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: pci-disable-decode-of-io-memory-during-bar-sizing.patch</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 30 Oct 2007, Arjan van de Ven wrote:<br />&gt; <br />&gt; the problem is... you're not supposed to mix both types of accesses.<br /><br />You have to, anyway. Even now the MMCONFIG stuff uses CONF1 cycles for <br />startup.<br /><br />Also, there's reason to believe that mixing things up _has_ to work <br />anyway, and if the issue is between "works in practice" and "theory says <br />that you shouldn't mix", I'll take practice every time.<br /><br />Especially since we *know* that the theory is broken. Right now MMCONFIG <br />is effectively disabled very aggressively because it's simply unusably <br />flaky. So the choice is between:<br /><br /> - don't use MMCONFIG at all, because it has so many problems<br /> - use MMCONFIG sparingly enough to hide the problems<br /><br />and what "you're supposed to do" is simply trumped by Real Life(tm). <br />Because Intel screwed up so badly when they designed that piece of shit.<br /><br />(Where "screwed up badly" is the usual "left it to firmware people" thing, <br />of course. Dammit, Intel *could* have just made it a real PCI BAR in the <br />Northbridge, and specified it as such, and we wouldn't have these <br />problems! But no, it had to be another idiotic "firmware tells where it <br />is" thing)<br /><br />&gt; &gt; The fact is, CONF1 style accesses are just safer, and *work*. <br />&gt; <br />&gt; I would suggest a slight twist then: use CONF1 *until* you're using<br />&gt; something above 256, and then and only then switch to MMCONFIG from<br />&gt; then on for all accesses.<br /><br />No.<br /><br />Maybe if you do it per-device, and only *after* probing (ie we have seen <br />multiple, and successful, accesses), but globally, absolutely not. That <br />would be useless. The bugs we have had in this area have been exactly the <br />kinds of things like "we don't know the real size of the MMCONFIG areas" <br />etc.<br /><br />I could easily see device driver writers probing to see if something <br />works, and I absolutely don't think we should just automatically enable <br />MMCONFIG from then on.<br /><br />But maybe we could have a per-device flag that a driver *can* set. Ie have <br />the logic be:<br /><br /> - use MMCONFIG if we have to (reg &gt;= 256)<br /><br />OR<br /><br /> - use MMCONFIG if the driver specifically asked us to<br /><br />and then drivers that absolutely need it, and know they do, can set that <br />flag. Preferably after they actually verified that it works.<br /><br />That way you _can_ get the "this is how you're supposed to do it" <br />behaviour, but you get it when there is a reasonable chance that it <br />actually works.<br /><br />And quite frankly, if you're not supposed to mix these things even across <br />devices, then I think we are better off just doing what we effectively do <br />now: mostly ignore the damn thing because it's too broken to use.<br /><br />Maybe somebody inside Intel could just clarify the documentation, and <br />change it from "you're not supposed to mix" to "mix all you want". <br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
