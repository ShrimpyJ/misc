    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2007/12/27/82">First message in thread</a></li><li><a href="/lkml/2007/12/27/82">Robert Hancock</a><ul><li><a href="/lkml/2007/12/27/88">Kai Ruhnau</a></li><li class="origin"><a href="/lkml/2007/12/27/116">Linus Torvalds</a><ul><li><a href="/lkml/2007/12/27/116">Loic Prylli</a><ul><li><a href="/lkml/2007/12/27/117">Matthew Wilcox</a></li><li><a href="/lkml/2007/12/27/118">Linus Torvalds</a><ul><li><a href="/lkml/2007/12/27/119">Linus Torvalds</a></li><li><a href="/lkml/2007/12/27/120">Kai Ruhnau</a></li><li><a href="/lkml/2007/12/28/3">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2007/12/28/8">Benjamin Herrenschmidt</a></li></ul></li></ul></li><li><a href="/lkml/2007/12/27/160">Robert Hancock</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 27 Dec 2007 10:58:31 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [Patch v2] Make PCI extended config space (MMCONFIG) a driver opt-in</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 27 Dec 2007, Robert Hancock wrote:<br /><br />&gt; Linus Torvalds wrote:<br />&gt; &gt; <br />&gt; &gt; But yes. The *fact* is that MMCONFIG has not just been globally broken, but<br />&gt; &gt; broken on a per-device basis. I don't know why (and quite frankly, I doubt<br />&gt; &gt; anybody does), but the PCI device ID corruption happened only for a specific<br />&gt; &gt; set of devices.<br />&gt; &gt; <br />&gt; &gt; Whether it was a timing issue with particular devices or whether it was a<br />&gt; &gt; timing issue with some particular bridge (and could affect any devices<br />&gt; &gt; behind that bridge), who knows... It almost certainly was brought on by a<br />&gt; &gt; borderline (or broken) northbridge, but it apparently only affected specific<br />&gt; &gt; devices - which makes me suspect that it wasn't *entirely* due to just the<br />&gt; &gt; northbridge, and it was a combination of things.<br />&gt; <br />&gt; Pointer to such a report? The only single-device problems I'm aware of<br />&gt; are with some devices within the K8 integrated northbridge, which we<br />&gt; already handle. Other than that, the only non-global problems I'm aware<br />&gt; of are devices behind host bridges which can't receive/handle MMCONFIG<br />&gt; requests, in which case the problem would be bus-wide.<br /><br />There was a thread called "PCI vendor id == 1 regression?" (Kai Ruhnau was <br />the main reporter for that one). But looking back, it seems that one <br />didn't hit the kernel mailing list, so I guess google cannot pick it up. I <br />can forward all the emails if you want, but quite frankly, you don't <br />really want to. It boils down to:<br /><br />Stephen Hemminger:<br />  "There have been two reports with different hardware of the PCI vendor<br />   id of 0001 showing up. I got a report on sky2, and Francois saw similar<br />   problem on r8169.<br />   In one case, it happened only with 2.6.23 kernel, the correct id was<br />   returned by older kernels.<br /><br />   This is a heads up, there may be a PCI problem. Or just<br />   some users smoking strange fall leaves."<br /><br />And then one of the reporters:<br /><br />  "Good kernel:<br /><br />   02:00.0 Ethernet controller: Marvell Technology Group Ltd. 88E8056 PCI-E Gigabit Ethernet Controller (rev 12)<br />	00: ab 11 64 43 07 00 10 00 12 00 00 02 01 00 00 00<br /><br />   Bad kernel:<br /><br />   02:00.0 Ethernet controller: Unknown device 0001:4364 (rev 12)<br />	00: 01 00 64 43 07 00 10 00 12 00 00 02 01 00 00 00"<br /><br />and after I suspected it was mmconfig-related and asked him to try "lspci <br />-H1" to force conf1 accesses from user space on a broken kernel:<br /><br />   "Bare lspci gives the wrong vendor ID, lspci -H1 the right one."<br /><br />for *one* single device.<br /><br />In other words, just a single word in mmconfig was corrupt, but it was <br />consistently corrupt.<br /><br />The PCI device chain for that particular report was:<br /><br />	00:00.0 Host bridge: ATI Technologies Inc Unknown device 7930<br />	..<br />	00:06.0 PCI bridge: ATI Technologies Inc Unknown device 7936 (prog-if 00 [Normal decode])<br />	..<br />	02:00.0 Ethernet controller: Marvell Technology Group Ltd. 88E8056 PCI-E Gigabit Ethernet Controller (rev 12)<br /><br />and with the bug, the PCI vendor ID for that ethernet chip was 0x0001 <br />(bogus vendor) rather than the correct Marvell ID (0x11ab).<br /><br />But as mentioned, there were other reports too of the exact same bug (with <br />different PCI devices, but the same "vendor == 0001" bogosity).<br /><br />Googling for<br /><br />	lspci "Unknown device 0001:" mmconfig<br /><br />shows reports like these:<br /><br />	<a href="https://lkml.org/lkml/2007/10/29/500">http://lkml.org/lkml/2007/10/29/500</a><br />	<a href="http://madwifi.org/ticket/1587">http://madwifi.org/ticket/1587</a><br />	<a href="http://www.nvnews.net/vbulletin/showthread.php?t=103271">http://www.nvnews.net/vbulletin/showthread.php?t=103271</a><br />	<a href="http://naoya.g.hatena.ne.jp/naoya/20070529/1180436756">http://naoya.g.hatena.ne.jp/naoya/20070529/1180436756</a><br />	<a href="https://bbs.archlinux.org/viewtopic.php?id=34321">http://bbs.archlinux.org/viewtopic.php?id=34321</a><br />	...<br /><br />which all seem to be due to this same bug with different cards (but the <br />common theme seems to be an ATI northbridge).<br /><br />The point is: mmconfig is easily broken. In surprising ways. The whole <br />concept is stupid, it was badly done, and it has never gotten any testing <br />what-so-ever until Linux started using it (and now Vista). And hardware <br />that isn't tested is broken by *definition*.<br /><br />And there's no point in blaming AMD. They may have gotten it wrong, but <br />hey, so did Intel (with machines that lock up completely), so it's not <br />like this is some "bad AMD" case. It's a "bad mmconfig" case.<br /><br />	                    Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
