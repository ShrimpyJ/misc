    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2007/12/17/429">First message in thread</a></li><li><a href="/lkml/2007/12/18/284">Richard Henderson</a><ul><li><a href="/lkml/2007/12/18/259">Linus Torvalds</a></li><li><a href="/lkml/2007/12/18/279">Ivan Kokshaysky</a></li><li><a href="/lkml/2007/12/18/289">Chuck Ebbert</a><ul><li><a href="/lkml/2007/12/18/294">Linus Torvalds</a></li><li><a href="/lkml/2007/12/18/335">Richard Henderson</a></li></ul></li><li><a href="/lkml/2007/12/18/291">Linus Torvalds</a><ul><li><a href="/lkml/2007/12/20/38">Ivan Kokshaysky</a><ul><li><a href="/lkml/2007/12/20/477">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2007/12/22/29">Andrew Morton</a><ul><li><a href="/lkml/2007/12/22/30">Andrew Morton</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2007/12/18/292">Richard Henderson</a><ul><li class="origin"><a href="/lkml/2007/12/18/388">Linus Torvalds</a><ul><li><a href="/lkml/2007/12/18/388">Linus Torvalds</a><ul><li><a href="/lkml/2007/12/20/496">Richard Henderson</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2007/12/18/357">Bjorn Helgaas</a></li><li><a href="/lkml/2007/12/18/401">Keith Packard</a></li><li><a href="/lkml/2007/12/20/473">Benjamin Herrenschmidt</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2007/12/18/322/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 18 Dec 2007 14:31:42 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: PCI resource problems caused by improper address rounding</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 18 Dec 2007, Richard Henderson wrote:<br />&gt; <br />&gt; Another way to look at this is that the graphics BAR came in from<br />&gt; the BIOS allocated at c0000000, and we ignored that.<br /><br />We did?<br /><br />&gt; Perhaps there's a way to give weight to the BIOS settings when <br />&gt; consdering where the PCI region is supposed to start?<br /><br />Normally, we *always* keep the BIOS allocations, unless it explicitly <br />clashes with something and we have reason to believe that they cannot <br />work. And there's nothing it clashes with, so we definitely *should* have <br />kept it.<br /><br />Why do you think it came pre-allocated at 0xc0000000? I'm seeing the <br />message <br /><br />   PCI: Cannot allocate resource region 1 of device 0000:01:00.0<br /><br />and I can well imagine that that is it, but if it was a valid allocation, <br />then we really should have kept it there.<br /><br />That question also brings up another issue: how come did we actually <br />choose address 0xc0000000 with the original patch you sent in? If we can't <br />find it in the parent resources, we shouldn't have accepted it even if it <br />had room for it!<br /><br />Which brings up *another* potential fix for this thing: as mentioned, <br />Intel bridges often claim to be "Normal decode", but the core ones seem to <br />almost never actually be that, and they tend to be "Negative decode". So <br />what may be going on is:<br /><br /> - the kernel sees that BIOS allocation at 0xc0000000 (I'll take your word <br />   for it, it doesn't actually say so without PCI debugging enabled)<br /><br /> - ...and notices that the PCI BAR is behind a PCI bridge that does<br />   not claim to be able to actually bridge that resource (it's normal <br />   decode, and the ranges it *does* decode are elsewhere!)<br /><br /> - so clearly that old allocation is pure crap and has to be re-done in a <br />   range that is actually properly bridged.<br /><br />but that decision bases itself on the Intel bridge not lying, and if it <br />turns out that the bridge at 0000:00:01.0 actually is transparent, then <br />the original allocation would have been ok.<br /><br />That said, your bridge at 00:1e.0 is *also* transparent, and it's actually <br />against the PCI specs to have two transparent bridges on the same PCI bus, <br />so I'm a bit surprised about that. But it does bring up a new thing you <br />could *try*, namely this patch...<br /><br />(You obviously have to replace "insert-your-device-here" with the proper <br />PCI device ID for the thing you have - your lspci output only gives the <br />name, not the numbers)<br /><br />We seem to have a multitude of possible reasons for this insanity. It <br />would be interesting to hear which one(s) of the possibilities make a <br />difference, if any.<br /><br />			Linus<br /><br />---<br /> drivers/pci/quirks.c |    1 +<br /> 1 files changed, 1 insertions(+), 0 deletions(-)<br /><br />diff --git a/drivers/pci/quirks.c b/drivers/pci/quirks.c<br />index 26cc4dc..c3b52f5 100644<br />--- a/drivers/pci/quirks.c<br />+++ b/drivers/pci/quirks.c<br />&#64;&#64; -820,6 +820,7 &#64;&#64; static void __devinit quirk_transparent_bridge(struct pci_dev *dev)<br /> {<br /> 	dev-&gt;transparent = 1;<br /> }<br />+DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_INTEL,	insert-your-device-id-here,	quirk_transparent_bridge );<br /> DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_INTEL,	PCI_DEVICE_ID_INTEL_82380FB,	quirk_transparent_bridge );<br /> DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_TOSHIBA,	0x605,	quirk_transparent_bridge );<br /> <br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
