    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/8/7/27">First message in thread</a></li><li><a href="/lkml/2013/8/25/151">Hillf Danton</a><ul><li><a href="/lkml/2013/8/26/414">Dave Jones</a><ul><li class="origin"><a href="/lkml/2013/8/26/452">Linus Torvalds</a><ul><li><a href="/lkml/2013/8/26/452">Linus Torvalds</a><ul><li><a href="/lkml/2013/8/26/521">Hugh Dickins</a></li></ul></li></ul></li><li><a href="/lkml/2013/8/26/439">Cyrill Gorcunov</a><ul><li><a href="/lkml/2013/8/26/448">Dave Jones</a><ul><li><a href="/lkml/2013/8/26/450">Cyrill Gorcunov</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 26 Aug 2013 13:15:59 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: unused swap offset / bad page map.</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Aug 26, 2013 at 12:08 PM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt;<br />&gt; [ 4588.541886] swap_free: Unused swap offset entry 00002d15<br />&gt; [ 4588.541952] BUG: Bad page map in process trinity-kid12  pte:005a2a80 pmd:22c01f067<br />&gt;<br />&gt; I can reproduce this pretty quickly by driving the system into swapping using<br />&gt; a few instances of 'trinity -C64' (this creates 64 threads)<br />&gt;<br />&gt; I'm not sure how far back this bug goes, so I'll try some older kernels<br />&gt; and see if I can bisect it, because we don't seem to be getting closer<br />&gt; to figuring out what's actually happening..<br /><br />Bisecting would indeed be good. But I get the feeling that you'll need<br />to go back a *long* time, because the swap_map[] code hasn't changed<br />in ages.<br /><br />I'm adding Hugh Dickins to the cc just in case he hasn't seen this on<br />linux-mm, because the swap_map[] code is complex as hell, and Hugh did<br />touch some of it last. The whole swap_map[] thing is complicated by:<br /><br /> - it's a single byte per swap entry<br /> - it's not even a *structured* byte, but a single counter that has<br />several "fields" by hand<br /> - it has a count in the low 6 bits, with a magic "bad" value (which<br />is also a magic "continuation" value if one of the high bits are set)<br /> - it has two magic bits: HAS_CACHE and CONTINUED<br /> - it has a _third_ magic value (SWAP_MAP_SHMEM) which is "CONTINUED+BAD"<br /> - we increment this nasty pseudo-counter wildly hackily, and and have<br />magic special case checks for the odd cases<br /><br />and if we get any of the special cases wrong, we'll<br />increment/decrement it wrong, and we're screwed.<br /><br />The *locking* looks pretty simple, though. It's a simple spinlock. We<br />do some optimistic tests outside the spinlock, but the actual<br />allocation and modification seem to all be inside the lock and<br />re-check any optimistic values afaik.<br /><br />So I'm almost likely to think that we are more likely to have<br />something wrong in the messy magical special cases. I'm wondering if<br />we should get rid of the continuation crap, for example, and expand<br />the "one byte per swap page" to two bytes instead.<br /><br />Hugh, I think you know this code best, because you added the last<br />special case (that SWAP_MAP_SHMEM value). Comments?<br /><br />                  Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
