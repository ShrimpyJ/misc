    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/9/27/477">First message in thread</a></li><li><a href="/lkml/2013/9/27/488">Linus Torvalds</a><ul><li><a href="/lkml/2013/9/27/501">Davidlohr Bueso</a><ul><li><a href="/lkml/2013/9/27/544">Tim Chen</a><ul><li><a href="/lkml/2013/9/28/11">Ingo Molnar</a></li></ul></li></ul></li><li><a href="/lkml/2013/9/28/15">Ingo Molnar</a><ul><li class="origin"><a href="/lkml/2013/9/28/165">Linus Torvalds</a><ul><li><a href="/lkml/2013/9/28/165">Andi Kleen</a><ul><li><a href="/lkml/2013/9/28/171">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2013/9/28/194">Ingo Molnar</a><ul><li><a href="/lkml/2013/9/28/174">Linus Torvalds</a></li><li><a href="/lkml/2013/9/28/178">Ingo Molnar</a></li><li><a href="/lkml/2013/9/28/179">Linus Torvalds</a></li><li><a href="/lkml/2013/9/28/180">Ingo Molnar</a></li><li><a href="/lkml/2013/9/28/183">Ingo Molnar</a></li><li><a href="/lkml/2013/9/28/185">Ingo Molnar</a></li><li><a href="/lkml/2013/9/30/53">Andrea Arcangeli</a></li><li><a href="/lkml/2013/9/30/105">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/30/211">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/30/229">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/30/386">Waiman Long</a></li><li><a href="/lkml/2013/9/30/407">Tim Chen</a></li><li><a href="/lkml/2013/9/30/411">Andrew Morton</a></li></ul></li><li><a href="/lkml/2013/9/29/280">Davidlohr Bueso</a><ul><li><a href="/lkml/2013/9/29/284">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2013/9/29/311">Michel Lespinasse</a><ul><li><a href="/lkml/2013/9/30/19">Ingo Molnar</a></li></ul></li><li><a href="/lkml/2013/9/30/106">Peter Zijlstra</a><ul><li><a href="/lkml/2013/10/1/37">Ingo Molnar</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 28 Sep 2013 11:55:26 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] rwsem: reduce spinlock contention in wakeup code path</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Sat, Sep 28, 2013 at 12:41 AM, Ingo Molnar &lt;mingo&#64;kernel.org&gt; wrote:<br />&gt;<br />&gt;<br />&gt; Yeah, I fully agree. The reason I'm still very sympathetic to Tim's<br />&gt; efforts is that they address a regression caused by a mechanic<br />&gt; mutex-&gt;rwsem conversion:<br />&gt;<br />&gt;   5a505085f043 mm/rmap: Convert the struct anon_vma::mutex to an rwsem<br />&gt;<br />&gt; ... and Tim's patches turn that regression into an actual speedup.<br /><br />Btw, I really hate that thing. I think we should turn it back into a<br />spinlock. None of what it protects needs a mutex or an rwsem.<br /><br />Because you guys talk about the regression of turning it into a rwsem,<br />but nobody talks about the *original* regression.<br /><br />And it *used* to be a spinlock, and it was changed into a mutex back<br />in 2011 by commit 2b575eb64f7a. That commit doesn't even have a reason<br />listed for it, although my dim memory of it is that the reason was<br />preemption latency.<br /><br />And that caused big regressions too.<br /><br />Of course, since then, we may well have screwed things up and now we<br />sleep under it, but I still really think it was a mistake to do it in<br />the first place.<br /><br />So if the primary reason for this is really just that f*cking anon_vma<br />lock, then I would seriously suggest:<br /><br /> - turn it back into a spinlock (or rwlock_t, since we subsequently<br />separated the read and write paths)<br /><br /> - fix up any breakage (ie new scheduling points) that exposes<br /><br /> - look at possible other approaches wrt latency on that thing.<br /><br />Hmm?<br /><br />                Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
