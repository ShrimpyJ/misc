    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/9/17/113">First message in thread</a></li><li><a href="/lkml/2013/9/17/113">Peter Zijlstra</a><ul><li><a href="/lkml/2013/9/17/106">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/108">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/109">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/110">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/111">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/112">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/114">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/115">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/117">Peter Zijlstra</a><ul><li><a href="/lkml/2013/9/17/368">Peter Zijlstra</a></li></ul></li><li><a href="/lkml/2013/9/17/119">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/129">Peter Zijlstra</a></li><li><a href="/lkml/2013/9/17/149">Ingo Molnar</a><ul><li><a href="/lkml/2013/9/17/156">Peter Zijlstra</a></li></ul></li><li><a href="/lkml/2013/9/17/249">Peter Zijlstra</a><ul><li><a href="/lkml/2013/9/23/398">"Paul E. McKenney"</a><ul><li><a href="/lkml/2013/9/23/564">"Paul E. McKenney"</a><ul><li><a href="/lkml/2013/9/24/75">Peter Zijlstra</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2013/9/17/329">Thomas Gleixner</a><ul><li><a href="/lkml/2013/9/17/325">Thomas Gleixner</a></li><li><a href="/lkml/2013/9/17/326">Thomas Gleixner</a><ul><li><a href="/lkml/2013/11/13/419">tip-bot for Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/9/17/327">Thomas Gleixner</a><ul><li><a href="/lkml/2013/11/13/418">tip-bot for Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/9/17/330">Thomas Gleixner</a><ul><li><a href="/lkml/2013/9/18/115">Peter Zijlstra</a></li><li><a href="/lkml/2013/11/13/420">tip-bot for Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/9/17/331">Thomas Gleixner</a><ul><li><a href="/lkml/2013/11/13/417">tip-bot for Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/9/17/332">Thomas Gleixner</a><ul><li><a href="/lkml/2013/9/17/420">David Miller</a><ul><li><a href="/lkml/2013/9/17/439">Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/11/13/415">tip-bot for Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/9/17/360">Geert Uytterhoeven</a><ul><li><a href="/lkml/2013/9/17/387">Thomas Gleixner</a><ul><li><a href="/lkml/2013/9/18/250">Thomas Gleixner</a></li></ul></li></ul></li><li><a href="/lkml/2013/9/20/256">Guenter Roeck</a><ul><li><a href="/lkml/2013/9/20/445">Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2013/11/20/444">Tony Luck</a><ul><li><a href="/lkml/2013/11/20/496">Thomas Gleixner</a><ul><li><a href="/lkml/2013/11/21/165">Thomas Gleixner</a></li></ul></li></ul></li></ul></li><li class="origin"><a href="/lkml/2013/9/19/39">Linus Torvalds</a><ul><li><a href="/lkml/2013/9/19/39">Andi Kleen</a><ul><li><a href="/lkml/2013/9/19/74">Ingo Molnar</a></li><li><a href="/lkml/2013/9/20/11">"H. Peter Anvin"</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 18 Sep 2013 13:44:31 -0500</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 01/11] x86: Use asm goto to implement better modify_and_test() functions</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Sep 17, 2013 at 4:10 AM, Peter Zijlstra &lt;peterz&#64;infradead.org&gt; wrote:<br />&gt; Linus suggested using asm goto to get rid of the typical SETcc + TEST<br />&gt; instruction pair -- which also clobbers an extra register -- for our<br />&gt; typical modify_and_test() functions.<br /><br />Thinking about this, we actually have another place in x86 low-level<br />code where "asm goto" makes a lot of sense: exception handling for<br />__put_user_asm().<br /><br />I'd love to use it for __get_user_asm() too, but it doesn't work there<br />because "asm goto" cannot have outputs (and a get_user obviously needs<br />an output - the value it gets). But for put_user(), it seems to be a<br />very good match.<br /><br />The attached patch is ENTIRELY untested, but I did check some of the<br />generated assembly language. And the output is absolutely beautiful,<br />because now gcc sees the error case directly, so the straight-line<br />code is just he single "mov" instruction, no tests, no nothing. The<br />exception case will just jump to the local label directly.<br /><br />Of course, the STAC/CLAC noise is there, and we really should try to<br />come up with a better model for that (so that the code that uses<br />__put_user() because it wants to do many of them in one go after<br />having done one access_ok() check) but that's a separate issue.<br /><br />hpa, comments? Are you looking at perhaps moving the stac/clac<br />instructions out? With this, "filldir()" ends up lookng something like<br /><br />   ...<br />   data32 xchg %ax,%ax  # stac<br />   mov    %rcx,0x8(%rax)<br />   data32 xchg %ax,%ax  # clac<br />   mov    0x10(%rbx),%r13<br />   data32 xchg %ax,%ax  # stac<br />   mov    %r8,0x0(%r13)<br />   data32 xchg %ax,%ax  # clac<br />   data32 xchg %ax,%ax  # stac<br />   mov    %r12w,0x10(%r13)<br />   data32 xchg %ax,%ax  # clac<br />   ...<br /><br />which is a bit sad, since the code really is almost perfect aside from<br />the tons of extra nops/stac/clac instructions...<br /><br />                        Linus<br />[unhandled content-type:application/octet-stream]</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
