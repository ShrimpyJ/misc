    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/10/25/26">First message in thread</a></li><li><a href="/lkml/2013/10/25/26">"Artem S. Tashkinov"</a><ul><li class="origin"><a href="/lkml/2013/11/4/473">Linus Torvalds</a><ul><li><a href="/lkml/2013/11/4/473">Andreas Dilger</a><ul><li><a href="/lkml/2013/11/4/542">Dave Chinner</a><ul><li><a href="/lkml/2013/11/7/268">Jan Kara</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2013/10/25/110">NeilBrown</a><ul><li><a href="/lkml/2013/10/25/133">David Lang</a><ul><li><a href="/lkml/2013/10/25/362">"Artem S. Tashkinov"</a><ul><li><a href="/lkml/2013/10/25/373">NeilBrown</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2013/10/25/334">"Artem S. Tashkinov"</a><ul><li><a href="/lkml/2013/10/25/343">Diego Calleja</a><ul><li><a href="/lkml/2013/10/25/401">Fengguang Wu</a><ul><li><a href="/lkml/2013/11/15/301">Diego Calleja</a></li></ul></li></ul></li><li><a href="/lkml/2013/10/25/356">NeilBrown</a></li><li><a href="/lkml/2013/10/29/637">Jan Kara</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 25 Oct 2013 09:18:49 +0100</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Disabling in-memory write cache for x86-64 in Linux II</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Oct 25, 2013 at 8:25 AM, Artem S. Tashkinov &lt;t.artem&#64;lycos.com&gt; wrote:<br />&gt;<br />&gt; On my x86-64 PC (Intel Core i5 2500, 16GB RAM), I have the same 3.11 kernel<br />&gt; built for the i686 (with PAE) and x86-64 architectures. What's really troubling me<br />&gt; is that the x86-64 kernel has the following problem:<br />&gt;<br />&gt; When I copy large files to any storage device, be it my HDD with ext4 partitions<br />&gt; or flash drive with FAT32 partitions, the kernel first caches them in memory entirely<br />&gt; then flushes them some time later (quite unpredictably though) or immediately upon<br />&gt; invoking "sync".<br /><br />Yeah, I think we default to a 10% "dirty background memory" (and<br />allows up to 20% dirty), so on your 16GB machine, we allow up to 1.6GB<br />of dirty memory for writeout before we even start writing, and twice<br />that before we start *waiting* for it.<br /><br />On 32-bit x86, we only count the memory in the low 1GB (really<br />actually up to about 890MB), so "10% dirty" really means just about<br />90MB of buffering (and a "hard limit" of ~180MB of dirty).<br /><br />And that "up to 3.2GB of dirty memory" is just crazy. Our defaults<br />come from the old days of less memory (and perhaps servers that don't<br />much care), and the fact that x86-32 ends up having much lower limits<br />even if you end up having more memory.<br /><br />You can easily tune it:<br /><br />    echo $((16*1024*1024)) &gt; /proc/sys/vm/dirty_background_bytes<br />    echo $((48*1024*1024)) &gt; /proc/sys/vm/dirty_bytes<br /><br />or similar. But you're right, we need to make the defaults much saner.<br /><br />Wu? Andrew? Comments?<br /><br />             Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
