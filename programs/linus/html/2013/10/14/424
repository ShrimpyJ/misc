    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/10/14/353">First message in thread</a></li><li><a href="/lkml/2013/10/14/353">Dave Jones</a><ul><li class="origin"><a href="/lkml/2013/10/14/503">Linus Torvalds</a><ul><li><a href="/lkml/2013/10/14/503">Oleg Nesterov</a></li><li><a href="/lkml/2013/10/14/634">Linus Torvalds</a><ul><li><a href="/lkml/2013/10/15/507">Oleg Nesterov</a><ul><li><a href="/lkml/2013/10/15/673">Dave Jones</a></li><li><a href="/lkml/2013/10/16/842">Eric Wong</a></li></ul></li><li><a href="/lkml/2013/10/23/109">Pekka Enberg</a></li><li><a href="/lkml/2013/10/23/298">Peter Hurley</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 14 Oct 2013 10:31:14 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: epoll oops.</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Oct 14, 2013 at 8:46 AM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt; Machine is wedged and I can't get to it until tomorrow, but this is what was on serial console.<br />&gt; kernel running was from some time last Friday, I can get exact info tomorrow, though<br />&gt; I don't think there's anything epoll related recently that could explain this.<br /><br />It looks like it is the access to "lock-&gt;key" that takes a page fault.<br />The pointer looks good (%r13=ffff8801654cec98), so I'm pretty sure<br />this is due to DEBUG_PAGEALLOC and a free'd page.<br /><br />So it looks like ep_unregister_pollwait() calls remove_wait_queue() on<br />a wait-queue head that has already been free'd.<br /><br />I have this dim memory of us having fought this before. But maybe I'm<br />just remembering some of the old signalfd-vs-epoll races.<br /><br />Oleg, does this trigger any memory for you? Commit 971316f0503a<br />("epoll: ep_unregister_pollwait() can use the freed pwq-&gt;whead") just<br />makes me go "Hmm, this is *exactly* that that commit is talking<br />about.."<br /><br />                      Linus<br /><br />---<br />&gt; Oops: 0000 [#1] PREEMPT SMP DEBUG_PAGEALLOC<br />&gt; CPU: 3 PID: 449 Comm: trinity-main Not tainted 3.12.0-rc4+ #98<br />&gt; task: ffff88023e239560 ti: ffff880083082000 task.ti: ffff880083082000<br />&gt; RIP: 0010:[&lt;ffffffff810c9f98&gt;]  [&lt;ffffffff810c9f98&gt;] __lock_acquire+0x58/0x1be0<br />&gt; Call Trace:<br />&gt;  [&lt;ffffffff810cc2d3&gt;] lock_acquire+0x93/0x200<br />&gt;  [&lt;ffffffff81732c3b&gt;] _raw_spin_lock_irqsave+0x4b/0x90<br />&gt;  [&lt;ffffffff810848d9&gt;] remove_wait_queue+0x19/0x40<br />&gt;  [&lt;ffffffff812120eb&gt;] ep_unregister_pollwait.isra.14+0x5b/0x1e0<br />&gt;  [&lt;ffffffff81212786&gt;] ep_remove+0x26/0x140<br />&gt;  [&lt;ffffffff81213391&gt;] eventpoll_release_file+0x71/0xa0<br />&gt;  [&lt;ffffffff811c4faa&gt;] __fput+0x2aa/0x2d0<br />&gt;  [&lt;ffffffff811c501e&gt;] ____fput+0xe/0x10<br />&gt;  [&lt;ffffffff8107d67c&gt;] task_work_run+0xac/0xe0<br />&gt;  [&lt;ffffffff81056bd7&gt;] do_exit+0x2c7/0xcc0<br />&gt;  [&lt;ffffffff810589cc&gt;] do_group_exit+0x4c/0xc0<br />&gt;  [&lt;ffffffff81058a54&gt;] SyS_exit_group+0x14/0x20<br />&gt;  [&lt;ffffffff8173bf64&gt;] tracesys+0xdd/0xe2<br />&gt; Code: 85 c0 8b 05 4b d6 bc 00 45 0f 45 e0 85 c0 0f 84 07 01 00 00 8b 05 31 af 00 01 49 89 fd 41 89 f7 41 89 d3 85 c0 0f 84 08 01 00 00 &lt;49&gt; 8b 45 00 ba 01 00 00 00 48 3d 60 6a 13 82 44 0f 44 e2 41 83<br />&gt; RIP  [&lt;ffffffff810c9f98&gt;] __lock_acquire+0x58/0x1be0<br />&gt;  RSP &lt;ffff880083083c18&gt;<br />&gt; CR2: ffff8801654cec98<br />&gt; ---[ end trace 044e98c2d3aab216 ]---<br />&gt;<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
