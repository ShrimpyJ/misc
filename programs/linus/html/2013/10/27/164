    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/10/14/431">First message in thread</a></li><li><a href="/lkml/2013/10/27/156">Linus Torvalds</a><ul><li><a href="/lkml/2013/10/27/161">Linus Torvalds</a><ul><li class="origin"><a href="/lkml/2013/10/27/166">Linus Torvalds</a><ul><li><a href="/lkml/2013/10/27/166">Greg Kroah-Hartman</a><ul><li><a href="/lkml/2013/10/28/471">Bjorn Helgaas</a></li></ul></li></ul></li><li><a href="/lkml/2013/10/30/385">Pablo Neira Ayuso</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 27 Oct 2013 21:13:29 +0000</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [BUG 3.12.rc4] Oops: unable to handle kernel paging request during shutdown</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">.. and one more case of freeing a delayed work object (likely a kobject again):<br /><br />This time it looks like it's in the PCI layer, freeing the msi irq information.<br /><br />It looks like that code simply does<br /><br />    kobject_del(&amp;entry-&gt;kobj);<br />    kobject_put(&amp;entry-&gt;kobj);<br />    list_del(&amp;entry-&gt;list);<br />    kfree(entry);<br /><br />and the problem is that the "entry-&gt;kobj" may have *other* references<br />to it, thanks to people accessing it through /sys, so despite doing a<br />kojbect_del/kobject_put(), it's not at all ok to then do a "kfree()"<br />on it. The embedded kobj might still be in use.<br /><br />Afaik, that code should do the kfree() on the kobject in the _release_<br />method, not synchronously like that.<br /><br />We already have a msi_kobj_release(), I'm wondering why that doesn't<br />do the kfree().<br /><br />Bjorn? Yinghai? Greg, comments about that msi kobj usage?<br /><br />            Linus<br /><br />---<br /><br />  [ 2373.142964] mei_me 0000:00:16.0: stop<br />  [ 2373.143023] kobject: 'pn544' (ffff88011808f810): kobject_release,<br />parent           (null) (delayed)<br />  [ 2373.143076] kobject: '59' (ffff8800d268f648): kobject_release,<br />parent           (null) (delayed)<br />  [ 2373.143080] ------------[ cut here ]------------<br />  [ 2373.143087] WARNING: CPU: 3 PID: 2922 at lib/debugobjects.c:260<br />debug_print_object+0x83/0xa0()<br />  [ 2373.143094] ODEBUG: free active (active state 0) object type:<br />timer_list hint: delayed_work_timer_fn+0x0/0x20<br />  [ 2373.143096] Modules linked in: fuse ipt_MASQUERADE ip6t_REJECT<br />xt_conntrack bnep bluetooth ip6table_nat nf_conntrack_ipv6<br />nf_defrag_ipv6 nf_nat_ipv6 ip6table_mangle ip6ta$<br />  [ 2373.143159] CPU: 3 PID: 2922 Comm: rmmod Tainted: G        W<br />3.12.0-rc6-00331-ga2ff82065b5b #2<br />  [ 2373.143162] Hardware name: Sony Corporation SVP11213CXB/VAIO,<br />BIOS R0270V7 05/17/2013<br />  [ 2373.143164]  0000000000000009 ffff8800b74b5c20 ffffffff8160d4a2<br />ffff8800b74b5c68<br />  [ 2373.143170]  ffff8800b74b5c58 ffffffff810514e8 ffff8800b74a4f00<br />ffffffff81c365e0<br />  [ 2373.143174]  ffffffff819f9133 ffffffff81f4c1b0 0000000000000001<br />ffff8800b74b5cb8<br />  [ 2373.143179] Call Trace:<br />  [ 2373.143189]  [&lt;ffffffff8160d4a2&gt;] dump_stack+0x45/0x56<br />  [ 2373.143195]  [&lt;ffffffff810514e8&gt;] warn_slowpath_common+0x78/0xa0<br />  [ 2373.143200]  [&lt;ffffffff81051557&gt;] warn_slowpath_fmt+0x47/0x50<br />  [ 2373.143204]  [&lt;ffffffff812f8883&gt;] debug_print_object+0x83/0xa0<br />  [ 2373.143209]  [&lt;ffffffff8106aa90&gt;] ? execute_in_process_context+0x90/0x90<br />  [ 2373.143214]  [&lt;ffffffff812f99fb&gt;] debug_check_no_obj_freed+0x20b/0x250<br />  [ 2373.143219]  [&lt;ffffffff8132d213&gt;] ? free_msi_irqs+0x103/0x150<br />  [ 2373.143224]  [&lt;ffffffff8115db59&gt;] kfree+0x89/0x160<br />  [ 2373.143227]  [&lt;ffffffff8132d213&gt;] free_msi_irqs+0x103/0x150<br />  [ 2373.143232]  [&lt;ffffffff8132dc8d&gt;] pci_disable_msi+0x3d/0x60<br />  [ 2373.143241]  [&lt;ffffffffa01d2211&gt;] mei_me_remove+0x61/0xb0 [mei_me]<br />  [ 2373.143248]  [&lt;ffffffff81317796&gt;] pci_device_remove+0x36/0xb0<br />  [ 2373.143254]  [&lt;ffffffff813c6bea&gt;] __device_release_driver+0x7a/0xe0<br />  [ 2373.143260]  [&lt;ffffffff813c7568&gt;] driver_detach+0xc8/0xd0<br />  [ 2373.143266]  [&lt;ffffffff813c6816&gt;] bus_remove_driver+0x96/0x120<br />  [ 2373.143273]  [&lt;ffffffff813c7b77&gt;] driver_unregister+0x27/0x50<br />  [ 2373.143278]  [&lt;ffffffff813167ec&gt;] pci_unregister_driver+0x1c/0x90<br />  [ 2373.143286]  [&lt;ffffffffa01d3098&gt;] mei_me_driver_exit+0x10/0xf78 [mei_me]<br />  [ 2373.143291]  [&lt;ffffffff810b857d&gt;] SyS_delete_module+0x15d/0x2c0<br />  [ 2373.143299]  [&lt;ffffffff81002929&gt;] ? do_notify_resume+0x59/0x90<br />  [ 2373.143305]  [&lt;ffffffff8161b9a2&gt;] system_call_fastpath+0x16/0x1b<br />  [ 2373.143308] ---[ end trace 25f53c192da70827 ]---<br />  [ 2373.143313] kobject: 'msi_irqs' (ffff880037327a18):<br />kobject_release, parent ffff880119bb40a8 (delayed)<br />  [ 2373.143458] kobject: 'misc' (ffff8800d6487500): kobject_release,<br />parent ffff880119bb40a8 (delayed)<br />  [ 2373.143463] kobject: 'mei' (ffff8800d35f3410): kobject_release,<br />parent           (null) (delayed)<br />  [ 2373.143607] kobject: 'mei_me' (ffff88003717ce00):<br />kobject_release, parent ffff8801194b2818 (delayed)<br />  [ 2373.143670] kobject: 'drivers' (ffff8800d6487600):<br />kobject_release, parent ffffffffa01d5330 (delayed)<br />  [ 2373.143678] kobject: 'holders' (ffff8800d6714700):<br />kobject_release, parent ffffffffa01d5330 (delayed)<br />  [ 2373.143682] kobject: 'notes' (ffff8800d6714600): kobject_release,<br />parent ffffffffa01d5330 (delayed)<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
