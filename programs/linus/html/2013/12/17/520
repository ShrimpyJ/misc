    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2013/12/17/417">First message in thread</a></li><li><a href="/lkml/2013/12/17/417">Knut Petersen</a><ul><li><a href="/lkml/2013/12/17/519">Eric Dumazet</a><ul><li><a href="/lkml/2013/12/18/93">Knut Petersen</a></li></ul></li><li class="origin"><a href="/lkml/2013/12/17/535">Linus Torvalds</a><ul><li><a href="/lkml/2013/12/17/535">David Miller</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 17 Dec 2013 11:06:15 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [BUG: 3.13.0-rc4] inconsistent lock state</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">David, Eric, netdev,<br /> this seems to be due to __udp4_lib_rcv() doing udp_sk_rx_dst_set(),<br />which takes the 'sk-&gt;sk_dst_lock' spinlock. This all happens in a<br />software irq context.<br /><br />And on the other hand, inet_csk_listen_start() does sk_dst_reset(),<br />which takes the same lock *without* bh-disable, so it could deadlock<br />if an interrupt comes in, and bh processing happens, and we try to<br />take the lock recursively.<br /><br />Now, if I read everything correctly, I think that this is all fine in<br />practice because inet_csk_listen_start() is only ever called for TCP<br />sockets (inet_listen seems to exit unless it's a SOCK_STREAM), and<br />that this is a false lockdep warning due to a very hacky use of<br />sk_dst_lock by UDP.<br /><br />However, even if that's the case, then to make lockdep happy, maybe<br />UDP and TCP sockets need to initialize that sk_dst_lock in different<br />lockdep classes. Because we should make sure that lockdep is happy<br />either way.<br /><br />Or maybe use a different lock for that UDP hack.<br /><br />This seems to have been introduced by commit 975022310233 ("udp: ipv4:<br />must add synchronization in udp_sk_rx_dst_set()").<br /><br />Hmm?<br /><br />              Linus<br /><br />On Tue, Dec 17, 2013 at 10:13 AM, Knut Petersen<br />&lt;Knut_Petersen&#64;t-online.de&gt; wrote:<br />&gt; Hi Linus / everybody!<br />&gt;<br />&gt; Booting openSuSE 13.1 with kernel 3.13.0-rc4 triggers the attached<br />&gt; warning.<br />golem kernel: [   25.324096] <br />golem kernel: [   25.326525] =================================<br />golem kernel: [   25.328009] [ INFO: inconsistent lock state ]<br />golem kernel: [   25.328009] 3.13.0-rc4-main #89 Not tainted<br />golem kernel: [   25.328009] ---------------------------------<br />golem kernel: [   25.328009] inconsistent {SOFTIRQ-ON-W} -&gt; {IN-SOFTIRQ-W} usage.<br />golem kernel: [   25.328009] SuSEfirewall2/1453 [HC0[0]:SC1[1]:HE1:SE0] takes:<br />golem kernel: [   25.328009]  (&amp;(&amp;sk-&gt;sk_dst_lock)-&gt;rlock){+.?...}, at: [&lt;c0516fe1&gt;] __udp4_lib_rcv+0x4db/0x6d2<br />golem kernel: [   25.328009] {SOFTIRQ-ON-W} state was registered at:<br />golem kernel: [   25.328009]   [&lt;c0154319&gt;] __lock_acquire+0x6d5/0x1556<br />golem kernel: [   25.328009]   [&lt;c0155733&gt;] lock_acquire+0x72/0xc9<br />golem kernel: [   25.328009]   [&lt;c054e122&gt;] _raw_spin_lock+0x2a/0x39<br />golem kernel: [   25.328009]   [&lt;c04fdff3&gt;] inet_csk_listen_start+0x7d/0xc1<br />golem kernel: [   25.328009]   [&lt;c051cff2&gt;] inet_listen+0x145/0x16b<br />golem kernel: [   25.328009]   [&lt;c04c23d4&gt;] SyS_listen+0x48/0x63<br />golem kernel: [   25.328009]   [&lt;c04c3096&gt;] SyS_socketcall+0xb4/0x1fc<br />golem kernel: [   25.328009]   [&lt;c0553df4&gt;] sysenter_do_call+0x12/0x32<br />golem kernel: [   25.328009] irq event stamp: 53738<br />golem kernel: [   25.328009] hardirqs last  enabled at (53738): [&lt;c012dc10&gt;] local_bh_enable+0x92/0xa4<br />golem kernel: [   25.328009] hardirqs last disabled at (53737): [&lt;c012dbc2&gt;] local_bh_enable+0x44/0xa4<br />golem kernel: [   25.328009] softirqs last  enabled at (41266): [&lt;c012d9aa&gt;] __do_softirq+0x168/0x21a<br />golem kernel: [   25.328009] softirqs last disabled at (53653): [&lt;c0102bff&gt;] do_softirq_own_stack+0x34/0x3a<br />golem kernel: [   25.328009] <br />golem kernel: [   25.328009] other info that might help us debug this:<br />golem kernel: [   25.328009]  Possible unsafe locking scenario:<br />golem kernel: [   25.328009] <br />golem kernel: [   25.328009]        CPU0<br />golem kernel: [   25.328009]        ----<br />golem kernel: [   25.328009]   lock(&amp;(&amp;sk-&gt;sk_dst_lock)-&gt;rlock);<br />golem kernel: [   25.328009]   &lt;Interrupt&gt;<br />golem kernel: [   25.328009]     lock(&amp;(&amp;sk-&gt;sk_dst_lock)-&gt;rlock);<br />golem kernel: [   25.328009] <br />golem kernel: [   25.328009]  *** DEADLOCK ***<br />golem kernel: [   25.328009] <br />golem kernel: [   25.328009] 5 locks held by SuSEfirewall2/1453:<br />golem kernel: [   25.328009]  #0:  (&amp;dup_mmap_sem){.+.+.+}, at: [&lt;c01ab8c4&gt;] uprobe_start_dup_mmap+0x12/0x14<br />golem kernel: [   25.328009]  #1:  (&amp;mm-&gt;mmap_sem){++++++}, at: [&lt;c0128491&gt;] dup_mm+0x8c/0x3a4<br />golem kernel: [   25.328009]  #2:  (&amp;mm-&gt;mmap_sem/1){+.+.+.}, at: [&lt;c01284aa&gt;] dup_mm+0xa5/0x3a4<br />golem kernel: [   25.328009]  #3:  (rcu_read_lock){.+.+..}, at: [&lt;c04cfe90&gt;] __netif_receive_skb_core+0x136/0x5c2<br />golem kernel: [   25.328009]  #4:  (rcu_read_lock){.+.+..}, at: [&lt;c04f3f4f&gt;] ip_local_deliver_finish+0x2b/0x21b<br />golem kernel: [   25.328009] <br />golem kernel: [   25.328009] stack backtrace:<br />golem kernel: [   25.328009] CPU: 0 PID: 1453 Comm: SuSEfirewall2 Not tainted 3.13.0-rc4-main #89<br />golem kernel: [   25.328009] Hardware name:    /i915GMm-HFS, BIOS 6.00 PG 09/14/2005<br />golem kernel: [   25.328009]  00000000 f02d0110 f600bd60 c0548f1f f600bd80 c054714f c06d12e1 c06d11e0<br />golem kernel: [   25.328009]  c06d1fe2 f02d05ec f02d0110 c0152caa f600bda4 c015361e 00000004 00000000<br />golem kernel: [   25.328009]  00000006 00000004 f02d05e8 00000002 f02d05ec f600be04 c01542a6 c0153a54<br />golem kernel: [   25.328009] Call Trace:<br />golem kernel: [   25.328009]  [&lt;c0548f1f&gt;] dump_stack+0x16/0x18<br />golem kernel: [   25.328009]  [&lt;c054714f&gt;] print_usage_bug+0x21f/0x22b<br />golem kernel: [   25.328009]  [&lt;c0152caa&gt;] ? check_usage_backwards+0xda/0xda<br />golem kernel: [   25.328009]  [&lt;c015361e&gt;] mark_lock+0x2c4/0x4c2<br />golem kernel: [   25.328009]  [&lt;c01542a6&gt;] __lock_acquire+0x662/0x1556<br />golem kernel: [   25.328009]  [&lt;c0153a54&gt;] ? trace_hardirqs_on+0xb/0xd<br />golem kernel: [   25.328009]  [&lt;fa07d588&gt;] ? nf_conntrack_seqadj_fini+0x15/0x15 [nf_conntrack]<br />golem kernel: [   25.328009]  [&lt;c0154363&gt;] ? __lock_acquire+0x71f/0x1556<br />golem kernel: [   25.328009]  [&lt;c0155733&gt;] lock_acquire+0x72/0xc9<br />golem kernel: [   25.328009]  [&lt;c0516fe1&gt;] ? __udp4_lib_rcv+0x4db/0x6d2<br />golem kernel: [   25.328009]  [&lt;c054e122&gt;] _raw_spin_lock+0x2a/0x39<br />golem kernel: [   25.328009]  [&lt;c0516fe1&gt;] ? __udp4_lib_rcv+0x4db/0x6d2<br />golem kernel: [   25.328009]  [&lt;c0516fe1&gt;] __udp4_lib_rcv+0x4db/0x6d2<br />golem kernel: [   25.328009]  [&lt;c05175e7&gt;] udp_rcv+0x17/0x19<br />golem kernel: [   25.328009]  [&lt;c04f4027&gt;] ip_local_deliver_finish+0x103/0x21b<br />golem kernel: [   25.328009]  [&lt;c04f45bd&gt;] ip_local_deliver+0x75/0x7a<br />golem kernel: [   25.328009]  [&lt;c04f43e3&gt;] ip_rcv_finish+0x2a4/0x332<br />golem kernel: [   25.328009]  [&lt;c04f481d&gt;] ip_rcv+0x25b/0x2ba<br />golem kernel: [   25.328009]  [&lt;c04d0291&gt;] __netif_receive_skb_core+0x537/0x5c2<br />golem kernel: [   25.328009]  [&lt;c04d0ada&gt;] __netif_receive_skb+0x1b/0x57<br />golem kernel: [   25.328009]  [&lt;c04d0b4d&gt;] netif_receive_skb+0x37/0x3a<br />golem kernel: [   25.328009]  [&lt;c04d12a3&gt;] napi_gro_receive+0x36/0x72<br />golem kernel: [   25.328009]  [&lt;c045a5d3&gt;] sky2_poll+0x6c1/0x98c<br />golem kernel: [   25.328009]  [&lt;c01539fb&gt;] ? trace_hardirqs_on_caller+0x11d/0x16b<br />golem kernel: [   25.328009]  [&lt;c04d0d71&gt;] net_rx_action+0xaa/0x19e<br />golem kernel: [   25.328009]  [&lt;c012d900&gt;] __do_softirq+0xbe/0x21a<br />golem kernel: [   25.328009]  [&lt;c012d842&gt;] ? __tasklet_hrtimer_trampoline+0x33/0x33<br />golem kernel: [   25.328009]  &lt;IRQ&gt;  [&lt;c012dcc0&gt;] ? irq_exit+0x46/0x81<br />golem kernel: [   25.328009]  [&lt;c011ccba&gt;] ? smp_apic_timer_interrupt+0x36/0x3f<br />golem kernel: [   25.328009]  [&lt;c054ee6b&gt;] ? apic_timer_interrupt+0x2f/0x34<br />golem kernel: [   25.328009]  [&lt;c01c007b&gt;] ? bdi_has_dirty_io+0x37/0x46<br />golem kernel: [   25.328009]  [&lt;c0128626&gt;] ? dup_mm+0x221/0x3a4<br />golem kernel: [   25.328009]  [&lt;c01293d0&gt;] ? copy_process.part.34+0xc02/0x104e<br />golem kernel: [   25.328009]  [&lt;c0129981&gt;] ? do_fork+0xab/0x263<br />golem kernel: [   25.328009]  [&lt;c02f7b6a&gt;] ? _copy_to_user+0x41/0x4c<br />golem kernel: [   25.328009]  [&lt;c02f7764&gt;] ? trace_hardirqs_on_thunk+0xc/0x10<br />golem kernel: [   25.328009]  [&lt;c0553e23&gt;] ? sysenter_exit+0xf/0x16<br />golem kernel: [   25.328009]  [&lt;c0129bb0&gt;] ? SyS_clone+0x1b/0x1d<br />golem kernel: [   25.328009]  [&lt;c0553df4&gt;] ? sysenter_do_call+0x12/0x32<br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
