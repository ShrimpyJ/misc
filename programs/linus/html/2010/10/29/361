    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2010/10/29/318">First message in thread</a></li><li><a href="/lkml/2010/10/29/318">David Miller</a><ul><li class="origin"><a href="/lkml/2010/10/30/209">Linus Torvalds</a><ul><li><a href="/lkml/2010/10/30/209">David Miller</a></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2010/10/29/361/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 29 Oct 2010 14:41:03 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [GIT] Networking</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Oct 29, 2010 at 12:59 PM, David Miller &lt;davem&#64;davemloft.net&gt; wrote:<br />&gt;<br />&gt; This has the verify_iovec() INT_MAX limiter change as well as:<br /><br />I think you'd want this as well, to make sure that sendto/recvfrom<br />don't generate invalid iovecs.<br /><br />Feel free to add my sign-off (or just commit it as yourself) after<br />giving it some testing.<br /><br />NOTE! On thing that struck me is that the VFS layer does the<br />"access_ok()" on the pre-truncated size and pointer pair, and I think<br />that is the correct thing to do. However, the socket layer (and this<br />patch) just truncates the size, so even if the copy is then done<br />correctly with the proper user access checking, it will not check that<br />the whole original buffer was valid - only that the buffer it fills in<br />is valid.<br /><br />Now, this is not a security issue (since we're just not checking stuff<br />that isn't getting filled in), but I think it's a QoI issue - it<br />allows users to successfully pass in bogus buffers with huge sizes,<br />and then if the thing only reads a few bytes it will all be ok.<br /><br />That's not a new thing: the old code may not have truncated the sizes,<br />but if you pass in a 2GB buffer size, 99.999% of all socket read calls<br />obviously won't ever fill that 2GB, but will happily return with<br />whatever is there in the socket now (especially with nonblocking IO<br />etc). But I do wonder if we shouldn't do the access_ok() on the whole<br />buffer, as a way to keep user code honest.<br /><br />                  Linus<br /> net/socket.c |    4 ++++<br /> 1 files changed, 4 insertions(+), 0 deletions(-)<br /><br />diff --git a/net/socket.c b/net/socket.c<br />index 5247ae1..3ca2fd9 100644<br />--- a/net/socket.c<br />+++ b/net/socket.c<br />&#64;&#64; -1652,6 +1652,8 &#64;&#64; SYSCALL_DEFINE6(sendto, int, fd, void __user *, buff, size_t, len,<br /> 	struct iovec iov;<br /> 	int fput_needed;<br /> <br />+	if (len &gt; INT_MAX)<br />+		len = INT_MAX;<br /> 	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);<br /> 	if (!sock)<br /> 		goto out;<br />&#64;&#64; -1709,6 +1711,8 &#64;&#64; SYSCALL_DEFINE6(recvfrom, int, fd, void __user *, ubuf, size_t, size,<br /> 	int err, err2;<br /> 	int fput_needed;<br /> <br />+	if (size &gt; INT_MAX)<br />+		size = INT_MAX;<br /> 	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);<br /> 	if (!sock)<br /> 		goto out;</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
