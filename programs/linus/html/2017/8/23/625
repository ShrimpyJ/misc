    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2017/8/23/647">First message in thread</a></li><li><a href="/lkml/2017/8/23/647">Doug Nazar</a><ul><li class="origin"><a href="">Linus Torvalds</a></li><li><a href="/lkml/2017/8/23/646">Doug Nazar</a><ul><li><a href="/lkml/2017/8/23/651">Linus Torvalds</a><ul><li><a href="/lkml/2017/8/23/670">Andreas Dilger</a><ul><li><a href="/lkml/2017/8/24/337">Doug Nazar</a></li><li><a href="/lkml/2017/8/27/194">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2017/8/24/321">Doug Nazar</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2017/8/23/625/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 23 Aug 2017 12:37:13 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Kernels v4.9+ cause short reads of block devices</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Aug 23, 2017 at 12:15 PM, Doug Nazar &lt;nazard&#64;nazar.ca&gt; wrote:<br />&gt; The following commits cause short reads of block devices, however writes are<br />&gt; still allowed.<br />&gt;<br />&gt; c2a9737f45e2 ("vfs,mm: fix a dead loop in truncate_inode_pages_range()")<br />&gt; d05c5f7ba164 ("vfs,mm: fix return value of read() at s_maxbytes")<br />&gt;<br />&gt; When e2fsck sees this, it thinks it's a bad sector and tries to write a<br />&gt; block of nulls which overwrites the valid data.<br /><br />Hmm. Block devices shouldn't have issues with s_maxbytes, and I'm<br />surprised that nobody has seen that before.<br /><br />&gt; Device is LVM over 2 x RAID-5 on an old 32bit desktop.<br />&gt;<br />&gt; RO    RA   SSZ   BSZ   StartSec            Size   Device<br />&gt; rw  4096   512  4096          0   9748044840960 /dev/Storage/Main<br /><br />.. and the problem may be as simple as just a missing initialization<br />of s_maxbytes for blockdev_superblock.<br /><br />Does the attcahed trivial one-liner fix things for you?<br /><br />Al, if it really is this simple, how come nobody even noticed?<br /><br />Also, I do wonder if that check in do_generic_file_read() should just<br />unconditionally use MAX_LFS_FILESIZE, since the whole point there is<br />really about the index wrap-around, not about any underlying<br />filesystem limits per se.<br /><br />And that's exactly what MAX_LFS_FILESIZE is - the maximum size that<br />fits in the page index.<br /><br />              Linus<br /> fs/block_dev.c | 1 +<br /> 1 file changed, 1 insertion(+)<br /><br />diff --git a/fs/block_dev.c b/fs/block_dev.c<br />index 9941dc8342df..4c3867c5298a 100644<br />--- a/fs/block_dev.c<br />+++ b/fs/block_dev.c<br />&#64;&#64; -830,6 +830,7 &#64;&#64; void __init bdev_cache_init(void)<br /> 	if (IS_ERR(bd_mnt))<br /> 		panic("Cannot create bdev pseudo-fs");<br /> 	blockdev_superblock = bd_mnt-&gt;mnt_sb;   /* For writeback */<br />+	blockdev_superblock-&gt;s_maxbytes = MAX_LFS_FILESIZE;<br /> }<br /> <br /> /*</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
