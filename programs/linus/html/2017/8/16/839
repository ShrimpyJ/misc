    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2017/8/16/534">First message in thread</a></li><li><a href="/lkml/2017/8/16/807">Linus Torvalds</a><ul><li><a href="/lkml/2017/8/16/826">(Eric W. Biederman)</a><ul><li class="origin"><a href="/lkml/2017/8/16/879">Linus Torvalds</a><ul><li><a href="/lkml/2017/8/16/879">(Eric W. Biederman)</a></li><li><a href="/lkml/2017/8/23/759">Stefan Lippers-Hollmann</a><ul><li><a href="/lkml/2017/8/23/762">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2017/8/16/839/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 16 Aug 2017 17:08:07 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 0/1] devpts: use dynamic_dname() to generate proc name</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Aug 16, 2017 at 4:51 PM, Eric W. Biederman<br />&lt;ebiederm&#64;xmission.com&gt; wrote:<br />&gt;<br />&gt; *Blink* You are right I missed that.<br />&gt;<br />&gt; In which case I am concerned about failures that make it to err_release.<br />&gt; Unless I am missing something (again) failures that jump to err_release<br />&gt; won't call mntput and will result in a mnt leak.<br /><br />Yes, I think you're right.<br /><br />Maybe this attached patch is better anyway. It's smaller, because it<br />keeps more closely to the old code, and just adds a mntput() in all<br />the exit cases, and depends on the "path_get()" to have incremented<br />the mnt refcount one extra time.<br /><br />Can you find something in this one?<br /><br />ENTIRELY UNTESTED!<br /><br />               Linus<br /> drivers/tty/pty.c         | 7 +++++--<br /> fs/devpts/inode.c         | 4 +++-<br /> include/linux/devpts_fs.h | 2 +-<br /> 3 files changed, 9 insertions(+), 4 deletions(-)<br /><br />diff --git a/drivers/tty/pty.c b/drivers/tty/pty.c<br />index 284749fb0f6b..1fc80ea87c13 100644<br />--- a/drivers/tty/pty.c<br />+++ b/drivers/tty/pty.c<br />&#64;&#64; -793,6 +793,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	struct tty_struct *tty;<br /> 	struct path *pts_path;<br /> 	struct dentry *dentry;<br />+	struct vfsmount *mnt;<br /> 	int retval;<br /> 	int index;<br /> <br />&#64;&#64; -805,7 +806,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	if (retval)<br /> 		return retval;<br /> <br />-	fsi = devpts_acquire(filp);<br />+	fsi = devpts_acquire(filp, &amp;mnt);<br /> 	if (IS_ERR(fsi)) {<br /> 		retval = PTR_ERR(fsi);<br /> 		goto out_free_file;<br />&#64;&#64; -849,7 +850,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	pts_path = kmalloc(sizeof(struct path), GFP_KERNEL);<br /> 	if (!pts_path)<br /> 		goto err_release;<br />-	pts_path-&gt;mnt = filp-&gt;f_path.mnt;<br />+	pts_path-&gt;mnt = mnt;<br /> 	pts_path-&gt;dentry = dentry;<br /> 	path_get(pts_path);<br /> 	tty-&gt;link-&gt;driver_data = pts_path;<br />&#64;&#64; -866,6 +867,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	path_put(pts_path);<br /> 	kfree(pts_path);<br /> err_release:<br />+	mntput(mnt);<br /> 	tty_unlock(tty);<br /> 	// This will also put-ref the fsi<br /> 	tty_release(inode, filp);<br />&#64;&#64; -874,6 +876,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	devpts_kill_index(fsi, index);<br /> out_put_fsi:<br /> 	devpts_release(fsi);<br />+	mntput(mnt);<br /> out_free_file:<br /> 	tty_free_file(filp);<br /> 	return retval;<br />diff --git a/fs/devpts/inode.c b/fs/devpts/inode.c<br />index 108df2e3602c..44dfbca9306f 100644<br />--- a/fs/devpts/inode.c<br />+++ b/fs/devpts/inode.c<br />&#64;&#64; -133,7 +133,7 &#64;&#64; static inline struct pts_fs_info *DEVPTS_SB(struct super_block *sb)<br /> 	return sb-&gt;s_fs_info;<br /> }<br /> <br />-struct pts_fs_info *devpts_acquire(struct file *filp)<br />+struct pts_fs_info *devpts_acquire(struct file *filp, struct vfsmount **ptsmnt)<br /> {<br /> 	struct pts_fs_info *result;<br /> 	struct path path;<br />&#64;&#64; -142,6 +142,7 &#64;&#64; struct pts_fs_info *devpts_acquire(struct file *filp)<br /> <br /> 	path = filp-&gt;f_path;<br /> 	path_get(&amp;path);<br />+	*ptsmnt = NULL;<br /> <br /> 	/* Has the devpts filesystem already been found? */<br /> 	sb = path.mnt-&gt;mnt_sb;<br />&#64;&#64; -165,6 +166,7 &#64;&#64; struct pts_fs_info *devpts_acquire(struct file *filp)<br /> 	 * pty code needs to hold extra references in case of last /dev/tty close<br /> 	 */<br /> 	atomic_inc(&amp;sb-&gt;s_active);<br />+	*ptsmnt = mntget(path.mnt);<br /> 	result = DEVPTS_SB(sb);<br /> <br /> out:<br />diff --git a/include/linux/devpts_fs.h b/include/linux/devpts_fs.h<br />index 277ab9af9ac2..7883e901f65c 100644<br />--- a/include/linux/devpts_fs.h<br />+++ b/include/linux/devpts_fs.h<br />&#64;&#64; -19,7 +19,7 &#64;&#64;<br /> <br /> struct pts_fs_info;<br /> <br />-struct pts_fs_info *devpts_acquire(struct file *);<br />+struct pts_fs_info *devpts_acquire(struct file *, struct vfsmount **ptsmnt);<br /> void devpts_release(struct pts_fs_info *);<br /> <br /> int devpts_new_index(struct pts_fs_info *);</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
