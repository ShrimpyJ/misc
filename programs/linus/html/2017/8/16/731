    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2017/8/16/534">First message in thread</a></li><li><a href="/lkml/2017/8/16/689">Linus Torvalds</a><ul><li><a href="/lkml/2017/8/16/708">Linus Torvalds</a><ul><li class="origin"><a href="/lkml/2017/8/16/752">Linus Torvalds</a><ul><li><a href="/lkml/2017/8/16/752">Christian Brauner</a><ul><li><a href="/lkml/2017/8/16/755">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2017/8/16/800">(Eric W. Biederman)</a><ul><li><a href="/lkml/2017/8/16/807">Linus Torvalds</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2017/8/16/884">(Eric W. Biederman)</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2017/8/16/731/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 16 Aug 2017 14:03:14 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 0/1] devpts: use dynamic_dname() to generate proc name</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Aug 16, 2017 at 1:30 PM, Linus Torvalds<br />&lt;torvalds&#64;linux-foundation.org&gt; wrote:<br />&gt;<br />&gt; I suspect the easiest fix is to just add a "mnt" argument to<br />&gt; devpts_acquire(),  It shouldn't be too painful. Let me try.<br /><br />Ok, here's a *very* lightly tested patch. It might have new bugs, but<br />it makes your test program DTRT.<br /><br />Al, mind going over this and making sure I didn't miss anything?<br /><br />And Christian, if you can beat on this, that would be good.<br /><br />                        Linus<br /> drivers/tty/pty.c         | 15 +++++++++++----<br /> fs/devpts/inode.c         |  4 +++-<br /> include/linux/devpts_fs.h |  2 +-<br /> 3 files changed, 15 insertions(+), 6 deletions(-)<br /><br />diff --git a/drivers/tty/pty.c b/drivers/tty/pty.c<br />index 284749fb0f6b..432f514e3f42 100644<br />--- a/drivers/tty/pty.c<br />+++ b/drivers/tty/pty.c<br />&#64;&#64; -793,6 +793,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	struct tty_struct *tty;<br /> 	struct path *pts_path;<br /> 	struct dentry *dentry;<br />+	struct vfsmount *mnt;<br /> 	int retval;<br /> 	int index;<br /> <br />&#64;&#64; -805,7 +806,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	if (retval)<br /> 		return retval;<br /> <br />-	fsi = devpts_acquire(filp);<br />+	fsi = devpts_acquire(filp, &amp;mnt);<br /> 	if (IS_ERR(fsi)) {<br /> 		retval = PTR_ERR(fsi);<br /> 		goto out_free_file;<br />&#64;&#64; -849,9 +850,14 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	pts_path = kmalloc(sizeof(struct path), GFP_KERNEL);<br /> 	if (!pts_path)<br /> 		goto err_release;<br />-	pts_path-&gt;mnt = filp-&gt;f_path.mnt;<br />-	pts_path-&gt;dentry = dentry;<br />-	path_get(pts_path);<br />+<br />+	/*<br />+	 * The mnt already got a ref from devpts_acquire(),<br />+	 * so we only dget() on the dentry.<br />+	 */<br />+	pts_path-&gt;mnt = mnt;<br />+	pts_path-&gt;dentry = dget(dentry);<br />+<br /> 	tty-&gt;link-&gt;driver_data = pts_path;<br /> <br /> 	retval = ptm_driver-&gt;ops-&gt;open(tty, filp);<br />&#64;&#64; -874,6 +880,7 &#64;&#64; static int ptmx_open(struct inode *inode, struct file *filp)<br /> 	devpts_kill_index(fsi, index);<br /> out_put_fsi:<br /> 	devpts_release(fsi);<br />+	mntput(mnt);<br /> out_free_file:<br /> 	tty_free_file(filp);<br /> 	return retval;<br />diff --git a/fs/devpts/inode.c b/fs/devpts/inode.c<br />index 108df2e3602c..44dfbca9306f 100644<br />--- a/fs/devpts/inode.c<br />+++ b/fs/devpts/inode.c<br />&#64;&#64; -133,7 +133,7 &#64;&#64; static inline struct pts_fs_info *DEVPTS_SB(struct super_block *sb)<br /> 	return sb-&gt;s_fs_info;<br /> }<br /> <br />-struct pts_fs_info *devpts_acquire(struct file *filp)<br />+struct pts_fs_info *devpts_acquire(struct file *filp, struct vfsmount **ptsmnt)<br /> {<br /> 	struct pts_fs_info *result;<br /> 	struct path path;<br />&#64;&#64; -142,6 +142,7 &#64;&#64; struct pts_fs_info *devpts_acquire(struct file *filp)<br /> <br /> 	path = filp-&gt;f_path;<br /> 	path_get(&amp;path);<br />+	*ptsmnt = NULL;<br /> <br /> 	/* Has the devpts filesystem already been found? */<br /> 	sb = path.mnt-&gt;mnt_sb;<br />&#64;&#64; -165,6 +166,7 &#64;&#64; struct pts_fs_info *devpts_acquire(struct file *filp)<br /> 	 * pty code needs to hold extra references in case of last /dev/tty close<br /> 	 */<br /> 	atomic_inc(&amp;sb-&gt;s_active);<br />+	*ptsmnt = mntget(path.mnt);<br /> 	result = DEVPTS_SB(sb);<br /> <br /> out:<br />diff --git a/include/linux/devpts_fs.h b/include/linux/devpts_fs.h<br />index 277ab9af9ac2..7883e901f65c 100644<br />--- a/include/linux/devpts_fs.h<br />+++ b/include/linux/devpts_fs.h<br />&#64;&#64; -19,7 +19,7 &#64;&#64;<br /> <br /> struct pts_fs_info;<br /> <br />-struct pts_fs_info *devpts_acquire(struct file *);<br />+struct pts_fs_info *devpts_acquire(struct file *, struct vfsmount **ptsmnt);<br /> void devpts_release(struct pts_fs_info *);<br /> <br /> int devpts_new_index(struct pts_fs_info *);</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
