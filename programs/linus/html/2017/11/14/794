    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2017/11/12/256">First message in thread</a></li><li><a href="/lkml/2017/11/14/638">Linus Torvalds</a><ul><li><a href="/lkml/2017/11/14/788">Theodore Ts'o</a><ul><li class="origin"><a href="">Linus Torvalds</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 14 Nov 2017 17:11:47 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [GIT PULL] ext4 updates for 4.15</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Nov 14, 2017 at 4:56 PM, Theodore Ts'o &lt;tytso&#64;mit.edu&gt; wrote:<br />&gt;<br />&gt;    The e2fsprogs user space libraries all use<br />&gt; EXT4_*_FL, and we can't change that without breaking applications<br />&gt; depending on userspace, but we can keep things consistent in the<br />&gt; kernel, and that probably means completely converting away from<br />&gt; EXT4_*_FL, if possible.<br /><br />So I don't think you'd necessarily need to convert from one to the<br />other, but wouldn't it be nice if you at least defined one in terms of<br />the other, ie something like<br /><br />  #define EXT4_ENCRYPT_FL (1u &lt;&lt; EXT4_INODE_ENCRYPT)<br /><br />so that when you grep for one you see how they are directly related.<br /><br />Now it was much less obvious, and I was nervous because that whole<br />series did introduce _different_ bits that were not in the same space<br />at all, and encoded the same thing (ie that S_ENCRYPTED bit).<br /><br />Maybe this normally doesn't come up, but it was not all that obvious,<br />particularly since there was a lot of indirection:<br /><br /> ext4_encrypted_inode() -&gt;<br />    ext4_test_inode_flag(inode, EXT4_INODE_ENCRYPT) -&gt;<br />        EXT4_INODE_BIT_FNS()<br /><br />That EXT4_INODE_BIT_FNS thing was really fascinating to see.<br /><br />So just confirming that yes,<br /><br />   ext4_encrypted_inode()<br /><br />is the same thing as<br /><br />   EXT4_I(inode)-&gt;i_flags &amp; EXT4_ENCRYPT_FL<br /><br />was a real adventure.<br /><br />Making it clear that EXT4_ENCRYPT_FL and EXT4_INODE_ENCRYPT are the<br />same bit would maybe have lessened the confusion at least a tiny bit.<br /><br />Of course, not having five different ways to test the same bit would<br />have been even better.<br /><br />Ok, I'm exaggerating.<br /><br />But there really does seem to be a lot of different ways to check<br />i_flags bits, with some uses checking it directly, the places<br />_setting_ it using ext4_set_inode_flag(), and then other testers using<br />bit-specific helper.<br /><br />And that somewhat confusing model seems to be true of pretty much all the bits.<br /><br />As long as you can keep track of it, I guess it's fine.<br /><br />            Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
