    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2017/12/30/54">First message in thread</a></li><li><a href="/lkml/2017/12/30/88">Dominik Brodowski</a><ul><li><a href="/lkml/2017/12/30/115">Dave Hansen</a><ul><li><a href="/lkml/2017/12/30/128">Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2017/12/30/127">Thomas Gleixner</a><ul><li class="origin"><a href="/lkml/2017/12/30/142">Linus Torvalds</a><ul><li><a href="/lkml/2017/12/30/142">Dave Hansen</a><ul><li><a href="/lkml/2017/12/30/146">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2017/12/30/153">Thomas Gleixner</a><ul><li><a href="/lkml/2017/12/30/157">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2017/12/30/161">Thomas Gleixner</a><ul><li><a href="/lkml/2017/12/30/173">Linus Torvalds</a></li><li><a href="/lkml/2017/12/30/174">Thomas Gleixner</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 30 Dec 2017 10:40:37 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: x86/pti: smp_processor_id() called while preemptible in resume-from-sleep</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Sat, Dec 30, 2017 at 10:20 AM, Thomas Gleixner &lt;tglx&#64;linutronix.de&gt; wrote:<br />&gt; On Sat, 30 Dec 2017, Dominik Brodowski wrote:<br />&gt;&gt;<br />&gt;&gt; native_cpu_up+0x2f0/0xa30:<br />&gt;&gt; invalidate_user_asid at arch/x86/include/asm/tlbflush.h:343<br />&gt;<br />&gt; Ah, that makes sense. Missed that in the maze.<br />&gt;<br />&gt; What makes less sense is that tlbflush itself. I'm surely missing something<br />&gt; subtle, but from a first look that tlbflush is pointless.<br /><br />Hmm. Regardless of whether the TLB flush makes sense in that<br />smpboot_setup_warm_reset_vector() location (and I agree that it looks<br />a bit odd), the warning does look pretty relevant.<br /><br />The __native_flush_tlb() function looks _very_ broken.<br /><br />It does:<br /><br />        invalidate_user_asid(this_cpu_read(cpu_tlbstate.loaded_mm_asid));<br />        /*<br />         * If current-&gt;mm == NULL then we borrow a mm which may change<br />         * during a task switch and therefore we must not be preempted<br />         * while we write CR3 back:<br />         */<br />        preempt_disable();<br />        native_write_cr3(__native_read_cr3());<br />        preempt_enable();<br /><br />but why is that preempt-disabled region only around the cr3 write? The<br />invalidate_user_asid() logic seems to be very CPU-sensitive too.<br /><br />And even if there is some reason why invalidate_user_asid() really can<br />do multiple different percpu accesses and it doesn't matter whether<br />the thread is bouncing around on different cpu's while it does it,<br />there doesn't seem any _reason_ not to just extend the preempt-disable<br />over the whole series.<br /><br />It really looks strange how it does multiple reads (and then a final<br />write!) to percpu state, when the cpu can change in between.<br /><br />So I'd suggest moving the preempt_disable() up to the top of that<br />function, regardless of whether we could then remove that seemingly<br />stale TLB flush in that crazy<br />smpboot_setup/restore_warm_reset_vector() dance...<br /><br />Andy?<br /><br />                      Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
