    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2017/12/23/159">First message in thread</a></li><li><a href="/lkml/2017/12/26/175">Linus Torvalds</a><ul><li><a href="/lkml/2017/12/26/180">   hpa&#64;zytor ...</a></li><li><a href="/lkml/2017/12/26/225">Alexandru Chirvasitu</a><ul><li><a href="/lkml/2017/12/26/229">   hpa&#64;zytor ...</a></li><li><a href="/lkml/2017/12/26/230">   hpa&#64;zytor ...</a></li><li><a href="/lkml/2017/12/26/234">   hpa&#64;zytor ...</a></li><li class="origin"><a href="/lkml/2017/12/26/282">Linus Torvalds</a><ul><li><a href="/lkml/2017/12/26/282">   hpa&#64;zytor ...</a><ul><li><a href="/lkml/2017/12/26/285">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2017/12/26/307">Alexandru Chirvasitu</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 26 Dec 2017 18:16:37 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: PROBLEM: consolidated IDT invalidation causes kexec to reboot</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Dec 26, 2017 at 3:19 PM, Alexandru Chirvasitu<br />&lt;achirvasub&#64;gmail.com&gt; wrote:<br />&gt;<br />&gt; I went back to the initial problematic commit e802a51 and modified it as you suggest:<br /><br />Thank you.<br /><br />&gt; This did not work out for me, but now it fails differently. Both<br />&gt; (kexec -l + kexec -e) and (kexec -p + echo c &gt; /proc/sysrq-trigger)<br />&gt; end in call traces and freezes.<br />&gt;<br />&gt; It does seem to be tied to idt_invalidate. One of the last things I<br />&gt; see on the screen (which is ends up frozen with the computer inactive)<br />&gt; is<br />&gt;<br />&gt; EIP: idt_invalidate+0x6/0x40 SS:ESP: 0068:f6c47cd0<br /><br />Yes, interesting, it's the stack canary load access there:<br /><br />        mov    %gs:0x14,%edx<br /><br />that traps.<br /><br />And that actually makes a lot of sense: the load_segments() call just<br />above has rloaded all segments with __KERNEL_DS.<br /><br />So while the stack canary access *intends* to load it from the magic<br />stack canary segment (offset 0x14), we've just reset all segments to<br />the standard zero-based full-sized ones, and obviously that will take<br />a page fault at 0x14.<br /><br />And the reason you now actually *see* the page fault is that we<br />haven't completely buggered the CPU state now, so the trap handler<br />actually works. With the GDT reset before, it used to take that same<br />trap, but now the trap handler itself would fault, and cause a triple<br />fault - which resets the machine.<br /><br />So it wasn't actually tracing, it was the stack canary all along. So<br />at least it's truly root-caused now.<br /><br />But the fix is the same: we just can't afford to do any function calls.<br /><br />Alternatively, we should just fix that insane "load_segments()". I'm<br />not sure why the code insists on reloading the segments in the first<br />place.<br /><br />So you could try just to remove the "load_segments()" line entirely.<br /><br />Thanks for spending the time testing things out,<br /><br />                     Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
