    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2018/11/3/437">First message in thread</a></li><li><a href="/lkml/2018/12/17/763">Linus Torvalds</a><ul><li><a href="/lkml/2018/12/17/771">Linus Torvalds</a><ul><li class="origin"><a href="/lkml/2018/12/17/810">Linus Torvalds</a><ul><li><a href="/lkml/2018/12/17/810">James Bottomley</a><ul><li><a href="/lkml/2018/12/17/821">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2018/12/17/843">Mimi Zohar</a><ul><li><a href="/lkml/2018/12/17/850">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2018/12/17/798/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 17 Dec 2018 11:39:57 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH RESEND] KEYS: fix parsing invalid pkey info string</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Dec 17, 2018 at 11:06 AM Linus Torvalds<br />&lt;torvalds&#64;linux-foundation.org&gt; wrote:<br />&gt;<br />&gt; Honestly, for being about "security", all of this code seems to be<br />&gt; doing some really questionable things with all those Opt_xyz enums.<br /><br />Yeah, at least security/keys/trusted.c ends up mixing that enum and<br />just using "int" completely randomly, and you have datablob_parse()<br />returning either a negative integer _or_ an "Opt_xyz" value, so having<br />Opt_err be -1 is doubly confusing there (it would also be "-EPERM"<br />depending on how you treat it).<br /><br />There doesn't seem to be any _actual_ confusion (because Opt_err is<br />always turned into an actual real error code), but it's  just another<br />sign of "those enums should not be negative".<br /><br />So on the whole, I think that the "Opt_err = -1" is a serious mistake,<br />but at least for now, ima_policy.c clearly has (bogus) code that<br />relies on it.<br /><br />But the two cases that use "test_and_set_bit()" do not seem to have<br />any reason to use that -1 enum, so while we can't do the "just remove<br />-1" in general, I do think the proper fix is to just do it for those<br />two files.<br /><br />Eric, mind testing a patch like that? Untested patch attached just for<br />completeness..<br /><br />                    Linus<br /> security/keys/keyctl_pkey.c | 2 +-<br /> security/keys/trusted.c     | 2 +-<br /> 2 files changed, 2 insertions(+), 2 deletions(-)<br /><br />diff --git a/security/keys/keyctl_pkey.c b/security/keys/keyctl_pkey.c<br />index 783978842f13..70e65a2ff207 100644<br />--- a/security/keys/keyctl_pkey.c<br />+++ b/security/keys/keyctl_pkey.c<br />&#64;&#64; -25,7 +25,7 &#64;&#64; static void keyctl_pkey_params_free(struct kernel_pkey_params *params)<br /> }<br /> <br /> enum {<br />-	Opt_err = -1,<br />+	Opt_err,<br /> 	Opt_enc,		/* "enc=&lt;encoding&gt;" eg. "enc=oaep" */<br /> 	Opt_hash,		/* "hash=&lt;digest-name&gt;" eg. "hash=sha1" */<br /> };<br />diff --git a/security/keys/trusted.c b/security/keys/trusted.c<br />index ff6789365a12..697bfc6c8192 100644<br />--- a/security/keys/trusted.c<br />+++ b/security/keys/trusted.c<br />&#64;&#64; -711,7 +711,7 &#64;&#64; static int key_unseal(struct trusted_key_payload *p,<br /> }<br /> <br /> enum {<br />-	Opt_err = -1,<br />+	Opt_err,<br /> 	Opt_new, Opt_load, Opt_update,<br /> 	Opt_keyhandle, Opt_keyauth, Opt_blobauth,<br /> 	Opt_pcrinfo, Opt_pcrlock, Opt_migratable,</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
