    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2018/8/17/546">First message in thread</a></li><li><a href="/lkml/2018/8/17/546">Guenter Roeck</a><ul><li><a href="/lkml/2018/8/17/548">Andi Kleen</a><ul><li><a href="/lkml/2018/8/17/551">Guenter Roeck</a></li></ul></li><li class="origin"><a href="/lkml/2018/8/17/572">Linus Torvalds</a><ul><li><a href="/lkml/2018/8/17/572">Guenter Roeck</a></li><li><a href="/lkml/2018/8/18/8">Andi Kleen</a></li></ul></li><li><a href="/lkml/2018/8/20/412">Michal Hocko</a><ul><li><a href="/lkml/2018/8/20/457">Andi Kleen</a><ul><li><a href="/lkml/2018/8/20/499">Michal Hocko</a></li><li><a href="/lkml/2018/8/20/529">Andi Kleen</a><ul><li><a href="/lkml/2018/8/21/450">Guenter Roeck</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 17 Aug 2018 17:25:07 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Crash in MM code in v4.4.y, v4.9.y with TRANSPARENT_HUGEPAGE enabled</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Aug 17, 2018 at 3:27 PM Guenter Roeck &lt;linux&#64;roeck-us.net&gt; wrote:<br />&gt;<br />&gt; [    6.649970] random: crng init done<br />&gt; [    6.689002] BUG: unable to handle kernel paging request at ffffeafffa1a0020<br /><br />Hmm. Lots of bits set.<br /><br />&gt; [    6.689082] RIP: 0010:[&lt;ffffffff8116ba10&gt;]  [&lt;ffffffff8116ba10&gt;] page_remove_rmap+0x10/0x230<br />&gt; [    6.689082] RSP: 0018:ffffc900007abc18  EFLAGS: 00000296<br />&gt; [    6.689082] RAX: ffffea0005e58000 RBX: ffffeafffa1a0000 RCX: 0000000020200000<br />&gt; [    6.689082] RDX: 00003fffffe00000 RSI: 0000000000000001 RDI: ffffeafffa1a0000<br /><br />Is that RDX value the same value as PHYSICAL_PMD_PAGE_MASK?<br /><br />If I did my math right, it would be, if your CPU has 46 bits of<br />physical memory. Might that be the case?<br /><br />The reason I mention that is because we had the bug with spurious<br />inversion of the zero pte/pmd, fixed by<br /><br />  f19f5c49bbc3 ("x86/speculation/l1tf: Exempt zeroed PTEs from inversion")<br /><br />and that would make a zeroed pmd entry be inverted by<br />PHYSICAL_PMD_PAGE_MASK, and then you get odd garbage page pointers<br />etc.<br /><br />Maybe. I could have gotten the math wrong too, but it sounds like the<br />register contents _potentially_ might match up with something like<br />this, and then we'd zap a bogus hugepage because of some confusion.<br /><br />Although then I'd have expected the bisection to hit<br />"x86/speculation/l1tf: Invert all not present mappings" instead of the<br />one you hit, so I don't know.<br /><br />Plus I'd have expected the problem to have been in mainline too, and<br />apparently it's just the 4.4 and 4.9 backports.<br /><br />Your test-case does have mprotect with PROT_NONE. Which together with<br />that mask that *might* be PHYSICAL_PMD_PAGE_MASK makes me think it<br />might be related.<br /><br />             Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
