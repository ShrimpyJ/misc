    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2018/8/22/412">First message in thread</a></li><li><a href="/lkml/2018/8/22/424">Peter Zijlstra</a><ul><li><a href="/lkml/2018/8/23/48">Nicholas Piggin</a><ul><li class="origin"><a href="/lkml/2018/8/23/61">Linus Torvalds</a><ul><li><a href="/lkml/2018/8/23/61">Nicholas Piggin</a><ul><li><a href="/lkml/2018/8/23/74">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2018/8/23/72">Benjamin Herrenschmidt</a><ul><li><a href="/lkml/2018/8/23/76">Linus Torvalds</a></li><li><a href="/lkml/2018/8/24/178">Peter Zijlstra</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2018/8/23/1384">Will Deacon</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 22 Aug 2018 20:59:46 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 3/4] mm/tlb, x86/mm: Support invalidating TLB caches for RCU_TABLE_FREE</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Aug 22, 2018 at 8:45 PM Nicholas Piggin &lt;npiggin&#64;gmail.com&gt; wrote:<br />&gt;<br />&gt; powerpc/radix has no such issue, it already does this tracking.<br /><br />Yeah, I now realize that this was why you wanted to add that hacky<br />thing to the generic code, so that you can add the tlb_flush_pgtable()<br />call.<br /><br />I thought it was because powerpc had some special flush instruction<br />for it, and the regular tlb flush didn't do it. But no. It was because<br />the regular code had lost the tlb flush _entirely_, because powerpc<br />didn't want it.<br /><br />&gt; We were discussing this a couple of months ago, I wasn't aware of ARM's<br />&gt; issue but I suggested x86 could go the same way as powerpc.<br /><br />The problem is that x86 _used_ to do this all correctly long long ago.<br /><br />And then we switched over to the "generic" table flushing (which<br />harkens back to the powerpc code).<br /><br />Which actually turned out to be not generic at all, and did not flush<br />the internal pages like x86 used to (back when x86 just used<br />tlb_remove_page for everything).<br /><br />So as a result, x86 had unintentionally lost the TLB flush we used to<br />have, because tlb_remove_table() had lost the tlb flushing because of<br />a powerpc quirk.<br /><br />You then added it back as a hacky per-architecture hook (apparently<br />having realized that you never did it at all), which didn't fix the<br />unintentional lack of flushing on x86.<br /><br />So now we're going to do it right.  No more "oh, powerpc didn't need<br />to flush because the hash tables weren't in the tlb at all" thing in<br />the generic code that then others need to work around.<br /><br />              Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
