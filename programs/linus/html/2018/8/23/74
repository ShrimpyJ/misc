    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2018/8/22/412">First message in thread</a></li><li><a href="/lkml/2018/8/23/51">Linus Torvalds</a><ul><li><a href="/lkml/2018/8/23/61">Nicholas Piggin</a><ul><li class="origin"><a href="/lkml/2018/8/23/87">Linus Torvalds</a><ul><li><a href="/lkml/2018/8/23/87">Nicholas Piggin</a></li></ul></li></ul></li><li><a href="/lkml/2018/8/23/72">Benjamin Herrenschmidt</a><ul><li><a href="/lkml/2018/8/23/76">Linus Torvalds</a><ul><li><a href="/lkml/2018/8/23/81">Linus Torvalds</a><ul><li><a href="/lkml/2018/8/23/98">Martin Schwidefsky</a></li></ul></li><li><a href="/lkml/2018/8/23/82">Benjamin Herrenschmidt</a><ul><li><a href="/lkml/2018/8/23/89">Nicholas Piggin</a></li></ul></li><li><a href="/lkml/2018/8/23/1071">Will Deacon</a><ul><li><a href="/lkml/2018/8/24/183">Peter Zijlstra</a></li></ul></li></ul></li><li><a href="/lkml/2018/8/24/178">Peter Zijlstra</a><ul><li><a href="/lkml/2018/8/24/373">Peter Zijlstra</a><ul><li><a href="/lkml/2018/8/24/426">Peter Zijlstra</a></li><li><a href="/lkml/2018/8/24/494">Will Deacon</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 22 Aug 2018 22:03:40 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 3/4] mm/tlb, x86/mm: Support invalidating TLB caches for RCU_TABLE_FREE</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Aug 22, 2018 at 9:33 PM Nicholas Piggin &lt;npiggin&#64;gmail.com&gt; wrote:<br />&gt;<br />&gt; I think it was quite well understood and fixed here, a145abf12c9 but<br />&gt; again that was before I really started looking at it.<br /><br />You don't understand the problem.<br /><br />All the x86 people thought WE ALREADY DID THAT.<br /><br />Because we had done this all correctly over a decade ago!<br /><br />Nobody realized that it had been screwed up by the powerpc code, and<br />the commit you point to was believed to be a new *powerpc* only issue,<br />because the semantics on powerpc has changed because of the radix<br />tree.<br /><br />The semantics on x86 have never changed, they've always been the same.<br />So why would the x86 people react to powerpc doing something that x86<br />had already always done.<br /><br />See?<br /><br />Nobody cared one whit about commit a145abf12c9, because it just<br />handles a new powerpc-specific case.<br /><br />&gt; I don't really understand what the issue you have with powerpc here.<br />&gt; powerpc hash has the page table flushing accessors which are just<br />&gt; no-ops, it's the generic code that fails to call them properly. Surely<br />&gt; there was no powerpc patch that removed those calls from generic code?<br /><br />Yes there was.<br /><br />Look where the generic code *came* from.<br /><br />It's powerpc code.<br /><br />See commit 267239116987 ("mm, powerpc: move the RCU page-table freeing<br />into generic code").<br /><br />The powerpc code was made into the generic code, because the powerpc<br />code had to handle all those special RCU freeing things etc that<br />others didn't.<br /><br />It's just that when x86 was then switched over to use the "generic"<br />code, people didn't realize that the generic code didn't do the TLB<br />invalidations for page tables, because they hadn't been needed on<br />powerpc.<br /><br />So the powerpc code that was made generic, never really was. The new<br />"generic" code had a powerpc-specific quirk.<br /><br />That then very subtly broke x86, without the x86 people ever<br />realizing. Because the old simple non-RCU x86 code had never had that<br />issue, it just treated the leaf pages and the directory pages exactly<br />the same.<br /><br />See?<br /><br />And THAT is why I talk about the powerpc code. Because what is<br />"generic" code in 4.18 (and several releases before) oisn't actually<br />generic.<br /><br />And that's basically exactly the bug that the patches from PeterZ is<br />fixing. Making the "tlb_remove_table()" code always flush the tlb, the<br />way it should have when it was made generic.<br /><br />              Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
