    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/11/14/656">First message in thread</a></li><li><a href="/lkml/2014/12/14/311">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/14/313">Dave Jones</a></li><li><a href="/lkml/2014/12/15/18">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/15/20">Dave Jones</a><ul><li><a href="/lkml/2014/12/15/651">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/15/873">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2014/12/15/279">Borislav Petkov</a></li><li><a href="/lkml/2014/12/18/447">Andy Lutomirski</a><ul><li><a href="/lkml/2014/12/18/458">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/18/464">Andy Lutomirski</a></li></ul></li><li><a href="/lkml/2014/12/18/459">Dave Jones</a></li></ul></li></ul></li><li><a href="/lkml/2014/12/17/342">Dave Jones</a><ul><li><a href="/lkml/2014/12/17/365">Dave Jones</a><ul><li><a href="/lkml/2014/12/17/369">Dave Jones</a></li><li><a href="/lkml/2014/12/17/379">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/17/388">Dave Jones</a></li></ul></li></ul></li><li class="origin"><a href="">Linus Torvalds</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 17 Dec 2014 11:41:00 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: frequent lockups in 3.18rc4</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Dec 17, 2014 at 10:22 AM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt;<br />&gt; Here's save_xstate_sig:<br /><br />Ok, that just confirmed that it was the call to __clear_user and the<br />"xsave64" instruction like expected. And the offset in __clear_user()<br />was just the return address after the call to "might_fault", so this<br />all matches with __clear_user and/or the xsave64 instruction taking<br />infinite page-faults.<br /><br />.. which also kind of matches with your old "pipe/page fault oddness"<br />report, where it was the single-byte write in<br />"fault_in_pages_writable()" that kept taking infinite page faults.<br /><br />However.<br /><br />I'm back looking at your old trace for the pipe/page fault oddness<br />report, and it goes like this (simplified):<br /><br />    __do_page_fault() {<br />      down_read_trylock();<br />      __might_sleep();<br />      find_vma();<br />      handle_mm_fault() {<br />        _raw_spin_lock();<br />        ptep_set_access_flags();<br />        _raw_spin_unlock();<br />      }<br />      up_read();<br />    }<br /><br />which is a bit hard to read because it doesn't trace all functions -<br />it only traces the ones that didn't get inlined.<br /><br />But "didn't get inlined" already means that we know the<br />handle_mm_fault() codepath it didn't go outside of mm/memory.c apart<br />from the quoted parts. So no hugetlb.c code, and no mm/filemap.c code.<br />So there are no lock_page_or_retry() failures, for example.<br /><br />There are only two ptep_set_access_flags() calls in mm/memory.c - in<br />do_wp_page() for the page re-use case, and in handle_pte_fault() for<br />the "pte was present and already writable".<br /><br />And it's almost certainly not the do_wp_page() one, because that is<br />not something that gcc inlines at least for me (it has two different<br />call sites).<br /><br />So I'm a bit less optimistic about the VM_FAULT_RETRY +<br />fatal_signal_pending() scenario, because it simply doesn't match your<br />earlier odd page fault thing.<br /><br />Your earlier page fault problem really looks like the VM is confused<br />about the page table contents. The kernel thinks the page is already<br />perfectly writable, and just marks it accessed and returns. But the<br />page fault just kept happening. And from that thread, you had<br />"error-code=0", which means "not present page, write fault".<br /><br />So that earlier "infinite page fault" bug really smells like something<br />else went wrong. One of:<br /><br /> - we're using the wrong "mm". The x86 fault code uses "tsk-&gt;mm",<br />rather than "tsk-&gt;active_mm", which is somewhat dubious. At the same<br />time, they should always match, unless "mm" is NULL. And we know mm<br />isn't NULL, because __do_page_fault checks for that lack of user<br />context..<br /><br />   There's also small areas in the scheduler where the current task<br />itself is kind of a gray area, and the CPU hasn't been switched to the<br />new cr3 yet, but those are all irq-off. They don't match your stack<br />trace anyway.<br /><br /> - we walk the page table directories without necessarily checking<br />that they are writable.  So maybe the PTE itself is writable, but the<br />PMD isn't. We do have read-only PMD's (see pmd_wrprotect). But that<br />*should* only trigger for hugepage entries. And again, your old error<br />code really said that the CPU thinks it is "not present".<br /><br /> - the whole NUMA protnone mess. That's what I suspected back then,<br />and I keep coming back to it. That's the code that makes the kernel<br />think that "pte_present is set", even though the CPU sees that the<br />actual PTE_PRESENT bit is clear.<br /><br />Ugh. I'd have loved for the VM_FAULT_RETRY thing to explain all your<br />problems, but it doesn't.<br /><br />                        Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
