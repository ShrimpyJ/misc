    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/12/14/338">First message in thread</a></li><li><a href="/lkml/2014/12/14/338">Frederic Weisbecker</a><ul><li><a href="/lkml/2014/12/14/339">Frederic Weisbecker</a></li><li><a href="/lkml/2014/12/14/340">Frederic Weisbecker</a><ul><li class="origin"><a href="/lkml/2014/12/15/572">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/15/572">Frederic Weisbecker</a><ul><li><a href="/lkml/2014/12/15/673">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 14 Dec 2014 18:46:27 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 2/2] sched: Pull resched loop to __schedule() callers</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Sun, Dec 14, 2014 at 6:24 PM, Frederic Weisbecker &lt;fweisbec&#64;gmail.com&gt; wrote:<br />&gt; -need_resched:<br />&gt;         preempt_disable();<br />&gt;         cpu = smp_processor_id();<br />&gt;         rq = cpu_rq(cpu);<br />&gt; &#64;&#64; -2821,8 +2824,6 &#64;&#64; need_resched:<br />&gt;         post_schedule(rq);<br />&gt;<br />&gt;         sched_preempt_enable_no_resched();<br />&gt; -       if (need_resched())<br />&gt; -               goto need_resched;<br /><br /><br />So my suggestion was to move the<br />"preempt_disable()/enable_no_resched()" into the callers too.<br /><br />Everybody already does that - except for "schedule()" itself. So that<br />would involve adding it here too:<br /><br />&gt; &#64;&#64; -2842,7 +2843,9 &#64;&#64; asmlinkage __visible void __sched schedule(void)<br />&gt;         struct task_struct *tsk = current;<br />&gt;<br />&gt;         sched_submit_work(tsk);<br />&gt; -       __schedule();<br />&gt; +       do {<br />preempt_disable();<br />&gt; +               __schedule();<br />sched_preempt_enable_no_resched();<br />&gt; +       } while (need_resched());<br />&gt;  }<br /><br />Hmm?<br /><br />That would mean that we have one less preempt update in the<br />__sched_preempt() cases. If somebody cares about the preempt counter<br />value, we'd have to increemnt the preempt count add values too, ie do<br /><br />    __preempt_count_add(PREEMPT_ACTIVE+1);<br /><br />there, but I'm not convicned anybody cares about the exact count.<br /><br />As it is, you end up doing the preempt count things twice in the<br />__sched_preempt() case: first the PREEMPT_ACTIVE count, and then the<br />count inside __schedule().<br /><br />Hmm?<br /><br />                     Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
