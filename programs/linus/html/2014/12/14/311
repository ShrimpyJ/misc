    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/11/14/656">First message in thread</a></li><li><a href="/lkml/2014/12/13/110">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/13/112">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/13/114">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/13/117">Al Viro</a><ul><li><a href="/lkml/2014/12/13/118">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2014/12/13/119">Al Viro</a></li></ul></li><li><a href="/lkml/2014/12/14/305">Dave Jones</a><ul><li class="origin"><a href="/lkml/2014/12/14/313">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/14/313">Dave Jones</a></li><li><a href="/lkml/2014/12/15/18">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/15/20">Dave Jones</a></li><li><a href="/lkml/2014/12/15/279">Borislav Petkov</a></li><li><a href="/lkml/2014/12/18/447">Andy Lutomirski</a></li></ul></li><li><a href="/lkml/2014/12/17/342">Dave Jones</a><ul><li><a href="/lkml/2014/12/17/365">Dave Jones</a></li><li><a href="/lkml/2014/12/17/374">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 14 Dec 2014 16:38:00 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: frequent lockups in 3.18rc4</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Sun, Dec 14, 2014 at 3:46 PM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt; On Sat, Dec 13, 2014 at 02:40:51PM -0800, Linus Torvalds wrote:<br />&gt;  &gt; On Sat, Dec 13, 2014 at 2:36 PM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt;  &gt; &gt;<br />&gt;  &gt; &gt; Ok, I think we can rule out preemption. I just checked on it, and<br />&gt;  &gt; &gt; found it wedged.<br />&gt;  &gt;<br />&gt;  &gt; Ok, one more. Mind checking what happens without CONFIG_DEBUG_PAGEALLOC?<br />&gt;<br />&gt; Crap. Looks like it wedged. It's stuck that way until I get back to it<br />&gt; on Wednesday.<br /><br />Hey, this is not "crap" at all. Quite the reverse. I think you may<br />have hit on the real bug now, and it's possible that the<br />DEBUG_PAGEALLOC code was hiding it because it was trying to handle the<br />page fault.<br /><br />Or something.<br /><br />Anyway, this time your backtrace is *interesting*. It's showing<br />something that looks real. Namely "save_xstate_sig" apparently taking<br />a page fault. And unlike your earlier traces, now all the different<br />CPU traces show very similar things, which again is something that<br />makes a lot more sense than your previous lockups have.<br /><br />That said, maybe I'm just being optimistic, because while the NMI<br />watchdog messages now look ostensibly much saner, I'm not actually<br />seeing what's really going on. But at least this time I *could*<br />imagine that it's something like infinitely taking a page fault in<br />save_xstate_sig. This is some pretty special code, with the whole FPU<br />save state handling  being one mess of random really subtle issues<br />with FPU exceptions, page faults, delayed allocation, yadda yadda.<br /><br />And I could fairly easily imagine endless page faults due to the<br />exception table, or even endless signal handling loops due to getting<br />a signal while trying to handle a signal. Both things that would<br />actually reasonably result in a watchdog.<br /><br />So I'm adding some x86 FPU save people to the cc.<br /><br />Can anybody make sense of that backtrace, keeping in mind that we're<br />looking for some kind of endless loop where we don't make progress?<br /><br />There's more in the original email (see on lkml if you haven't seen<br />the thread earlier already), but they look similar with that whole<br />do_signal -&gt; save_xstate_sig -&gt; do_page_fault thing just on other<br />CPU's.<br /><br />DaveJ, do you have the kernel image for this? I'd love to see what the<br />code is around that "save_xstate_sig+0x81" or around those<br />__clear_user+0x17/0x36 points...<br /><br />                          Linus<br /><br /><br />&gt; [ 6188.985536] NMI watchdog: BUG: soft lockup - CPU#1 stuck for 22s! [trinity-c175:14205]<br />&gt; [ 6188.985612] CPU: 1 PID: 14205 Comm: trinity-c175 Not tainted 3.18.0+ #103 [loadavg: 200.63 151.07 150.40 179/407 17316]<br />&gt; [ 6188.985652] task: ffff880056ac96d0 ti: ffff8800975d8000 task.ti: ffff8800975d8000<br />&gt; [ 6188.985680] RIP: 0010:[&lt;ffffffff810c6430&gt;]  [&lt;ffffffff810c6430&gt;] lock_release+0xc0/0x240<br />&gt; [ 6188.985988] Stack:<br />&gt; [ 6188.986101] Call Trace:<br />&gt; [ 6188.986116]  [&lt;ffffffff8116f928&gt;] __perf_sw_event+0x168/0x240<br />&gt; [ 6188.987079]  [&lt;ffffffff8116f842&gt;] ? __perf_sw_event+0x82/0x240<br />&gt; [ 6188.988045]  [&lt;ffffffff81178ab2&gt;] ? __lock_page_or_retry+0xb2/0xc0<br />&gt; [ 6188.989008]  [&lt;ffffffff811a68f8&gt;] ? handle_mm_fault+0x458/0xe90<br />&gt; [ 6188.989986]  [&lt;ffffffff8104250e&gt;] __do_page_fault+0x28e/0x5c0<br />&gt; [ 6188.990940]  [&lt;ffffffff813750de&gt;] ? trace_hardirqs_on_thunk+0x3a/0x3f<br />&gt; [ 6188.991884]  [&lt;ffffffff8107c25d&gt;] ? __do_softirq+0x1ed/0x310<br />&gt; [ 6188.992826]  [&lt;ffffffff817d09e0&gt;] ? retint_restore_args+0xe/0xe<br />&gt; [ 6188.993773]  [&lt;ffffffff8137511d&gt;] ? trace_hardirqs_off_thunk+0x3a/0x3c<br />&gt; [ 6188.994715]  [&lt;ffffffff8104284c&gt;] do_page_fault+0xc/0x10<br />&gt; [ 6188.995658]  [&lt;ffffffff817d1a32&gt;] page_fault+0x22/0x30<br />&gt; [ 6188.996590]  [&lt;ffffffff81375266&gt;] ? __clear_user+0x36/0x60<br />&gt; [ 6188.997518]  [&lt;ffffffff81375247&gt;] ? __clear_user+0x17/0x60<br />&gt; [ 6188.998440]  [&lt;ffffffff8100f3f1&gt;] save_xstate_sig+0x81/0x220<br />&gt; [ 6188.999362]  [&lt;ffffffff817cf1cf&gt;] ? _raw_spin_unlock_irqrestore+0x4f/0x60<br />&gt; [ 6189.000291]  [&lt;ffffffff810029e7&gt;] do_signal+0x5c7/0x740<br />&gt; [ 6189.001220]  [&lt;ffffffff81209acf&gt;] ? mnt_drop_write+0x2f/0x40<br />&gt; [ 6189.002164]  [&lt;ffffffff811e527e&gt;] ? chmod_common+0xfe/0x150<br />&gt; [ 6189.003096]  [&lt;ffffffff81002bc5&gt;] do_notify_resume+0x65/0x80<br />&gt; [ 6189.004038]  [&lt;ffffffff813750de&gt;] ? trace_hardirqs_on_thunk+0x3a/0x3f<br />&gt; [ 6189.004972]  [&lt;ffffffff817d00ff&gt;] int_signal+0x12/0x17<br />&gt; [ 6189.005899] Code: ff 0f 85 7c 00 00 00 4c 89 ea 4c 89 e6 48 89 df e8 26 fc ff ff 65 48 8b 04 25 00 aa 00 00 c7 80 6c 07 00 00 00 00 00 00 41 56 9d &lt;48&gt; 83 c4 08 5b 41 5c 41 5d 41 5e 41 5f 5d f3 c3 65 ff 04 25 e0<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
