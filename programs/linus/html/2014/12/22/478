    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/11/14/656">First message in thread</a></li><li><a href="/lkml/2014/12/22/392">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/22/400">Linus Torvalds</a></li><li><a href="/lkml/2014/12/22/459">Dave Jones</a><ul><li class="origin"><a href="/lkml/2014/12/23/266">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/23/266">Dave Jones</a><ul><li><a href="/lkml/2014/12/24/203">Sasha Levin</a></li></ul></li><li><a href="/lkml/2014/12/23/460">Dave Jones</a><ul><li><a href="/lkml/2014/12/26/140">Dave Jones</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2014/12/22/479">John Stultz</a><ul><li><a href="/lkml/2014/12/22/489">Linus Torvalds</a><ul><li><a href="/lkml/2014/12/28/103">"Paul E. McKenney"</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 22 Dec 2014 15:59:19 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: frequent lockups in 3.18rc4</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Dec 22, 2014 at 2:57 PM, Dave Jones &lt;davej&#64;codemonkey.org.uk&gt; wrote:<br />&gt;<br />&gt; I tried the nohpet thing for a few hours this morning and didn't see<br />&gt; anything weird, but it may have been that I just didn't run long enough.<br />&gt; When I saw your patch, I gave that a shot instead, with hpet enabled<br />&gt; again.  Just got back to find lots of messages in dmesg, but none<br />&gt; of the usual NMI/lockup messages.<br /><br />Hmm. So my patch is a bit sloppy, and I suspect that the sloppiness<br />may account for some - and quite probably all - of those numbers.<br /><br />Some of your numbers are pretty big (it's a 32-bit mask, so they are<br />all really just pretty small negative numbers), but they are still in<br />the 2us .. 165ms range when taking the 14MHz HPET counter into<br />account.  So not huge timer shifts.<br /><br />And the sloppiness of the patch is two-fold:<br /><br />One problem with my patch is that it does that "tkr-&gt;cycle_error"<br />without any locking (because it's running in various environmetns<br />where locking really doesn't work, and we can't even sanely disable<br />preemption because we might well be inside the scheduler etc.<br /><br />So this:<br /><br />          cycle_now = tkr-&gt;read(tkr-&gt;clock) + tkr-&gt;cycle_error;<br /><br />          /* calculate the delta since the last update_wall_time: */<br />          delta = clocksource_delta(cycle_now, tkr-&gt;cycle_last, tkr-&gt;mask);<br /><br />          /* Hmm? This is really not good, we're too close to overflowing */<br />          if (unlikely(delta &gt; (tkr-&gt;mask &gt;&gt; 3))) {<br />                  tkr-&gt;cycle_error = delta;<br />                 delta = 0;<br />          }<br /><br />might run concurrently on two CPU's, and then that tkr-&gt;cycle_error<br />access isn't serialized, so a "later" read of the HPET clock could end<br />up being written to tkr-&gt;cycle_error before. So that can account for<br />small errors: you'd have a "cycle_error" that gets updated on one CPU,<br />and then used to correct for an "earlier" read of the clock on another<br />CPU, and that could make the cycle error possibly worse.<br /><br />However, that first race only matters if you get errors to begin with,<br />so if that was the only race, it would still show that some real error<br />happened.<br /><br />BUT.<br /><br />The *bigger* problem is that since the reading side cannot hold any<br />locks at all, it can also race against the writing side. That's by<br />design, and we will use the sequence counter to recover from it and<br />try again, but it means that some of those small errors are just a<br />reader racing with the wall-time update code, and since this error<br />code is done _inside_ the read-sequence code, it's not aware of the<br />retry, and will give a false positive even if we then later on throw<br />the known-bad result out and re-try.<br /><br />So your small negative numbers are most likely just those false positives.<br /><br />I was more hoping to see some big sudden jumps on the order of your<br />20-second delays - the kinds of jumps that your "tsc unstable"<br />messages implied (which weren't in the 2us .. 165ms range, but in the<br />2s to 250s range)<br /><br />Ugh. I guess I'll have to try to figure out a non-sloppy thing, but<br />quite frankly, the non-sloppy things I tried first were rather painful<br />failures. The sloppy thing was sloppy, but worked well to see the<br />disaster case.<br /><br />I'll put on my thinking cap. Maybe I can move the "cycle_error" logic<br />to outside the sequence lock retry loop.<br /><br />But in the meantime please do keep that thing running as long as you<br />can. Let's see if we get bigger jumps. Or perhaps we'll get a negative<br />result - the original softlockup bug happening *without* any bigger<br />hpet jumps.<br /><br />                         Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
