    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/10/28/490">First message in thread</a></li><li><a href="/lkml/2014/10/28/490">Will Deacon</a><ul><li><a href="/lkml/2014/10/28/488">Will Deacon</a></li><li><a href="/lkml/2014/10/28/489">Will Deacon</a></li><li class="origin"><a href="">Linus Torvalds</a></li><li><a href="/lkml/2014/10/28/740">Linus Torvalds</a><ul><li><a href="/lkml/2014/10/28/781">Will Deacon</a><ul><li><a href="/lkml/2014/10/28/799">Linus Torvalds</a><ul><li><a href="/lkml/2014/10/28/840">Will Deacon</a></li><li><a href="/lkml/2014/10/28/1053">Benjamin Herrenschmidt</a></li></ul></li></ul></li><li><a href="/lkml/2014/10/28/1101">Linus Torvalds</a><ul><li><a href="/lkml/2014/10/29/751">Will Deacon</a><ul><li><a href="/lkml/2014/10/29/810">Linus Torvalds</a></li><li><a href="/lkml/2014/11/4/484">Catalin Marinas</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 28 Oct 2014 08:18:39 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [RFC PATCH 2/2] zap_pte_range: fix partial TLB flushing in response to a dirty pte</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Oct 28, 2014 at 4:44 AM, Will Deacon &lt;will.deacon&#64;arm.com&gt; wrote:<br />&gt; &#64;&#64; -1194,11 +1194,10 &#64;&#64; again:<br />&gt;                  * then update the range to be the remaining<br />&gt;                  * TLB range.<br />&gt;                  */<br />&gt; -               old_end = tlb-&gt;end;<br />&gt; -               tlb-&gt;end = addr;<br />&gt; +               tlb-&gt;end = old_end = min(tlb-&gt;end, addr);<br />&gt;                 tlb_flush_mmu_tlbonly(tlb);<br />&gt; -               tlb-&gt;start = addr;<br />&gt; -               tlb-&gt;end = old_end;<br />&gt; +               tlb-&gt;start = old_end;<br />&gt; +               tlb-&gt;end = end;<br /><br />I don't think this is right. Setting "tlb-&gt;end = end" looks very wrong<br />indeed, because "end" here inside zap_pte_range() is *not* the final<br />end of the zap range, it is just the end of the current set of pte's.<br /><br />There's a reason the old code *saved* the old end value. You've now<br />ripped that out, and use the "old_end" for something else entirely.<br /><br />Your arm64 version of tlb_add_flush() then hides the bug you just<br />introduced by updating the end range for each page you encounter. But<br />quite frankly, I think your problems are all fundamental to that very<br />issue. You're playing games with start/end during the TLB flush<br />itself, which is not how those things were designed to work.<br /><br />So now you break everything that *doesn't* do your arm games.<br /><br />                   Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
