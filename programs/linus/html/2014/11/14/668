    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/11/14/656">First message in thread</a></li><li><a href="/lkml/2014/11/14/656">Dave Jones</a><ul><li class="origin"><a href="/lkml/2014/11/14/692">Linus Torvalds</a><ul><li><a href="/lkml/2014/11/14/692">Dave Jones</a></li><li><a href="/lkml/2014/11/14/705">Thomas Gleixner</a><ul><li><a href="/lkml/2014/11/14/728">Dave Jones</a><ul><li><a href="/lkml/2014/11/14/747">Thomas Gleixner</a></li></ul></li><li><a href="/lkml/2014/11/14/767">Linus Torvalds</a><ul><li><a href="/lkml/2014/11/17/614">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2014/11/15/124">Dave Jones</a><ul><li><a href="/lkml/2014/11/15/160">Dave Jones</a><ul><li><a href="/lkml/2014/11/16/2">Linus Torvalds</a></li><li><a href="/lkml/2014/11/20/449">Frederic Weisbecker</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2014/11/17/409">Don Zickus</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 14 Nov 2014 14:01:27 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: frequent lockups in 3.18rc4</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Nov 14, 2014 at 1:31 PM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt; I'm not sure how long this goes back (3.17 was fine afair) but I'm<br />&gt; seeing these several times a day lately..<br /><br />Hmm. I don't see what would have changed in this area since v3.17.<br />There's a TLB range fix in mm/memory.c, but for the life of me I can't<br />see how that would possibly matter the way x86 does TLB flushing (if<br />the range fix does something bad and the range goes too large, x86<br />will just end up doing a full TLB invalidate instead).<br /><br />Plus, judging by the fact that there's a stale "leave_mm+0x210/0x210"<br />(wouldn't that be the *next* function, namely do_flush_tlb_all())<br />pointer on the stack, I suspect that whole range-flushing doesn't even<br />trigger, and we are flushing everything.<br /><br />But since you say "several times a day", just for fun, can you test<br />the follow-up patch to that one-liner fix that Will Deacon posted<br />today (Subject: "[PATCH] mmu_gather: move minimal range calculations<br />into generic code"). That does some further cleanup in this area.<br /><br />I don't see any changes to the x86 IPI or TLB flush handling, but<br />maybe I'm missing something, so I'm adding the x86 maintainers to the<br />cc.<br /><br />&gt; I've got a local hack to dump loadavg on traces, and as you can see in that<br />&gt; example, the machine was really busy, but we were at least making progress<br />&gt; before the trace spewed, and the machine rebooted. (I have reboot-on-lockup sysctl<br />&gt; set, without it, the machine just wedges indefinitely shortly after the spew).<br />&gt;<br />&gt; The trace doesn't really enlighten me as to what we should be doing<br />&gt; to prevent this though.<br />&gt;<br />&gt; ideas?<br /><br />I can't say I have any ideas except to point at the TLB range patch,<br />and quite frankly, I don't see how that would matter.<br /><br />If Will's patch doesn't make a difference, what about reverting that<br />ce9ec37bddb6? Although it really *is* a "obvious bugfix", and I really<br />don't see why any of this would be noticeable on x86 (it triggered<br />issues on ARM64, but that was because ARM64 cared much more about the<br />exact range).<br /><br />&gt; I can try to bisect it, but it takes hours before it happens,<br />&gt; so it might take days to complete, and the next few weeks are<br />&gt; complicated timewise..<br /><br />Hmm. Even narrowing it down a bit might help, ie if you could get say<br />four bisections in over a day, and see if that at least says "ok, it's<br />likely one of these pulls".<br /><br />But yeah, I can see it being painful, so maybe a quick check of the<br />TLB ones, even if I can't for the life see why they would possibly<br />matter.<br /><br />                 Linus<br /><br />---<br />&gt; NMI watchdog: BUG: soft lockup - CPU#3 stuck for 22s! [trinity-c129:25570]<br />&gt; irq event stamp: 74224<br />&gt; hardirqs last  enabled at (74223): [&lt;ffffffff9c875664&gt;] restore_args+0x0/0x30<br />&gt; hardirqs last disabled at (74224): [&lt;ffffffff9c8759aa&gt;] apic_timer_interrupt+0x6a/0x80<br />&gt; softirqs last  enabled at (74222): [&lt;ffffffff9c07f43a&gt;] __do_softirq+0x26a/0x6f0<br />&gt; softirqs last disabled at (74209): [&lt;ffffffff9c07fb4d&gt;] irq_exit+0x13d/0x170<br />&gt; CPU: 3 PID: 25570 Comm: trinity-c129 Not tainted 3.18.0-rc4+ #83 [loadavg: 198.04 186.66 181.58 24/442 26708]<br />&gt; RIP: 0010:[&lt;ffffffff9c11e98a&gt;]  [&lt;ffffffff9c11e98a&gt;] generic_exec_single+0xea/0x1d0<br />&gt; Call Trace:<br />&gt;  [&lt;ffffffff9c048b20&gt;] ? leave_mm+0x210/0x210<br />&gt;  [&lt;ffffffff9c048b20&gt;] ? leave_mm+0x210/0x210<br />&gt;  [&lt;ffffffff9c11ead6&gt;] smp_call_function_single+0x66/0x110<br />&gt;  [&lt;ffffffff9c048b20&gt;] ? leave_mm+0x210/0x210<br />&gt;  [&lt;ffffffff9c11f021&gt;] smp_call_function_many+0x2f1/0x390<br />&gt;  [&lt;ffffffff9c049300&gt;] flush_tlb_mm_range+0xe0/0x370<br />&gt;  [&lt;ffffffff9c1d95a2&gt;] tlb_flush_mmu_tlbonly+0x42/0x50<br />&gt;  [&lt;ffffffff9c1d9cb5&gt;] tlb_finish_mmu+0x45/0x50<br />&gt;  [&lt;ffffffff9c1daf59&gt;] zap_page_range_single+0x119/0x170<br />&gt;  [&lt;ffffffff9c1db140&gt;] unmap_mapping_range+0x140/0x1b0<br />&gt;  [&lt;ffffffff9c1c7edd&gt;] shmem_fallocate+0x43d/0x540<br />&gt;  [&lt;ffffffff9c223aba&gt;] do_fallocate+0x12a/0x1c0<br />&gt;  [&lt;ffffffff9c1f0bd3&gt;] SyS_madvise+0x3d3/0x890<br />&gt;  [&lt;ffffffff9c874c89&gt;] tracesys_phase2+0xd4/0xd9<br />&gt; Kernel panic - not syncing: softlockup: hung tasks<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
