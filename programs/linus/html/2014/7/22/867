    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/7/22/838">First message in thread</a></li><li><a href="/lkml/2014/7/22/838">Andy Lutomirski</a><ul><li class="origin"><a href="/lkml/2014/7/22/902">Linus Torvalds</a><ul><li><a href="/lkml/2014/7/22/902">Andy Lutomirski</a><ul><li><a href="/lkml/2014/7/23/210">Borislav Petkov</a><ul><li><a href="/lkml/2014/7/23/551">Andy Lutomirski</a></li></ul></li></ul></li><li><a href="/lkml/2014/7/23/186">Borislav Petkov</a></li></ul></li><li><a href="/lkml/2014/7/23/659">Andi Kleen</a><ul><li><a href="/lkml/2014/7/23/676">Andy Lutomirski</a><ul><li><a href="/lkml/2014/7/23/731">Andi Kleen</a><ul><li><a href="/lkml/2014/7/24/646">"H. Peter Anvin"</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 22 Jul 2014 18:03:35 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: STI architectural question (and lretq -- I'm not even kidding)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Jul 22, 2014 at 5:10 PM, Andy Lutomirski &lt;luto&#64;amacapital.net&gt; wrote:<br />&gt;<br />&gt; But here's the problem: what happens if an NMI or MCE happens between<br />&gt; the sti and the lretq?  I think an MCE just might be okay -- it's not<br />&gt; really recoverable anyway.  (Except for the absurd MCE broadcast crap,<br />&gt; which may cause this to be a problem.)  But what about an NMI between<br />&gt; sti and lretq?<br /><br />Sadly, it's not architected.<br /><br />The "mov ss" and "pop ss" do indeed suppress even NMI. And that *has*<br />to be true, because in legacy real mode - where there is no protection<br />domain change, and the "lss" instruction didn't originally exist - the<br />"pop/mov ss" and "mov sp" instruction sequence had to be entirely<br />atomic. And this is even very officially documented. From the intel<br />system manual:<br /><br />    "A POP SS instruction inhibits all interrupts, including the NMI<br />interrupt, until after execution of the next instruction. This action<br />allows sequential execution of POP SS and MOV ESP, EBP instructions<br />without the danger of having an invalid stack during an interrupt.<br />However, use of the LSS instruction is the preferred method of loading<br />the SS and ESP registers"<br /><br />However, while "sti" has conceptually the same one-instruction<br />interrupt window disable as mov/pop ss, it looks like Intel broke it<br />for NMI. The documentation only talks about "external, maskable<br />interrupts", and while I suspect *many* micro-architectures also end<br />up disabling NMI for the next instruction, there are many reasons to<br />think not all do.<br /><br />See for example<br /><br />    <a href="http://www.sandpile.org/x86/inter.htm">http://www.sandpile.org/x86/inter.htm</a><br /><br />and note #5 under external interrupt suppression.<br /><br />Now, sandpile is pretty old, but Christian Ludloff used to get things<br />like that right.<br /><br />So I'm afraid that "sti; lret" is not guaranteed to be architecturally<br />NMI-safe. But it *might* be safe on certain micro-architectures, and<br />maybe somebody inside Intel or AMD can give us a hint about when it is<br />safe and when it isn't.<br /><br />                Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
