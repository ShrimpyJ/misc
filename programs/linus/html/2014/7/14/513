    </div></td><td width="32"> </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2014/7/14/363">First message in thread</a></li><li><a href="/lkml/2014/7/14/363">=?utf-8?Q?Bj=C3=B8rn_Mork?=</a><ul><li><a href="/lkml/2014/7/14/329">Hans de Goede</a></li><li><a href="/lkml/2014/7/14/492">Linus Torvalds</a><ul><li class="origin"><a href="/lkml/2014/7/14/702">Linus Torvalds</a><ul><li><a href="/lkml/2014/7/14/702">=?utf-8?Q?Bj=C3=B8rn_Mork?=</a><ul><li><a href="/lkml/2014/7/14/700">Linus Torvalds</a></li><li><a href="/lkml/2014/7/14/749">=?utf-8?Q?Bj=C3=B8rn_Mork?=</a></li></ul></li></ul></li><li><a href="/lkml/2014/7/14/565">"Rafael J. Wysocki"</a></li><li><a href="/lkml/2014/7/15/63">Hans de Goede</a><ul><li><a href="/lkml/2014/7/15/78">=?utf-8?Q?Bj=C3=B8rn_Mork?=</a></li><li><a href="/lkml/2014/7/15/193">Hans de Goede</a></li></ul></li></ul></li><li><a href="/lkml/2014/7/14/879">=?utf-8?Q?Bj=C3=B8rn_Mork?=</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2014/7/14/513/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 14 Jul 2014 09:59:51 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [BISECTED 3.16-rc REGREGRESSION] backlight control stopped working</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Jul 14, 2014 at 9:24 AM, Linus Torvalds<br />&lt;torvalds&#64;linux-foundation.org&gt; wrote:<br />&gt;<br />&gt; Bjørn, what's your setup? Is this perhaps solvable some other way?<br /><br />For example, I wonder if we could fix the "dual brightness change"<br />problem automatically by making a new option for<br />'brightness_switch_enabled'.<br /><br />Currently, there are two cases:<br /><br /> - enabled: do the actual brightness change _and_ send the input<br />report keycode for a brightness change<br /><br /> - disabled: just send the keycode, excpecting the desktop software to<br />handle it.<br /><br />and maybe we could have a new case (and make *that* the default):<br /><br /> - delayed: send the keycode, and set up a delayed timer (say, one<br />tenth of a second) to do the actual brightness change. And if a<br />brightness change from user mode comes in during that delay, we cancel<br />the kernel-induced pending change.<br /><br />Something like the very hacky attached patch that is COMPLETELY UNTESTED.<br /><br />My point being that I think we can get this right *without* some<br />stupid "user has to specify the behavior of their desktop application<br />and ACPI implementation" crap. Especially since it's entirely possible<br />that there are different behaviors for the same machine (ie the user<br />session may act differently from the login screen, which will act<br />differently from the text virtual terminal).<br /><br />I really don't expect my patch to work as-is, it is really meant more<br />as an illustration of an approach that might work. There may well be<br />many other complications (ie how does this interact with the whole<br />"use_native_backlight" thing and user space possibly accessing *other*<br />backlight controls). But I have the feeling that this should be<br />solvable without breaking old setups or causing problems on newer<br />ones.<br /><br />                Linus<br /> drivers/acpi/video.c | 42 ++++++++++++++++++++++++++++++------------<br /> 1 file changed, 30 insertions(+), 12 deletions(-)<br /><br />diff --git a/drivers/acpi/video.c b/drivers/acpi/video.c<br />index 071c1dfb93f3..9c4afface8e7 100644<br />--- a/drivers/acpi/video.c<br />+++ b/drivers/acpi/video.c<br />&#64;&#64; -68,8 +68,8 &#64;&#64; MODULE_AUTHOR("Bruno Ducrot");<br /> MODULE_DESCRIPTION("ACPI Video Driver");<br /> MODULE_LICENSE("GPL");<br /> <br />-static bool brightness_switch_enabled;<br />-module_param(brightness_switch_enabled, bool, 0644);<br />+static int brightness_switch_enabled = -1;<br />+module_param(brightness_switch_enabled, int, 0644);<br /> <br /> /*<br />  * By default, we don't allow duplicate ACPI video bus devices<br />&#64;&#64; -270,11 +270,21 &#64;&#64; static int acpi_video_get_brightness(struct backlight_device *bd)<br /> 	return 0;<br /> }<br /> <br />+static u32 acpi_brightness_event;<br />+static struct acpi_video_device *acpi_brightness_device;<br />+static void acpi_video_set_brighness_delayed(struct work_struct *work)<br />+{<br />+	acpi_video_switch_brightness(acpi_brightness_device, acpi_brightness_event);<br />+}<br />+<br />+static DECLARE_DELAYED_WORK(acpi_brightness_work, acpi_video_set_brighness_delayed);<br />+<br /> static int acpi_video_set_brightness(struct backlight_device *bd)<br /> {<br /> 	int request_level = bd-&gt;props.brightness + 2;<br /> 	struct acpi_video_device *vd = bl_get_data(bd);<br /> <br />+	cancel_delayed_work(&amp;acpi_brightness_work);<br /> 	return acpi_video_device_lcd_set_level(vd,<br /> 				vd-&gt;brightness-&gt;levels[request_level]);<br /> }<br />&#64;&#64; -1601,6 +1611,19 &#64;&#64; static void acpi_video_bus_notify(struct acpi_device *device, u32 event)<br /> 	return;<br /> }<br /> <br />+static void brightness_switch_event(struct acpi_video_device *video_device, u32 event)<br />+{<br />+	if (!brightness_switch_enabled)<br />+		return;<br />+	if (brightness_switch_enabled &gt; 0) {<br />+		acpi_video_switch_brightness(video_device, event);<br />+		return;<br />+	}<br />+	acpi_brightness_device = video_device;<br />+	acpi_brightness_event = event;<br />+	schedule_delayed_work(&amp;acpi_brightness_work, HZ/10);<br />+}<br />+<br /> static void acpi_video_device_notify(acpi_handle handle, u32 event, void *data)<br /> {<br /> 	struct acpi_video_device *video_device = data;<br />&#64;&#64; -1618,28 +1641,23 &#64;&#64; static void acpi_video_device_notify(acpi_handle handle, u32 event, void *data)<br /> <br /> 	switch (event) {<br /> 	case ACPI_VIDEO_NOTIFY_CYCLE_BRIGHTNESS:	/* Cycle brightness */<br />-		if (brightness_switch_enabled)<br />-			acpi_video_switch_brightness(video_device, event);<br />+		brightness_switch_event(video_device, event);<br /> 		keycode = KEY_BRIGHTNESS_CYCLE;<br /> 		break;<br /> 	case ACPI_VIDEO_NOTIFY_INC_BRIGHTNESS:	/* Increase brightness */<br />-		if (brightness_switch_enabled)<br />-			acpi_video_switch_brightness(video_device, event);<br />+		brightness_switch_event(video_device, event);<br /> 		keycode = KEY_BRIGHTNESSUP;<br /> 		break;<br /> 	case ACPI_VIDEO_NOTIFY_DEC_BRIGHTNESS:	/* Decrease brightness */<br />-		if (brightness_switch_enabled)<br />-			acpi_video_switch_brightness(video_device, event);<br />+		brightness_switch_event(video_device, event);<br /> 		keycode = KEY_BRIGHTNESSDOWN;<br /> 		break;<br /> 	case ACPI_VIDEO_NOTIFY_ZERO_BRIGHTNESS:	/* zero brightness */<br />-		if (brightness_switch_enabled)<br />-			acpi_video_switch_brightness(video_device, event);<br />+		brightness_switch_event(video_device, event);<br /> 		keycode = KEY_BRIGHTNESS_ZERO;<br /> 		break;<br /> 	case ACPI_VIDEO_NOTIFY_DISPLAY_OFF:	/* display device off */<br />-		if (brightness_switch_enabled)<br />-			acpi_video_switch_brightness(video_device, event);<br />+		brightness_switch_event(video_device, event);<br /> 		keycode = KEY_DISPLAY_OFF;<br /> 		break;<br /> 	default:</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
