    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/1996/7/11/14">First message in thread</a></li><li><a href="/lkml/1996/7/11/44">Linus Torvalds</a><ul><li><a href="/lkml/1996/7/12/49">Matthias Urlichs</a></li><li><a href="/lkml/1996/7/13/5">Scott Street</a><ul><li class="origin"><a href="/lkml/1996/7/14/50">Linus Torvalds</a><ul><li><a href="/lkml/1996/7/14/50">Bryn Paul Arnold Jones</a></li><li><a href="/lkml/1996/7/15/23">(Thomas Schoebel-Theuer)</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 13 Jul 1996 11:57:34 +0300 (EET DST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: NFS still has caching problem</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 11 Jul 1996, Scott Street wrote:<br />&gt; <br />&gt;   Why did this check fail anyway?  If (I'm looking at 2.0.0 src) linux <br />&gt; checks the last modified date and the size (from what I can tell in <br />&gt; file.c revalidate_inode(), why didn't the cache update?  The date <br />&gt; should have changed for the "new" copy of the file.  <br />&gt; Of course the silly answer is the date didn't change, but then isn't that <br />&gt; a "feature" of the NFS server?<br /><br />Note that the "mtime" field is only tested when the NFS cache times out, <br />because we don't want to invalidate the cache when we write to the file<br />ourselves (*). The _size_ is checked a lot more often, because we can <br />always compare the size of the local file and the size on the server.<br /><br />(*) We can't compare local mtime and server mtime for the simple reason <br />that they are different things - local and server time need not be <br />synchronized at all. Trying to make any decisions based on local and <br />server times leads to all kinds of problems, including _never_ timing <br />out the cache (very bad indeed), or timing out for no reason.<br /><br />If you take a look at how Linux NFS checks the "mtime", you'll notice <br />that it never checks the local mtime against the server-reported mtime; <br />"revalidate_inode()" checks the NFS_OLDMTIME against the server-reported <br />mtime (and NFS_OLDMTIME is in "server time" rather than "local time").<br /><br />In short, checking sizes is easy, because we have to agree on sizes (or there<br />is a cache problem and we should invalidate). Checking "mode" is ok too, for<br />the same reason. But checking "mtime" is hard do the the server and the<br />client having different clocks (this is the normal distributed processing<br />problem - the time skew between operations). <br /><br />I'm not saying that the current behaviour can't be improved upon: we sure <br />could improve some of the heuristics. But the patches I've seen so far <br />aren't "it". Take a deep thought about the implications of time skew <br />between the different parties wrt NFS (one implication is that even <br />though the file changed due to _us_ doing the writing, we can't know from <br />the mtime)<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
