    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/1996/4/27/78">First message in thread</a></li><li><a href="/lkml/1996/4/27/78">"Ulrich Windl"</a><ul><li class="origin"><a href="">Linus Torvalds</a></li><li><a href="/lkml/1996/4/28/153">Molnar Ingo</a><ul><li><a href="/lkml/1996/4/29/77">Ingo Molnar</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 26 Apr 1996 14:43:40 +0300 (EET DST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: do_fast_gettimeoffset(void) buggy?</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Fri, 26 Apr 1996, Ulrich Windl wrote:<br />&gt; <br />&gt; I have a question about the routine below. The routine is a Pentium <br />&gt; specific microtime() routine. I'm afraid it is not correct. See my <br />&gt; "???" tag at the beginning of a line. If someone can tell me, if I'm <br />&gt; wrong, I'd like to hear it!<br /><br />I think you're wrong, but feel free to double-check..<br /><br />&gt; 	/* .. relative to previous jiffy (32 bits is enough) */<br />&gt; 	time_low -= (unsigned long) last_timer_cc;<br />&gt; ??? We have two 64 bit quantities, and we are interested in the least <br />&gt; ??? significant 32 bit. Currently just the "low longwords" are <br />&gt; ??? subtracted, yielding a possible overflow (result in unsigned).<br />&gt; ??? Usually you would need some carry processing.<br /><br />Carry makes a difference only for the high 32 bits, and as we're going to <br />ignore the high bits in the result anyway, we don't care. Essentially, <br />what we're doing is a 64-bit subtract, and then extracting the low bits, <br />so the expression we're looking for is actually<br /><br />	(t2 - t1) mod 2^32<br /><br />but that is mathematically equivalent to what we're doing:<br /><br />	((t2 mod 2^32) - (t1 mod 2^32)) mod 2^32<br /><br />Remember, C defines unsigned integer arithmetic to work this way <br />(although the "32" part is implementation defined), so we're not even <br />depending on any special behaviour here - this is just how the addition <br />operator works in C.<br /><br />I guess anybody who wants to be _really_ sure needs to take a course<br />in algebra, and think about what the operator "+" really means in different <br />circumstances. <br /><br />Btw, linux depends on this property of unsigned arithmetic in C in other <br />places too - take a look at the "before()" and "after()" functions that <br />define the incomplete order of TCP sequence numbers in the same "modulus<br />2^32" mathematical world ;-)<br /><br />&gt; 	if (quotient &gt;= 1000000/HZ)<br />&gt; 		quotient = 1000000/HZ-1;<br />&gt; <br />&gt; ??? Is this the correction for the missed carry?<br /><br />No, that's just correcting for the fact that the way we do calculations <br />we can't really depend on everything being exact: if we have lost a few <br />timer ticks along the way we should make sure that we don't let the <br />"correction factor" grow too large (otherwise we might end up with a <br />struct timeval that is not monotonically growing after the next timer <br />tick).<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
