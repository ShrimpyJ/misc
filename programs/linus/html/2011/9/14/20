    </div></td><td width="32"> </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2011/9/13/311">First message in thread</a></li><li><a href="/lkml/2011/9/13/311">Eric Dumazet</a><ul><li><a href="/lkml/2011/9/13/404">Andrew Morton</a><ul><li><a href="/lkml/2011/9/13/409">Eric Dumazet</a></li><li><a href="/lkml/2011/9/13/414">Lin Ming</a><ul><li><a href="/lkml/2011/9/15/90">Pawel Sikora</a><ul><li><a href="/lkml/2011/9/15/96">Justin Piszcz</a></li></ul></li></ul></li></ul></li><li class="origin"><a href="/lkml/2011/9/14/24">Linus Torvalds</a><ul><li><a href="/lkml/2011/9/14/24">Eric Dumazet</a><ul><li><a href="/lkml/2011/9/14/36">Shaohua Li</a><ul><li><a href="/lkml/2011/9/14/44">Shaohua Li</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2011/9/14/21">Linus Torvalds</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 13 Sep 2011 23:48:13 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [BUG] infinite loop in find_get_pages()</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">Re-sending, because apparently none of my email in the last few days<br />have actually gone out due to LF problems..<br /><br />                       Linus<br /><br />On Tue, Sep 13, 2011 at 12:48 PM, Linus Torvalds<br />&lt;torvalds&#64;linux-foundation.org&gt; wrote:<br />&gt; On Tue, Sep 13, 2011 at 12:23 PM, Eric Dumazet &lt;eric.dumazet&#64;gmail.com&gt; wrote:<br />&gt;&gt;<br />&gt;&gt; It seems current kernels (3.1.0-rc6) are really unreliable, or maybe I<br />&gt;&gt; expect too much from them.<br />&gt;<br />&gt; No, by now, they should be damn well reliable.<br />&gt;<br />&gt;&gt; On my 4GB x86_64 machine (2 quad-core cpus, 2 threads per core), I can<br />&gt;&gt; have a cpu locked in<br />&gt;&gt;<br />&gt;&gt;  find_get_pages -&gt; radix_tree_gang_lookup_slot -&gt; __lookup<br />&gt;<br />&gt; Hmm. There hasn't been many changes in this area, so the few changes<br />&gt; that *do* exist are obviously very suspicious.<br />&gt;<br />&gt; In particular, the only real change to that whole setup is the changes<br />&gt; by Hugh to make the swap entries use the radix tree. So I'm bringing<br />&gt; Hugh and Andrew to the discussion (and Rik, since he acked a few of<br />&gt; those changes).<br />&gt;<br />&gt; The fact that some light swapping activity seems to accompany the<br />&gt; problem just makes me more certain it's Hugh's swap/radix tree work.<br />&gt;<br />&gt; We're talking only a handful of patches, so maybe Hugh could create a<br />&gt; revert patch just to confirm that yes, that's the problem.<br />&gt;<br />&gt; Hugh?<br />&gt;<br />&gt;                      Linus<br />&gt;<br />&gt; --- quoting the rest of the email for Hugh/Andrew ---<br />&gt;&gt; Problem is : A bisection will be very hard, since a lot of kernels<br />&gt;&gt; simply destroy my disk (the PCI MRRS horror stuff).<br />&gt;&gt;<br />&gt;&gt; Messages at console :<br />&gt;&gt;<br />&gt;&gt; INFO: rcu_preempt_state detected stalls on CPUs/tasks: {} (detected by<br />&gt;&gt; 11 t=60002 jiffies)<br />&gt;&gt;<br />&gt;&gt; perf top -C 1<br />&gt;&gt;<br />&gt;&gt; Events: 3K cycles<br />&gt;&gt; +     43,08%  bash  [kernel.kallsyms]  [k] __lookup<br />&gt;&gt; +     41,51%  bash  [kernel.kallsyms]  [k] find_get_pages<br />&gt;&gt; +     15,31%  bash  [kernel.kallsyms]  [k] radix_tree_gang_lookup_slot<br />&gt;&gt;<br />&gt;&gt;    43.08%     bash  [kernel.kallsyms]  [k] __lookup<br />&gt;&gt;               |<br />&gt;&gt;               --- __lookup<br />&gt;&gt;                  |<br />&gt;&gt;                  |--97.09%-- radix_tree_gang_lookup_slot<br />&gt;&gt;                  |          find_get_pages<br />&gt;&gt;                  |          pagevec_lookup<br />&gt;&gt;                  |          invalidate_mapping_pages<br />&gt;&gt;                  |          drop_pagecache_sb<br />&gt;&gt;                  |          iterate_supers<br />&gt;&gt;                  |          drop_caches_sysctl_handler<br />&gt;&gt;                  |          proc_sys_call_handler.isra.3<br />&gt;&gt;                  |          proc_sys_write<br />&gt;&gt;                  |          vfs_write<br />&gt;&gt;                  |          sys_write<br />&gt;&gt;                  |          system_call_fastpath<br />&gt;&gt;                  |          __write<br />&gt;&gt;                  |<br />&gt;&gt;<br />&gt;&gt;<br />&gt;&gt; Steps to reproduce :<br />&gt;&gt;<br />&gt;&gt; In one terminal, kernel builds in a loop (defconfig + hpsa driver)<br />&gt;&gt;<br />&gt;&gt; cd /usr/src/linux<br />&gt;&gt; while :<br />&gt;&gt; do<br />&gt;&gt;  make clean<br />&gt;&gt;  make -j128<br />&gt;&gt; done<br />&gt;&gt;<br />&gt;&gt;<br />&gt;&gt; In another term :<br />&gt;&gt;<br />&gt;&gt; while :<br />&gt;&gt; do<br />&gt;&gt;  echo 3 &gt;/proc/sys/vm/drop_caches<br />&gt;&gt;  sleep 20<br />&gt;&gt; done<br />&gt;&gt;<br />&gt;&gt;<br />&gt;&gt; Before the lock, I can see in another terminal some swapping activity.<br />&gt;&gt;<br />&gt;&gt; $ vmstat 1<br />&gt;&gt; procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----<br />&gt;&gt;  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa<br />&gt;&gt;  2  2  17728 3443924  11520 328020    0    0   256 12076 16250  554  0  6 82 12<br />&gt;&gt;  1  1  17728 3444776  11584 328072    0    0   100  2868 16223  267  0  6 86  7<br />&gt;&gt;  1  1  17728 3442200  12100 328348    0    0   868     0 16600 1778  0  7 88  6<br />&gt;&gt;  1  1  17728 3438032  13036 329048    0    0  1628     0 16862 2480  0  7 87  5<br />&gt;&gt;  1  1  17728 3546864  13988 220256    0    0  1000     0 16313  931  0  7 87  6<br />&gt;&gt;  1  1  17728 3544260  16024 220256    0    0  2036     0 16513 1531  0  6 88  6<br />&gt;&gt;  1  1  17728 3542896  17196 220256    0    0  1160   556 16324  893  0  6 88  6<br />&gt;&gt;  1  1  17728 3540748  18756 220256    0    0  1560     0 16398 1172  0  6 88  6<br />&gt;&gt;  1  1  17728 3538692  20168 220256    0    0  1412     0 16544 1088  0  6 88  6<br />&gt;&gt;  2  0  17728 3536676  21816 220248    0    0  1648     0 16447 1246  0  6 88  6<br />&gt;&gt;  1  1  17728 3535052  22544 220256    0    0   728     0 16215  605  1  6 87  5<br />&gt;&gt;  1  1  17728 3533672  23404 220244    0    0   860  4240 16264  705  0  6 88  6<br />&gt;&gt;  1  1  17728 3532688  24232 220244    0    0   828     0 16272  685  0  6 87  6<br />&gt;&gt;  1  1  17728 3531552  25080 220244    0    0   848     0 16294  700  0  6 88  6<br />&gt;&gt;  1  1  17728 3529584  26532 220256    0    0  1452     0 16376 1104  0  6 87  6<br />&gt;&gt;  1  2  17728 3545232  27848 199176    0    0  1312    52 16392  911  0  7 85  8<br />&gt;&gt;  1  2  17728 3659060  29576  84420    0    0  1736    40 16570  959  0  7 81 12<br />&gt;&gt; 38  3  17728 3640652  29984  69976    0    0   688     0 16885 2987  3  8 80  9<br />&gt;&gt;  5  2  17728 3601716  30208  75628    0    0  4676     4 18080 5727 11 10 66 12<br />&gt;&gt; procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----<br />&gt;&gt;  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa<br />&gt;&gt; 103 27  17728 2286372  30376  78952    0    0  3044     8 17772 6803 49 16 34  1<br />&gt;&gt; 128  1  17728 1337588  30416  79952    0    0   732  4080 16389 4874 91  9  0  0<br />&gt;&gt; 122  7  17728 730264  30472  81056    0    0   540  1300 16535 5451 91  9  0  0<br />&gt;&gt; 99 16  17728 996308  30544  83136    0    0   492   452 16951 6629 92  8  0  0<br />&gt;&gt; 89 23  17728 1150640  30592  88288    0    0  3232   224 17286 7312 91  9  0  0<br />&gt;&gt; 114  7  17728 1344768  30660  92104    0    0  1668   228 17395 7297 89 11  0  0<br />&gt;&gt; 99  3  17728 848716  30696  93684    0    0   688  2072 16947 6368 92  8  0  0<br />&gt;&gt; 112  9  17728 609908  30748  96036    0    0   620   272 17221 7640 90 10  0  0<br />&gt;&gt; 111  8  17728 480244  30808  98268    0    0   788   320 17227 7391 92  8  0  0<br />&gt;&gt; 115  7  17728 549564  30852 100552    0    0   656   232 17583 7807 92  9  0  0<br />&gt;&gt; 107  9  17728 666776  30888 102904    0    0   716     0 17406 7781 91  9  0  0<br />&gt;&gt; 124  5  17728 685368  30960 105544    0    0  1056   944 17281 7713 90 10  0  0<br />&gt;&gt; 130  1  17728 538832  31000 108080    0    0   776     0 16943 7347 91  9  0  0<br />&gt;&gt; 130  0  17728 364476  31032 110252    0    0   676     0 16767 6948 91  9  0  0<br />&gt;&gt; 129  0  17728 149332  31064 111848    0    0   540    32 16673 6272 92  8  0  0<br />&gt;&gt; 129  0  17728 274664  31096 114052    0    0   628     0 17207 7694 92  8  0  0<br />&gt;&gt; 128  3  17728 589736  31160 117420    0    0   816   996 17381 8443 90 10  0  0<br />&gt;&gt; 126  5  17728 485300  31172 119544    0    0   416     0 17024 7186 91  9  0  0<br />&gt;&gt; 130  0  17728 349500  31216 122344    0    0   492     0 17046 7358 91  9  0  0<br />&gt;&gt; procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----<br />&gt;&gt;  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa<br />&gt;&gt; 130  2  17728 416972  31248 125404    0    0   496   120 17112 7124 91  9  0  0<br />&gt;&gt; 125  5  17308 188608  29444 106888    0  576  1436   612 40020 9430 91  8  0  0<br />&gt;&gt; 113 16  17308 218700  29528 110336   32    0  1908     0 17210 7214 92  8  0  0<br />&gt;&gt;  1 145  20292  15688  26884 108200   40 3020   188  4660 27003 3664 30  7  0 63<br />&gt;&gt;  1 145  21128  15920  24212 107420    0  836     0  3824 16813  430  1  6  0 93<br />&gt;&gt;  2 144  22904  16020  20780 106780    0 1776     0  6548 16611  505  1  6  0 93<br />&gt;&gt;  1 146  23496  15788  17476 106160   32  596    60  3620 16610  308  1  6  0 93<br />&gt;&gt;  1 147  23924  16216  16028 105852   32  432    32  5012 16477  156  0  6  0 93<br />&gt;&gt;  1 145  24428  15904  14744 103452   20  504    20  3112 16776  125  1  6  0 93<br />&gt;&gt;  1 146  25304  16184  14688  97712    0  876    16  3352 16759  447  2  6  0 92<br />&gt;&gt;  1 147  26984  15908  14588  88348   96 1680    96  6352 17006  235  1  6  0 93<br />&gt;&gt;  1 146  28724  16112  14152  77132   32 1740    44  3536 16739  375  2  6  0 92<br />&gt;&gt;  1 151  29900  15896  12072  68484  156 1184   192  2068 16860  576  2  6  0 91<br />&gt;&gt;  2 152  33724  33908   9536  58616  184 3856   512  6764 16536  492  2  6  3 88<br />&gt;&gt;  1 142  33276 427352   8964  58988 1096  120  2624   120 16730 1129  6  7  8 79<br />&gt;&gt;  2 142  33000 421512   8988  60944 1560    0  3512     0 16771 1220  1  6  9 84<br />&gt;&gt;  2 143  32604 392952   9012  62308 1176    0  2436     0 16690 1173  2  7 10 82<br />&gt;&gt;  8 134  32400 255348   9044  64696  688    0  2584     0 17105 2181 16  8 14 62<br />&gt;&gt;  6 136  31796 142068   9092  66024 1060    0  1828     0 17040 2226 37 10 12 41<br />&gt;&gt; procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----<br />&gt;&gt;  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa<br />&gt;&gt;  2 143  31664  15844   9152  67452  580   64  1324   292 16973 2066 37 10 11 43<br />&gt;&gt;  4 141  31876  56160   9052  67528   48  328   140  1724 16476  696  6  7  0 87<br />&gt;&gt;  4 141  32420 176260   8896  68808  108  732   760  2280 17449 3081 24  9  0 67<br />&gt;&gt; 11 134  32540 119868   8484  70568  108  852  1140  1408 17436 3788 45 12  1 43<br />&gt;&gt; 17 129  32880  57044   8256  73008    0  364  1212   364 17489 4000 59 13  0 28<br />&gt;&gt; 11 135  33468 107128   7660  73124  200 1044   888  2076 17043 1956 23  9  0 69<br />&gt;&gt;  1 144  34788  16076   6948  71572  180 1524   276  1908 16787  967 13  7  0 79<br />&gt;&gt;  1 145  35472  16188   5868  70348  112  768   120  1284 16696  561  1  6  0 93<br />&gt;&gt;  1 145  36056  16696   5492  68240   16  596    16  3356 16456  202  0  6  0 93<br />&gt;&gt;  1 143  38200  15952   3168  63968   32 2168    52  6460 16834  423  1  7  0 92<br />&gt;&gt;  9 131  40128 139084   3064  61060  172 2144   644  2192 17701 2250 19  9  0 72<br />&gt;&gt;  9 133  40548 110308   3092  60492  468  620   900  1852 17516 1983 35  9  0 55<br />&gt;&gt; 10 132  40448  79476   3132  61808 1020    0  1480     0 17505 3254 35 10  0 55<br />&gt;&gt; 12 132  40532 139396   3156  63204  776  260  1272   892 17457 3179 44 11  0 45<br />&gt;&gt; 11 132  40392  66336   3256  65264  788    0  1536     0 17551 3860 46 11  0 43<br />&gt;&gt;  1 142  41112  15796   3296  65680 1176  812  1636  2568 17026 1798 28  9  0 63<br />&gt;&gt;  1 140  41500  15960   3244  64828   92  472   116  4008 16445  443  4  7  0 90<br />&gt;&gt;  1 140  42252  16740   3232  64356    0  764     0  1500 16403  185  0  6  0 94<br />&gt;&gt;  1 139  49636  16024   2928  60652   52 7376    52  7376 17507 1236  0  7  0 93<br />&gt;&gt; procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----<br />&gt;&gt;  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa<br />&gt;&gt;  2 140  55780  16444   2548  55948  176 6200   332  6260 17160  592  1  7  0 92<br />&gt;&gt;  3 145  59800 358088   2404  55468  100 4108  1092  4132 18514 3864 17  8  0 75<br />&gt;&gt;  3 143  60712  27028   2416  57184  816  964  2392  1288 18089 3476 43 10  0 47<br />&gt;&gt;  4 141  61296 154136   2516  58024  424  980  1312   980 17298 2489 28  9  0 62<br />&gt;&gt; 21 122  62544  83120   2528  58372  100 1456   788  1456 17717 2738 64 12  0 24<br />&gt;&gt; 24 120  62780  53328   2580  62216   16  292  2528   292 17163 4076 85 14  0  1<br />&gt;&gt;  1 143  65088  16096   2492  61524  152 2708   764  2712 16734 1474 16  8  0 76<br />&gt;&gt;  3 141  65672  34232   2476  60536   56  672   240  3208 16726  661  4  7  0 89<br />&gt;&gt;  1 144  65584  16044   2488  60440  808   68   948  1532 17187 1353 10  8  0 82<br />&gt;&gt;  4 141  70836  17216   2444  58024   64 5272    64  6968 16957  437  0  6  0 93<br />&gt;&gt;  6 134  73728  31940   2424  56880  436 3092   748  3188 16950 1269  8  7  0 85<br />&gt;&gt;  2 139  76036 107996   2408  56404   92 2420   476  2784 16869  690  6  7  0 87<br />&gt;&gt;  6 135  76112  82792   2436  57884 1108  476  1632   724 16999 1711 18  8  0 73<br />&gt;&gt;  1 139  77184  17872   2444  57860  996 1084  1168  2320 16644  748 11  8  0 81<br />&gt;&gt;  1 141  91136  15952   2300  51868  100 14088   128 14152 17494 1284  1  7  5 87<br />&gt;&gt;  1 143  98356 204144   2256  48168  640 7496  1148  7580 17471 1840  6  7 12 74<br />&gt;&gt;  3 139  97344 174272   2276  48968 2636    0  3216     0 16962 1499 13  8 11 69<br />&gt;&gt;  9 133  97220 123464   2352  50584 1348    0  2320   500 17100 2255 27  9  8 56<br />&gt;&gt;  9 134  97092  33672   2396  51780 1292  108  2028   108 16821 1547 27  8  8 57<br />&gt;&gt; procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----<br />&gt;&gt;  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa<br />&gt;&gt; 11 134  95068  75744   2448  53444  852    0  1696     0 17318 2630 34 10  2 54<br />&gt;&gt;  1 143  95104  15972   2504  54544  116   44   696    44 16545 1209 20  8  5 67<br />&gt;&gt; ^C<br />&gt;&gt;<br />&gt;&gt;<br />&gt;&gt;<br />&gt;&gt;<br />&gt;<br />--<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
