    </div></td><td width="32"> </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2011/12/11/120">First message in thread</a></li><li><a href="/lkml/2011/12/20/74">"Liu, Jinsong"</a><ul><li><a href="/lkml/2011/12/20/85">Avi Kivity</a></li><li><a href="/lkml/2011/12/20/86">Alexey Zaytsev</a><ul><li class="origin"><a href="/lkml/2011/12/20/283">Linus Torvalds</a><ul><li><a href="/lkml/2011/12/20/283">"Liu, Jinsong"</a><ul><li><a href="/lkml/2011/12/20/302">Alexey Zaytsev</a></li><li><a href="/lkml/2011/12/21/76">Avi Kivity</a></li></ul></li><li><a href="/lkml/2011/12/20/358">Jan Kiszka</a><ul><li><a href="/lkml/2011/12/21/93">Jan Kiszka</a></li></ul></li></ul></li><li><a href="/lkml/2011/12/20/262">"Liu, Jinsong"</a><ul><li><a href="/lkml/2011/12/21/77">Avi Kivity</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 20 Dec 2011 10:58:41 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [Regression, bisected] a3e06bbe8445f57eb949e6474c5a9b30f24d2057: KVM: emulate lapic tsc deadline timer for guest"</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Dec 20, 2011 at 1:51 AM, Alexey Zaytsev<br />&lt;alexey.zaytsev&#64;gmail.com&gt; wrote:<br />&gt;<br />&gt; Let me clarify the situation.<br />&gt;<br />&gt; Before this commit, the tsc was advertised in cpuid, and it was<br />&gt; handled, if I understand things correctly, by qemu.<br />&gt; After this commit, the tsc is advertised in cpuid, and is handled in<br />&gt; the kernel, but only after qemu issues KVM_CREATE_IRQCHIP. If it does<br />&gt; not issue the ioctl, the kernel just discards any wrmsrs done to the<br />&gt; tsc. This does not look like an Illumos problem to me. Linux guests<br />&gt; kind of work here, because they are  prepared to work on utterly<br />&gt; broken hardware. Good for you, but please don't break less-prepared<br />&gt; guests.<br /><br />Yes. This is a regression, and needs to be fixed.<br /><br />Liu, if you don't have time to debug it, we'll just revert the commit.<br />It's that easy. Regressions are not allowed. There are no excuses.<br /><br />In particular, saying "just wait for qemu-kvm" is not an acceptable<br />answer, because the point is that things *used* to work, and they<br />broke. No "change it to work with the new kernel" allowed, except for<br />some *very* rare critical circumstances (usually "major security-bug<br />that we had to fix, and people who relied on it are thus out of<br />luck").<br /><br />Commit a3e06bbe8445 still seems to revert cleanly, so that is the easy option.<br /><br />That said, it sounds like maybe another solution is to start with the<br />TSC_DEADLINE timer bit in cpuid cleared, and only setting it after the<br />KVM_CREATE_IRQCHIP ioctl.<br /><br />In fact, the patch is clearly buggy, in that it apparently doesn't<br />emulate TSC_DEADLINE correctly and natively on its own.<br /><br />Jan, Marcelo, Avi - is there a quick fix, or should I just revert?<br /><br />And please don't *EVER* tell people that they should just work around<br />regressions. Regressions are absolutely unacceptable. Kernel people<br />need to understand that.<br /><br />                   Linus<br />--<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
