    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2011/12/30/82">First message in thread</a></li><li><a href="/lkml/2011/12/30/82">Dave Jones</a><ul><li class="origin"><a href="/lkml/2011/12/30/90">Linus Torvalds</a><ul><li><a href="/lkml/2011/12/30/90">Matthew Garrett</a><ul><li><a href="/lkml/2011/12/31/25">Alan Stern</a><ul><li><a href="/lkml/2011/12/31/26">Oliver Neukum</a></li><li><a href="/lkml/2011/12/31/27">Matthew Garrett</a></li></ul></li></ul></li><li><a href="/lkml/2011/12/31/30">Marek Vasut</a><ul><li><a href="/lkml/2012/1/1/11">Oliver Neukum</a><ul><li><a href="/lkml/2012/1/1/12">Marek Vasut</a></li></ul></li></ul></li><li><a href="/lkml/2011/12/31/42">Larry Finger</a></li><li><a href="/lkml/2012/1/1/67">Jack Stone</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 30 Dec 2011 16:22:06 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: loading firmware while usermodehelper disabled.</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Dec 30, 2011 at 3:54 PM, Dave Jones &lt;davej&#64;redhat.com&gt; wrote:<br />&gt; We're getting a bunch of reports against Fedora 16<br />&gt; (still using 3.1) which look like some drivers are trying to<br />&gt; load firmware on resume from suspend, while usermodehelper<br />&gt; is disabled.<br /><br />Ok, buggy drivers. You *must*not* load firmware in your resume path,<br />since there is no actual guarantee that any particular device will be<br />resumed after the disk that contains the firmware images.<br /><br />So it's very simple: drivers that load firmware at resume time are<br />buggy. No ifs, buts, or maybes about it.<br /><br />&gt; Here are some example traces:<br />&gt;<br />&gt; <a href="https://bugzilla.redhat.com/show_bug.cgi?id=746411">https://bugzilla.redhat.com/show_bug.cgi?id=746411</a><br /><br />It's isight_firmware_load(), in the isight_firmware driver. The driver<br />doesn't actually do anything but load the firmware, and is apparently<br />not very good at that either.<br /><br />It should either fake a disconnect and reconnect of the device (and<br />let the reconnect then load the firmware through udev or something) or<br />it should just save the firmware image in memory from the original<br />load, and make the resume just re-initialize it - not load it.<br /><br />It's also possible that it could be considered a USB layer bug, and<br />the USB layer should just not rebind the devices directly in the<br />resume function, but do it somehow later. HOWEVER, that would only<br />work for "random" USB devices that aren't in use by user space (like<br />disks etc might be). So I think that in general the real solution is<br />always just "make sure that the firmware is in memory before the<br />suspend even happens".<br /><br />Greg - has the USB resume logic been changed lately?<br /><br />Matthew? Any comments about that particular driver?<br /><br />&gt; <a href="https://bugzilla.redhat.com/show_bug.cgi?id=771002">https://bugzilla.redhat.com/show_bug.cgi?id=771002</a><br /><br />Same issue, different driver. Again, it's USB, and it's possible that<br />USB just makes it really hard to do this correctly (ie the "save<br />firmware image across suspend so that you don't have to load it at<br />resume time").<br /><br />It's also possible that we should blame the firmware code, which is<br />expressly written to encourage these kinds of bugs. It may be that i<br />tshould be the firmware code that has a "get_firmware()" +<br />"put_firmware()" model, and it should cache the firmware explicitly if<br />the config supports suspend, so that a firmware read at resume time<br />would actually work. The whole "request_firmware()" interface really<br />is very prone to these kinds of bugs.<br /><br />But it's possible this could be fixed at the driver level by doing the<br />caching there.<br /><br />In this case it's the rtl8192cu driver, so Larry, Chaoming, John etc<br />added to the cc for that one.<br /><br />&gt; This possibly sounds like the problem that caca9510ff4e5d842c0589110243d60927836222<br />&gt; was trying to fix, but that patch is present in the kernels<br />&gt; being reported.<br /><br />No, caca9510ff4e is only for the case where you actually compile the<br />firmware *into* the kernel, so it's part of the kernel image. That's<br />useful mainly for avoiding modules and initrd images, thus allowing<br />things like having root directly on a disk that needs firmware to be<br />loaded. Quite unusual, and it doesn't really work all that well.<br /><br />Oh, and some people use it for the Radeon firmware with the radeon DRM<br />code built it.<br /><br />It really does need to be fixed at a driver level (possibly with the<br />help of firmware/usb support infrastructure).<br /><br />                  Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
