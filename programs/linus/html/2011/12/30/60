    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2011/12/29/41">First message in thread</a></li><li><a href="/lkml/2011/12/29/62">Linus Torvalds</a><ul><li><a href="/lkml/2011/12/30/50">Peter Zijlstra</a><ul><li class="origin"><a href="/lkml/2011/12/30/67">Linus Torvalds</a><ul><li><a href="/lkml/2011/12/30/67">Hugh Dickins</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2011/12/30/60/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 30 Dec 2011 12:06:18 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [GIT PULL] futex fixlet</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Dec 30, 2011 at 9:07 AM, Peter Zijlstra &lt;a.p.zijlstra&#64;chello.nl&gt; wrote:<br />&gt;<br />&gt; So I _think_ you're completely right and we can simply kill the whole<br />&gt; thing, but I've been trying very hard to forget everything kernel<br />&gt; related for a week, and I really shouldn't kick-start my brain until<br />&gt; somewhere next week.<br /><br />Ok.<br /><br />Ingo, I'd suggest you put a patch like that into -next, and mark it<br />for stable after it has gotten lots more testing.<br /><br />Something like the appended *totally* untested code. It compiles, but<br />maybe there really is some "!page-&gt;mapping" case that could possibly<br />matter.<br /><br />I can't see it, though - but we should definitely get some testing for<br />this before I'd put it in a release. Since we do that<br />"get_user_pages_fast()" and ask for a writable page, the result should<br />be as stable as it will ever get. There is still the race with<br />hugepage splitting, but at least that one has a comment.<br /><br />                       Linus<br /> kernel/futex.c |   20 ++++++++++++--------<br /> 1 files changed, 12 insertions(+), 8 deletions(-)<br /><br />diff --git a/kernel/futex.c b/kernel/futex.c<br />index ea87f4d2f455..8d2ee2f66418 100644<br />--- a/kernel/futex.c<br />+++ b/kernel/futex.c<br />&#64;&#64; -310,21 +310,25 &#64;&#64; again:<br /> 	if (page != page_head) {<br /> 		get_page(page_head);<br /> 		put_page(page);<br />+		/* Avoid "unused label" for non-THP config */<br />+		if (0)<br />+			goto again;<br /> 	}<br /> #endif<br /> <br /> 	lock_page(page_head);<br />+<br />+	/*<br />+	 * If the page doesn't have a mapping associated with it,<br />+	 * this is either an anonymous page that was accessed RO<br />+	 * (so no COW etc) and we would just return EFAULT anyway,<br />+	 * or some special case page (ZERO_PAGE, gate area, special<br />+	 * mapping..).<br />+	 */<br /> 	if (!page_head-&gt;mapping) {<br /> 		unlock_page(page_head);<br /> 		put_page(page_head);<br />-		/*<br />-		* ZERO_PAGE pages don't have a mapping. Avoid a busy loop<br />-		* trying to find one. RW mapping would have COW'd (and thus<br />-		* have a mapping) so this page is RO and won't ever change.<br />-		*/<br />-		if ((page_head == ZERO_PAGE(address)))<br />-			return -EFAULT;<br />-		goto again;<br />+		return -EFAULT;<br /> 	}<br /> <br /> 	/*</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
