    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2011/12/24/47">First message in thread</a></li><li><a href="/lkml/2011/12/24/53">Al Viro</a><ul><li><a href="/lkml/2011/12/25/30">"J. Bruce Fields"</a><ul><li class="origin"><a href="/lkml/2011/12/26/121">Linus Torvalds</a><ul><li><a href="/lkml/2011/12/26/121">"J. Bruce Fields"</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2011/12/26/117/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 26 Dec 2011 10:37:56 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: file locking fix for 3.2</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />I'm committing the appended version instead. It removes all the games with <br />IS_ERR(), and just does the checking at the allocation point, the way the <br />other lease_alloc() user does too.<br /><br />Holler if you see something odd in there..<br /><br />                   Linus<br />---<br />commit 6d4b9e38d3980826abccfbd90e95bf4bd41b8dd2<br />Author: Linus Torvalds &lt;torvalds&#64;linux-foundation.org&gt;<br />Date:   Mon Dec 26 10:25:26 2011 -0800<br /><br />    vfs: fix handling of lock allocation failure in lease-break case<br />    <br />    Bruce Fields notes that commit 778fc546f749 ("locks: fix tracking of<br />    inprogress lease breaks") introduced a possible error pointer<br />    dereference on failure to allocate memory.  locks_conflict() will<br />    dereference the passed-in new lease lock structure that may be an error pointer.<br />    <br />    This means an open (without O_NONBLOCK set) on a file with a lease<br />    applied (generally only done when Samba or nfsd (with v4) is running)<br />    could crash if a kmalloc() fails.<br />    <br />    So instead of playing games with IS_ERROR() all over the place, just<br />    check the allocation failure early.  That makes the code more<br />    straightforward, and avoids this possible bad pointer dereference.<br />    <br />    Based-on-patch-by: J. Bruce Fields &lt;bfields&#64;redhat.com&gt;<br />    Cc: Al Viro &lt;viro&#64;zeniv.linux.org.uk&gt;<br />    Signed-off-by: Linus Torvalds &lt;torvalds&#64;linux-foundation.org&gt;<br />---<br /> fs/locks.c |   11 +++--------<br /> 1 files changed, 3 insertions(+), 8 deletions(-)<br /><br />diff --git a/fs/locks.c b/fs/locks.c<br />index 3b0d05dcd7c1..637694bf3a03 100644<br />--- a/fs/locks.c<br />+++ b/fs/locks.c<br />&#64;&#64; -1205,6 +1205,8 &#64;&#64; int __break_lease(struct inode *inode, unsigned int mode)<br /> 	int want_write = (mode &amp; O_ACCMODE) != O_RDONLY;<br /> <br /> 	new_fl = lease_alloc(NULL, want_write ? F_WRLCK : F_RDLCK);<br />+	if (IS_ERR(new_fl))<br />+		return PTR_ERR(new_fl);<br /> <br /> 	lock_flocks();<br /> <br />&#64;&#64; -1221,12 +1223,6 &#64;&#64; int __break_lease(struct inode *inode, unsigned int mode)<br /> 		if (fl-&gt;fl_owner == current-&gt;files)<br /> 			i_have_this_lease = 1;<br /> <br />-	if (IS_ERR(new_fl) &amp;&amp; !i_have_this_lease<br />-			&amp;&amp; ((mode &amp; O_NONBLOCK) == 0)) {<br />-		error = PTR_ERR(new_fl);<br />-		goto out;<br />-	}<br />-<br /> 	break_time = 0;<br /> 	if (lease_break_time &gt; 0) {<br /> 		break_time = jiffies + lease_break_time * HZ;<br />&#64;&#64; -1284,8 +1280,7 &#64;&#64; restart:<br /> <br /> out:<br /> 	unlock_flocks();<br />-	if (!IS_ERR(new_fl))<br />-		locks_free_lock(new_fl);<br />+	locks_free_lock(new_fl);<br /> 	return error;<br /> }<br /> <br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
