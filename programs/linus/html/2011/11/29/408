    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2011/11/28/662">First message in thread</a></li><li><a href="/lkml/2011/11/29/393">Andi Kleen</a><ul><li><a href="/lkml/2011/11/29/397">Linus Torvalds</a><ul><li><a href="/lkml/2011/11/29/401">Andi Kleen</a><ul><li><a href="/lkml/2011/11/29/404">Linus Torvalds</a><ul><li><a href="/lkml/2011/11/29/413">Steven Rostedt</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2011/11/29/403">Steven Rostedt</a><ul><li class="origin"><a href="/lkml/2011/12/7/434">Linus Torvalds</a><ul><li><a href="/lkml/2011/12/7/434">Steven Rostedt</a><ul><li><a href="/lkml/2011/12/7/457">Linus Torvalds</a></li><li><a href="/lkml/2011/12/7/548">Andi Kleen</a></li></ul></li><li><a href="/lkml/2012/1/8/9">tip-bot for Linus Torvalds</a></li></ul></li><li><a href="/lkml/2011/11/29/428">Andi Kleen</a></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2011/11/29/408/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 29 Nov 2011 12:44:55 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Perhaps a side effect regarding NMI returns</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Nov 29, 2011 at 12:35 PM, Steven Rostedt &lt;rostedt&#64;goodmis.org&gt; wrote:<br />&gt;<br />&gt; There may be a problem where you are profiling at a high frequency, and<br />&gt; then hit this and suddenly, your high frequency NMIs are stopped till<br />&gt; the next interrupt. If you are running at 100HZ, the next interrupt may<br />&gt; not happen for 10ms, where we don't have an NMI triggered until then.<br /><br />It could be much worse than that with no-HZ and some CPU-intensive<br />load with no timers. I don't think "sysret" enables NMI's either, so<br />return-to-user-mode may well leave NMI blocked.<br /><br />So I really think this might be a real issue. And the simplest<br />approach seems to be to just remove the code. Something like the<br />attached (TOTALLY UNTESTED!) patch.<br /><br />Hmm?<br /><br />                  Linus<br /> arch/x86/kernel/entry_64.S |   32 --------------------------------<br /> 1 files changed, 0 insertions(+), 32 deletions(-)<br /><br />diff --git a/arch/x86/kernel/entry_64.S b/arch/x86/kernel/entry_64.S<br />index faf8d5e74b0b..3819ea907339 100644<br />--- a/arch/x86/kernel/entry_64.S<br />+++ b/arch/x86/kernel/entry_64.S<br />&#64;&#64; -1489,46 +1489,14 &#64;&#64; ENTRY(nmi)<br /> 	movq %rsp,%rdi<br /> 	movq $-1,%rsi<br /> 	call do_nmi<br />-#ifdef CONFIG_TRACE_IRQFLAGS<br />-	/* paranoidexit; without TRACE_IRQS_OFF */<br />-	/* ebx:	no swapgs flag */<br />-	DISABLE_INTERRUPTS(CLBR_NONE)<br /> 	testl %ebx,%ebx				/* swapgs needed? */<br /> 	jnz nmi_restore<br />-	testl $3,CS(%rsp)<br />-	jnz nmi_userspace<br /> nmi_swapgs:<br /> 	SWAPGS_UNSAFE_STACK<br /> nmi_restore:<br /> 	RESTORE_ALL 8<br /> 	jmp irq_return<br />-nmi_userspace:<br />-	GET_THREAD_INFO(%rcx)<br />-	movl TI_flags(%rcx),%ebx<br />-	andl $_TIF_WORK_MASK,%ebx<br />-	jz nmi_swapgs<br />-	movq %rsp,%rdi			/* &amp;pt_regs */<br />-	call sync_regs<br />-	movq %rax,%rsp			/* switch stack for scheduling */<br />-	testl $_TIF_NEED_RESCHED,%ebx<br />-	jnz nmi_schedule<br />-	movl %ebx,%edx			/* arg3: thread flags */<br />-	ENABLE_INTERRUPTS(CLBR_NONE)<br />-	xorl %esi,%esi 			/* arg2: oldset */<br />-	movq %rsp,%rdi 			/* arg1: &amp;pt_regs */<br />-	call do_notify_resume<br />-	DISABLE_INTERRUPTS(CLBR_NONE)<br />-	jmp nmi_userspace<br />-nmi_schedule:<br />-	ENABLE_INTERRUPTS(CLBR_ANY)<br />-	call schedule<br />-	DISABLE_INTERRUPTS(CLBR_ANY)<br />-	jmp nmi_userspace<br /> 	CFI_ENDPROC<br />-#else<br />-	jmp paranoid_exit<br />-	CFI_ENDPROC<br />-#endif<br /> END(nmi)<br /> <br /> ENTRY(ignore_sysret)</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
