    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/10/22/124">First message in thread</a></li><li><a href="/lkml/2008/10/23/33">Markus Trippelsdorf</a><ul><li><a href="/lkml/2008/10/23/497">Theodore Tso</a><ul><li><a href="/lkml/2008/10/24/143">Theodore Tso</a></li><li class="origin"><a href="/lkml/2008/10/25/52">Linus Torvalds</a><ul><li><a href="/lkml/2008/10/25/52">Theodore Tso</a></li><li><a href="/lkml/2008/10/25/53">Theodore Tso</a><ul><li><a href="/lkml/2008/10/25/54">Markus Trippelsdorf</a></li><li><a href="/lkml/2008/10/25/159">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 24 Oct 2008 09:08:26 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: ext3: fix ext3_dx_readdir hash collision handling - Regression</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Fri, 24 Oct 2008, Markus Trippelsdorf wrote:<br />&gt;<br />&gt; Notice that I don't use "rm -rf" but "rm -r". The problem only occurs<br />&gt; when I run "rm -r" without the "-f" switch.<br />&gt; <br />&gt; The first time I encountered this problem was on an ext4 test partition<br />&gt; a few days ago. When I tried to delete a big directory structure on that<br />&gt; partition with mc (GNU Midnight Commander) by hitting F8 and then selecting<br />&gt; "All" on the "Delete it recursively" popup, it just stopped deleting<br />&gt; files after a while. So I had to repeat this procedure several times to<br />&gt; get rid of the directory.<br /><br />Hmm. I may actually have hit the same problem. I attributed it to a git <br />buglet, and left it for later, because the last few days were pretty crazy <br />(closing the merge window is when people always send their last-minute <br />stuff even if they shouldn't, but to make things worse I was also gone for <br />a day-and-a-half).<br /><br />The "git buglet" looks liek this:<br /><br /> - build a kernel<br /><br /> - do "git clean -dqfx". This fails with<br /><br />	warning: failed to remove 'include/config/'<br /><br /> - do "git clean -dqfx" again. And now it works - apparently because the <br />   first invocation deleted enough of the big directory.<br /><br />Doing an 'strace' to see what is going on, I see:<br /><br />	..<br />	getdents(3, /* 132 entries */, 4096)    = 3888<br />	lstat("include/config/sgi", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0<br />	open("include/config/sgi", O_RDONLY|O_NONBLOCK|O_DIRECTORY|0x80000) = 4<br />	fstat(4, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0<br />	getdents(4, /* 3 entries */, 4096)      = 80<br />	lstat("include/config/sgi/partition.h", {st_mode=S_IFREG|0644, st_size=0, ...}) = 0<br />	unlink("include/config/sgi/partition.h") = 0<br />	getdents(4, /* 0 entries */, 4096)      = 0<br />	close(4)                                = 0<br />	rmdir("include/config/sgi")             = 0<br />	lstat("include/config/sgi", 0x7fffdc4d2110) = -1 ENOENT (No such file or directory)<br />	close(3)                                = 0<br />	write(2, "warning: failed to remove \'include/config/\'\n", 44) = 44<br />	..<br /><br />and notice how it does that<br /><br />	lstat("include/config/sgi", ..<br /><br />_twice_. That, in turn (knowing the git implementation), implies that it <br />was returned twice from that first "getdents(3, ...)" call.<br /><br />So what git clean does is to scan over the readdir() return values, see if <br />it's a file it knows about, try to remove it if not, lstat() every entry, <br />recurse into them if they are directories, and then remove it. If the <br />lstat() fails, "git clean" will fail.<br /><br />So what happens is that it sees that "sgi" entry _twice_ in the readdir <br />output, traverse into it once (and delete it), and the second time when it <br />does an lstat() it will obviously fail (because now it's deleted!), and <br />that will make "git clean" fail the whole thing due to an unexpected <br />error.<br /><br />And I _think_ that what brings this on is:<br /><br /> - caring about the error value<br /><br />   This is why "rm -rf" works for you, but "rm -r" does not. With "-f", rm <br />   simply won't care. And like "rm -r", "git clean" cares about error <br />   values.<br /><br /> - large enough directories that you have *multiple* "getdents()" calls.<br /><br /> - likely: removing files in between getdents() calls.<br /><br />Hmm. Ted? I have not tried to revert that commit that Markus pinpointed <br />(6a897cf447a83c9c3fd1b85a1e525c02d6eada7d: "ext3: fix ext3_dx_readdir hash <br />collision handling"), but now that I look at that "git bug", I am getting <br />pretty damn sure that it's exactly the same issue, and it's not a git bug <br />at all.<br /><br />Markus basically has exactly the same thing:<br /><br />  rm: cannot remove `linux-2.6.27.2/arch/alpha/include/asm/statfs.h': No such file or directory<br /><br />and that ENOENT is almost certainly because "rm" already removed that <br />filename _once_, and it's the second time that fails.<br /><br />And yes, that commit is all about returning directory entries twice. It <br />claims to fix it, but I bet it breaks it.<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
