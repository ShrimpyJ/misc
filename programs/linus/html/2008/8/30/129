    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/8/28/371">First message in thread</a></li><li><a href="/lkml/2008/8/29/381">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/29/392">"Rafael J. Wysocki"</a><ul><li class="origin"><a href="/lkml/2008/8/30/135">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/30/135">"Yinghai Lu"</a><ul><li><a href="/lkml/2008/8/30/141">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2008/8/30/151">"Rafael J. Wysocki"</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 30 Aug 2008 10:39:29 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Linux 2.6.27-rc5: System boot regression caused by commit a2bd7274b47124d2fc4dfdb8c0591f545ba749dd</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sat, 30 Aug 2008, Rafael J. Wysocki wrote:<br />&gt; <br />&gt; &gt; And if you have the whole dmesg, that would be useful.<br />&gt; <br />&gt; dmesg from -rc5 with the offending commit reverted and with the patch<br />&gt; below applied is at:<br />&gt; <br />&gt; <a href="http://www.sisk.pl/kernel/debug/mainline/2.6.27-rc5/2.6.27-rc5-git.log">http://www.sisk.pl/kernel/debug/mainline/2.6.27-rc5/2.6.27-rc5-git.log</a><br /><br />Ok, the more I look at this, the more interesting it gets.<br /><br />In particular, this:<br /><br />	...<br />	ACPI: bus type pnp registered<br />	pnp 00:08: mem resource (0xfec00000-0xfec00fff) overlaps 0000:00:00.0 BAR 3 (0xe0000000-0xffffffff), disabling<br />	pnp 00:08: mem resource (0xfee00000-0xfee00fff) overlaps 0000:00:00.0 BAR 3 (0xe0000000-0xffffffff), disabling<br />	pnp 00:09: mem resource (0xffb80000-0xffbfffff) overlaps 0000:00:00.0 BAR 3 (0xe0000000-0xffffffff), disabling<br />	pnp 00:09: mem resource (0xfff00000-0xffffffff) overlaps 0000:00:00.0 BAR 3 (0xe0000000-0xffffffff), disabling<br />	pnp 00:0b: mem resource (0xe0000000-0xefffffff) overlaps 0000:00:00.0 BAR 3 (0xe0000000-0xffffffff), disabling<br />	pnp 00:0c: mem resource (0xfec00000-0xffffffff) overlaps 0000:00:00.0 BAR 3 (0xe0000000-0xffffffff), disabling<br />	pnp: PnP ACPI: found 13 devices<br />	ACPI: ACPI bus type pnp unregistered<br />	SCSI subsystem initialized<br />	libata version 3.00 loaded.<br />	usbcore: registered new interface driver usbfs<br />	usbcore: registered new interface driver hub<br />	usbcore: registered new device driver usb<br />	PCI: Using ACPI for IRQ routing<br />	pci 0000:00:00.0: BAR 3: can't allocate resource<br />	...<br /><br />there's a few things to note here:<br /><br /> - the resource at 0000:00:00.0 BAR 3 is totally bogus.<br /><br />   We know it's totally bogus because you actually have other resources in <br />   the 0xf....... range, and they work fine. It's also likely to be <br />   totally bogus because it so happens that the end-point of 0xffffffff is <br />   commonly something that the BIOS leaves as a "I sized this resource", <br />   because that's how resources are sized (you write all ones into them <br />   and look what you can read back).<br /><br />   But your lspci -vxx output clearly shows that (a) MEM is enabled in <br />   the command word, and yes, the BAR register at 0x18 does indeed have <br />   value 0xe0000000. So it's just the length that is really bogus.<br /><br /> - pnp clearly sees that bogus resource at 0xe0000000-0xffffffff<br /><br /> - BUT: the "can't allocate resource" thing is from <br />   pcibios_allocate_resources(), and means that the request_resource() <br />   failed _despite_ the fact that you hadn't reserved the e820 resources <br />   yet with the new patch.<br /><br />The thing that seems to save you is that we've already allocated something <br />in that region. There's a few things there, like:<br /><br />	fee00000-fee00fff : Local APIC<br /><br />but that particular one is actually reserved much later, so that doesn't <br />explain it. I think that what happens is that we have allocated the _bus_ <br />resources earlier in "pcibios_allocate_bus_resources()", and that means <br />that we already have these resources:<br /><br />	fe700000-fe7fffff : PCI Bus 0000:01<br />	fe800000-fe8fffff : PCI Bus 0000:02<br />	fe900000-fe9fffff : PCI Bus 0000:03<br />	fea00000-feafffff : PCI Bus 0000:04<br />	feb00000-febfffff : PCI Bus 0000:05<br /><br />in the resource tree, and that in turn means that when we try to allocate <br />the bogus MCFG resource, it fails.<br /><br />Which is good - it mustn't succeed.<br /><br />What _broke_ for you is that the horrible patch that got reverted said <br />that "if we recognize this as an MCFG resource, we will _always_ try to <br />insert it", so it fundamentally broke the whole resource tree, because it <br />force-inserted that totally crap resource.<br /><br />Now, the thing that worries me a bit is that I wonder how common this kind <br />of crap is. And in particular, I wonder how often we've been saved from <br />horrible issues like this by the fact that we've inserted the e820 <br />resources first. Of course - it can work both ways - sometimes it saves <br />us, and sometimes it just causes more problems (eg when we then <br />re-allocate the resource successfully somewhere else).<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
