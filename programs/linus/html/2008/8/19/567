    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/8/19/479">First message in thread</a></li><li><a href="/lkml/2008/8/19/492">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/552">Bart Trojanowski</a><ul><li><a href="/lkml/2008/8/19/556">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/561">Bart Trojanowski</a></li></ul></li></ul></li><li><a href="/lkml/2008/8/19/559">Bart Trojanowski</a><ul><li class="origin"><a href="/lkml/2008/8/19/569">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/569">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/595">Bart Trojanowski</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 19 Aug 2008 17:43:25 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: vfat BKL/lock_super regression in v2.6.26-rc3-g8f59342</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 19 Aug 2008, Bart Trojanowski wrote:<br />&gt; <br />&gt; So, maybe it would be a good idea to have a 'delaysync=60' to force a<br />&gt; sync after 60 seconds of inactivity.  Unless, there is something else<br />&gt; that would do that for me already.<br /><br />Oh, it could be even shorter.<br /><br />The problem with using 'sync' is that it easily ends up overwriting things <br />like the sector that contains a particular inode thousands of times for <br />even trivial operations. Or things like the file allocation table etc.<br /><br />For example, something as trivial as copying a single big file, if the <br />copy program just copies it a few kB at a time, then a file that is a few <br />megabytes in size will actually end up rewriting the inode block (just <br />because the size grows) thousands of time. <br /><br />With any kind of half-way decent wear leveling, this isn't a problem at <br />all, and most flash drives have that. But if they don't, then that means <br />that the file allocation table sectors and the inode sectors get rewritten <br />over and over and over again thousands of times.<br /><br />Just making it do the sync once per _second_ or something like that would <br />already make the "thousands of times" go away. The sectors would probably <br />be rewritten a few times per big file, and just once per couple of tens of <br />files for small files being written.<br /><br />So we don't even need anything like 60 seconds, we literally would just <br />need some trivial delays.<br /><br />But no, we don't have that kind of "half-sync" behavior. Right now, it's <br />pretty much all or nothing.  Either we're fully synchronous (and that <br />really is bad for crappy flash), or we end up depending on bdflush writing <br />things back in the background.<br /><br />Of course, pdflush already syncs within 60s (in fact, 30s by default, <br />iirc), but then things like "laptop_mode" will actually make that <br />potentially much less frequent (I think the default value for that is 5 <br />minutes).<br /><br />I do think this is something we could do better, no question about it.<br /><br />But I don't know exactly what the timeout should be, though (although I <br />suspect that it should involve _ignoring_ non-data writes like the atime <br />updates, and trigger a timeout on data writes so that when you actually <br />write a file, you'll know that the sync will happen within five seconds of <br />you having finished the write or whatever).<br /><br />And no, no such mount option currently exists. And the pdflush things are <br />all global, not per-device, iirc.<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
