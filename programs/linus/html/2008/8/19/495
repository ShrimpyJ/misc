    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/8/19/479">First message in thread</a></li><li><a href="/lkml/2008/8/19/479">Bart Trojanowski</a><ul><li><a href="/lkml/2008/8/19/480">Bart Trojanowski</a><ul><li class="origin"><a href="/lkml/2008/8/19/575">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/575">Bart Trojanowski</a></li></ul></li></ul></li><li><a href="/lkml/2008/8/19/492">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/552">Bart Trojanowski</a><ul><li><a href="/lkml/2008/8/19/556">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/561">Bart Trojanowski</a></li></ul></li></ul></li><li><a href="/lkml/2008/8/19/559">Bart Trojanowski</a><ul><li><a href="/lkml/2008/8/19/567">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/19/569">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2008/8/19/495/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 19 Aug 2008 15:21:21 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] make lock_super recursive to simulate BKL</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 19 Aug 2008, Bart Trojanowski wrote:<br />&gt;<br />&gt; This fixes a regression introduced when BKL was removed from the<br />&gt; vfat driver in commit 8f5934278d1d86590244c2791b28f77d67466007.<br /><br />I agree that it's going to almost certainly fix the regression, but could <br />you test the following patch instead as an alternative? I'd rather remove <br />the broken recursive lockign than introduce it as an acceptable concept.<br /><br />		Linus<br />---<br /> fs/fat/inode.c |   10 +++-------<br /> 1 files changed, 3 insertions(+), 7 deletions(-)<br /><br />diff --git a/fs/fat/inode.c b/fs/fat/inode.c<br />index 6d266d7..80ff338 100644<br />--- a/fs/fat/inode.c<br />+++ b/fs/fat/inode.c<br />&#64;&#64; -562,26 +562,23 &#64;&#64; static int fat_write_inode(struct inode *inode, int wait)<br /> 	struct buffer_head *bh;<br /> 	struct msdos_dir_entry *raw_entry;<br /> 	loff_t i_pos;<br />-	int err = 0;<br />+	int err;<br /> <br /> retry:<br /> 	i_pos = MSDOS_I(inode)-&gt;i_pos;<br /> 	if (inode-&gt;i_ino == MSDOS_ROOT_INO || !i_pos)<br /> 		return 0;<br /> <br />-	lock_super(sb);<br /> 	bh = sb_bread(sb, i_pos &gt;&gt; sbi-&gt;dir_per_block_bits);<br /> 	if (!bh) {<br /> 		printk(KERN_ERR "FAT: unable to read inode block "<br /> 		       "for updating (i_pos %lld)\n", i_pos);<br />-		err = -EIO;<br />-		goto out;<br />+		return -EIO;<br /> 	}<br /> 	spin_lock(&amp;sbi-&gt;inode_hash_lock);<br /> 	if (i_pos != MSDOS_I(inode)-&gt;i_pos) {<br /> 		spin_unlock(&amp;sbi-&gt;inode_hash_lock);<br /> 		brelse(bh);<br />-		unlock_super(sb);<br /> 		goto retry;<br /> 	}<br /> <br />&#64;&#64; -607,11 +604,10 &#64;&#64; retry:<br /> 	}<br /> 	spin_unlock(&amp;sbi-&gt;inode_hash_lock);<br /> 	mark_buffer_dirty(bh);<br />+	err = 0;<br /> 	if (wait)<br /> 		err = sync_dirty_buffer(bh);<br /> 	brelse(bh);<br />-out:<br />-	unlock_super(sb);<br /> 	return err;<br /> }<br /> <br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
