    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/8/23/105">First message in thread</a></li><li><a href="/lkml/2008/8/25/320">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/25/322">Arjan van de Ven</a></li><li><a href="/lkml/2008/8/25/324">Linus Torvalds</a><ul><li class="origin"><a href="/lkml/2008/8/26/23">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/26/23">Ingo Molnar</a><ul><li><a href="/lkml/2008/8/26/25">David Miller</a></li><li><a href="/lkml/2008/8/26/243">Mike Travis</a></li></ul></li><li><a href="/lkml/2008/8/26/241">Mike Travis</a><ul><li><a href="/lkml/2008/8/26/252">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2008/8/25/340">"Alan D. Brunelle"</a><ul><li><a href="/lkml/2008/8/25/358">Christoph Lameter</a><ul><li><a href="/lkml/2008/8/26/27">Ingo Molnar</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2008/8/26/108">Rusty Russell</a><ul><li><a href="/lkml/2008/8/26/197">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/26/222">Adrian Bunk</a><ul><li><a href="/lkml/2008/8/26/226">Linus Torvalds</a></li><li><a href="/lkml/2008/8/26/227">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2008/8/26/282">Jeff Garzik</a><ul><li><a href="/lkml/2008/8/26/291">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2008/8/25/331/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 25 Aug 2008 14:15:02 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [Bug #11342] Linux 2.6.27-rc3: kernel BUG at mm/vmalloc.c - bisected</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Mon, 25 Aug 2008, Linus Torvalds wrote:<br />&gt; <br />&gt; checkstack.pl shows these things as the top problems:<br />&gt; <br />&gt; 	0xffffffff80266234 smp_call_function_mask [vmlinux]:    2736<br />&gt; 	0xffffffff80234747 __build_sched_domains [vmlinux]:     2232<br />&gt; 	0xffffffff8023523f __build_sched_domains [vmlinux]:     2232<br />&gt; <br />&gt; Anyway, the reason smp_call_function_mask and friends have such _huge_ <br />&gt; stack usages for you is that they contain a 'cpumask_t' on the stack.<br /><br />In fact, they contain multiple CPU-masks, each 4k-bits - 512 bytes - in <br />size. And they tend to call each other.<br /><br />Quite frankly, I don't think we were really ready for 4k CPU's. I'm going <br />to commit this patch to make sure others don't do that many CPU's by <br />mistake. It marks MAXCPU's as being 'broken' so you cannot select it, and <br />also limits the number of CPU's that you _can_ select to "just" 512.<br /><br />Right now, 4k cpu's is known broken because of the stack usage. I'm not <br />willing to debug more of these kinds of stack smashers, they're really <br />nasty to work with. I wonder how many other random failures these have <br />been involved with?<br /><br />This patch also makes the ifdef mess in Kconfig much cleaner and avoids <br />duplicate definitions by just conditionally suppressing the question and <br />giving higher defaults. <br /><br />We can enable MAXSMP and raise the CPU limits some time in the future. But <br />that future is not going to be before 2.6.27 - the code simply isn't ready <br />for it.<br /><br />The reason I picked 512 CPU's as the limit is that we _used_ to limit <br />things to 255. So it's higher than it used to be, but low enough to still <br />feel safe. Considering that a 4k-bit CPU mask (512 bytes) _almost_ worked, <br />the 512-bit (64 bytes) masks are almost certainly fine.<br /><br />Still, sane people should limit their NR_CPUS to 8 or 16 or something like <br />that. Very very few people really need the pain of big NR_CPUS. Not even <br />"just" 512 CPU's.<br /><br />Travis, Ingo and Thomas cc'd, since they were involved in the original <br />commit (1184dc2ffe2c8fb9afb766d870850f2c3165ef25) that raised the limit.<br /><br />		Linus<br /><br />---<br /> arch/x86/Kconfig |   30 ++++++++----------------------<br /> 1 files changed, 8 insertions(+), 22 deletions(-)<br /><br />diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig<br />index 68d91c8..ed92864 100644<br />--- a/arch/x86/Kconfig<br />+++ b/arch/x86/Kconfig<br />&#64;&#64; -577,35 +577,29 &#64;&#64; config SWIOTLB<br /> <br /> config IOMMU_HELPER<br /> 	def_bool (CALGARY_IOMMU || GART_IOMMU || SWIOTLB || AMD_IOMMU)<br />+<br /> config MAXSMP<br /> 	bool "Configure Maximum number of SMP Processors and NUMA Nodes"<br />-	depends on X86_64 &amp;&amp; SMP<br />+	depends on X86_64 &amp;&amp; SMP &amp;&amp; BROKEN<br /> 	default n<br /> 	help<br /> 	  Configure maximum number of CPUS and NUMA Nodes for this architecture.<br /> 	  If unsure, say N.<br /> <br />-if MAXSMP<br />-config NR_CPUS<br />-	int<br />-	default "4096"<br />-endif<br />-<br />-if !MAXSMP<br /> config NR_CPUS<br />-	int "Maximum number of CPUs (2-4096)"<br />-	range 2 4096<br />+	int "Maximum number of CPUs (2-512)" if !MAXSMP<br />+	range 2 512<br /> 	depends on SMP<br />+	default "4096" if MAXSMP<br /> 	default "32" if X86_NUMAQ || X86_SUMMIT || X86_BIGSMP || X86_ES7000<br /> 	default "8"<br /> 	help<br /> 	  This allows you to specify the maximum number of CPUs which this<br />-	  kernel will support.  The maximum supported value is 4096 and the<br />+	  kernel will support.  The maximum supported value is 512 and the<br /> 	  minimum value which makes sense is 2.<br /> <br /> 	  This is purely to save memory - each supported CPU adds<br /> 	  approximately eight kilobytes to the kernel image.<br />-endif<br /> <br /> config SCHED_SMT<br /> 	bool "SMT (Hyperthreading) scheduler support"<br />&#64;&#64; -996,17 +990,10 &#64;&#64; config NUMA_EMU<br /> 	  into virtual nodes when booted with "numa=fake=N", where N is the<br /> 	  number of nodes. This is only useful for debugging.<br /> <br />-if MAXSMP<br />-<br /> config NODES_SHIFT<br />-	int<br />-	default "9"<br />-endif<br />-<br />-if !MAXSMP<br />-config NODES_SHIFT<br />-	int "Maximum NUMA Nodes (as a power of 2)"<br />+	int "Maximum NUMA Nodes (as a power of 2)" if !MAXSMP<br /> 	range 1 9   if X86_64<br />+	default "9" if MAXSMP<br /> 	default "6" if X86_64<br /> 	default "4" if X86_NUMAQ<br /> 	default "3"<br />&#64;&#64; -1014,7 +1001,6 &#64;&#64; config NODES_SHIFT<br /> 	help<br /> 	  Specify the maximum number of NUMA Nodes available on the target<br /> 	  system.  Increases memory reserved to accomodate various tables.<br />-endif<br /> <br /> config HAVE_ARCH_BOOTMEM_NODE<br /> 	def_bool y<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
