    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/8/28/371">First message in thread</a></li><li><a href="/lkml/2008/8/29/304">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2008/8/29/340">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2008/8/29/361">"Yinghai Lu"</a><ul><li><a href="/lkml/2008/8/29/365">"Yinghai Lu"</a><ul><li><a href="/lkml/2008/8/29/394">"Rafael J. Wysocki"</a></li></ul></li><li><a href="/lkml/2008/8/29/393">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2008/8/29/420">"Yinghai Lu"</a></li></ul></li></ul></li><li class="origin"><a href="/lkml/2008/8/29/392">Linus Torvalds</a><ul><li><a href="/lkml/2008/8/29/392">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2008/8/30/129">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2008/8/29/398">Jeff Garzik</a><ul><li><a href="/lkml/2008/8/29/400">"Rafael J. Wysocki"</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2008/8/29/381/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 29 Aug 2008 14:44:24 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Linux 2.6.27-rc5: System boot regression caused by commit a2bd7274b47124d2fc4dfdb8c0591f545ba749dd</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Fri, 29 Aug 2008, Rafael J. Wysocki wrote:<br />&gt; <br />&gt; Bisection turned up commit a2bd7274b47124d2fc4dfdb8c0591f545ba749dd as the culprit:<br />&gt; <br />&gt; commit a2bd7274b47124d2fc4dfdb8c0591f545ba749dd<br />&gt; Author: Yinghai Lu &lt;yhlu.kernel&#64;gmail.com&gt;<br />&gt; Date:   Mon Aug 25 00:56:08 2008 -0700<br />&gt; <br />&gt;     x86: fix HPET regression in 2.6.26 versus 2.6.25, check hpet against BAR, v3<br />&gt; <br />&gt; Reverting this commit helps.<br /><br />Heh, interesting, since we were talking about reverting that one for other <br />reasons entirely.<br /><br />See the thread "x86: split e820 reserved entries record to late" (yeah, I <br />know that subject isn't very grammatical or sensible) for some patches <br />worth trying _after_ you've reverted that one.<br /><br />Anyway, clearly that commit needs to be reverted regardless, so I'll do <br />the revert. Can you please test the appended test-patch by Yinghai on top <br />of the revert?<br /><br />(This is not the final version, but it should be sufficient to be tested)<br /><br />And if you have the whole dmesg, that would be useful.<br /><br />		Linus<br /><br />---<br />From: Yinghai Lu &lt;yhlu.kernel&#64;gmail.com&gt;<br />Subject: [PATCH] x86: split e820 reserved entries record to late v3<br />Date: Thu, 28 Aug 2008 17:41:29 -0700<br /><br />so could let BAR res register at first, or even pnp?<br /><br />v2: insert e820 reserve resources before pnp_system_init<br />v3: fix merging problem in tip/x86/core<br />    please drop the one in tip/x86/core use this one instead<br /><br />Signed-off-by: Yinghai Lu &lt;yhlu.kernel&#64;gmail.com&gt;<br /><br />---<br /> arch/x86/kernel/e820.c |   20 ++++++++++++++++++--<br /> arch/x86/pci/i386.c    |    3 +++<br /> include/asm-x86/e820.h |    1 +<br /> 3 files changed, 22 insertions(+), 2 deletions(-)<br /><br />Index: linux-2.6/arch/x86/kernel/e820.c<br />===================================================================<br />--- linux-2.6.orig/arch/x86/kernel/e820.c<br />+++ linux-2.6/arch/x86/kernel/e820.c<br />&#64;&#64; -1271,13 +1271,15 &#64;&#64; static inline const char *e820_type_to_s<br /> /*<br />  * Mark e820 reserved areas as busy for the resource manager.<br />  */<br />+struct resource __initdata *e820_res;<br /> void __init e820_reserve_resources(void)<br /> {<br /> 	int i;<br />-	struct resource *res;<br /> 	u64 end;<br />+	struct resource *res;<br /> <br /> 	res = alloc_bootmem_low(sizeof(struct resource) * e820.nr_map);<br />+	e820_res = res;<br /> 	for (i = 0; i &lt; e820.nr_map; i++) {<br /> 		end = e820.map[i].addr + e820.map[i].size - 1;<br /> #ifndef CONFIG_RESOURCES_64BIT<br />&#64;&#64; -1291,7 +1293,8 &#64;&#64; void __init e820_reserve_resources(void)<br /> 		res-&gt;end = end;<br /> <br /> 		res-&gt;flags = IORESOURCE_MEM | IORESOURCE_BUSY;<br />-		insert_resource(&amp;iomem_resource, res);<br />+		if (e820.map[i].type != E820_RESERVED || res-&gt;start &lt; (1ULL&lt;&lt;20))<br />+			insert_resource(&amp;iomem_resource, res);<br /> 		res++;<br /> 	}<br /> <br />&#64;&#64; -1303,6 +1306,19 &#64;&#64; void __init e820_reserve_resources(void)<br /> 	}<br /> }<br /> <br />+void __init e820_reserve_resources_late(void)<br />+{<br />+	int i;<br />+	struct resource *res;<br />+<br />+	res = e820_res;<br />+	for (i = 0; i &lt; e820.nr_map; i++) {<br />+		if (e820.map[i].type == E820_RESERVED &amp;&amp; res-&gt;start &gt;= (1ULL&lt;&lt;20))<br />+			insert_resource(&amp;iomem_resource, res);<br />+		res++;<br />+	}<br />+}<br />+<br /> char *__init default_machine_specific_memory_setup(void)<br /> {<br /> 	char *who = "BIOS-e820";<br />Index: linux-2.6/arch/x86/pci/i386.c<br />===================================================================<br />--- linux-2.6.orig/arch/x86/pci/i386.c<br />+++ linux-2.6/arch/x86/pci/i386.c<br />&#64;&#64; -33,6 +33,7 &#64;&#64;<br /> #include &lt;linux/bootmem.h&gt;<br /> <br /> #include &lt;asm/pat.h&gt;<br />+#include &lt;asm/e820.h&gt;<br /> <br /> #include "pci.h"<br /> <br />&#64;&#64; -230,6 +231,8 &#64;&#64; void __init pcibios_resource_survey(void<br /> 	pcibios_allocate_bus_resources(&amp;pci_root_buses);<br /> 	pcibios_allocate_resources(0);<br /> 	pcibios_allocate_resources(1);<br />+<br />+	e820_reserve_resources_late();<br /> }<br /> <br /> /**<br />Index: linux-2.6/include/asm-x86/e820.h<br />===================================================================<br />--- linux-2.6.orig/include/asm-x86/e820.h<br />+++ linux-2.6/include/asm-x86/e820.h<br />&#64;&#64; -122,6 +122,7 &#64;&#64; extern void e820_register_active_regions<br /> extern u64 e820_hole_size(u64 start, u64 end);<br /> extern void finish_e820_parsing(void);<br /> extern void e820_reserve_resources(void);<br />+extern void e820_reserve_resources_late(void);<br /> extern void setup_memory_map(void);<br /> extern char *default_machine_specific_memory_setup(void);<br /> extern char *machine_specific_memory_setup(void);<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
