    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/7/11/328">First message in thread</a></li><li><a href="/lkml/2008/7/13/42">"Dmitry Adamushko"</a><ul><li><a href="/lkml/2008/7/13/94">Linus Torvalds</a><ul><li><a href="/lkml/2008/7/13/104">Ingo Molnar</a></li><li class="origin"><a href="/lkml/2008/7/13/109">Linus Torvalds</a><ul><li><a href="/lkml/2008/7/13/109">"Dmitry Adamushko"</a><ul><li><a href="/lkml/2008/7/13/112">Ingo Molnar</a></li><li><a href="/lkml/2008/7/13/115">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 13 Jul 2008 10:46:59 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: current linux-2.6.git: cpusets completely broken</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sun, 13 Jul 2008, Linus Torvalds wrote:<br />&gt; <br />&gt; The thing is, we should fix the top level code to never even _consider_ an <br />&gt; invalid CPU as a target, and that in turn should mean that all the other <br />&gt; code should be able to just totally ignore CPU hotplug events.<br /><br />IOW, I think we should totally remove the whole "update_sched_domains()" <br />thing too. Any logic that needs it is broken. We shouldn't detach the <br />scheduler domains in DOWN_PREPARE (much less UP_PREPARE), we should just <br />leave them damn well alone.<br /><br />As the comment says, "The domains and groups cannot be updated in place <br />without racing with the balancing code". The thing is, we shouldn't even <br />try. The correct way to handle all this is to make the balancing code use <br />the domains regardless, but protect against CPU's going down with <br />_another_ data structure that is much easier to update.<br /><br />Namely something like 'cpu_active_map'.<br /><br />Then we just get rid of all the crap in update_sched_domains() entirely, <br />and then we can make the cpusets code do the *sane* thing, which is to <br />rebuild the scheduler domains only when the CPU up/down has completed.<br /><br />So instead of this illogical and crazy mess:<br /><br />	+       switch (phase) {<br />	+       case CPU_UP_CANCELED:<br />	+       case CPU_UP_CANCELED_FROZEN:<br />	+       case CPU_DOWN_FAILED:<br />	+       case CPU_DOWN_FAILED_FROZEN:<br />	+       case CPU_ONLINE:<br />	+       case CPU_ONLINE_FROZEN:<br />	+       case CPU_DEAD:<br />	+       case CPU_DEAD_FROZEN:<br />	+               common_cpu_mem_hotplug_unplug(1);<br /><br />it should just say<br /><br />	+       switch (phase) {<br />	+       case CPU_ONLINE:<br />	+       case CPU_ONLINE_FROZEN:<br />	+       case CPU_DEAD:<br />	+       case CPU_DEAD_FROZEN:<br />	+               common_cpu_mem_hotplug_unplug(1);<br /><br />because it only makes sense to rebuild the scheduler domains when the <br />thing SUCCEEDS. <br /><br />See? By having a sane design, the code is not just more robust and easy to <br />follow, you can also simplify it and make it more logical.<br /><br />The current design is not sane.<br /><br />			Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
