    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2008/7/30/45">First message in thread</a></li><li><a href="/lkml/2008/7/31/46">Dmitry Torokhov</a><ul><li><a href="/lkml/2008/7/31/56">Linus Torvalds</a><ul><li><a href="/lkml/2008/7/31/59">Dmitry Torokhov</a></li><li class="origin"><a href="/lkml/2008/7/31/66">Linus Torvalds</a><ul><li><a href="/lkml/2008/7/31/66">Dmitry Torokhov</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2008/7/31/62/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 31 Jul 2008 13:28:37 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: linux-next: Tree for July 30</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 31 Jul 2008, Linus Torvalds wrote:<br />&gt; &gt;     /* Check for ABS_X, ABS_Y, ABS_PRESSURE and BTN_TOOL_FINGER */<br />&gt; &gt; <br />&gt; &gt;     SYSCALL(ret = ioctl(fd, EVIOCGBIT(0, KEY_MAX), evbits));<br />&gt; &gt; <br />&gt; &gt; So we allocate 64 bytes on stack and then as kernel to fill it with<br />&gt; &gt; 511 bytes worth of data.<br />&gt; <br />&gt; Ok, I can see how it's confused, asking for KEY_MAX _bits_. If this is the <br />&gt; main user, why not just change the definition to be in bits?<br /><br />Or just say that "if the buffer is really much too big, maybe they meant <br />bits"?<br /><br />IOW, something like this?<br /><br />(And no, I'm not seriously proposing _this_ patch, but you get the idea)<br /><br />		Linus<br />---<br /> drivers/input/evdev.c |    9 +++++++--<br /> 1 files changed, 7 insertions(+), 2 deletions(-)<br /><br />diff --git a/drivers/input/evdev.c b/drivers/input/evdev.c<br />index 2d65411..e45451d 100644<br />--- a/drivers/input/evdev.c<br />+++ b/drivers/input/evdev.c<br />&#64;&#64; -734,7 +734,7 &#64;&#64; static long evdev_do_ioctl(struct file *file, unsigned int cmd,<br /> 		if (_IOC_DIR(cmd) == _IOC_READ) {<br /> <br /> 			if ((_IOC_NR(cmd) &amp; ~EV_MAX) == _IOC_NR(EVIOCGBIT(0, 0))) {<br />-<br />+				unsigned int size = _IOC_SIZE(cmd);<br /> 				unsigned long *bits;<br /> 				int len;<br /> <br />&#64;&#64; -751,7 +751,12 &#64;&#64; static long evdev_do_ioctl(struct file *file, unsigned int cmd,<br /> 				case EV_SW:  bits = dev-&gt;swbit;  len = SW_MAX;  break;<br /> 				default: return -EINVAL;<br /> 				}<br />-				return bits_to_user(bits, len, _IOC_SIZE(cmd), p, compat_mode);<br />+<br />+				/* Some people get confused about size in bits vs bytes */<br />+				if (size &gt;= len/8)<br />+					size = size/8;<br />+<br />+				return bits_to_user(bits, len, size, p, compat_mode);<br /> 			}<br /> <br /> 			if (_IOC_NR(cmd) == _IOC_NR(EVIOCGKEY(0)))<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
