    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2019/12/30/14">First message in thread</a></li><li><a href="/lkml/2019/12/30/26">Aleksa Sarai</a><ul><li><a href="/lkml/2019/12/30/37">Aleksa Sarai</a><ul><li class="origin"><a href="/lkml/2019/12/30/61">Linus Torvalds</a><ul><li><a href="/lkml/2019/12/30/61">Aleksa Sarai</a><ul><li><a href="/lkml/2020/1/2/109">David Laight</a></li></ul></li></ul></li><li><a href="/lkml/2019/12/31/289">Al Viro</a><ul><li><a href="/lkml/2019/12/31/290">Al Viro</a><ul><li><a href="/lkml/2019/12/31/296">Al Viro</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 29 Dec 2019 23:53:47 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH RFC 0/1] mount: universally disallow mounting over symlinks</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Sun, Dec 29, 2019 at 11:30 PM Aleksa Sarai &lt;cyphar&#64;cyphar.com&gt; wrote:<br />&gt;<br />&gt;     BUG: kernel NULL pointer dereference, address: 0000000000000000<br /><br />Would you mind building with debug info, and then running the oops through<br /><br /> scripts/decode_stacktrace.sh<br /><br />which makes those addresses much more legible.<br /><br />&gt;     #PF: supervisor instruction fetch in kernel mode<br />&gt;     #PF: error_code(0x0010) - not-present page<br /><br />Somebody jumped through a NULL pointer.<br /><br />&gt;     RAX: 0000000000000000 RBX: ffff906d0cc3bb40 RCX: 0000000000000abc<br />&gt;     RDX: 0000000000000089 RSI: ffff906d74623cc0 RDI: ffff906d74475df0<br />&gt;     RBP: ffff906d74475df0 R08: ffffd70b7fb24c20 R09: ffff906d066a5000<br />&gt;     R10: 0000000000000000 R11: 8080807fffffffff R12: ffff906d74623cc0<br />&gt;     R13: 0000000000000089 R14: ffffb70b82963dc0 R15: 0000000000000080<br />&gt;     FS:  00007fbc2a8f0540(0000) GS:ffff906dcf500000(0000) knlGS:0000000000000000<br />&gt;     CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033<br />&gt;     CR2: ffffffffffffffd6 CR3: 00000003c68f8001 CR4: 00000000003606e0<br />&gt;     Call Trace:<br />&gt;      __lookup_slow+0x94/0x160<br /><br />And "__lookup_slow()" has two indirect calls (they aren't obvious with<br />retpoline, but look for something  like<br /><br />        call __x86_indirect_thunk_rax<br /><br />which is the modern sad way of doing "call *%rax"). One is for<br />revalidatinging an old dentry, but the one I _suspect_ you trigger is<br />this one:<br /><br />                old = inode-&gt;i_op-&gt;lookup(inode, dentry, flags);<br /><br />but I thought we only could get here if we know it's a directory.<br /><br />How did we miss the "d_can_lookup()", which is what should check that<br />yes, we can call that -&gt;lookup() routine.<br /><br />This is why I have that suspicion that it's somehow that O_PATH fd<br />opened in another process without O_PATH causes confusion...<br /><br />So what I think has happened is that because of the O_PATH thing,<br />we've ended up with an inode that has never been truly opened (because<br />O_PATH skips that part), but then with the /proc/&lt;pid&gt;/fd/xyz open, we<br />now have a file descriptor that _looks_ like it is valid, and we're<br />treating that inode as if it can be used.<br /><br />But I'm handwaving.<br /><br />             Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
