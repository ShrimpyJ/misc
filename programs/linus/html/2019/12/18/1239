    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2019/12/5/774">First message in thread</a></li><li><a href="/lkml/2019/12/7/173">Linus Torvalds</a><ul><li><a href="/lkml/2019/12/9/228">Vincent Guittot</a><ul><li><a href="/lkml/2019/12/9/674">Linus Torvalds</a><ul><li><a href="/lkml/2019/12/9/687">Akemi Yagi</a><ul><li><a href="/lkml/2019/12/9/709">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2019/12/9/1189">DJ Delorie</a></li><li><a href="/lkml/2019/12/10/659">Vincent Guittot</a><ul><li><a href="/lkml/2019/12/10/884">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2019/12/11/1624">DJ Delorie</a><ul><li><a href="/lkml/2019/12/11/1704">Linus Torvalds</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2019/12/12/239">Konstantin Khlebnikov</a><ul><li class="origin"><a href="/lkml/2019/12/18/1284">Linus Torvalds</a><ul><li><a href="/lkml/2019/12/18/1284">Josh Triplett</a><ul><li><a href="/lkml/2019/12/18/1290">Josh Triplett</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 18 Dec 2019 14:51:27 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 0/2] pipe: Fixes [ver #2]</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Thu, Dec 12, 2019 at 2:18 AM Konstantin Khlebnikov<br />&lt;khlebnikov&#64;yandex-team.ru&gt; wrote:<br />&gt;<br />&gt; commit f467a6a66419 pipe: fix and clarify pipe read wakeup logic<br />&gt; killed "wake writer when buffer becomes half empty" part added by<br />&gt; commit cefa80ced57a ("pipe: Increase the writer-wakeup threshold to reduce context-switch count").<br />&gt;<br />&gt; I suppose that was unintentional. Jobserver juggles with few bytes and<br />&gt; should never reach half/full buffer thresholds.<br /><br />It wasn'tunintentional - the rest of the cleanups should mean that we<br />never wake things up unnecessarily - we now only wake up if it _used_<br />to be 100% full, and we only do it once per read.<br /><br />And it did it without the watermark, which I was worried about might<br />break something that "knew" the size of the pipe.<br /><br />But performance testing would be good. Both for the "no unnecessary<br />wakeups" case, but also for the thundering herd issue.<br /><br />To answer Josh's email in this same thread:<br /><br />On Wed, Dec 18, 2019 at 12:59 PM Josh Triplett &lt;josh&#64;joshtriplett.org&gt; wrote:<br />&gt;<br />&gt; Debian and Ubuntu have make 4.2.1-1.2, which includes "[SV 51159] Use a<br />&gt; non-blocking read with pselect to avoid hangs." and various other fixes.<br />&gt; <a href="https://metadata.ftp-master.debian.org/changelogs/main/m/make-dfsg/make-dfsg_4.2.1-1.2_changelog">https://metadata.ftp-master.debian.org/changelogs/main/m/make-dfsg/make-dfsg_4.2.1-1.2_changelog</a><br />&gt; So, both Debian and Ubuntu should be fine with the pipe improvements.<br />&gt; (I'm testing that now.)<br />&gt;<br />&gt; Is the version of your non-thundering-herd pipe wakeup patch attached to<br />&gt; <a href="https://lore.kernel.org/lkml/CAHk-=wicgTacrHUJmSBbW9MYAdMPdrXzULPNqQ3G7">https://lore.kernel.org/lkml/CAHk-=wicgTacrHUJmSBbW9MYAdMPdrXzULPNqQ3G7</a>+HkLeNf1Q&#64;mail.gmail.com/<br />&gt; still the best version to test performance with?<br /><br />That's my latest version, but you'll have to tweak it a tiny bit<br />because of d1c6a2aa02af ("pipe: simplify signal handling in<br />pipe_read() and add comments") which I did after that patch.<br /><br />The easiest way to resolve it is likely to revert that d1c6a2aa02af,<br />then apply the non-thundering-herd patch and then apply d1c6a2aa02af<br />again by hand - it's fairly straightforward (and you can return<br />-ERESTARTSYS directly if wait_event_interruptible_exclusive() fails,<br />because of all the same reasons why it coul dhappen without the<br />thundering-herd patch.<br /><br />I can look at re-creating that patch if  you find it to be too annoying.<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
