    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2019/7/22/567">First message in thread</a></li><li><a href="/lkml/2019/7/22/567">Christian Brauner</a><ul><li class="origin"><a href="/lkml/2019/7/22/745">Linus Torvalds</a><ul><li><a href="/lkml/2019/7/22/745">Christian Brauner</a></li><li><a href="/lkml/2019/7/23/278">Oleg Nesterov</a><ul><li><a href="/lkml/2019/7/23/285">Christian Brauner</a></li></ul></li></ul></li><li><a href="/lkml/2019/7/22/749">   pr-tracker-bot&#64;kernel ...</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 22 Jul 2019 09:27:08 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [GIT PULL] pidfd fixes</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Jul 22, 2019 at 7:26 AM Christian Brauner &lt;christian&#64;brauner.io&gt; wrote:<br />&gt;<br />&gt; This contains a fix for pidfd polling. It ensures that the task's exit<br />&gt; state is visible to all waiters:<br /><br />Hmm.<br /><br />I've pulled this, but the exit_state thing has been very fragile<br />before, and I'm not entirely happy with how this just changes where it<br />is set. I guess the movement here is all inside the tasklist_lock, so<br />it's not that big of a deal, but still..<br /><br />I would *really* like Oleg to take a look.<br /><br />Also, and the primary reason I write this email is that this basically<br />makes the "EXIT_ZOMBIE / EXIT_DEAD" state handling look all kinds of<br />crazy. You set it to EXIT_ZOMBIE potentially _twice_. Whaa?<br /><br />So if we set EXIT_ZOMBIE early, then I think we should change the<br />EXIT_DEAD case too. IOW, do something like this on top:<br /><br />  --- a/kernel/exit.c<br />  +++ b/kernel/exit.c<br />  &#64;&#64; -734,9 +734,10 &#64;&#64; static void exit_notify(struct task_struct<br />*tsk, int group_dead)<br />                autoreap = true;<br />        }<br /><br />  -     tsk-&gt;exit_state = autoreap ? EXIT_DEAD : EXIT_ZOMBIE;<br />  -     if (tsk-&gt;exit_state == EXIT_DEAD)<br />  +     if (autoreap) {<br />  +             tsk-&gt;exit_state = EXIT_DEAD;<br />                list_add(&amp;tsk-&gt;ptrace_entry, &amp;dead);<br />  +     }<br /><br />        /* mt-exec, de_thread() is waiting for group leader */<br />        if (unlikely(tsk-&gt;signal-&gt;notify_count &lt; 0))<br /><br />where now the logic becomes "ok, we turned into a zombie above, and if<br />we autoreap this thread then we turn the zombie into a fully dead<br />thread".<br /><br />Because currently we end up having "first turn it into a zombie", then<br />"set it to zombie or dead depending on autoreap" and then "if we<br />turned it into dead, move it to the dead list".<br /><br />That just feels confused to me. Comments?<br /><br />              Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
