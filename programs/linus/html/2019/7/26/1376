    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2019/7/26/388">First message in thread</a></li><li><a href="/lkml/2019/7/26/388">Christian Brauner</a><ul><li class="origin"><a href="/lkml/2019/7/26/1400">Linus Torvalds</a><ul><li><a href="/lkml/2019/7/26/1400">Al Viro</a><ul><li><a href="/lkml/2019/7/26/1417">(Eric W. Biederman)</a><ul><li><a href="/lkml/2019/7/26/1443">Al Viro</a></li></ul></li><li><a href="/lkml/2019/7/26/1441">Al Viro</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 26 Jul 2019 15:47:02 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Regression in 5.3 for some FS_USERNS_MOUNT (aka user-namespace-mountable) filesystems</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Fri, Jul 26, 2019 at 5:00 AM Christian Brauner &lt;christian&#64;brauner.io&gt; wrote:<br />&gt;<br />&gt; The commit that introduced the regression is:<br />&gt;<br />&gt; commit 0ce0cf12fc4c6a089717ff613d76457052cf4303<br />&gt; Author: Al Viro &lt;viro&#64;zeniv.linux.org.uk&gt;<br />&gt; Date:   Sun May 12 15:42:48 2019 -0400<br />&gt;<br />&gt;     consolidate the capability checks in sget_{fc,userns}()<br />&gt;<br />&gt;     ... into a common helper - mount_capable(type, userns)<br /><br />The commit message there tries to imply that it's just consolidating<br />existing checks, but you're right - that's not at all the case.<br /><br />In sget_fc(), the tests are all the exact same tests, but it uses a<br />different 'user_ns' after the commit. It *used* to use fc-&gt;user_ns,<br />now it uses 'user_ns' which depends on that 'global' bit.<br /><br />And in sget_userns(), the userns is the same, but the tests are<br />different. Before that commit, it *always* checked for capability in<br />user_ns, and then (for non-FS_USERNS_MOUNT) it checked for capability<br />in the init namespace.<br /><br />I guess the semantic change in sget_userns() is immaterial - if you<br />have CAP_SYS_ADMIN in the init namespace, you will have it in user_ns<br />too.<br /><br />But the sget_fc() semantic change is a more serious change. Maybe that<br />was just unintentional, and Al _meant_ to pass in "fc-&gt;user_ns", but<br />didn't?<br /><br />Of course, then later on, commit 20284ab7427f ("switch mount_capable()<br />to fs_context") drops that argument entirely, and hardcodes the<br />decision to look at fc-&gt;global.<br /><br />But that fc-&gt;global decision wasn't there originally, and is incorrect<br />since it breaks existing users.<br /><br />What gets much more confusing about this is that the two different<br />users then moved around. The sget_userns() case got moved to<br />legacy_get_tree(), and then joined together in vfs_get_tree(), and<br />then split and moved out to do_new_mount() and vfs_fsconfig_locked().<br /><br />And that "joined together into vfs_get_tree()" must be wrong, because<br />the two cases used two different namespace rules. The sget_userns()<br />case *did* have that "global" flag check, while the sget_fc() did not.<br /><br />Messy. Al?<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
