    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2019/10/16/1774">First message in thread</a></li><li><a href="/lkml/2019/10/16/1774">syzbot</a><ul><li><a href="/lkml/2019/10/16/1813">syzbot</a><ul><li class="origin"><a href="/lkml/2019/10/17/621">Linus Torvalds</a><ul><li><a href="/lkml/2019/10/17/621">Eric Biggers</a></li></ul></li><li><a href="/lkml/2019/10/18/1012">David Howells</a></li><li><a href="/lkml/2019/10/22/302">David Howells</a></li><li><a href="/lkml/2019/10/22/404">David Howells</a></li></ul></li><li><a href="/lkml/2019/10/21/912">David Howells</a><ul><li><a href="/lkml/2019/10/21/916">Dmitry Vyukov</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 17 Oct 2019 08:53:06 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: WARNING: refcount bug in find_key_to_update</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Oct 16, 2019 at 7:42 PM syzbot<br />&lt;syzbot+6455648abc28dbdd1e7f&#64;syzkaller.appspotmail.com&gt; wrote:<br />&gt;<br />&gt; syzbot has bisected this bug to 0570bc8b7c9b ("Merge tag<br />&gt;  'riscv/for-v5.3-rc1' ...")<br /><br />Yeah, that looks unlikely. The only non-riscv changes are from<br />documentation updates and moving a config variable around.<br /><br />Looks like the crash is quite unlikely, and only happens in one out of<br />ten runs for the ones it has happened to.<br /><br />The backtrace looks simple enough, though:<br /><br />  RIP: 0010:refcount_inc_checked+0x2b/0x30 lib/refcount.c:156<br />   __key_get include/linux/key.h:281 [inline]<br />   find_key_to_update+0x67/0x80 security/keys/keyring.c:1127<br />   key_create_or_update+0x4e5/0xb20 security/keys/key.c:905<br />   __do_sys_add_key security/keys/keyctl.c:132 [inline]<br />   __se_sys_add_key security/keys/keyctl.c:72 [inline]<br />   __x64_sys_add_key+0x219/0x3f0 security/keys/keyctl.c:72<br />   do_syscall_64+0xd0/0x540 arch/x86/entry/common.c:296<br />   entry_SYSCALL_64_after_hwframe+0x49/0xbe<br /><br />which to me implies that there's some locking bug, and somebody<br />released the key without holding a lock.<br /><br />That code looks a bit confused to me. Releasing a key without holding<br />a lock looks permitted, but if that's the case then __key_get() is<br />complete garbage. It would need to use 'refcount_inc_not_zero()' and<br />failure would require failing the caller.<br /><br />But I haven't followed the key locking rules, so who knows. That "put<br />without lock" scenario would explain the crash, though.<br /><br />David?<br /><br />              Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
