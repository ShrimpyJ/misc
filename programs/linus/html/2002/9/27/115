    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2002/9/27/107">First message in thread</a></li><li><a href="/lkml/2002/9/27/109">Linus Torvalds</a><ul><li><a href="/lkml/2002/9/27/113">Ingo Molnar</a><ul><li class="origin"><a href="/lkml/2002/9/27/118">Linus Torvalds</a><ul><li><a href="/lkml/2002/9/27/118">Ingo Molnar</a><ul><li><a href="/lkml/2002/9/27/127">Linus Torvalds</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2002/9/28/28">Arjan van de Ven</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 27 Sep 2002 09:47:25 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [patch] 'virtual =&gt; physical page mapping cache', vcache-2.5.38-B8</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />On Fri, 27 Sep 2002, Ingo Molnar wrote:<br />&gt; <br />&gt; the futex code needs to 'get to the physical page', 'hash the futex queue'<br />&gt; and 'hash the vcache entry' atomically.<br /><br />I really don't think it needs to.<br /><br />It really needs to do<br /> - hash the vcache entry _first_<br /> - not care about the rest<br /><br />Once it hashes the vcache entry, we already know that all future COW's <br />will tell us about themselves, and since out callback will serialize them <br />with the futex lock, we're now done.<br /><br />That's kind of the whole point of the vcache - it's the "race avoidance"  <br />thing.<br /><br />And the vcache doesn't need to know what the physical page was: it only <br />needs the address and the VM, which we have a priori. So we _can_ do all <br />of this first.<br /><br />You may want to do something clever to avoid taking the vcache lock in the <br />COW path unless there is real reason to believe that you have to, but as <br />far as I can tell, you can do that by simply adding a memory barrier to <br />the end of the "insert vcache entry" thing.<br /><br />Because once you do that, and you make sure that the COW thing does the <br />vcache callback _after_ changing the page tables, the COW code can <br /><br /> - do the hash (which is invariant and has no races, since it depends <br />   solely on the virtual address and the VM)<br /> - check if the hash queue is empty<br /> - only if the hash queue is non-empty does the COW code need to get the <br />   vcache lock (and obviously it needs to re-load the hash entry from the <br />   queue after it got the lock, but the hash is still valid)<br /><br />And the COW case is the "hard" one. The swapper one is simple, just <br />handled by gatting the page table spinlock in get_user_pages() (which we <br />must already be doing, or we'd already be screwed).<br /><br />Maybe I'm missing something, but the locking really doesn't look all that <br />problematic if we just do things in the obvious order..<br /><br />		Linus<br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
