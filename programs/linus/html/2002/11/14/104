    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2002/11/12/238">First message in thread</a></li><li><a href="/lkml/2002/11/12/244">Alan Cox</a><ul><li><a href="/lkml/2002/11/13/248">Jirka Kosina</a><ul><li><a href="/lkml/2002/11/13/254">Chris Wright</a></li><li><a href="/lkml/2002/11/14/16">Helge Hafting</a></li></ul></li><li><a href="/lkml/2002/11/13/283">Andrea Arcangeli</a><ul><li><a href="/lkml/2002/11/13/306">Andrea Arcangeli</a></li><li class="origin"><a href="/lkml/2002/11/14/123">Linus Torvalds</a><ul><li><a href="/lkml/2002/11/14/123">Andrea Arcangeli</a><ul><li><a href="/lkml/2002/11/14/129">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2002/11/14/146">Petr Vandrovec</a></li></ul></li></ul></li><li><a href="/lkml/2002/11/16/99">Krzysiek Taraszka</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2002/11/14/104/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 14 Nov 2002 10:12:53 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: FW: i386 Linux kernel DoS</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />Ok, the reason for this one is that we don't really emulate a<br />trap/interrupt gate correctly when taking a lcall. We _do_ set up the <br />stack to be identical, but a real trap/interrupt will also clear TF and NT <br />in EFLAGS on entry to the kernel (_after_ having saved the value off), and <br />our emulation code didn't do that.<br /><br />So when we returned with an "iret", we had NT set in EFLAGS, causing the<br />iret to do all the wrong things.<br /><br />This is my 2.5.x fix, I suspect it applies as-is to 2.4.x too. I don't <br />think anything has changed here in a long time. <br /><br />Does anybody see anything else we're missing from the emulation path? <br /><br />(Or path_s_, as I noticed after fixing the bug once already ;^p. We should<br />probably try to do this all as common code rather than having two separate<br />paths for lcall 0x7 and lcall 0x27 - the code is identical apart from one<br />little constant.. This looks like the minimal patch, though.)<br /><br />		Linus<br /><br />-----<br /># The following is the BitKeeper ChangeSet Log<br /># --------------------------------------------<br /># 02/11/14	torvalds&#64;home.transmeta.com	1.848<br /># Fix impressive call gate misuse DoS reported on bugtraq.<br /># --------------------------------------------<br /># 02/11/14	torvalds&#64;home.transmeta.com	1.849<br /># Duh. Fix the other lcall entry point too.<br /># --------------------------------------------<br />#<br />diff -Nru a/arch/i386/kernel/entry.S b/arch/i386/kernel/entry.S<br />--- a/arch/i386/kernel/entry.S	Thu Nov 14 09:59:08 2002<br />+++ b/arch/i386/kernel/entry.S	Thu Nov 14 09:59:08 2002<br />&#64;&#64; -66,7 +66,9 &#64;&#64;<br /> OLDSS		= 0x38<br /> <br /> CF_MASK		= 0x00000001<br />+TF_MASK		= 0x00000100<br /> IF_MASK		= 0x00000200<br />+DF_MASK		= 0x00000400 <br /> NT_MASK		= 0x00004000<br /> VM_MASK		= 0x00020000<br /> <br />&#64;&#64; -134,6 +136,17 &#64;&#64;<br /> 	movl %eax,EFLAGS(%esp)	#<br /> 	movl %edx,EIP(%esp)	# Now we move them to their "normal" places<br /> 	movl %ecx,CS(%esp)	#<br />+<br />+	#<br />+	# Call gates don't clear TF and NT in eflags like<br />+	# traps do, so we need to do it ourselves.<br />+	# %eax already contains eflags (but it may have<br />+	# DF set, clear that also)<br />+	#<br />+	andl $~(DF_MASK | TF_MASK | NT_MASK),%eax<br />+	pushl %eax<br />+	popfl<br />+<br /> 	movl %esp, %ebx<br /> 	pushl %ebx<br /> 	andl $-8192, %ebx	# GET_THREAD_INFO<br />&#64;&#64; -156,6 +169,17 &#64;&#64;<br /> 	movl %eax,EFLAGS(%esp)	#<br /> 	movl %edx,EIP(%esp)	# Now we move them to their "normal" places<br /> 	movl %ecx,CS(%esp)	#<br />+<br />+	#<br />+	# Call gates don't clear TF and NT in eflags like<br />+	# traps do, so we need to do it ourselves.<br />+	# %eax already contains eflags (but it may have<br />+	# DF set, clear that also)<br />+	#<br />+	andl $~(DF_MASK | TF_MASK | NT_MASK),%eax<br />+	pushl %eax<br />+	popfl<br />+<br /> 	movl %esp, %ebx<br /> 	pushl %ebx<br /> 	andl $-8192, %ebx	# GET_THREAD_INFO<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
