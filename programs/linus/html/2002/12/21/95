    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2002/12/19/145">First message in thread</a></li><li><a href="/lkml/2002/12/20/110">Linus Torvalds</a><ul><li><a href="/lkml/2002/12/20/43">Ivan Kokshaysky</a><ul><li><a href="/lkml/2002/12/20/150">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2002/12/20/106">David Mosberger</a><ul><li><a href="/lkml/2002/12/20/49">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2002/12/21/89">(Eric W. Biederman)</a><ul><li class="origin"><a href="/lkml/2002/12/22/8">Linus Torvalds</a><ul><li><a href="/lkml/2002/12/22/8">Paul Mackerras</a><ul><li><a href="/lkml/2002/12/22/43">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2002/12/22/69">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2002/12/22/20">(Eric W. Biederman)</a><ul><li><a href="/lkml/2002/12/22/60">Ivan Kokshaysky</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 21 Dec 2002 14:44:23 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: PATCH 2.5.x disable BAR when sizing</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />[ Ivan added to the cc, to see if he has any ideas on turning things off ]<br /><br />On 21 Dec 2002, Eric W. Biederman wrote:<br />&gt;<br />&gt; Actually it is not quite as bad as that.<br />&gt; - We can reasonably assume there are no pci to pci transactions going<br />&gt;   on, so the only accesses to a pci resource are generated by the<br />&gt;   kernel from printk.<br /><br />Actually, I think it's certainly valid to not allow "printk()" to happen<br />around the BAR probing, at least at bootup when we control all the CPU's<br />tightly anyway.<br /><br />And hotplug devices should be disabled at plug-in, so later BAR probing<br />should be pretty harmless too (and, as you point out about bridging, they<br />should be shielded by the hotplug bridge itself).<br /><br />&gt; - If the large device is behind a pci bridge it should be shielded<br />&gt;   from the chaos.<br />&gt;<br />&gt; - If we don't call printk until we restore the old BAR value (which<br />&gt;   is currently the case (drivers/pci/probe.c:60)) there should be no<br />&gt;   transactions on the pci bus, that get a conflicting routing.<br /><br />The problem has been at least in the case I saw it that there are devices<br />that aren't entirely quiescent, often because we haven't even _gotten_ to<br />them yet, and the boot sequence left them active.<br /><br />The one I saw was USB, and that's likely to be the worst case, since it's<br />one of very few devices that tends to "do stuff" even when inactive (ie a<br />USB setup walks the USB command tables in memory continuously, even if<br />nothing is happening).  It's also one of the few classes of devices that<br />many PC's have SMM support for, so they are still alive even after the<br />BIOS has otherwise given up control.<br /><br />&gt; As long as the pci bus is quiet while we are sizing a bar the current<br />&gt; method safe.<br /><br />Well, the thing is, as long as the PCI bus is 100% quiet, it simply<br />doesn't _matter_ which method we use.<br /><br />The interesting cases are all "some activity that we don't know about is<br />going on". That's the thing that breaks disabling the PCI device, but it's<br />also the thing that can break _not_ disabling the PCI device.<br /><br />So if we can guarantee a quiescent PCI bus, then I could also accept the<br />patch that disables MEM/IO resources for BAR probing. At that point it<br />simply shouldn't matter any more, and then I'd happily drop my concerns<br />about it.<br /><br />This is why I repeated my "turn the power off at the whole house" analogy,<br />even if David didn't like it. It's _fine_ to turn the power off if we know<br />things are quiet, it's just that as things stand now, we don't actually<br />know that.<br /><br />If somebody wants to try to follow that method, I can try to dig out the<br />machine that I had problems on before and test things at least on that<br />setup to make myself happier about the fact that it really solves the<br />problem. The solution may be as simple as just making our current<br />two-phase PCI scanning be a _three_phase one:<br /><br /> - (new) phase 1 - scan for and turn off all devices<br /> - phase 2 - go back and check the resources (BAR probing etc)<br /> - phase 3 - allocate unassigned resources.<br /><br />One of the problems with turning off devices is that we actually have a<br />hard time doing so. We can trivially turn off IO/MEM/DMA, but PCI doesn't<br />have a good way to turn off interrupts (which in turn can become SCI<br />events).<br /><br />Which still makes me worry about legacy USB in particular - simply because<br />I wonder what happens if the USB controller raises an interrupt which<br />causes an SMM event, which then causes trouble because the SMM handler<br />will be unhappy when the device isn't there any more.<br /><br />We've actually had those kinds of problems in real life, see the<br />quirk_piix3_usb() quirks, for example. So I'm really not trying to be<br />difficult here, it's just that PC BIOS issues, and SMM in _particular_<br />tends to be quite a horrible mess for the early boot sequence.<br /><br />		Linus<br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
