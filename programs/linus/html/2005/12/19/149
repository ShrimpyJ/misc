    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2005/12/19/95">First message in thread</a></li><li><a href="/lkml/2005/12/19/132">Jens Axboe</a><ul><li><a href="/lkml/2005/12/19/133">Jens Axboe</a></li><li><a href="/lkml/2005/12/19/141">Ben Collins</a><ul><li><a href="/lkml/2005/12/19/145">Jens Axboe</a><ul><li><a href="/lkml/2005/12/19/158">Ben Collins</a><ul><li><a href="/lkml/2005/12/19/162">Jens Axboe</a></li></ul></li></ul></li><li class="origin"><a href="/lkml/2005/12/19/152">Linus Torvalds</a><ul><li><a href="/lkml/2005/12/19/152">Jens Axboe</a></li><li><a href="/lkml/2005/12/19/161">Ben Collins</a></li></ul></li></ul></li><li><a href="/lkml/2005/12/19/148">Ben Collins</a><ul><li><a href="/lkml/2005/12/19/151">Jens Axboe</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 19 Dec 2005 12:02:23 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 2.6.15-rc6] block: Make CDROMEJECT more robust</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Mon, 19 Dec 2005, Ben Collins wrote:<br />&gt; <br />&gt; &gt; &gt;  		case CDROMEJECT:<br />&gt; &gt; &gt; -			rq = blk_get_request(q, WRITE, __GFP_WAIT);<br />&gt; &gt; &gt; -			rq-&gt;flags |= REQ_BLOCK_PC;<br />&gt; &gt; &gt; -			rq-&gt;data = NULL;<br />&gt; &gt; &gt; -			rq-&gt;data_len = 0;<br />&gt; &gt; &gt; -			rq-&gt;timeout = BLK_DEFAULT_TIMEOUT;<br />&gt; &gt; &gt; -			memset(rq-&gt;cmd, 0, sizeof(rq-&gt;cmd));<br />&gt; &gt; &gt; -			rq-&gt;cmd[0] = GPCMD_START_STOP_UNIT;<br />&gt; &gt; &gt; -			rq-&gt;cmd[4] = 0x02 + (close != 0);<br />&gt; &gt; &gt; -			rq-&gt;cmd_len = 6;<br />&gt; &gt; &gt; -			err = blk_execute_rq(q, bd_disk, rq, 0);<br />&gt; &gt; &gt; -			blk_put_request(rq);<br />&gt; &gt; &gt; +			err = 0;<br />&gt; &gt; &gt; +<br />&gt; &gt; &gt; +			err |= blk_send_allow_medium_removal(q, bd_disk);<br />&gt; &gt; &gt; +			err |= blk_send_start_stop(q, bd_disk, 0x01);<br />&gt; &gt; &gt; +			err |= blk_send_start_stop(q, bd_disk, 0x02);<br />&gt; &gt; <br />&gt; &gt; Do this in the eject tool, if it's required for some devices.<br />&gt; <br />&gt; It already is in eject tool, but as described, that requires root<br />&gt; access. Not something I want to force a user to do in order to eject<br />&gt; their CDROM/iPod/USBStick in gnome. What exactly is wrong with the<br />&gt; commands? If they are harmless for devices that don't need it, and fix a<br />&gt; huge number of problems (did you see the Cc list on the bug report?) for<br />&gt; users with affected devices, then what's the harm?<br /><br />I do agree that the suggested patch seems to be a real cleanup, regardless <br />of whether the original code bug has now been fixed or not.<br /><br />Are there devices that really want the old sequence? <br /><br />Also, do we really need to send fist a start_stop 1 and then a 2?<br /><br />Wouldn't the _logical_ thing be to replace the old code with just a <br />cleaned-up-version of what the old code did, ie just do<br /><br />	err = blk_send_start_stop(q, bd_disk, 0x02);<br /><br />for the eject case? That way we could do the patch as a pure cleanup, and <br />then a separate patch might change the singe "start_stop 2" with the more <br />complex sequence.<br /><br />(IOW, I'd prefer to separate out the cleanup from the "make the eject <br />sequence more complete" part).<br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
