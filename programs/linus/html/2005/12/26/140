    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2005/12/26/87">First message in thread</a></li><li><a href="/lkml/2005/12/26/87">Jules Villard</a><ul><li><a href="/lkml/2005/12/26/103">Jules Villard</a><ul><li><a href="/lkml/2005/12/27/1">Marc Koschewski</a><ul><li><a href="/lkml/2005/12/27/2">Marc Koschewski</a></li></ul></li></ul></li><li class="origin"><a href="/lkml/2005/12/26/135">Linus Torvalds</a><ul><li><a href="/lkml/2005/12/26/135">Jules Villard</a></li><li><a href="/lkml/2005/12/26/137">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2005/12/26/139">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2005/12/26/141">Jules Villard</a><ul><li><a href="/lkml/2005/12/26/138">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2005/12/27/57">Jules Villard</a><ul><li><a href="/lkml/2005/12/27/144">Benjamin Herrenschmidt</a></li><li><a href="/lkml/2005/12/28/8">Benjamin Herrenschmidt</a></li></ul></li></ul></li><li><a href="/lkml/2005/12/27/52">Benjamin Herrenschmidt</a><ul><li><a href="/lkml/2005/12/27/53">Jules Villard</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patches in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2005/12/26/140/1">Get diff 1</a></li><li><a href="/lkml/diff/2005/12/26/140/2">Get diff 2</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 26 Dec 2005 15:55:21 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Suspend to {mem,disk} broken in 2.6.15-rc6/rc7 on my T42</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Mon, 26 Dec 2005, Jules Villard wrote:<br />&gt; <br />&gt; Please find my .config and the lspci output attached (my graphic card<br />&gt; is a AGP plugged ATI Radeon Mobility 7500 and I use the "radeon"<br />&gt; driver from xorg).<br /><br />Ok, from the sysrq-T stuff it _looks_ like X is just busy-looping in user <br />space. So it's probably some disagreement between radeonfb and X.org<br /><br />The fact that everything was ok in -rc5 would imply that it's likely one <br />of the radeon aperture size issue patches.<br /><br />&gt; Investigating a bit further, I found out that resume is quite innocent<br />&gt; about all this: what hangs X is switching from a vt to X.<br /><br />I'm cc'ing BenH and DaveA, but in the meantime, while waiting for the <br />professionals, can you try to revert the two attachments (revert "diff-1" <br />first, try that, and revert "diff-2" after that if it didn't start <br />working after the first revert).<br /><br />Thanks,<br /><br />		Linusdiff-tree 281ab031a8c9e5b593142eb4ec59a87faae8676a (from 7b6666530e2736f190a2629c8abe34275054449f)<br />Author: Benjamin Herrenschmidt &lt;benh&#64;kernel.crashing.org&gt;<br />Date:   Fri Dec 16 16:52:22 2005 +1100<br /><br />    [PATCH] radeon drm: fix agp aperture map offset<br />    <br />    This finally fixes the radeon memory mapping bug that was incorrectly<br />    fixed by the previous patch.  This time, we use the actual vram size as<br />    the size to calculate how far to move the AGP aperture from the<br />    framebuffer in card's memory space.<br />    <br />    If there are still issues with this patch, they are due to bugs in the X<br />    driver that I'm working on fixing too.<br />    <br />    Signed-off-by: Benjamin Herrenschmidt &lt;benh&#64;kernel.crashing.org&gt;<br />    Cc: Mark M. Hoffman &lt;mhoffman&#64;lightlink.com&gt;<br />    Cc: Paul Mackerras &lt;paulus&#64;samba.org&gt;<br />    Signed-off-by: Linus Torvalds &lt;torvalds&#64;osdl.org&gt;<br /><br />diff --git a/drivers/char/drm/radeon_cp.c b/drivers/char/drm/radeon_cp.c<br />index 9f2b4ef..95ae9e0 100644<br />--- a/drivers/char/drm/radeon_cp.c<br />+++ b/drivers/char/drm/radeon_cp.c<br />&#64;&#64; -1312,6 +1312,8 &#64;&#64; static void radeon_set_pcigart(drm_radeo<br /> static int radeon_do_init_cp(drm_device_t * dev, drm_radeon_init_t * init)<br /> {<br /> 	drm_radeon_private_t *dev_priv = dev-&gt;dev_private;<br />+	unsigned int mem_size;<br />+<br /> 	DRM_DEBUG("\n");<br /> <br /> 	dev_priv-&gt;is_pci = init-&gt;is_pci;<br />&#64;&#64; -1521,8 +1523,11 &#64;&#64; static int radeon_do_init_cp(drm_device_<br /> 					  + dev_priv-&gt;fb_location) &gt;&gt; 10));<br /> <br /> 	dev_priv-&gt;gart_size = init-&gt;gart_size;<br />-	dev_priv-&gt;gart_vm_start = dev_priv-&gt;fb_location<br />-	    + RADEON_READ(RADEON_CONFIG_APER_SIZE) * 2;<br />+<br />+	mem_size = RADEON_READ(RADEON_CONFIG_MEMSIZE);<br />+	if (mem_size == 0)<br />+		mem_size = 0x800000;<br />+	dev_priv-&gt;gart_vm_start = dev_priv-&gt;fb_location + mem_size;<br /> <br /> #if __OS_HAS_AGP<br /> 	if (!dev_priv-&gt;is_pci)<br />diff --git a/drivers/char/drm/radeon_drv.h b/drivers/char/drm/radeon_drv.h<br />index 7bda7e3..d92ccee 100644<br />--- a/drivers/char/drm/radeon_drv.h<br />+++ b/drivers/char/drm/radeon_drv.h<br />&#64;&#64; -379,6 +379,7 &#64;&#64; extern int r300_do_cp_cmdbuf(drm_device_<br /> #	define RADEON_PLL_WR_EN			(1 &lt;&lt; 7)<br /> #define RADEON_CLOCK_CNTL_INDEX		0x0008<br /> #define RADEON_CONFIG_APER_SIZE		0x0108<br />+#define RADEON_CONFIG_MEMSIZE		0x00f8<br /> #define RADEON_CRTC_OFFSET		0x0224<br /> #define RADEON_CRTC_OFFSET_CNTL		0x0228<br /> #	define RADEON_CRTC_TILE_EN		(1 &lt;&lt; 15)diff-tree 47807ce381acc34a7ffee2b42e35e96c0f322e52 (from 0e670506668a43e1355b8f10c33d081a676bd521)<br />Author: Dave Airlie &lt;airlied&#64;linux.ie&gt;<br />Date:   Tue Dec 13 04:18:41 2005 +0000<br /><br />    [drm] fix radeon aperture issue<br />    <br />    Ben noticed that on certain cards we've landed the AGP space on top of<br />    the second aperture instead of after it..  Which messes things up a lot<br />    on those machines.<br />    <br />    This just moves the gart further out, a more correct fix is in the works<br />    from Ben for after 2.6.15.<br />    <br />    Signed-off-by: Dave Airlie &lt;airlied&#64;linux.ie&gt;<br />    CC: Ben Herrenschmidt &lt;benh&#64;kernel.crashing.org&gt;<br />    Signed-off-by: Linus Torvalds &lt;torvalds&#64;osdl.org&gt;<br /><br />diff --git a/drivers/char/drm/radeon_cp.c b/drivers/char/drm/radeon_cp.c<br />index 03839ea..9f2b4ef 100644<br />--- a/drivers/char/drm/radeon_cp.c<br />+++ b/drivers/char/drm/radeon_cp.c<br />&#64;&#64; -1522,7 +1522,7 &#64;&#64; static int radeon_do_init_cp(drm_device_<br /> <br /> 	dev_priv-&gt;gart_size = init-&gt;gart_size;<br /> 	dev_priv-&gt;gart_vm_start = dev_priv-&gt;fb_location<br />-	    + RADEON_READ(RADEON_CONFIG_APER_SIZE);<br />+	    + RADEON_READ(RADEON_CONFIG_APER_SIZE) * 2;<br /> <br /> #if __OS_HAS_AGP<br /> 	if (!dev_priv-&gt;is_pci)</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
