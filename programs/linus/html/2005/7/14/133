    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2005/7/8/259">First message in thread</a></li><li><a href="/lkml/2005/7/14/122">Linus Torvalds</a><ul><li><a href="/lkml/2005/7/14/126">Arjan van de Ven</a><ul><li class="origin"><a href="/lkml/2005/7/14/169">Linus Torvalds</a><ul><li><a href="/lkml/2005/7/14/169">Russell King</a><ul><li><a href="/lkml/2005/7/14/193">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2005/7/14/203">Johannes Stezenbach</a></li></ul></li><li><a href="/lkml/2005/7/14/139">"Al Boldi"</a></li><li><a href="/lkml/2005/7/14/180">john stultz</a><ul><li><a href="/lkml/2005/7/14/194">Linus Torvalds</a><ul><li><a href="/lkml/2005/7/14/205">Christoph Lameter</a></li><li><a href="/lkml/2005/7/14/224">john stultz</a></li><li><a href="/lkml/2005/7/14/246">Alan Cox</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/7/14/129">Chris Friesen</a><ul><li><a href="/lkml/2005/7/14/136">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2005/7/14/170">john stultz</a></li><li><a href="/lkml/2005/7/14/243">Alan Cox</a><ul><li><a href="/lkml/2005/7/14/257">Linus Torvalds</a><ul><li><a href="/lkml/2005/7/14/263">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2005/7/14/287">Eric St-Laurent</a></li></ul></li><li><a href="/lkml/2005/7/14/258">Lee Revell</a><ul><li><a href="/lkml/2005/7/14/261">Linus Torvalds</a><ul><li><a href="/lkml/2005/7/14/265">Lee Revell</a><ul><li><a href="/lkml/2005/7/14/269">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2005/7/14/268">Lee Revell</a></li><li><a href="/lkml/2005/7/15/3">Con Kolivas</a><ul><li><a href="/lkml/2005/7/15/5">Lee Revell</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 14 Jul 2005 10:21:41 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] i386: Selectable Frequency of the Timer Interrupt</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 14 Jul 2005, Arjan van de Ven wrote:<br />&gt; <br />&gt; I *will* argue that for relative delays in drivers, msleep() is better.<br /><br />Oh, I agree.<br /><br />I think we should continue the simplification of the simple stuff. If <br />somebody just wants to sleep a while, do it.<br /><br />But if somebody is doing this because they think "jiffies" are evil, then <br />that somebody is being a total idiot. Jiffies aren't evil. They are <br />basically the most efficient way to handle any kind of absolute timeouts, <br />and any "repeating timeout" _needs_ to be written in absolute terms.<br /><br />And quite frankly, in this discussion I have several times seen the <br />argument that we should be getting rid of jiffies because somebody thinks <br />jiffies are "hard" and somehow incompatible with "tickless".<br /><br />THAT is the thinking I want to squash.<br /><br />We're not getting rid of jiffies, and we're not going to be "tickless". We <br />might have a variable clock, but that has _nothing_ to do with the basic <br />fact that even a variable clock needs a fundamental baseline, and that the <br />kernel _needs_ a heartbeat.<br /><br />And that baseline and heartbeat is HZ and "jiffies". End of story. Anybody<br />who argues for getting rid of it just isn't thinking things through.<br /><br />&gt; I have nothing religious against jiffies per se. My argument however is<br />&gt; that with a few simple, relative interfaces *in addition* to an absolute<br />&gt; interface, almost all drivers suddenly are isolated from jiffies and HZ<br />&gt; because they simply don't care. Because they really DON'T care about<br />&gt; absolute time. At all. <br /><br />That's not even true.<br /><br />A _lot_ of drivers end up caring about absolute time, because a _lot_ of <br />drivers have a very simple issue like:<br /><br /> - poll this port every 10ms until it returns "ready", or until we time<br />   out after 500ms.<br /><br />And the thing is, you can do it the stupid way:<br /><br />	for (i = 0; i &lt; 50; i++) {<br />		if (ready())<br />			return 0;<br />		msleep(10);<br />	}<br />	.. timeout ..<br /><br />or you can do it the _right_ way. The stupid way is simpler, but anybody <br />who doesn't see what the problem is has some serious problems in kernel <br />programming. Hint: it might not be polling for half a second, it might be <br />polling for half a _minute_ for all you know.<br /><br />In other words, the _right_ way to do this is literally<br /><br />	unsigned long timeout = jiffies + HZ/2;<br />	for (;;) {<br />		if (ready())<br />			return 0;<br />		if (time_after(timeout, jiffies))<br />			break;<br />		msleep(10);<br />	}<br /><br />which is unquestionably more complex, yes, but it's more complex because <br />it is CORRECT!<br /><br />And yes, we have had people "simplifying" drivers and screwing things like <br />this up. And you don't even notice, until the machine is under heavy load, <br />and then the "simplified" driver ends up being very very broken, and <br />people wonder why performance sucks.<br /><br />So stop saying that drivers not needing absolute timeouts. They need it<br />qutie often.<br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
