    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2005/7/28/64">First message in thread</a></li><li><a href="/lkml/2005/7/28/64">Andrew Morton</a><ul><li><a href="/lkml/2005/7/28/76">Adrian Bunk</a></li><li><a href="/lkml/2005/7/28/256">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2005/7/28/261">Andrew Morton</a><ul><li><a href="/lkml/2005/7/28/318">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2005/7/28/351">Andrew Morton</a></li><li><a href="/lkml/2005/7/29/32">Matthias Urlichs</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/7/28/265">Christoph Lameter</a><ul><li><a href="/lkml/2005/7/28/274">Russell King</a><ul><li><a href="/lkml/2005/7/28/304">Christoph Lameter</a></li></ul></li></ul></li><li><a href="/lkml/2005/7/28/281">Michael Thonke</a><ul><li><a href="/lkml/2005/7/28/285">Andrew Morton</a><ul><li><a href="/lkml/2005/7/28/301">Nick Sillik</a><ul><li><a href="/lkml/2005/7/28/307">Michael Thonke</a></li></ul></li></ul></li><li><a href="/lkml/2005/7/28/291">Adrian Bunk</a></li></ul></li><li><a href="/lkml/2005/7/28/294">Adrian Bunk</a></li><li><a href="/lkml/2005/7/28/315">Michael Thonke</a><ul><li><a href="/lkml/2005/7/28/325">Dirk</a></li><li><a href="/lkml/2005/7/28/354">Andrew Morton</a><ul><li><a href="/lkml/2005/7/29/158">Michael Thonke</a><ul><li><a href="/lkml/2005/7/29/236">Andrew Morton</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/7/29/18">"Martin J. Bligh"</a><ul><li><a href="/lkml/2005/7/29/22">Andrew Morton</a><ul><li><a href="/lkml/2005/7/29/154">"Martin J. Bligh"</a><ul><li><a href="/lkml/2005/7/29/166">(Eric W. Biederman)</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/7/29/20">"Martin J. Bligh"</a><ul><li><a href="/lkml/2005/7/29/23">Andrew Morton</a><ul><li><a href="/lkml/2005/8/2/274">"Martin J. Bligh"</a><ul><li><a href="/lkml/2005/8/3/3">"Martin J. Bligh"</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/7/29/21">"Martin J. Bligh"</a></li><li><a href="/lkml/2005/7/29/323">Khalid Aziz</a><ul><li><a href="/lkml/2005/7/29/327">Andrew Morton</a><ul><li><a href="/lkml/2005/7/30/87">Khalid Aziz</a><ul><li><a href="/lkml/2005/7/30/118">Andrew Morton</a></li></ul></li><li><a href="/lkml/2005/8/1/131">Bjorn Helgaas</a></li></ul></li></ul></li><li><a href="/lkml/2005/7/30/46">Richard Purdie</a><ul><li><a href="/lkml/2005/7/30/105">Andrew Morton</a></li></ul></li><li><a href="/lkml/2005/7/31/41">Manuel Lauss</a><ul><li><a href="/lkml/2005/7/31/43">Andrew Morton</a><ul><li><a href="/lkml/2005/7/31/62">Manuel Lauss</a></li><li><a href="/lkml/2005/7/31/80">Manuel Lauss</a><ul><li><a href="/lkml/2005/7/31/124">Andrew Morton</a></li></ul></li></ul></li><li class="origin"><a href="/lkml/2005/7/31/138">Linus Torvalds</a><ul><li><a href="/lkml/2005/7/31/138">Manuel Lauss</a><ul><li><a href="/lkml/2005/7/31/143">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2005/7/31/178">Stelian Pop</a></li><li><a href="/lkml/2005/8/1/116">Stelian Pop</a><ul><li><a href="/lkml/2005/8/2/56">Stelian Pop</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/7/31/242">Richard Purdie</a><ul><li><a href="/lkml/2005/8/1/139">Christoph Lameter</a><ul><li><a href="/lkml/2005/8/1/207">Richard Purdie</a><ul><li><a href="/lkml/2005/8/1/224">Christoph Lameter</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2005/9/14/147">"Martin J. Bligh"</a><ul><li><a href="/lkml/2005/9/14/150">Anton Blanchard</a></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2005/7/31/134/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 31 Jul 2005 11:25:11 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 2.6.13-rc3-mm3</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sun, 31 Jul 2005, Manuel Lauss wrote:<br />&gt; <br />&gt; something broke the sonypi driver a bit after -mm2:<br />&gt; I can no longer set bluetooth-power for instance, and it logs these<br />&gt; messages:<br />&gt; <br />&gt; sonypi command failed at drivers/char/sonypi.c : sonypi_call2 (line 605)<br />&gt; sonypi command failed at drivers/char/sonypi.c : sonypi_call2 (line 607)<br />&gt; sonypi command failed at drivers/char/sonypi.c : sonypi_call1 (line 594)<br />&gt; <br />&gt; setting/getting brightness, getting battery/ac status still work.<br />&gt; <br />&gt; <br />&gt; The ioports assignments have changed a bit between -mm2 and -mm3:<br /><br />The diff shows:<br /><br />	-/proc/ioports on -mm2:<br />	+/proc/ioports on -mm3:<br />	 0000-001f : dma1<br />	 0020-0021 : pic1<br />	 0040-0043 : timer0<br />	&#64;&#64; -25,13 +25,13 &#64;&#64;<br />	 0540-055f : 0000:00:1f.3<br />	    0540-054f : i801-smbus<br />	 0cf8-0cff : PCI conf1<br />	-1080-109f : Sony Programable I/O Device<br />	+1000-1fff : PCI CardBus #03<br />	+   1080-109f : Sony Programable I/O Device<br />	+2000-2fff : PCI CardBus #03<br />	 c000-cfff : PCI Bus #01<br />	    c800-c8ff : 0000:01:00.0<br />	      c800-c8ff : radeonfb<br />	 d000-dfff : PCI Bus #02<br />	-   d000-d1ff : PCI CardBus #03<br />	-   d400-d5ff : PCI CardBus #03<br />	    dc00-dc3f : 0000:02:03.0<br />	      dc00-dc3f : e1000<br />	 e000-e03f : 0000:00:1f.5<br /><br />ie the difference is that the PCI cardbus resources have been moved from <br />inside PCI Bus #2 to outside of it, and as a side effect the sonypi<br />device just happened to be allocated inside the Cardbus IO space.<br /><br />Now, this is really unlucky. There are two issues here:<br /><br /> - the -mm2 iomap just _looks_ better. I can't tell what the exact<br />   difference is, but it looks like one of the PCI resource allocation<br />   patches got reverted or re-applied.<br /><br />   However, I'm almost positive that this is the Intel transparent bridge <br />   thing, and it doesn't really matter where the CardBus resources got <br />   allocated. So the _real_ breakage is probably due to a totally<br />   unrelated issue:<br /><br /> - The SonyPI driver just allocates IO regions in random areas. It's got a <br />   list of places to try allocating in, and the 1080 area just happens to <br />   be the first on the list, and since it's not used by anything else, it <br />   succeeds (never mind that it's on totally the wrong bus).<br />and I think the real bug here is the SonyPI driver.<br /><br />It should either use an IO port in the legacy motherboard resource area<br />(ie allocate itself somewhere in IO ports 0x100-0x3ff), _or_ it should <br />play well as a PCI device, and actually try to work with the PCI IO port <br />allocation layer.<br /><br />So instead of just saying "I want port 1080" (which may be on some other <br />bus entirely), it _could_ (and should) do something like<br /><br />	/*<br />	 * Use "device resource 6" for this: it's traditionally<br />	 * the PCI ROM resource, but we don't have a ROM, so we take it<br />	 * over for our special IO region.<br />	 */<br />	struct resource *res = dev-&gt;resource + 6;<br />	int ret;<br />	res-&gt;flags = IORESOURCE_IO;<br />	ret = pci_bus_alloc_resource(dev-&gt;bus,	/* bus */<br />			res, 			/* resource */<br />			SONYPI_TYPE2_REGION_SIZE, /* size */,<br />			SONYPI_TYPE2_REGION_SIZE, /* alignment */,<br />			PCIBIOS_MIN_IO,		/* Min starting pos */<br />			IORESOURCE_IO,		/* IO type */<br />			pcibios_align_resource,	/* Standard alignment */<br />			dev);<br />	if (ret &lt; 0)<br />		return -ENODEV;<br />	.. use port "res-&gt;start" ..<br /><br />which should do the right thing.<br /><br />Stelian? The above is untested, but it should give roughly the right <br />behaviour - you might need to tweak it a bit, but I think it should be a <br />lot better than just picking random IO ports out of your hat and seeing if <br />they are already used by something else...<br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
