    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2006/11/15/505">First message in thread</a></li><li><a href="/lkml/2006/11/21/239">Adrian Bunk</a><ul><li><a href="/lkml/2006/11/21/241">Dave Jones</a><ul><li><a href="/lkml/2006/11/21/244">Adrian Bunk</a><ul><li><a href="/lkml/2006/11/21/252">Dave Jones</a></li></ul></li></ul></li><li><a href="/lkml/2006/11/21/243">Vivek Goyal</a><ul><li><a href="/lkml/2006/11/21/245">Adrian Bunk</a></li><li class="origin"><a href="/lkml/2006/11/22/47">Linus Torvalds</a><ul><li><a href="/lkml/2006/11/22/47">Pavel Emelianov</a><ul><li><a href="/lkml/2006/11/22/117">Vivek Goyal</a></li><li><a href="/lkml/2006/11/22/155">Linus Torvalds</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2006/11/22/56">Andi Kleen</a><ul><li><a href="/lkml/2006/11/22/126">(Mel Gorman)</a><ul><li><a href="/lkml/2006/11/22/158">Andre Noll</a><ul><li><a href="/lkml/2006/11/23/86">(Mel Gorman)</a></li></ul></li></ul></li><li><a href="/lkml/2006/11/22/129">Andre Noll</a><ul><li><a href="/lkml/2006/11/22/145">Mel Gorman</a></li><li><a href="/lkml/2006/11/22/147">Andi Kleen</a><ul><li><a href="/lkml/2006/11/22/169">Andre Noll</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2006/11/22/294">David Brownell</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2006/11/21/261/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 21 Nov 2006 14:18:17 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 2.6.19-rc6: known regressions (v4)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 21 Nov 2006, Vivek Goyal wrote:<br /><br />&gt; On Tue, Nov 21, 2006 at 10:24:24PM +0100, Adrian Bunk wrote:<br />&gt; &gt; This email lists some known regressions in 2.6.19-rc6 compared to 2.6.18<br />&gt; &gt; that are not yet fixed in Linus' tree.<br />&gt; &gt; <br />&gt; &gt; If you find your name in the Cc header, you are either submitter of one<br />&gt; &gt; of the bugs, maintainer of an affectected subsystem or driver, a patch<br />&gt; &gt; of you caused a breakage or I'm considering you in any other way possibly<br />&gt; &gt; involved with one or more of these issues.<br />&gt; &gt; <br />&gt; &gt; Due to the huge amount of recipients, please trim the Cc when answering.<br />&gt; &gt; <br />&gt; &gt; <br />&gt; &gt; Subject    : kernel hangs when booting with irqpoll<br />&gt; &gt; References : <a href="https://lkml.org/lkml/2006/11/20/233">http://lkml.org/lkml/2006/11/20/233</a><br />&gt; &gt; Submitter  : Vivek Goyal &lt;vgoyal&#64;in.ibm.com&gt;<br />&gt; &gt; Caused-By  : Pavel Emelianov &lt;xemul&#64;openvz.org&gt;<br />&gt; &gt;              commit f72fa707604c015a6625e80f269506032d5430dc<br />&gt; &gt; Handled-By : Vivek Goyal &lt;vgoyal&#64;in.ibm.com&gt;<br />&gt; &gt; Status     : problem is being debugged<br />&gt; &gt; <br />&gt; <br />&gt; Adrian,<br />&gt; <br />&gt; Pavel already provided a fix for this issue.<br />&gt; <br />&gt; http://marc.theaimsgroup.com/?l=linux-kernel&amp;m=116409933100117&amp;w=2<br /><br />I really think this is wrong.<br /><br />The original patch was wrong, and the _real_ problem is in __do_IRQ() that <br />got the desc-&gt;lock too early.<br /><br />I _think_ the correct fix is to simply revert the broken commit, and fix <br />the _one_ place that called "misnote_interrupt()" with the lock held.<br /><br />Something like this..<br /><br />I also think that the real fix will be to move the whole<br /><br />	if (!noirqdebug)<br />		note_interrupt(irq, desc, action_ret);<br /><br /><br />into handle_IRQ_event itself, since every caller (except for <br />"misrouted_irq()" itself, and that should probably be done separately) <br />should always do it. Right now we have a lot of people that just do<br /><br />	action_ret = handle_IRQ_event(irq, action);<br />	if (!noirqdebug)<br />		note_interrupt(irq, desc, action_ret);<br /><br />explicitly.<br /><br />The only thing that keeps us from doing that is that we don't pass in <br />"desc", but we should just do that.<br /><br />But in the meantime, this appears to be the minimal fix. Can people please <br />test and verify?<br /><br />		Linus<br /><br />---<br />diff --git a/kernel/irq/handle.c b/kernel/irq/handle.c<br />index 42aa6f1..a681912 100644<br />--- a/kernel/irq/handle.c<br />+++ b/kernel/irq/handle.c<br />&#64;&#64; -231,10 +231,10 &#64;&#64; fastcall unsigned int __do_IRQ(unsigned<br /> 		spin_unlock(&amp;desc-&gt;lock);<br /> <br /> 		action_ret = handle_IRQ_event(irq, action);<br />-<br />-		spin_lock(&amp;desc-&gt;lock);<br /> 		if (!noirqdebug)<br /> 			note_interrupt(irq, desc, action_ret);<br />+<br />+		spin_lock(&amp;desc-&gt;lock);<br /> 		if (likely(!(desc-&gt;status &amp; IRQ_PENDING)))<br /> 			break;<br /> 		desc-&gt;status &amp;= ~IRQ_PENDING;<br />diff --git a/kernel/irq/spurious.c b/kernel/irq/spurious.c<br />index 9c7e2e4..543ea2e 100644<br />--- a/kernel/irq/spurious.c<br />+++ b/kernel/irq/spurious.c<br />&#64;&#64; -147,11 +147,7 &#64;&#64; void note_interrupt(unsigned int irq, st<br /> 	if (unlikely(irqfixup)) {<br /> 		/* Don't punish working computers */<br /> 		if ((irqfixup == 2 &amp;&amp; irq == 0) || action_ret == IRQ_NONE) {<br />-			int ok;<br />-<br />-			spin_unlock(&amp;desc-&gt;lock);<br />-			ok = misrouted_irq(irq);<br />-			spin_lock(&amp;desc-&gt;lock);<br />+			int ok = misrouted_irq(irq);<br /> 			if (action_ret == IRQ_NONE)<br /> 				desc-&gt;irqs_unhandled -= ok;<br /> 		}<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
