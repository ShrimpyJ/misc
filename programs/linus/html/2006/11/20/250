    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2006/11/16/177">First message in thread</a></li><li><a href="/lkml/2006/11/16/177">Thomas Gleixner</a><ul><li><a href="/lkml/2006/11/16/182">Ingo Molnar</a><ul><li><a href="/lkml/2006/11/16/190">Thomas Gleixner</a><ul><li><a href="/lkml/2006/11/16/227">Linus Torvalds</a><ul><li><a href="/lkml/2006/11/16/238">Alan Stern</a></li><li><a href="/lkml/2006/11/16/309">"Paul E. McKenney"</a></li></ul></li></ul></li><li><a href="/lkml/2006/11/16/193">Peter Zijlstra</a></li><li><a href="/lkml/2006/11/16/211">Andrew Morton</a><ul><li><a href="/lkml/2006/11/16/212">Thomas Gleixner</a></li></ul></li><li class="origin"><a href="">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2006/11/16/186">Alan Stern</a><ul><li><a href="/lkml/2006/11/16/197">Thomas Gleixner</a><ul><li><a href="/lkml/2006/11/16/213">Alan Stern</a><ul><li><a href="/lkml/2006/11/16/219">Thomas Gleixner</a></li></ul></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2006/11/20/250/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 20 Nov 2006 11:57:07 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [patch] cpufreq: mark cpufreq_tsc() as core_initcall_sync</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />I decided to go with this instead, for now.<br /><br />Please holler if you see problems with it.<br /><br />		Linus<br /><br />---<br />commit b3438f8266cb1f5010085ac47d7ad6a36a212164<br />Author: Linus Torvalds &lt;torvalds&#64;woody.osdl.org&gt;<br />Date:   Mon Nov 20 11:47:18 2006 -0800<br /><br />    Add "pure_initcall" for static variable initialization<br />    <br />    This is a quick hack to overcome the fact that SRCU currently does not<br />    allow static initializers, and we need to sometimes initialize those<br />    things before any other initializers (even "core" ones) can do so.<br />    <br />    Currently we don't allow this at all for modules, and the only user that<br />    needs is right now is cpufreq. As reported by Thomas Gleixner:<br />    <br />       "Commit b4dfdbb3c707474a2254c5b4d7e62be31a4b7da9 ("[PATCH] cpufreq:<br />        make the transition_notifier chain use SRCU breaks cpu frequency<br />        notification users, which register the callback &gt; on core_init<br />        level."<br />    <br />    Cc: Thomas Gleixner &lt;tglx&#64;timesys.com&gt;<br />    Cc: Ingo Molnar &lt;mingo&#64;elte.hu&gt;<br />    Cc: Arjan van de Ven &lt;arjan&#64;infradead.org&gt;<br />    Cc: Andrew Morton &lt;akpm&#64;osdl.org&gt;,<br />    Signed-off-by: Linus Torvalds &lt;torvalds&#64;osdl.org&gt;<br /><br />diff --git a/drivers/cpufreq/cpufreq.c b/drivers/cpufreq/cpufreq.c<br />index 86e69b7..dd0c262 100644<br />--- a/drivers/cpufreq/cpufreq.c<br />+++ b/drivers/cpufreq/cpufreq.c<br />&#64;&#64; -59,7 +59,7 &#64;&#64; static int __init init_cpufreq_transitio<br /> 	srcu_init_notifier_head(&amp;cpufreq_transition_notifier_list);<br /> 	return 0;<br /> }<br />-core_initcall(init_cpufreq_transition_notifier_list);<br />+pure_initcall(init_cpufreq_transition_notifier_list);<br /> <br /> static LIST_HEAD(cpufreq_governor_list);<br /> static DEFINE_MUTEX (cpufreq_governor_mutex);<br />diff --git a/include/asm-generic/vmlinux.lds.h b/include/asm-generic/vmlinux.lds.h<br />index 9d87316..e60d6f2 100644<br />--- a/include/asm-generic/vmlinux.lds.h<br />+++ b/include/asm-generic/vmlinux.lds.h<br />&#64;&#64; -215,6 +215,8 &#64;&#64;<br /> 		.notes : { *(.note.*) } :note<br /> <br /> #define INITCALLS							\<br />+  	*(.initcall0.init)						\<br />+  	*(.initcall0s.init)						\<br />   	*(.initcall1.init)						\<br />   	*(.initcall1s.init)						\<br />   	*(.initcall2.init)						\<br />diff --git a/include/linux/init.h b/include/linux/init.h<br />index ff40ea1..5eb5d24 100644<br />--- a/include/linux/init.h<br />+++ b/include/linux/init.h<br />&#64;&#64; -93,6 +93,14 &#64;&#64; extern void setup_arch(char **);<br /> 	static initcall_t __initcall_##fn##id __attribute_used__ \<br /> 	__attribute__((__section__(".initcall" level ".init"))) = fn<br /> <br />+/*<br />+ * A "pure" initcall has no dependencies on anything else, and purely<br />+ * initializes variables that couldn't be statically initialized.<br />+ *<br />+ * This only exists for built-in code, not for modules.<br />+ */<br />+#define pure_initcall(fn)		__define_initcall("0",fn,1)<br />+<br /> #define core_initcall(fn)		__define_initcall("1",fn,1)<br /> #define core_initcall_sync(fn)		__define_initcall("1s",fn,1s)<br /> #define postcore_initcall(fn)		__define_initcall("2",fn,2)<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
