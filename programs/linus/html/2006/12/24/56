    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2006/12/16/164">First message in thread</a></li><li><a href="/lkml/2006/12/24/46">Andrei Popa</a><ul><li><a href="/lkml/2006/12/24/51">Linus Torvalds</a><ul><li><a href="/lkml/2006/12/24/55">Andrew Morton</a></li><li class="origin"><a href="/lkml/2006/12/24/58">Linus Torvalds</a><ul><li><a href="/lkml/2006/12/24/58">Linus Torvalds</a><ul><li><a href="/lkml/2006/12/24/73">"Gordon Farquharson"</a></li><li><a href="/lkml/2006/12/26/16">Nick Piggin</a></li></ul></li><li><a href="/lkml/2006/12/24/80">"Michael S. Tsirkin"</a></li></ul></li><li><a href="/lkml/2006/12/24/59">"Gordon Farquharson"</a><ul><li><a href="/lkml/2006/12/24/61">Linus Torvalds</a><ul><li><a href="/lkml/2006/12/24/63">Andrei Popa</a></li><li><a href="/lkml/2006/12/24/81">Martin Michlmayr</a></li></ul></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2006/12/24/56/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 24 Dec 2006 10:37:09 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] mm: fix page_mkclean_one (was: 2.6.19 file content corruption on ext3)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br /><br />On Sun, 24 Dec 2006, Linus Torvalds wrote:<br />&gt;<br />&gt; How about this particularly stupid diff? (please test with something that <br />&gt; _would_ cause corruption normally).<br /><br />Actually, here's an even more stupid diff, which actually to some degree <br />seems to capture the real problem better.<br /><br />Peter, tell me I'm crazy, but with the new rules, the following condition <br />is a bug:<br /><br /> - shared mapping<br /> - writable<br /> - not already marked dirty in the PTE<br /><br />because that combination means that the hardware can mark the PTE dirty <br />without us even realizing (and thus not marking the "struct page *" <br />dirty).<br /><br />(The above is actually a valid situation for IO mappings, but not for <br />"real" mappings. And IO mappings should never take page faults, I think).<br /><br />So, with that in mind, I wrote this stupid patch (for 32-bit x86, since I <br />used my Mac Mini for testing ratehr than my main machine - but the x86-64 <br />version should be pretty much identcal)..<br /><br />And you know what, Peter? It triggers for me. I get<br /><br />	WARNING at mm/memory.c:2274 do_no_page()<br />	 [&lt;c0103d4a&gt;] show_trace_log_lvl+0x1a/0x2f<br />	 [&lt;c010436c&gt;] show_trace+0x12/0x14<br />	 [&lt;c01043f0&gt;] dump_stack+0x16/0x18<br />	 [&lt;c0159790&gt;] __handle_mm_fault+0x38d/0x919<br />	 [&lt;c011c8c4&gt;] do_page_fault+0x1ff/0x507<br />	 [&lt;c03fabcc&gt;] error_code+0x7c/0x84<br /><br />which seems to say that do_no_page() can be used to insert shared and <br />non-dirty, but still writable, pages.<br /><br />But maybe my patch is just bogus, and I didn't think it through.<br /><br />Peter, I realize it's Christmas Eve, but let's face it, Santa appreciates <br />good boys and girls, and we all want tons of loot. So please be good, and <br />waste some time looking at this and tell me why I'm either wrong, or <br />there's a real smoking gun here.. ;)<br /><br />		Linus<br /><br />---<br />diff --git a/include/asm-i386/pgtable.h b/include/asm-i386/pgtable.h<br />index e6a4723..1389bb7 100644<br />--- a/include/asm-i386/pgtable.h<br />+++ b/include/asm-i386/pgtable.h<br />&#64;&#64; -494,7 +494,13 &#64;&#64; do {									\<br />  * The i386 doesn't have any external MMU info: the kernel page<br />  * tables contain all the necessary information.<br />  */<br />-#define update_mmu_cache(vma,address,pte) do { } while (0)<br />+#define bad_shared_pte(pte) (pte_write(pte) &amp;&amp; !pte_dirty(pte))<br />+#define update_mmu_cache(vma,address,pte) do {		\<br />+	static int __cnt;				\<br />+	WARN_ON(((vma)-&gt;vm_flags &amp; VM_SHARED)		\<br />+		 &amp;&amp; bad_shared_pte(pte)			\<br />+		 &amp;&amp; ++__cnt &lt; 5);			\<br />+} while (0)<br /> #endif /* !__ASSEMBLY__ */<br /> <br /> #ifdef CONFIG_FLATMEM<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
