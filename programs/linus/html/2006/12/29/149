    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2006/12/16/164">First message in thread</a></li><li><a href="/lkml/2006/12/29/44">Linus Torvalds</a><ul><li><a href="/lkml/2006/12/29/47">Andrei Popa</a></li><li><a href="/lkml/2006/12/29/51">Nick Piggin</a><ul><li><a href="/lkml/2006/12/29/99">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2006/12/29/63">Ingo Molnar</a></li><li><a href="/lkml/2006/12/29/70">Martin Johansson</a></li><li><a href="/lkml/2006/12/29/76">Martin Michlmayr</a><ul><li><a href="/lkml/2006/12/29/83">Stephen Clark</a><ul><li><a href="/lkml/2006/12/29/89">Martin Michlmayr</a></li></ul></li></ul></li><li><a href="/lkml/2006/12/29/145">Andrew Morton</a><ul><li><a href="/lkml/2006/12/29/148">Andrew Morton</a></li><li class="origin"><a href="/lkml/2006/12/29/154">Linus Torvalds</a><ul><li><a href="/lkml/2006/12/29/154">Theodore Tso</a><ul><li><a href="/lkml/2006/12/29/165">Linus Torvalds</a></li><li><a href="/lkml/2006/12/29/168">Andrew Morton</a></li></ul></li><li><a href="/lkml/2006/12/29/162">Andrew Morton</a><ul><li><a href="/lkml/2006/12/29/169">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 29 Dec 2006 14:42:51 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Ok, explained.. (was Re: [PATCH] mm: fix page_mkclean_one)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Fri, 29 Dec 2006, Andrew Morton wrote:<br />&gt; <br />&gt; - The above change means that we do extra writeout.  If a page is dirtied<br />&gt;   once, kjournald will write it and then pdflush will come along and<br />&gt;   needlessly write it again.<br /><br />There's zero extra writeout for any flushing that flushes BY PAGES.<br /><br />Only broken flushers that flush by buffer heads (which really really <br />really shouldn't be done any more: welcome to the 21st century) will cause <br />extra writeouts. And those extra writeouts are obviously required for all <br />the dirty state to actually hit the disk - which is the point of the <br />patch.<br /><br />So they're not "extra" - they are "required for correct working".<br /><br />But I can't stress the fact enough that people SHOULD NOT do writeback by <br />buffer heads. The buffer head has been purely an "IO entity" for the last <br />several years now, and it's not a cache entity. Anybody who does writeback <br />by buffer heads is basically bypassing the real cache (the page cache), <br />and that's why all the problems happen.<br /><br />I think ext3 is terminally crap by now. It still uses buffer heads in <br />places where it really really shouldn't, and as a result, things like <br />directory accesses are simply slower than they should be. Sadly, I don't <br />think ext4 is going to fix any of this, either.<br /><br />It's all just too inherently wrongly designed around the buffer head <br />(which was correct in 1995, but hasn't been correct for a long time in the <br />kernel any more).<br /><br />&gt; - Poor old IO accounting broke again.<br /><br />No. That's why I used "set_page_dirty()" and did it that strange ugly way <br />("set page dirty, even though it's already dirty, and even though the very <br />next thing we will do is TestClearPageDirty???").<br /><br />That code looks strange as a result, which is why it now has more comments <br />on it than actual code ;)<br /><br />&gt; - People were saying that ext2 and ext3,data=writeback were also showing<br />&gt;   corruption.  What's up with that?<br /><br />I thought the "ext3,data=writeback" case was reported to be fine by <br />several people?<br /><br />I'm not sure about ext2. I didn't look at what it did based on buffer <br />heads. I would have expected it to be ok.<br /><br />That said, at least one report was later shown to be bogus (errors due to <br />out of disk, not due to actual errors ;).<br /><br />&gt; - For a long time I've wanted to nuke the current ext3/jbd ordered-data<br />&gt;   implementation altogether, and just make kjournald call into the<br />&gt;   standard writeback code to do a standard suberblock-&gt;inodes-&gt;pages walk.<br /><br />I really would like to see less of the buffer-head-based stuff, and yes, <br />more of the normal inode page walking. I don't think you can "order" <br />accesses within a page anyway, exactly because of memory mapping issues, <br />so any page ordering is not about buffer heads on the page itself, it <br />should be purely about metadata.<br /><br />&gt; - It's pretty obnoxious that the VM now sets a clean page "dirty" and<br />&gt;   then proceeds to modify its contents.  It would be nice to stop doing<br />&gt;   that.<br /><br />No. I think this really the fundamental confusion people had. People <br />thought that setting the page dirty meant that it was no longer being <br />modified. It hasn't meant that in a LONG time - ever since the whole <br />DIRTY_TAG thing, the most important part of the PG_dirty thing has really <br />been that it's now efficiently findable by the writeout logic.<br /><br />And that is very much what the whole page accounting _depends_ on. When we <br />mmap a page, we need to mark it "findable" as dirty _before_ people <br />actually start writing to it, because it's too late afterwards.<br /><br />&gt;   We could stop marking the page dirty in do_wp_page() and create a new<br />&gt;   VM counter "NR_PTE_DIRTY", which means<br />&gt; <br />&gt;     "number of mapping_cap_account_dirty() pages which have a dirty pte<br />&gt;     pointing at them".<br /><br />Well, then you need to change what PAGE_MAPPING_TAG_DIRTY means too.<br /><br />That's very fundamental. That DIRTY _tag_ is now even more important than <br />the PG_dirty bit itself, since that's what we actually use to _access_ <br />those things.<br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
