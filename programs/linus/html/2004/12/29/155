    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2004/11/15/196">First message in thread</a></li><li><a href="/lkml/2004/12/29/101">Linus Torvalds</a><ul><li><a href="/lkml/2004/12/29/115">Jesse Allen</a><ul><li class="origin"><a href="/lkml/2004/12/29/158">Linus Torvalds</a><ul><li><a href="/lkml/2004/12/29/158">Davide Libenzi</a><ul><li><a href="/lkml/2004/12/29/164">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2004/12/29/185">Jesse Allen</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patches in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2004/12/29/155/1">Get diff 1</a></li><li><a href="/lkml/diff/2004/12/29/155/2">Get diff 2</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 29 Dec 2004 16:44:05 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: ptrace single-stepping change breaks Wine</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Wed, 29 Dec 2004, Jesse Allen wrote:<br />&gt; &gt; <br />&gt; &gt; So instead of removing the setting of TIF_SINGLESTEP in set_singlestep(),<br />&gt; &gt; can you test whether removing the _testing_ of it in do_syscall_trace()<br />&gt; &gt; makes things happier for you? Hmm?<br />&gt; &gt; <br />&gt; <br />&gt; Yes, doing that does work.  But I still have to remove the conditional<br />&gt; TF clear.  Here's the diff now to show you.<br /><br />Ok. That's a good piece of information. <br /><br />I don't actually understand why do_syscall_trace() does that <br />TIF_SINGLESTEP test in the first place, since the ptrace_notify() should <br />happen as part of the _normal_ TIF_SINGLESTEP handling, afaiks. No <br />apparent need to do it in syscall tracing, and do_syscall_trace() does <br />that bogus fake signal sending.<br /><br />Hmm.. That TF_SINGLESTEP test was added by Davide Libenzi in August, and I<br />think Davide had some test for exactly this. Davide? Can you recall why<br />you did this in the system call tracing code, rather than depend on the<br />regular TIF_SINGLESTEP handling in arch/i386/kernel/signal.c:<br />do_notify_resume()?<br /><br />(Jesse's patch re-appended here in-line for Davide's "reading pleasure").<br /><br />That still leaves the problem of the clearing of TF_MASK. I _appears_ that <br />the problem is that TF was set both by Wine doing a PTRACE_SINGLESTEP <br />(since PT_DTRACE is set) _and_ the application having TF enabled in eflags <br />from before (since it seems to want to keep it enabled).<br /><br />How about something like the attachment for the TF_MASK issue (replacing<br />your "don't clear" code)? The comments should make the intention pretty<br />obvious, but I have equally obviously not actually _tested_ any of this..<br /><br />		Linus<br /><br />---<br />--- linux/arch/i386/kernel/ptrace.c	2004-12-29 14:10:34.000000000 -0700<br />+++ linux-mod/arch/i386/kernel/ptrace.c	2004-12-29 14:22:33.000000000 -0700<br />&#64;&#64; -568,8 +568,7 &#64;&#64;<br /> 			audit_syscall_exit(current, regs-&gt;eax);<br /> 	}<br /> <br />-	if (!test_thread_flag(TIF_SYSCALL_TRACE) &amp;&amp;<br />-	    !test_thread_flag(TIF_SINGLESTEP))<br />+	if (!test_thread_flag(TIF_SYSCALL_TRACE))<br /> 		return;<br /> 	if (!(current-&gt;ptrace &amp; PT_PTRACED))<br /> 		return;<br />--- linux/arch/i386/kernel/signal.c	2004-12-29 14:10:34.000000000 -0700<br />+++ linux-mod/arch/i386/kernel/signal.c	2004-12-29 14:23:04.000000000 -0700<br />&#64;&#64; -299,8 +299,8 &#64;&#64;<br /> 	 * don't want debugging to change state.<br /> 	 */<br /> 	eflags = regs-&gt;eflags;<br />-	if (current-&gt;ptrace &amp; PT_DTRACE)<br />-		eflags &amp;= ~TF_MASK;<br />+//	if (current-&gt;ptrace &amp; PT_DTRACE)<br />+//		eflags &amp;= ~TF_MASK;<br /> 	err |= __put_user(eflags, &amp;sc-&gt;eflags);<br /> 	err |= __put_user(regs-&gt;esp, &amp;sc-&gt;esp_at_signal);<br /> 	err |= __put_user(regs-&gt;xss, (unsigned int __user *)&amp;sc-&gt;ss);===== arch/i386/kernel/ptrace.c 1.28 vs edited =====<br />--- 1.28/arch/i386/kernel/ptrace.c	2004-11-22 09:44:52 -08:00<br />+++ edited/arch/i386/kernel/ptrace.c	2004-12-29 16:42:04 -08:00<br />&#64;&#64; -142,18 +142,31 &#64;&#64;<br /> {<br /> 	long eflags;<br /> <br />+	/*<br />+	 * Always set TIF_SINGLESTEP - this guarantees that <br />+	 * we single-step system calls etc.. <br />+	 */<br /> 	set_tsk_thread_flag(child, TIF_SINGLESTEP);<br />+<br />+	/*<br />+	 * If TF was already set, don't do anything else<br />+	 */<br /> 	eflags = get_stack_long(child, EFL_OFFSET);<br />+	if (flags &amp; TRAP_FLAG)<br />+		return;<br /> 	put_stack_long(child, EFL_OFFSET, eflags | TRAP_FLAG);<br /> 	child-&gt;ptrace |= PT_DTRACE;<br /> }<br /> <br /> static void clear_singlestep(struct task_struct *child)<br /> {<br />+	/* Always clear TIF_SINGLESTEP... */<br />+	clear_tsk_thread_flag(child, TIF_SINGLESTEP);<br />+<br />+	/* But touch TF only if it was set by us.. */<br /> 	if (child-&gt;ptrace &amp; PT_DTRACE) {<br /> 		long eflags;<br /> <br />-		clear_tsk_thread_flag(child, TIF_SINGLESTEP);<br /> 		eflags = get_stack_long(child, EFL_OFFSET);<br /> 		put_stack_long(child, EFL_OFFSET, eflags &amp; ~TRAP_FLAG);<br /> 		child-&gt;ptrace &amp;= ~PT_DTRACE;</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
