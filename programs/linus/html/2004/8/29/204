    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2004/8/24/220">First message in thread</a></li><li><a href="/lkml/2004/8/29/175">Hans Reiser</a><ul><li><a href="/lkml/2004/8/29/199">	viro&#64;parcelfa ...</a><ul><li class="origin"><a href="/lkml/2004/8/29/210">Linus Torvalds</a><ul><li><a href="/lkml/2004/8/29/210">Linus Torvalds</a><ul><li><a href="/lkml/2004/8/29/224">	viro&#64;parcelfa ...</a></li><li><a href="/lkml/2004/8/29/239">Neil Brown</a></li><li><a href="/lkml/2004/9/2/84">Stephan von Krawczynski</a></li></ul></li><li><a href="/lkml/2004/8/29/221">Trond Myklebust</a><ul><li><a href="/lkml/2004/8/29/223">	viro&#64;parcelfa ...</a></li><li><a href="/lkml/2004/8/29/229">Linus Torvalds</a></li><li><a href="/lkml/2004/8/29/230">"Alexander G. M. Smith"</a></li></ul></li></ul></li><li><a href="/lkml/2004/8/29/247">Hans Reiser</a></li><li><a href="/lkml/2004/8/30/34">Hans Reiser</a><ul><li><a href="/lkml/2004/8/30/79">"Alexander G. M. Smith"</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 29 Aug 2004 14:50:07 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: silent semantic changes with reiser4</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sun, 29 Aug 2004 viro&#64;parcelfarce.linux.theplanet.co.uk wrote:<br />&gt; <br />&gt; A slew of cache coherency issues (and memory consumption on top of that).<br />&gt; Rigth now we have a signle dentry tree for all fs instances, no matter<br />&gt; how many times it and its subtrees are visible in the tree.  Which,<br />&gt; obviously, avoids all that crap.  As soon as we start trying to have<br />&gt; multiple trees over the same fs, we are in for a *lot* of fun.<br /><br />Al, I think you should make the argument a bit more specific, because I <br />doubt a lot of people understand just what the problems are with aliased <br />names. Just a few examples of the problems involved will illuminate things <br />very well, I think. People who haven't been intimate with the name caches <br />probably simply don't understand why you worry so much.<br /><br />I'll start out with some trivial examples, just to let Hans and others get<br />an idea about what the issues are. I think examples of problems are often <br />better ways to explain them than the abstract issues themselves.<br /><br />Aliases: let's say that you have filename "a" hard-linked to filename "b", <br />and you have a directory structure of streams under there. So you have<br /><br />	a/file1<br />	a/dir1/file2<br />	a/dir2/file3<br /><br />and (through the hard-link with "b") you have aliases of all these same <br />names available as "b/file1", "b/dir1/file2" etc).<br /><br />Now, imagine that you have two processes doing<br /><br />	mv a/dir1 a/dir2/newdir<br /><br />and<br /><br />	mv b/dir2 b/dir1/newdir<br /><br />at the same time. Both of them MUST NOT SUCCEED, for pretty obvious <br />reasons (you'd have moved two directories within each other, and now <br />neither would be accessible any more).<br /><br />How do you handle locking for this situation?<br /><br />Another interesting case is what happens when you have looked up and cache<br />the filename "a/file1" and then another process does "rm b/file1". How do<br />you update the _other_ cached copy, since they had two different names,<br />but _both_ names went away at the same time. Also again, how do you handle<br />locking?<br /><br />The general VFS layer has a lot of rules, and avoids these problems by<br />simply never having aliases between two directories. If the same directory<br />shows up multiple times (which can happen with bind mounts), they have the<br />exact same dentry for the directory, it's just found through two different<br />vfsmount instances. That's why vfsmounts exist - they allow the same name<br />cache entry to show up in different places at the same time.<br /><br />So when we do a bind mount, and the same directory shows up under two<br />different names "a" and "b", and we do a "rm b/file1", it _automatically_<br />disappears from "a/file1" too, simply by virtue of "a" and "b" literally<br />being the same dentry. No aliasing ever happens, and this makes coherency<br />and locking much easier (which is not to say that they are trivial, but<br />they are pretty damn clear in comparison to the alternatives).<br /><br />What Al (and others) worries about is that the reiser4 name handling has<br />_none_ of these issues figured out and protected against. You can protect <br />against them by taking very heavy locks (you can trivially protect against <br />all races by taking one large lock around any operation), but the fact is, <br />that is just not an option for high-performance name lookup. <br /><br />These aliasing/locking rules need to be global and wll-though-out. Not <br />just fix the two examples above, but be shown to be safe _in_general_. <br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
