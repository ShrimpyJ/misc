    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2004/9/17/235">First message in thread</a></li><li><a href="/lkml/2004/9/25/138">Linus Torvalds</a><ul><li><a href="/lkml/2004/9/25/141">Jeremy Allison</a><ul><li class="origin"><a href="/lkml/2004/9/25/144">Linus Torvalds</a><ul><li><a href="/lkml/2004/9/25/144">Jeremy Allison</a></li><li><a href="/lkml/2004/9/25/145">Samuel Thibault</a></li></ul></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2004/9/25/143/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 25 Sep 2004 15:18:50 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [2.6] smbfs &amp; "du" illness</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sat, 25 Sep 2004, Jeremy Allison wrote:<br />&gt; <br />&gt; &gt; What kinds of values do different smb servers actually fill this field <br />&gt; &gt; with? And what's the value you expect future samba severs will use?<br />&gt; <br />&gt; Ok, right now the only smb server that supports the UNIX<br />&gt; extensions is smbd (I'm working on getting NetApp to also<br />&gt; support them, but they don't as yet so we can get them to<br />&gt; do the right thing, bytes allocated, when they do), so we<br />&gt; know pretty much what will happen.<br /><br />Ok. Then we don't have to worry about somebody using a block count instead <br />of a byte count anywhere. That simplifies things a bit, at least.<br /><br />Samuel, does this patch work for you? I'll commit if after somebody <br />reports that it works (assuming nobody points out any stupid thinkos <br />in it).<br /><br />This will inevitably get the disk usage a _bit_ wrong if the file really <br />_does_ happen to use up an exact multiple of 1MB of disk, but hey, having <br />a heuristic that is sometimes a bit wrong is better than having one that <br />is always very wrong. <br /><br />This is totally untested, btw. For obvious reasons.<br /><br />		Linus<br /><br />----<br />===== fs/smbfs/proc.c 1.40 vs edited =====<br />--- 1.40/fs/smbfs/proc.c	2004-07-11 02:23:29 -07:00<br />+++ edited/fs/smbfs/proc.c	2004-09-25 15:15:23 -07:00<br />&#64;&#64; -2076,6 +2076,8 &#64;&#64;<br /> <br /> void smb_decode_unix_basic(struct smb_fattr *fattr, char *p)<br /> {<br />+	u64 size, disk_bytes;<br />+<br /> 	/* FIXME: verify nls support. all is sent as utf8? */<br /> <br /> 	fattr-&gt;f_unix = 1;<br />&#64;&#64; -2093,8 +2095,19 &#64;&#64;<br /> 	/* 84 L permissions */<br /> 	/* 92 L link count */<br /> <br />-	fattr-&gt;f_size = LVAL(p, 0);<br />-	fattr-&gt;f_blocks = LVAL(p, 8);<br />+	size = LVAL(p, 0);<br />+	disk_bytes = LVAL(p, 8);<br />+<br />+	/*<br />+	 * Some samba versions round up on-disk byte usage<br />+	 * to 1MB boundaries, making it useless. When seeing<br />+	 * that, use the size instead.<br />+	 */<br />+	if (!(disk_bytes &amp; 0xfffff))<br />+		disk_bytes = size+511;<br />+<br />+	fattr-&gt;f_size = size;<br />+	fattr-&gt;f_blocks = disk_bytes &gt;&gt; 9;<br /> 	fattr-&gt;f_ctime = smb_ntutc2unixutc(LVAL(p, 16));<br /> 	fattr-&gt;f_atime = smb_ntutc2unixutc(LVAL(p, 24));<br /> 	fattr-&gt;f_mtime = smb_ntutc2unixutc(LVAL(p, 32));<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
