    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/1997/11/30/71">First message in thread</a></li><li><a href="/lkml/1997/11/30/71">Myrdraal</a><ul><li class="origin"><a href="/lkml/1997/12/1/3">(Linus Torvalds)</a><ul><li><a href="/lkml/1997/12/1/3">Myrdraal</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">(Linus Torvalds)</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 2.1.68 brokenness.</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">1 Dec 1997 03:06:10 GMT</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">In article &lt;19971130194259.33168&#64;jackalz&gt;,<br />Myrdraal  &lt;myrdraal&#64;jackalz.dyn.ml.org&gt; wrote:<br />&gt;Hi,<br />&gt; Sound and various other parts of the kernel seem to be broken by the<br />&gt; signal change stuff in 2.1.68.<br /><br />Indeed.  The signal stuff also breaks some of the other Linux platforms<br />(essentially everything but x86 and alpha).  The other platforms will<br />take some time to sort out, and generally require a deeper understanding<br />of what the thing does, but everybody can chip in and help with the<br />"simple" things, ie device drivers etc that got broken. <br /><br />Fixing stuff up isn't all that hard, you just have to understand that<br />the signal semantics got extended in order for the kernel to support new<br />signals and the semantics required by the POSIX real-time signal stuff.<br /><br />The easiest case is actually the most common one: there are some places<br />(notably the sound driver) that use the older way of testing for pending<br />signals. They have code like<br /><br />	if (current-&gt;signal &amp; ~current-&gt;blocked)<br />		return -EINTR;<br /><br />which is very easy to just change to<br /><br />	if (signal_pending(current))<br />		return -EINTR;<br /><br />so you can _almost_ fix these things up by just having a global<br />search-and-replace for this.<br /><br />Some drivers, notably the ftape driver, have a slightly more complex<br />setup where they actually want to change the blocked signals.  Then you<br />actually have to do some more work, and while it's not complex it's also<br />not just a search-anr-replace kind of thing.<br /><br />For example, the ftape driver seems to do things like<br /><br />	int old_sigmask = current-&gt;blocked;<br /><br />	current-&gt;blocked = _BLOCK_ALL;<br />	...<br />	current-&gt;blocked = oldmask;<br /><br />which wasn't really correct even before (it breaks on 64-bit<br />architectures), but got totally broken by the new signal stuff. In the<br />new order, the code would need to do something like this instead:<br /><br />	sigset_t old_sigmask;<br /><br />	spin_lock_irq(&amp;current-&gt;sigmask_lock);<br />	oldset = current-&gt;blocked;<br />	siginitset(&amp;current-&gt;blocked, _BLOCK_ALL);<br />	recalc_sigpending(current);<br />	spin_unlock_irq(&amp;current-&gt;sigmask_lock);<br /><br />	...<br /><br />	spin_lock_irq(&amp;current-&gt;sigmask_lock);<br />	current-&gt;blocked = old_sigmask;<br />	recalc_sigpending(current);<br />	spin_unlock_irq(&amp;current-&gt;sigmask_lock);<br /><br />(the above is just a rough suggestion - you'd better look at some of the<br />examples in the current patches). <br /><br />If you notice that ftape does a lot of the above, I'd suggest creating<br />the proper helper functions to do it, rather than blindly doing the<br />above every time..<br /><br />Anyway, do we have any takers? Especially the sound patches should be<br />simple: I don't think the sound drivers try to mess around with signal<br />masks at all, so they should all be of the trivial kind to fix. <br /><br />		Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
