    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/1997/7/10/69">First message in thread</a></li><li><a href="/lkml/1997/7/10/69">(Kevin Buhr)</a><ul><li><a href="/lkml/1997/7/10/81">Bill Hawes</a><ul><li class="origin"><a href="/lkml/1997/7/10/95">Linus Torvalds</a><ul><li><a href="/lkml/1997/7/10/95">(Kevin Buhr)</a><ul><li><a href="/lkml/1997/7/10/86">Linus Torvalds</a></li><li><a href="/lkml/1997/7/12/38">James Mastros</a></li><li><a href="/lkml/1997/7/12/43">Bill Hawes</a></li></ul></li><li><a href="/lkml/1997/7/11/2">"Theodore Y. Ts'o"</a><ul><li><a href="/lkml/1997/7/11/1">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 10 Jul 1997 16:07:02 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: PATCH to pre-patch-2.1.45: clean_inode needs to reset i_writecount</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 10 Jul 1997, Bill Hawes wrote:<br />&gt; <br />&gt; The negative values in i_writecount are because the previous use of the<br />&gt; inode set the field to prevent writing, so it does need to be cleared in<br />&gt; clean_inode.<br /><br />Right you are.<br /><br />&gt; Some other potential problems to watch out for -- there appear to be<br />&gt; calls to mark_inode_dirty for pipe inodes, which puts them on the dirty<br />&gt; list, then onto the clean list, but not in the hash queues.  This may<br />&gt; not do any harm, but it violates the design spec.<br /><br />Actually, it doesn't really violate the design spec (which is essentially<br />to have the i_list and i_hash lists totally separate), but it _does_<br />violate a comment in the sources. I guess I should fix the comment ;) <br /><br />&gt; Also, I changed the code in get_new_inode and get_empty_inode to<br />&gt; atomic_inc() the use count, rather than set it.  The reason is that in<br />&gt; the call to put_inode(), there may be cases where the code will block<br />&gt; between calling clear_inode() and returning.  Thus for a short time the<br />&gt; inode may be one the unused list but with its count still at 1, and it's<br />&gt; possible for it to go back into use.  Setting the use count instead of<br />&gt; incrementing would then screw up the counts.<br /><br />I actually prefer the atomic_set(), because "clear_inode()" can set the<br />count to zero, and then the count gos negative when iput() decrements it. <br />But that's ok - nobody cares about the inode count once it is on the<br />unused list. <br /><br />&gt; In spite of a few glitches the new code seems to be working pretty well<br />&gt; -- I can compile kernels, copy source trees, and generally muck around<br />&gt; without too much corruption :-)<br /><br />I haven't seen any corruption - the only problem I see these days is the<br />memory leak due to not freeing dentries (I'm working on this), and the<br />related dirty shutdown because we don't know that we can unmount. <br /><br />This _does_ result in "dtime not zero" messages from fsck (which runs at<br />each boot), but that's actually because the ext2 "dtime" field is simply<br />broken. So you should actually not worry about that message (but anything<br />else would be worrysome..).<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
