    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2000/9/24/107">First message in thread</a></li><li><a href="/lkml/2000/9/24/67">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/24/9">Ingo Molnar</a></li><li><a href="/lkml/2000/9/24/116">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/25/3">"Stephen C. Tweedie"</a></li><li><a href="/lkml/2000/9/24/3">Miles Lane</a></li><li><a href="/lkml/2000/9/25/37">"Stephen C. Tweedie"</a></li><li><a href="/lkml/2000/9/24/50">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/25/261">Ingo Molnar</a><ul><li><a href="/lkml/2000/9/25/4">Andrea Arcangeli</a></li></ul></li><li><a href="/lkml/2000/9/24/115">Alexander Viro</a><ul><li><a href="/lkml/2000/9/24/62">Andrea Arcangeli</a></li><li><a href="/lkml/2000/9/25/211">"Stephen C. Tweedie"</a></li></ul></li></ul></li><li class="origin"><a href="/lkml/2000/9/24/22">Linus Torvalds</a><ul><li><a href="/lkml/2000/9/24/22">Marcelo Tosatti</a><ul><li><a href="/lkml/2000/9/25/141">Ingo Molnar</a></li></ul></li><li><a href="/lkml/2000/9/24/83">Alexander Viro</a></li><li><a href="/lkml/2000/9/24/102">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/25/84">Andrea Arcangeli</a></li><li><a href="/lkml/2000/9/24/90">Marcelo Tosatti</a></li></ul></li></ul></li><li><a href="/lkml/2000/9/24/58">Andrea Arcangeli</a></li><li><a href="/lkml/2000/9/25/136">Andrea Arcangeli</a></li><li><a href="/lkml/2000/9/24/64">Ingo Molnar</a><ul><li><a href="/lkml/2000/9/25/39">Linus Torvalds</a><ul><li><a href="/lkml/2000/9/25/152">Alexander Viro</a></li></ul></li></ul></li><li><a href="/lkml/2000/9/25/142">"Stephen C. Tweedie"</a></li><li><a href="/lkml/2000/9/26/78">Christoph Rohland</a><ul><li><a href="/lkml/2000/9/27/33">Erik Andersen</a></li><li><a href="/lkml/2000/9/27/161">Andrea Arcangeli</a></li></ul></li><li><a href="/lkml/2000/9/25/208">bert hubert</a></li><li><a href="/lkml/2000/9/24/96">"Stephen C. Tweedie"</a></li><li><a href="/lkml/2000/9/25/235">"Stephen C. Tweedie"</a><ul><li><a href="/lkml/2000/9/27/53">Andrea Arcangeli</a></li></ul></li><li><a href="/lkml/2000/9/25/256">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/27/19">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/28/8">Rik van Riel</a></li><li><a href="/lkml/2000/9/28/133">Andrea Arcangeli</a></li></ul></li><li><a href="/lkml/2000/9/27/44">Christoph Rohland</a></li></ul></li><li><a href="/lkml/2000/9/24/113">bert hubert</a><ul><li><a href="/lkml/2000/9/25/7">Andrea Arcangeli</a><ul><li><a href="/lkml/2000/9/25/167">Rik van Riel</a></li></ul></li><li><a href="/lkml/2000/9/26/19">Andrea Arcangeli</a></li><li><a href="/lkml/2000/9/26/60">Andrea Arcangeli</a></li><li><a href="/lkml/2000/9/27/79">Christoph Rohland</a><ul><li><a href="/lkml/2000/9/27/134">Ingo Molnar</a></li></ul></li><li><a href="/lkml/2000/9/26/66">Christoph Rohland</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 24 Sep 2000 17:09:40 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [patch] vmfixes-2.4.0-test9-B2</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sun, 24 Sep 2000, Andrea Arcangeli wrote:<br />&gt;<br />&gt; On Sun, Sep 24, 2000 at 10:26:11PM +0200, Ingo Molnar wrote:<br />&gt; &gt; where will it deadlock?<br />&gt; <br />&gt; ext2_new_block (or whatever that runs getblk with the superlock lock<br />&gt; acquired)-&gt;getblk-&gt;GFP-&gt;shrink_dcache_memory-&gt;prune_dcache-&gt;<br />&gt; prune_one_dentry-&gt;dput-&gt;dentry_iput-&gt;iput-&gt;inode-&gt;i_sb-&gt;s_op-&gt;<br />&gt; put_inode-&gt;ext2_discard_prealloc-&gt;ext2_free_blocks-&gt;lock_super-&gt;D<br /><br />Whee..<br /><br />Good that you remembered (now that you mention it, I recollect that we had<br />this bug and discussion earlier).<br /><br />I added a comment to the effect, although I still moved the __GFP_IO test<br />into the icache and dcache shrink functions, because as with the<br />shm_swap() thing this is probably something we do want to fix eventually.<br /><br />The icache shrinker probably has similar problems with clear_inode.<br /><br />I suspect that it might be a good idea to try to fix this issue, because<br />it will probably keep coming up otherwise. And it's likely to be fairly<br />easily debugged, by just making getblk() have some debugging code that<br />basically says something like<br /><br />	lock_super()<br />	{<br />		.. do the lock ..<br />+		current-&gt;super_locked++;<br />	}<br /><br />	unlock_super()<br />	{<br />+		if (current-&gt;super_locked &lt; 1)<br />+			BUG();<br />+		current-&gt;super_locked--;<br />		.. do the unlock ..<br />	}<br /><br />	getblk()<br />	{<br />+		if (current-&gt;super_locked)<br />+			BUG();<br />		.. do the getblk ..<br />	}<br /><br />and just making it a new rule that you cannot call getblk() with any locks<br />held.<br /><br />It should be fairly easy to make the callers well-behaved: the hard part<br />is probably just enumerating and finding the suckers, which is why the<br />above debug code would make people aware of it..<br /><br />(We definitely don't want to wait for the deadlock to happen and trap that<br />one: the above code will BUG() out in any normal situation regardless of<br />whether it would actually trigger a deadlock or even allocate memory or<br />not. Which is what we'd want if we want to fix this).<br /><br />On the whole, fixing the cases would probably imply dropping the lock,<br />doing the read, re-aquireing the lock, and then going back and seeing if<br />maybe somebody else already filled in the bitmap cache or whatever. So not<br />one-liners by any means, but we'll probably want to do it at some point<br />(the superblock lock is quite contended right now, and the reason for that<br />may well be that it's just so badly done for historical reasons).<br /><br />		Linus<br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />Please read the FAQ at <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
