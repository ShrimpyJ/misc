    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2000/8/29/47">First message in thread</a></li><li><a href="/lkml/2000/9/21/78">Linus Torvalds</a><ul><li><a href="/lkml/2000/9/22/160">"M.H.VanLeeuwen"</a><ul><li class="origin"><a href="/lkml/2000/9/22/80">Linus Torvalds</a><ul><li><a href="/lkml/2000/9/22/80">"M.H.VanLeeuwen"</a></li><li><a href="/lkml/2000/9/22/130">Alan Cox</a><ul><li><a href="/lkml/2000/9/23/98">"M.H.VanLeeuwen"</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2003/10/22/149">"M.H.VanLeeuwen"</a><ul><li><a href="/lkml/2003/10/22/151">Linus Torvalds</a><ul><li><a href="/lkml/2003/10/22/152">Linus Torvalds</a></li><li><a href="/lkml/2003/10/23/44">Mikael Pettersson</a><ul><li><a href="/lkml/2003/10/23/60">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2003/10/23/46">Marcelo Tosatti</a></li></ul></li></ul></li><li><a href="/lkml/2003/10/23/2">"M.H.VanLeeuwen"</a><ul><li><a href="/lkml/2003/11/3/173">Adam Belay</a><ul><li><a href="/lkml/2003/11/4/3">"M.H.VanLeeuwen"</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 22 Sep 2000 00:38:51 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] ISAPNP using an invalid IO_APIC IRQ</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />[ Left all the quotes intact, because I would like Ingo to give this a<br />  quick look. Sorry about the noise.. ]<br /><br />On Thu, 21 Sep 2000, M.H.VanLeeuwen wrote:<br />&gt; <br />&gt; Legacy would be just fine, but ISAPNP is attempting to assign an IRQ that is<br />&gt; unavailable on my system.  In otherwords, the BIOS has assigned it to some<br />&gt; other function and thus the IRQ doesn't appear to Linux as even existing.<br />&gt; In my case IRQ5 was assigned to "DISPLAY CONTROLLER" and IRQ5 isn't available<br />&gt; to the system, excerpts from dmesg:<br />&gt; ...<br />&gt; Bus #2 is ISA<br />&gt; I/O APIC #2 Version 17 at 0xFEC00000.<br />&gt; Int: type 0, pol 0, trig 0, bus 2, IRQ 04, APIC ID 2, APIC INT 04  *** NO ISA IRQ 5 ***<br />&gt; Int: type 0, pol 0, trig 0, bus 2, IRQ 06, APIC ID 2, APIC INT 06<br />&gt; ...<br />&gt; ENABLING IO-APIC IRQs<br />&gt; ...changing IO-APIC physical APIC ID to 2 ... ok.<br />&gt; Synchronizing Arb IDs.<br />&gt; init IO_APIC IRQs<br />&gt;  IO-APIC (apicid-pin) 2-0, 2-5, 2-10, 2-11, 2-17, 2-20, 2-21, 2-22, 2-23 not connected.<br />&gt;                              ^ no IRQ 5 ?<br />&gt; ...<br />&gt;  IRQ redirection table:<br />&gt;  NR Log Phy Mask Trig IRR Pol Stat Dest Deli Vect:<br />&gt;  04 003 03  0    0    0   0   0    1    1    49<br />&gt;  05 000 00  1    0    0   0   0    0    0    00   *** IRQ 5 ??? ***<br />&gt;  06 003 03  0    0    0   0   0    1    1    51<br />&gt; <br />&gt; Yet ISAPNP decided to assign that IRQ5 to my NIC.  ne.c fails to operate<br />&gt; when there are plenty of other IRQs still available.<br /><br />Hmm.. <br /><br />The legacy side should still work. The fact that it isn't routed to the<br />IO-APIC probably means that it is routed directly to the legacy stuff,<br />like the timer normally is.<br /><br />However:<br /><br />&gt; The difference is in this logic between _no_ IO-APIC and _yes_ IO_APIC<br />&gt; in isapnp.c<br />&gt; <br />&gt;         isapnp_for_each_dev(dev) {<br />&gt;                 if (dev-&gt;active) {<br />&gt;                         if (dev-&gt;irq_resource[0].start == irq ||<br />&gt;                             dev-&gt;irq_resource[1].start == irq)<br />&gt;                                 return 1;<br />&gt; <br />&gt;                 }<br />&gt;         }                                                                  <br />&gt; <br />&gt; since w/o IO_APIC no PIC-&gt;APIC IRQ transform is done and this returns 1<br />&gt; and IRQ 5 is not used.  With IO_APIC no match occurs and the system attempt<br />&gt; to use IRQ 5, thus a hung system.<br /><br />I have this suspicion that the correct interrupt mapping would be found in<br />the MP table.<br /><br />The same way PCI interrupts get mapped by the MP table to their "real"<br />mapping, any other irq numbers probably should too - we've mapped the<br />legacy irq 5 away to another interrupt, and nobody told ISA-PnP, so irq 5<br />is probably _really_ somewhere on irq 18 or similar with the IO-APIC<br />enabled.<br /><br />&gt; Hence, my attempt to rule out APIC IRQs that were unavailable to the system,<br />&gt; also assuming the legacy IRQs would also not be available.  This may not be<br />&gt; globally true, but seems to be on my system.  Abit BP6, nu Bios.<br />&gt; <br />&gt; This entire problem would not have bothered me too badly, had the system<br />&gt; come up and run, but w/o explicitly telling the BIOS to reserve an ISA<br />&gt; IRQ ISAPNP eventually decides to try IRQ 12.  IRQ sharing with PS/2 mouse<br />&gt; and ne.c fail miserably.  On 2.2.X I had been using IRQ9 for ne.c card.<br />&gt; With 2.4 IRQ 9 is listed after IRQ 12 in xtab[16] (isapnp.c) so the system<br />&gt; fails to boot.<br />&gt; <br />&gt; &gt; Especially as they seem to be acceptable if there are _no_ IO-APIC irq's.<br />&gt; <br />&gt; Only if they work. ;)<br /><br />The irq is still there, it's just that it's mapped somewhere else. The MP<br />table should give the mapping. <br /><br />Please find the "mptable" program, and run it. If you don't already have<br />it on your system, search for it on google or something.. It will print<br />out your whole MP table, and that might give a better clue about where irq<br />5 has gone, and what we should do inside the ISA PnP code to find the<br />right irq..<br /><br />		Linus<br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />Please read the FAQ at <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
