    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2012/9/14/99">First message in thread</a></li><li><a href="/lkml/2012/9/24/335">Mel Gorman</a><ul><li><a href="/lkml/2012/9/24/326">Nikolay Ulyanitsky</a></li><li><a href="/lkml/2012/9/24/339">Peter Zijlstra</a><ul><li><a href="/lkml/2012/9/24/350">Mike Galbraith</a></li><li class="origin"><a href="/lkml/2012/9/24/368">Linus Torvalds</a><ul><li><a href="/lkml/2012/9/24/368">Peter Zijlstra</a><ul><li><a href="/lkml/2012/9/24/380">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2012/9/24/486">Peter Zijlstra</a><ul><li><a href="/lkml/2012/9/24/382">Linus Torvalds</a></li><li><a href="/lkml/2012/9/24/388">Peter Zijlstra</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2012/9/24/351">Borislav Petkov</a></li><li><a href="/lkml/2012/9/25/3">Mike Galbraith</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 24 Sep 2012 08:52:45 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 20% performance drop on PostgreSQL 9.2 from kernel 3.5.3 to 3.6-rc5 on AMD chipsets - bisected</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Sep 24, 2012 at 8:30 AM, Peter Zijlstra &lt;a.p.zijlstra&#64;chello.nl&gt; wrote:<br />&gt; No idea if its sufficient, but its a start.<br /><br />Can we please do this too?<br /><br />    diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c<br />    index 96e2b18b6283..2010c1ece7b3 100644<br />    --- a/kernel/sched/fair.c<br />    +++ b/kernel/sched/fair.c<br />    &#64;&#64; -2634,25 +2634,12 &#64;&#64; find_idlest_cpu(struct sched_group *group,<br />struct task_struct *p, int this_cpu)<br />      */<br />     static int select_idle_sibling(struct task_struct *p, int target)<br />     {<br />    -	int cpu = smp_processor_id();<br />    -	int prev_cpu = task_cpu(p);<br />     	struct sched_domain *sd;<br />     	struct sched_group *sg;<br />     	int i;<br /><br />    -	/*<br />    -	 * If the task is going to be woken-up on this cpu and if it is<br />    -	 * already idle, then it is the right target.<br />    -	 */<br />    -	if (target == cpu &amp;&amp; idle_cpu(cpu))<br />    -		return cpu;<br />    -<br />    -	/*<br />    -	 * If the task is going to be woken-up on the cpu where it previously<br />    -	 * ran and if it is currently idle, then it the right target.<br />    -	 */<br />    -	if (target == prev_cpu &amp;&amp; idle_cpu(prev_cpu))<br />    -		return prev_cpu;<br />    +	if (idle_cpu(target))<br />    +		return target;<br /><br />     	/*<br />     	 * Otherwise, iterate the domains and find an elegible idle cpu.<br /><br />(obviously whitespace-damaged). The whole "let's test prev_cpu or cpu"<br />seems stupid and counter-productive. The only possible values for<br />'target' are the two we test for.<br /><br />Your patch looks odd, though. Why do you use some complex initial<br />value for 'candidate' (nr_cpu_ids) instead of a simple and readable<br />one (-1)?<br /><br />And the whole "if we find any non-idle cpu, skip the whole domain"<br />logic really seems a bit odd (that's not new to your patch, though).<br />Can somebody explain what the whole point of that idiotically written<br />function is?<br /><br />                  Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
