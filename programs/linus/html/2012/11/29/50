    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2012/11/18/182">First message in thread</a></li><li><a href="/lkml/2012/11/29/39">Linus Torvalds</a><ul><li><a href="/lkml/2012/11/29/47">Al Viro</a><ul><li class="origin"><a href="">Linus Torvalds</a></li><li><a href="/lkml/2012/11/29/56">Al Viro</a><ul><li><a href="/lkml/2012/11/29/53">Linus Torvalds</a></li><li><a href="/lkml/2012/11/29/63">Al Viro</a><ul><li><a href="/lkml/2012/11/29/188">Jeff Chua</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2012/11/29/269">Chris Mason</a><ul><li><a href="/lkml/2012/11/29/353">Chris Mason</a></li><li><a href="/lkml/2012/11/29/358">Linus Torvalds</a><ul><li><a href="/lkml/2012/11/29/371">Chris Mason</a><ul><li><a href="/lkml/2012/11/29/377">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 28 Nov 2012 22:33:58 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] Introduce a method to catch mmap_region (was: Recent kernel "mount" slow)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Nov 28, 2012 at 10:25 PM, Al Viro &lt;viro&#64;zeniv.linux.org.uk&gt; wrote:<br />&gt;<br />&gt;         Umm...  set_blocksize() is calling kill_bdev(), which does<br />&gt; truncate_inode_pages(mapping, 0).  What's going to happen to data in<br />&gt; the dirty pages?  IO in progress is not the only thing to worry about...<br /><br />Hmm. Yes. I think it works by virtue of "if you change the blocksize<br />while there is active IO, you're insane and you deserve whatever you<br />get".<br /><br />It shouldn't even be fundamentally hard to make it work, although I<br />suspect it would be more code than it would be worth. The sane model<br />would be to not use truncate_inode_pages(), but instead just walk the<br />pages and get rid of the buffer heads with the wrong size. Preferably<br />*combining* that with the sync_blockdev().<br /><br />We have no real reason to even invalidate the page cache, it's just<br />the buffers we want to get rid of.<br /><br />But I suspect it's true that none of that is really *worth* it,<br />considering that nobody likely wants to do any concurrent IO. We don't<br />want to crash, or corrupt the data structures, but I suspect "you get<br />what you deserve" might actually be the right model ;)<br /><br />So the current "sync_blockdev()+kill_bdev()" takes care of the *sane*<br />case (we flush any data that happened *before* the block size change),<br />and any concurrent writes with block-size changes are "good luck with<br />that".<br /><br />              Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
