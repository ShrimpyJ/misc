    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/1999/12/13/208">First message in thread</a></li><li><a href="/lkml/1999/12/16/204">Linus Torvalds</a><ul><li><a href="/lkml/1999/12/16/214">"David S. Miller"</a><ul><li class="origin"><a href="/lkml/1999/12/19/102">Linus Torvalds</a><ul><li><a href="/lkml/1999/12/19/102">Ralf Baechle</a></li><li><a href="/lkml/1999/12/20/116">Richard Henderson</a><ul><li><a href="/lkml/1999/12/20/155">David Wragg</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/1999/12/17/71">James Simmons</a><ul><li><a href="/lkml/1999/12/17/108">Raul Miller</a><ul><li><a href="/lkml/1999/12/17/111">Linus Torvalds</a><ul><li><a href="/lkml/1999/12/17/116">Raul Miller</a></li></ul></li><li><a href="/lkml/1999/12/18/56">James Simmons</a><ul><li><a href="/lkml/1999/12/18/71">Raul Miller</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 16 Dec 1999 16:40:09 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Thread-private mappings and graphics (was Re: Per-Processor Data Page)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 16 Dec 1999, David S. Miller wrote:<br />&gt;    You can do a _regular_ SMP-safe lock with _real_ thread safety and<br />&gt;    no faulting behaviour in a few instructions. We're talking maybe 50<br />&gt;    cycles here - about 40 cycles for the actual two locked<br />&gt;    instructions, and a very generous 10 cycles to check whether you<br />&gt;    are the old owner and going to the switch routine if not).<br />&gt; <br />&gt; And this scheme has some kind of provision that in the contention case<br />&gt; it knows how to go off and do some matrix multiplications instead of<br />&gt; spinning for the lock while another thread is pummeling triangles to<br />&gt; the card, right?<br /><br />Right. <br /><br />What happens is that it's basically a user-mode spinlock that on<br />contention does a kernel ioctl.<br /><br />The spinlock is in a shared memory data structure, that the kernel driver<br />also knows about etc, and yes it needs kernel support for the final<br />product, but you can do a lot of testing in user-mode alone (make it<br />thread-safe within one process first, and THEN look at how to make it safe<br />between processes through a shared area).<br /><br />&gt;    Oh. And btw. It's already been done. See the 3dfx driver.<br />&gt; <br />&gt; This was the premise of most of this thread I thought.  "3dfx do it<br />&gt; the lock way" and here is some other way we're discussion the merits<br />&gt; of for hardware that has the capability.<br /><br />Note that historically atomic locks have been EXPENSIVE. I think that was<br />true on MIPS too, even with the load-locked thing, just because with the<br />weak cache coherency the thing was initially done on the _bus_, not inside<br />the CPU. But happily that time is long gone, and it's not coming back. <br /><br />(The early alpha implementation of LD_L + ST_C was entierly uncached, and<br />just took a hundred cycles or more to generate a SMP-safe lock. Ugh.<br />Double-ugh. Intel does it in 20 cycles or so, and I think even that is<br />excessive, but they probably have good synchronization reasons for it).<br /><br />So it may be that at one point people _really_ didn't want to do the<br />explicit lock. I think that time is past.<br /><br />Note that the 3dfx driver works, but who knows, it can certainly have<br />bugs. But I did not get a bad feeling about including the DRM code from<br />Precision Insight into the kernel - unlike this "playing with mappings"<br />thing that just makes me shiver.<br /><br />		Linus<br /><br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.rutgers.edu<br />Please read the FAQ at <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
