    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2016/12/19/535">First message in thread</a></li><li><a href="/lkml/2016/12/21/78">Peter Zijlstra</a><ul><li><a href="/lkml/2016/12/21/92">Peter Zijlstra</a><ul><li class="origin"><a href="/lkml/2016/12/21/381">Linus Torvalds</a><ul><li><a href="/lkml/2016/12/21/381">Nicholas Piggin</a><ul><li><a href="/lkml/2016/12/21/404">Nicholas Piggin</a></li></ul></li><li><a href="/lkml/2016/12/22/412">Hugh Dickins</a></li></ul></li></ul></li><li><a href="/lkml/2016/12/21/141">Nicholas Piggin</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 21 Dec 2016 10:02:27 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [RFC][PATCH] make global bitlock waitqueues per-node</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Dec 21, 2016 at 12:32 AM, Peter Zijlstra &lt;peterz&#64;infradead.org&gt; wrote:<br />&gt;<br />&gt; FWIW, here's mine.. compiles and boots on a NUMA x86_64 machine.<br /><br />So I like how your patch is smaller, but your patch is also broken.<br /><br />First off, the whole contention bit is *not* NUMA-specific. It should<br />help non-NUMA too, by avoiding the stupid extra cache miss.<br /><br />Secondly, CONFIG_NUMA is a broken thing to test anyway, since adding a<br />bit for the NUMA case can overflow the page flags as far as I can tell<br />(MIPS seems to support NUMA on 32-bit, for example, but I didn't<br />really check the Kconfig details). Making it dependent on 64-bit might<br />be ok (and would fix the issue above - I don't think we really need to<br />care too much about 32-bit any more)<br /><br />But making it conditional at all means that now you have those two<br />different cases for this, which is a maintenance nightmare. So don't<br />do it even if we could say "screw 32-bit".<br /><br />Anyway, the conditional thing could be fixed by just taking Nick's<br />patch 1/2, and your patch (with the conditional bits stripped out).<br /><br />I do think your approach of just re-using the existing bit waiting<br />with just a page-specific waiting function is nicer than Nick's "let's<br />just roll new waiting functions" approach. It also avoids the extra<br />initcall.<br /><br />Nick, comments?<br /><br />Hugh - mind testing PeterZ's patch too? My comments about the<br />conditional PG_waiters bit and page bit overflow are not relevant for<br />your particular scenario, so you can ignore that part, and just take<br />PaterZ's patch directly.<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
