    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2016/8/9/440">First message in thread</a></li><li><a href="/lkml/2016/8/15/864">Linus Torvalds</a><ul><li><a href="/lkml/2016/8/16/838">Dave Chinner</a><ul><li class="origin"><a href="">Linus Torvalds</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 16 Aug 2016 16:23:04 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [LKP] [lkp] [xfs] 68a9f5e700: aim7.jobs-per-min -13.6% regression</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Aug 16, 2016 at 3:02 PM, Dave Chinner &lt;david&#64;fromorbit.com&gt; wrote:<br />&gt;&gt;<br />&gt;&gt; What does your profile show for when you actually dig into<br />&gt;&gt; __remove_mapping() itself?, Looking at your flat profile, I'm assuming<br />&gt;&gt; you get<br />&gt;<br />&gt; -   22.26%     0.93%  [kernel]          [k] __remove_mapping<br />&gt;    - 3.86% __remove_mapping<br />&gt;       - 18.35% _raw_spin_lock_irqsave<br />&gt;            __pv_queued_spin_lock_slowpath<br />&gt;         1.32% __delete_from_page_cache<br />&gt;       - 0.92% _raw_spin_unlock_irqrestore<br />&gt;            __raw_callee_save___pv_queued_spin_unlock<br /><br />Ok, that's all very consistent with my profiles, except - obviously -<br />for the crazy spinlock thing.<br /><br />One difference is that your unlock has that PV unlock thing - on raw<br />hardware it's just a single store. But I don't think I saw the<br />unlock_slowpath in there.<br /><br />There's nothing really expensive going on there that I can tell.<br /><br />&gt; And the instruction level profile:<br /><br />Yup. The bulk is in the cmpxchg and a cache miss (it just shows up in<br />the instruction after it: you can use "cycles:pp" to get perf to<br />actually try to fix up the blame to the instruction that _causes_<br />things rather than the instruction following, but in this case it's<br />all trivial).<br /><br />&gt; It's the same code AFAICT, except the pv version jumps straight to<br />&gt; the "queue" case.<br /><br />Yes. Your profile looks perfectly fine. Most of the profile is rigth<br />after the 'pause', which you'd expect.<br /><br />From a quick look, it seems like only about 2/3rd of the time is<br />actually spent in the "pause" loop, but the control flow is complex<br />enough that maybe I didn't follow it right. The native case is<br />simpler. But since I suspect that it's not so much about the<br />spinlocked region being too costly, but just about locking too damn<br />much), that 2/3rds actually makes sense: it's not that it's<br />necessarily spinning waiting for the lock all that long in any<br />individual case, it's just that the spin_lock code is called so much.<br /><br />So I still kind of just blame kswapd, rather than any new expense. It<br />would be interesting to hear if Mel is right about that kswapd<br />sleeping change between 4.6 and 4.7..<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
