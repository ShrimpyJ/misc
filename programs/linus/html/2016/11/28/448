    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2016/11/28/87">First message in thread</a></li><li><a href="/lkml/2016/11/28/87">Aaron Lu</a><ul><li><a href="/lkml/2016/11/28/88">Aaron Lu</a></li><li><a href="/lkml/2016/11/28/89">Aaron Lu</a><ul><li class="origin"><a href="/lkml/2016/11/28/880">Linus Torvalds</a><ul><li><a href="/lkml/2016/11/28/880">Aaron Lu</a><ul><li><a href="/lkml/2016/11/28/883">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2016/11/28/468">Dave Hansen</a><ul><li><a href="/lkml/2016/11/28/479">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 28 Nov 2016 09:15:36 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 2/2] mremap: use mmu gather logic for tlb flush in mremap</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Nov 28, 2016 at 12:40 AM, Aaron Lu &lt;aaron.lu&#64;intel.com&gt; wrote:<br />&gt; As suggested by Linus, the same mmu gather logic could be used for tlb<br />&gt; flush in mremap and this patch just did that.<br /><br />Ok, looking at this patch, I still think it looks like the right thing<br />to do, but I'm admittedly rather less certain of it.<br /><br />The main advantage of the mmu_gather thing is that it automatically<br />takes care of the TLB flush ranges for us, and that's a big deal<br />during munmap() (where the actual unmapped page range can be _very_<br />different from the total range), but now that I notice that this<br />doesn't actually remove any other code (in fact, it adds a line), I'm<br />wondering if it's worth it. mremap() is already "dense" in the vma<br />space, unlike munmap (ie you can't move multiple vma's with a single<br />mremap), so the fancy range optimizations that make a difference on<br />some architectures aren't much of an issue.<br /><br />So I guess the MM people should take a look at this and say whether<br />they think the current state is fine or whether we should do the<br />mmu_gather thing. People?<br /><br />However, I also independently think I found an actual bug while<br />looking at the code as part of looking at the patch.<br /><br />This part looks racy:<br /><br />                /*<br />                 * We are remapping a dirty PTE, make sure to<br />                 * flush TLB before we drop the PTL for the<br />                 * old PTE or we may race with page_mkclean().<br />                 */<br />                if (pte_present(*old_pte) &amp;&amp; pte_dirty(*old_pte))<br />                        force_flush = true;<br />                pte = ptep_get_and_clear(mm, old_addr, old_pte);<br /><br />where the issue is that another thread might make the pte be dirty (in<br />the hardware walker, so no locking of ours make any difference)<br />*after* we checked whether it was dirty, but *before* we removed it<br />from the page tables.<br /><br />So I think the "check for force-flush" needs to come *after*, and we should do<br /><br />                pte = ptep_get_and_clear(mm, old_addr, old_pte);<br />                if (pte_present(pte) &amp;&amp; pte_dirty(pte))<br />                        force_flush = true;<br /><br />instead.<br /><br />This happens for the pmd case too.<br /><br />So now I'm not sure the mmu_gather thing is worth it, but I'm pretty<br />sure that there remains a (very very) small race that wasn't fixed by<br />the original fix in commit 5d1904204c99 ("mremap: fix race between<br />mremap() and page cleanning").<br /><br />Aaron, sorry for waffling about this, and asking you to look at a<br />completely different issue instead.<br /><br />                 Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
