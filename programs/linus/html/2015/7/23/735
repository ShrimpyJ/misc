    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2015/7/23/722">First message in thread</a></li><li><a href="/lkml/2015/7/23/722">Andy Lutomirski</a><ul><li class="origin"><a href="/lkml/2015/7/23/743">Linus Torvalds</a><ul><li><a href="/lkml/2015/7/23/743">Andy Lutomirski</a><ul><li><a href="/lkml/2015/7/23/762">Linus Torvalds</a><ul><li><a href="/lkml/2015/7/23/775">Steven Rostedt</a></li></ul></li></ul></li><li><a href="/lkml/2015/7/23/749">Willy Tarreau</a><ul><li><a href="/lkml/2015/7/23/751">Andy Lutomirski</a><ul><li><a href="/lkml/2015/7/23/760">Willy Tarreau</a></li></ul></li><li><a href="/lkml/2015/7/23/763">Linus Torvalds</a><ul><li><a href="/lkml/2015/7/23/766">Willy Tarreau</a></li></ul></li></ul></li><li><a href="/lkml/2015/7/23/768">Peter Zijlstra</a><ul><li><a href="/lkml/2015/7/23/776">Linus Torvalds</a><ul><li><a href="/lkml/2015/7/23/782">Andy Lutomirski</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2015/7/23/765">Peter Zijlstra</a></li><li><a href="/lkml/2015/7/23/767">Steven Rostedt</a><ul><li><a href="/lkml/2015/7/23/783">Andy Lutomirski</a></li></ul></li><li><a href="/lkml/2015/7/24/496">Raymond Jennings</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 23 Jul 2015 13:38:33 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Dealing with the NMI mess</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Thu, Jul 23, 2015 at 1:21 PM, Andy Lutomirski &lt;luto&#64;amacapital.net&gt; wrote:<br />&gt;<br />&gt; 2. Forbid IRET inside NMIs.  Doable but maybe not that pretty.<br />&gt;<br />&gt; We haven't considered:<br />&gt;<br />&gt; 3. Forbid faults (other than MCE) inside NMI.<br /><br />I'd really prefer #2. #3 depends on us getting many things right, and<br />never introducing new cases in the future.<br /><br />#2, in contrast, seems to be fairly localized. Yes, RF is an issue,<br />but returning to user space with RF clear doesn't really seem to be<br />all that problematic.<br /><br />The point of RF is to make forward progress in the face of debug<br />register faults, but I don't see what was wrong with the whole<br />"disable any debug events that happen with interrupts disabled".<br /><br />And no, I do *not* believe that we should disable debug faults ahead<br />of time. We should take them, disable them, and return with 'ret'. No<br />complex "you can't put breakpoints in this region" crap, no magic<br />rules, no subtle issues.<br /><br />I really think your "disallow #DB" is pointless. I think your "prevent<br />instruction breakpoints in NMI" is wrong. Let them happen. Take them<br />and disable them. Return with RT clear. Go on with your life.<br /><br />And the "take them and disable them" is really simple. No "am I in an<br />NMI contect" thing (because that leads to the whole question about<br />"what is NMI context"). That's not the real rule anyway.<br /><br />No, make it very simple and straightforward. Make the test be "uhhuh,<br />I got a #DB in kernel mode, and interrupts were disabled - I know I'm<br />going to return with "ret", so I'm just going to have to disable this<br />breakpoint".<br /><br />Nothing clever. Nothing subtle. Nothing that needs "this range of<br />instructions is magical". No.  Just a very simple rule: if the context<br />we return to is kernel mode and interrupts are disabled, we're using<br />'ret', so we cannot suppress debug faults.<br /><br />Did I miss something? There were a lot of emails flying around, but I<br />*thought* I saw them all..<br /><br />              Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
