    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2001/12/20/192">First message in thread</a></li><li><a href="/lkml/2001/12/20/192">"Torrey Hoffman"</a><ul><li class="origin"><a href="/lkml/2001/12/20/227">Linus Torvalds</a><ul><li><a href="/lkml/2001/12/20/227">Tachino Nobuhiro</a><ul><li><a href="/lkml/2001/12/20/214">Andre Hedrick</a></li></ul></li><li><a href="/lkml/2001/12/20/250">Alexander Viro</a></li><li><a href="/lkml/2001/12/20/300">Andrea Arcangeli</a><ul><li><a href="/lkml/2001/12/20/234">Andrea Arcangeli</a></li><li><a href="/lkml/2001/12/30/3">Andrea Arcangeli</a></li><li><a href="/lkml/2001/12/30/14">Andrew Morton</a><ul><li><a href="/lkml/2001/12/30/104">Alexander Viro</a></li></ul></li><li><a href="/lkml/2001/12/29/59">Andrea Arcangeli</a><ul><li><a href="/lkml/2001/12/31/36">Daniel Phillips</a></li></ul></li><li><a href="/lkml/2002/1/4/159">"Stephen C. Tweedie"</a></li><li><a href="/lkml/2002/1/5/27">Andrew Morton</a></li><li><a href="/lkml/2002/1/6/120">Andrea Arcangeli</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 20 Dec 2001 11:46:23 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: ramdisk corruption problems - was: RE: pivot_root and initrd 	kern el panic woes</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">In article &lt;D52B19A7284D32459CF20D579C4B0C0211CB0F&#64;mail0.myrio.com&gt; you write:<br />&gt;Yes, this does fix the problem.  Thank you very much!<br />&gt;<br />&gt;Hopefully something like this will make it into 2.4.18?<br /><br />This does not seem quite right.<br /><br />&gt;Tachino Nobuhiro (tachino&#64;open.nm.fujitsu.co.jp) wrote:<br />&gt;&gt; Hello,<br />&gt;&gt; <br />&gt;&gt; Following patch may fix your problem. <br />&gt;&gt; <br />&gt;&gt; diff -r -u linux-2.4.17-rc2.org/drivers/block/rd.c <br />&gt;&gt; linux-2.4.17-rc2/drivers/block/rd.c<br />&gt;&gt; --- linux-2.4.17-rc2.org/drivers/block/rd.c	Thu Dec 20 20:30:57 2001<br />&gt;&gt; +++ linux-2.4.17-rc2/drivers/block/rd.c	Thu Dec 20 20:46:53 2001<br />&gt;&gt; &#64;&#64; -194,9 +194,11 &#64;&#64;<br />&gt;&gt;  static int ramdisk_readpage(struct file *file, struct page * page)<br />&gt;&gt;  {<br />&gt;&gt;  	if (!Page_Uptodate(page)) {<br />&gt;&gt; -		memset(kmap(page), 0, PAGE_CACHE_SIZE);<br />&gt;&gt; -		kunmap(page);<br />&gt;&gt; -		flush_dcache_page(page);<br />&gt;&gt; +		if (!page-&gt;buffers) {<br />&gt;&gt; +			memset(kmap(page), 0, PAGE_CACHE_SIZE);<br />&gt;&gt; +			kunmap(page);<br />&gt;&gt; +			flush_dcache_page(page);<br />&gt;&gt; +		}<br />&gt;&gt;  		SetPageUptodate(page);<br />&gt;&gt;  	}<br />&gt;&gt;  	UnlockPage(page);<br />&gt;&gt; <br />&gt;&gt; <br />&gt;&gt;   grow_dev_page() creates not Uptodate page which has valid <br />&gt;&gt; buffers, so<br />&gt;&gt; it is wrong that ramdisk_readpage() clears whole page unconditionally.<br /><br />The problem is that having buffers doesn't necessarily always mean that<br />they are valid, nor that _all_ of them are valid.<br /><br />Also, if the ramdisk "readpage" code is wrong, then so is the<br />"prepare_write" code.  They share the same logic, which basically says<br />that "if the page isn't up-to-date, then it is zero".  Which is always<br />true for normal read/write accesses, but as you found out it's not true<br />when parts of the page have been accessed by filesystems through the<br />buffers. <br /><br />So the code _should_ use a common helper, something like<br /><br />	static void ramdisk_updatepage(struct page * page)<br />	{<br />		if (!Page_Uptodate(page)) {<br />			struct buffer_head *bh = page-&gt;buffers;<br />			void * address = page_address(page);<br />			if (bh) {<br />				struct buffer_head *tmp = bh;<br />				do {<br />					if (!buffer_uptodate(tmp)) {<br />						memset(address, 0, tmp-&gt;b_size);<br />						 set_buffer_uptodate(tmp);<br />					}<br />					address += tmp-&gt;b_size;<br />					tmp = tmp-&gt;b_this_page;<br />				} while (tmp != bh);<br />			} else<br />				memset(address, 0, PAGE_SIZE);<br />			flush_dcache_page(page);<br />			SetPageUptodate(page);<br />		}<br />	}<br /><br />and then ramdisk_readpage() would just be<br /><br />	kmap(page);<br />	ramdisk_updatepage(page);<br />	UnlockPage(page);<br />	kunmap(page);<br />	return 0;<br /><br />while ramdisk_prepare_write() would be<br /><br />	ramdisk_updatepage(page);<br />	SetPageDirty(page);<br />	return 0;<br /><br />NOTE NOTE NOTE! This is untested.  Please somebody test it, and in<br />particular verify that there aren't any stupid highmem bugs, and<br />resubmit the patch to me and Marcelo, ok?<br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
