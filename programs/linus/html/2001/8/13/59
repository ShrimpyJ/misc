    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2001/8/13/31">First message in thread</a></li><li><a href="/lkml/2001/8/13/31">Max Kamenetsky</a><ul><li class="origin"><a href="/lkml/2001/8/14/2">Linus Torvalds</a><ul><li><a href="/lkml/2001/8/14/2">Max Kamenetsky</a></li></ul></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2001/8/13/59/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 13 Aug 2001 12:33:45 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 2.4.9-pre1 NFS problem</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">In article &lt;20010813114636.A4641&#64;chinook.stanford.edu&gt; you write:<br />&gt;<br />&gt;It looks like 2.4.9-pre1 breaks the NFS server.  Directories still get<br />&gt;exported and clients can mount them fine, but the ls command on the<br />&gt;client fails to report any files.  Filename completion also doesn't<br />&gt;work.  However, files can still be viewed if you know the exact file<br />&gt;name.<br /><br />Yes, there's a missing off_t -&gt; loff_t change in pre1, and the compile<br />will even warn about it...<br /><br />&gt;The same problem happens with 2.4.9-pre2.<br /><br />..but I thought I fixed it in pre2. <br /><br />HOWEVER - there are a few others that I missed because the NFSD layer is<br />doing ugly casts of function pointers (don't ask me why - it should have<br />the right type in 'filldir_t' already but wants to use its own type), so<br />the compiler can't warn about it. <br /><br />Let's hear it for type safety and avoiding ugly casts.<br /><br />Anyway, here's the patch - does this fix it for you?<br /><br />		Linus<br /><br />-----<br />diff -u --recursive --new-file pre2/linux/fs/nfsd/nfs3xdr.c linux/fs/nfsd/nfs3xdr.c<br />--- pre2/linux/fs/nfsd/nfs3xdr.c	Sun Aug 12 23:12:33 2001<br />+++ linux/fs/nfsd/nfs3xdr.c	Mon Aug 13 12:22:57 2001<br />&#64;&#64; -730,14 +730,14 &#64;&#64;<br /> <br /> int<br /> nfs3svc_encode_entry(struct readdir_cd *cd, const char *name,<br />-		     int namlen, off_t offset, ino_t ino, unsigned int d_type)<br />+		     int namlen, loff_t offset, ino_t ino, unsigned int d_type)<br /> {<br /> 	return encode_entry(cd, name, namlen, offset, ino, d_type, 0);<br /> }<br /> <br /> int<br /> nfs3svc_encode_entry_plus(struct readdir_cd *cd, const char *name,<br />-			  int namlen, off_t offset, ino_t ino, unsigned int d_type)<br />+			  int namlen, loff_t offset, ino_t ino, unsigned int d_type)<br /> {<br /> 	return encode_entry(cd, name, namlen, offset, ino, d_type, 1);<br /> }<br />diff -u --recursive --new-file pre2/linux/fs/nfsd/nfsxdr.c linux/fs/nfsd/nfsxdr.c<br />--- pre2/linux/fs/nfsd/nfsxdr.c	Sun Aug 12 23:12:33 2001<br />+++ linux/fs/nfsd/nfsxdr.c	Mon Aug 13 12:23:49 2001<br />&#64;&#64; -391,7 +391,7 &#64;&#64;<br /> <br /> int<br /> nfssvc_encode_entry(struct readdir_cd *cd, const char *name,<br />-		    int namlen, off_t offset, ino_t ino, unsigned int d_type)<br />+		    int namlen, loff_t offset, ino_t ino, unsigned int d_type)<br /> {<br /> 	u32	*p = cd-&gt;buffer;<br /> 	int	buflen, slen;<br />diff -u --recursive --new-file pre2/linux/include/linux/nfsd/nfsd.h linux/include/linux/nfsd/nfsd.h<br />--- pre2/linux/include/linux/nfsd/nfsd.h	Fri Aug 10 18:14:31 2001<br />+++ linux/include/linux/nfsd/nfsd.h	Mon Aug 13 12:30:35 2001<br />&#64;&#64; -57,7 +57,7 &#64;&#64;<br /> 	char			dotonly;<br /> };<br /> typedef int		(*encode_dent_fn)(struct readdir_cd *, const char *,<br />-						int, off_t, ino_t, unsigned int);<br />+						int, loff_t, ino_t, unsigned int);<br /> typedef int (*nfsd_dirop_t)(struct inode *, struct dentry *, int, int);<br /> <br /> /*<br />diff -u --recursive --new-file pre2/linux/include/linux/nfsd/xdr.h linux/include/linux/nfsd/xdr.h<br />--- pre2/linux/include/linux/nfsd/xdr.h	Fri Aug 10 18:15:05 2001<br />+++ linux/include/linux/nfsd/xdr.h	Mon Aug 13 12:28:54 2001<br />&#64;&#64; -151,7 +151,7 &#64;&#64;<br /> int nfssvc_encode_readdirres(struct svc_rqst *, u32 *, struct nfsd_readdirres *);<br /> <br /> int nfssvc_encode_entry(struct readdir_cd *, const char *name,<br />-				int namlen, off_t offset, ino_t ino, unsigned int);<br />+				int namlen, loff_t offset, ino_t ino, unsigned int);<br /> <br /> int nfssvc_release_fhandle(struct svc_rqst *, u32 *, struct nfsd_fhandle *);<br /> <br />diff -u --recursive --new-file pre2/linux/include/linux/nfsd/xdr3.h linux/include/linux/nfsd/xdr3.h<br />--- pre2/linux/include/linux/nfsd/xdr3.h	Fri Aug 10 18:15:17 2001<br />+++ linux/include/linux/nfsd/xdr3.h	Mon Aug 13 12:28:54 2001<br />&#64;&#64; -292,10 +292,10 &#64;&#64;<br /> int nfs3svc_release_fhandle2(struct svc_rqst *, u32 *,<br /> 				struct nfsd3_fhandle_pair *);<br /> int nfs3svc_encode_entry(struct readdir_cd *, const char *name,<br />-				int namlen, off_t offset, ino_t ino,<br />+				int namlen, loff_t offset, ino_t ino,<br /> 				unsigned int);<br /> int nfs3svc_encode_entry_plus(struct readdir_cd *, const char *name,<br />-				int namlen, off_t offset, ino_t ino,<br />+				int namlen, loff_t offset, ino_t ino,<br /> 				unsigned int);<br /> <br /> <br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
