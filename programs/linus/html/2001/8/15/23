    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2001/8/15/24">First message in thread</a></li><li><a href="/lkml/2001/8/15/24">"Nick Piggin"</a><ul><li class="origin"><a href="">Linus Torvalds</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2001/8/15/23/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 15 Aug 2001 02:43:24 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: kswapd using all cpu for long periods in 2.4.9-pre4</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">In article &lt;000c01c12569$65581630$0200a8c0&#64;W2K&gt; you write:<br />&gt;<br />&gt;Somewhere between 2.4.8 and 2.4.9-pre4 kswapd developed a problem. Actually<br />&gt;it looks like it is related to the changes in do_try_to_free_pages...<br />&gt;<br />&gt;kswapd is using all cpu for long periods (100-200 seconds then 100-200<br />&gt;seconds break....) there is very little disk activity (heres a vmstat while<br />&gt;its happening)<br /><br />For some reason do_try_to_free_pages() doesn't end up ever being happy<br />with how much memory there is free (that's why kswapd will loop).  But<br />you actually have a reasonable amount of free memory, so all the memory<br />free'ers will actually refuse to do anything.  The problem seems to be<br />that either inactive_shortage() or free_shortage() will just continually<br />claim that you have a shortage of memory. <br /><br />However, you actually do have memory:<br /><br />&gt;mem info during:<br />&gt;SysRq: Show Memory<br />&gt;Mem-info:<br />&gt;Free pages: 3744kB ( 0kB HighMem)<br />&gt;( Active: 6946, inactive_dirty: 4296, inactive_clean: 895, free: 936 (256<br />&gt;512 2048) )<br />&gt;5*4kB 1*8kB 1*16kB 1*32kB 1*64kB 1*128kB 1*256kB 1*512kB 0*1024kB 0*2048kB = 1036kB)<br />&gt;263*4kB 105*8kB 5*16kB 1*32kB 1*64kB 1*128kB 0*256kB 1*512kB 0*1024kB 0*2048kB = 2708kB)<br />&gt; = 0kB)<br />&gt;Swap cache: add 16680, delete 14047, find 17408/32591<br />&gt;Free swap: 110016kB<br />&gt;16368 pages of RAM<br />&gt;0 pages of HIGHMEM<br /><br />I bet this is it.<br /><br />It probably decides that you have a shortage of HIGHMEM pages. Which is<br />understandable, since you don't have any ;)<br /><br />Does the following trivial patch fix it for you?<br /><br />(If it doesn't, please try just removing the "continue" at line 930 or<br />so in the middle of the kswapd loop.  But I think there's something else<br />that makes kswapd just think it _should_ loop, and the lack of<br />zone-&gt;size testing in the inactive_shortage() calculations looks like<br />it).<br /><br />	Thanks,<br /><br />		Linus<br /><br />-----<br />--- pre4/linux/mm/vmscan.c	Wed Aug 15 02:39:44 2001<br />+++ linux/mm/vmscan.c	Wed Aug 15 02:37:07 2001<br />&#64;&#64; -788,6 +788,9 &#64;&#64;<br /> 			zone_t *zone = pgdat-&gt;node_zones + i;<br /> 			unsigned int inactive;<br /> <br />+			if (!zone-&gt;size)<br />+				continue;<br />+<br /> 			inactive  = zone-&gt;inactive_dirty_pages;<br /> 			inactive += zone-&gt;inactive_clean_pages;<br /> 			inactive += zone-&gt;free_pages;<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
