    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2001/9/26/22">First message in thread</a></li><li><a href="/lkml/2001/9/26/147">Andrea Arcangeli</a><ul><li><a href="/lkml/2001/9/27/155">Andrea Arcangeli</a><ul><li class="origin"><a href="/lkml/2001/9/27/180">Linus Torvalds</a><ul><li><a href="/lkml/2001/9/27/180">Andrea Arcangeli</a></li><li><a href="/lkml/2001/9/27/211">Linus Torvalds</a><ul><li><a href="/lkml/2001/9/27/192">Andrea Arcangeli</a></li></ul></li><li><a href="/lkml/2001/9/27/218">Andrea Arcangeli</a><ul><li><a href="/lkml/2001/9/27/185">Andrea Arcangeli</a></li><li><a href="/lkml/2001/9/27/194">Linus Torvalds</a></li><li><a href="/lkml/2001/9/27/200">Robert Macaulay</a></li><li><a href="/lkml/2001/9/27/213">Andrea Arcangeli</a></li></ul></li></ul></li><li><a href="/lkml/2001/9/27/207">"J . A . Magallon"</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 27 Sep 2001 16:16:11 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: highmem deadlock fix [was Re: VM in 2.4.10(+tweaks) vs. 2.4.9-ac14/15(+stuff)]</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />On Fri, 28 Sep 2001, Andrea Arcangeli wrote:<br />&gt;<br />&gt; The deadlock happens in the middle of write_locked_buffers when we hit<br />&gt; an highmem buffer, so while allocating with GFP_NOHIGHIO we end doing<br />&gt; sync_page_buffers on any page that isn't highmem, but that incidentally is one of the<br />&gt; other next buffers in the array that we previously locked in<br />&gt; write_some_buffers but that aren't in the I/O queue yet (so we'll wait<br />&gt; forever since they depends on us to be written).<br /><br />Interesting, indeed..<br /><br />However, your patch is racy:<br /><br />&gt; --- 2.4.10aa2/fs/buffer.c.~1~	Wed Sep 26 18:45:29 2001<br />&gt; +++ 2.4.10aa2/fs/buffer.c	Fri Sep 28 00:04:44 2001<br />&gt; &#64;&#64; -194,6 +194,7 &#64;&#64;<br />&gt;  		struct buffer_head * bh = *array++;<br />&gt;  		bh-&gt;b_end_io = end_buffer_io_sync;<br />&gt;  		submit_bh(WRITE, bh);<br />&gt; +		clear_bit(BH_Pending_IO, &amp;bh-&gt;b_state);<br /><br />No way can we clear the bit here, because the submit_bh() may have caused<br />the buffer to be unlocked and IO to have completed, and it is no longer<br />"owned" by us - somebody else might have started IO on it and we'd be<br />clearing the bit for the wrong user.<br /><br />I would suggest a totally different approach: make the "can we wait for<br />existing buffer heads" condition a GFP bit the same way the HIGHIO thing<br />is a GFP bit, and just not set it for GFP_NOHIGHIO.<br /><br />Thinking about it, I think GFP_NOIO also implies "we must not wait for<br />other buffers", because that could deadlock for _other_ things too, like<br />loop and NBD (which use NOIO to make sure that they don't recurse - but<br />that should also imply not waiting for themselves). The GFP_xxx approach<br />should fix those deadlocks too.<br /><br />		Linus<br /><br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
