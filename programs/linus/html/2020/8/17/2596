    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2020/8/17/2492">First message in thread</a></li><li><a href="/lkml/2020/8/17/2492">(Eric W. Biederman)</a><ul><li><a href="/lkml/2020/8/17/2502">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/362">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2503">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/363">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2504">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/357">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2505">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/20/2144">Cyrill Gorcunov</a></li></ul></li><li><a href="/lkml/2020/8/17/2506">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/394">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2507">"Eric W. Biederman"</a></li><li><a href="/lkml/2020/8/17/2508">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/392">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2509">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/17/2649">Al Viro</a><ul><li><a href="/lkml/2020/8/18/14">Alexei Starovoitov</a></li></ul></li></ul></li><li><a href="/lkml/2020/8/17/2510">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/17/2592">Linus Torvalds</a><ul><li><a href="/lkml/2020/8/17/2621">Linus Torvalds</a><ul><li><a href="/lkml/2020/8/18/420">Christian Brauner</a></li></ul></li></ul></li><li><a href="/lkml/2020/8/20/2150">Cyrill Gorcunov</a></li></ul></li><li><a href="/lkml/2020/8/17/2511">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/396">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2515">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/368">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2516">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/51">kernel test robot</a><ul><li><a href="/lkml/2020/8/18/546">(Eric W. Biederman)</a></li></ul></li></ul></li><li><a href="/lkml/2020/8/17/2517">"Eric W. Biederman"</a><ul><li class="origin"><a href="/lkml/2020/8/17/2623">Linus Torvalds</a><ul><li><a href="/lkml/2020/8/17/2623">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2020/8/18/400">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2519">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/372">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2520">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/398">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2521">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/375">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2522">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/379">Christian Brauner</a></li><li><a href="/lkml/2020/8/18/433">Christoph Hellwig</a><ul><li><a href="/lkml/2020/8/18/538">(Eric W. Biederman)</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 17 Aug 2020 17:08:27 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 12/17] proc/fd: In fdinfo seq_show don't use get_files_struct</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Mon, Aug 17, 2020 at 3:11 PM Eric W. Biederman &lt;ebiederm&#64;xmission.com&gt; wrote:<br />&gt;<br />&gt; Instead hold task_lock for the duration that task-&gt;files needs to be<br />&gt; stable in seq_show.  The task_lock was already taken in<br />&gt; get_files_struct, and so skipping get_files_struct performs less work<br />&gt; overall, and avoids the problems with the files_struct reference<br />&gt; count.<br /><br />Hmm. Do we even need that task_lock() at all? Couldn't we do this all<br />with just the RCU lock held for reading?<br /><br />As far as I can tell, we don't really need the task lock. We don't<br />even need the get/pid_task_struct().<br /><br />Can't we just do<br /><br />        rcu_read_lock();<br />        task = pid_task(proc_pid(inode), PIDTYPE_PID);<br />        if (task) {<br />                unsigned int fd = proc_fd(m-&gt;private);<br />                struct file *file = fcheck_task(task, fd);<br />                if (file)<br />                        .. do the seq_printf ..<br /><br />and do it all with no refcount games or task locking at all?<br /><br />Anyway, I don't dislike your patch per se, I just get the feeling that<br />you could go a bit further in that cleanup..<br /><br />And it's quite possible that I'm wrong, and you can't just use the RCU<br />lock, but as far as I can tell, both the task lookup and the file<br />lookup *already* really both depend on the RCU lock anyway, so the<br />other locking and reference counting games really do seem superfluous.<br /><br />Please just send me a belittling email telling me what a nincompoop I<br />am if I have missed something.<br /><br />             Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
