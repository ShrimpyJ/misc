    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2020/8/17/2492">First message in thread</a></li><li><a href="/lkml/2020/8/17/2492">(Eric W. Biederman)</a><ul><li><a href="/lkml/2020/8/17/2502">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/362">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2503">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/363">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2504">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/357">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2505">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/20/2144">Cyrill Gorcunov</a></li></ul></li><li><a href="/lkml/2020/8/17/2506">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/394">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2507">"Eric W. Biederman"</a></li><li><a href="/lkml/2020/8/17/2508">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/392">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2509">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/17/2649">Al Viro</a><ul><li><a href="/lkml/2020/8/18/14">Alexei Starovoitov</a></li></ul></li></ul></li><li><a href="/lkml/2020/8/17/2510">"Eric W. Biederman"</a><ul><li class="origin"><a href="/lkml/2020/8/17/2621">Linus Torvalds</a><ul><li><a href="/lkml/2020/8/17/2621">Linus Torvalds</a><ul><li><a href="/lkml/2020/8/18/420">Christian Brauner</a></li></ul></li></ul></li><li><a href="/lkml/2020/8/20/2150">Cyrill Gorcunov</a></li></ul></li><li><a href="/lkml/2020/8/17/2511">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/396">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2515">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/368">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2516">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/51">kernel test robot</a><ul><li><a href="/lkml/2020/8/18/546">(Eric W. Biederman)</a></li></ul></li></ul></li><li><a href="/lkml/2020/8/17/2517">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/17/2596">Linus Torvalds</a><ul><li><a href="/lkml/2020/8/17/2623">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2020/8/18/400">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2519">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/372">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2520">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/398">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2521">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/375">Christian Brauner</a></li></ul></li><li><a href="/lkml/2020/8/17/2522">"Eric W. Biederman"</a><ul><li><a href="/lkml/2020/8/18/379">Christian Brauner</a></li><li><a href="/lkml/2020/8/18/433">Christoph Hellwig</a><ul><li><a href="/lkml/2020/8/18/538">(Eric W. Biederman)</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 17 Aug 2020 16:54:34 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 09/17] file: Implement fnext_task</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">I like the series, but I have to say that the extension of the<br />horrible "fcheck*()" interfaces raises my hackles..<br /><br />That interface is very very questionable to begin with, and it's easy<br />to get wrong.<br /><br />I don't see you getting it wrong - you do seem to hold the RCU read<br />lock in the places I checked, but it worries me.<br /><br />I think my worry could be at least partially mitigated with more<br />comments and docs:<br /><br />On Mon, Aug 17, 2020 at 3:10 PM Eric W. Biederman &lt;ebiederm&#64;xmission.com&gt; wrote:<br />&gt;<br />&gt; +struct file *fnext_task(struct task_struct *task, unsigned int *ret_fd)<br /><br />Please please *please* make it clear that because this does *not*<br />increment any reference counts, you have to be very very careful using<br />the "struct file" pointer this returns.<br /><br />I really dislike the naming. The old "fcheck()" naming came from the<br />fact that at least one original user just mainly checked if the result<br />was NULL or not. And then others had to be careful to either hold the<br />file_lock spinlock, or at least the RCU read lock so that the result<br />didn't go away.<br /><br />Here, you have "fnext_task()", and it doesn't even have that "check"<br />warning mark, or any comment about how dangerous it can be to use..<br /><br />So the rule is that the "struct file" pointer this returns can only be<br />read under RCU, but the 'fd' it returns has a longer lifetime.<br /><br />I think your uses are ok, and I think this is an improvement in<br />general, I just want a bigger "WARNING! Here be dragons!" sign (and<br />naming could be nicer).<br /><br />            Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
