    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2020/7/21/76">First message in thread</a></li><li><a href="/lkml/2020/7/23/1246">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/23/1268">Hugh Dickins</a><ul><li class="origin"><a href="/lkml/2020/7/23/1385">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/23/1385">Hugh Dickins</a></li></ul></li></ul></li><li><a href="/lkml/2020/7/24/786">Oleg Nesterov</a><ul><li><a href="/lkml/2020/7/24/969">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/24/1262">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/24/1360">Hugh Dickins</a></li><li><a href="/lkml/2020/7/25/133">Oleg Nesterov</a></li><li><a href="/lkml/2020/8/3/755">Michal Hocko</a></li></ul></li><li><a href="/lkml/2020/7/25/125">Oleg Nesterov</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 23 Jul 2020 17:46:59 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [RFC PATCH] mm: silence soft lockups from unlock_page</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Thu, Jul 23, 2020 at 5:07 PM Hugh Dickins &lt;hughd&#64;google.com&gt; wrote:<br />&gt;<br />&gt; I say that for full disclosure, so you don't wrack your brains<br />&gt; too much, when it may still turn out to be a screwup on my part.<br /><br />Sounds unlikely.<br /><br />If that patch applied even reasonably closely, I don't see how you'd<br />see a list corruption that wasn't due to the patch.<br /><br />You'd have had to use the wrong spinlock by mistake due to munging it,<br />or something crazy like that.<br /><br />The main list-handling change is<br /><br /> (a) open-coding of that finish_wait()<br /><br /> (b) slightly different heuristics for removal in the wakeup function<br /><br />where (a) was because my original version of finishing the wait needed<br />to do that return code checking.<br /><br />So a normal "finish_wait()" just does<br /><br />        list_del_init(&amp;wait-&gt;entry);<br /><br />where-as my open-coded one replaced that with<br /><br />        if (!list_empty(&amp;wait-&gt;entry)) {<br />                list_del(&amp;wait-&gt;entry);<br />                ret = -EINTR;<br />        }<br /><br />and apart from that "set return to -EINTR because nobody woke us up",<br />it also uses just a regular "list_del()" rather than a<br />"list_del_init()". That causes the next/prev field to be poisoned<br />rather than re-initialized. But that second change was because the<br />list entry is on the stack, and we're not touching it any more and are<br />about to return, so I removed the "init" part.<br /><br />Anyway, (a) really looks harmless. Unless the poisoning now triggers<br />some racy debug test that had been hidden by the "init". Hmm.<br /><br />In contrast, (b) means that the likely access patterns of irqs<br />removing the wait entry from the list might be very different from<br />before. The old "autoremove" semantics would only remove the entry<br />from the list when try_to_wake_up() actually woke things up. Now, a<br />successful bit state _always_ removes it, which was kind of the point.<br />But it might cause very different list handling patterns.<br /><br />All the actual list handling looks "obviously safe" because it's<br />protected by the spinlock, though...<br /><br />If you do get oopses with the new patch too, try to send me a copy,<br />and maybe I'll stare at exactly where it happens register contents and<br />go "aah".<br /><br />        Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
