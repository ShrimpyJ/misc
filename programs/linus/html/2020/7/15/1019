    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2020/7/15/660">First message in thread</a></li><li><a href="/lkml/2020/7/15/660">"Kirill A. Shutemov"</a><ul><li class="origin"><a href="/lkml/2020/7/15/1149">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/15/1149">Joel Fernandes</a><ul><li><a href="/lkml/2020/7/15/1161">"Kirill A. Shutemov"</a></li><li><a href="/lkml/2020/7/15/1174">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/15/1186">Linus Torvalds</a></li></ul></li></ul></li><li><a href="/lkml/2020/7/15/1150">"Kirill A. Shutemov"</a><ul><li><a href="/lkml/2020/7/15/1178">Linus Torvalds</a><ul><li><a href="/lkml/2020/7/15/1196">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Wed, 15 Jul 2020 11:36:59 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCHv2] mm: Fix warning in move_normal_pmd()</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Wed, Jul 15, 2020 at 6:50 AM Kirill A. Shutemov<br />&lt;kirill.shutemov&#64;linux.intel.com&gt; wrote:<br />&gt;<br />&gt; mremap(2) does not allow source and destination regions to overlap, but<br />&gt; shift_arg_pages() calls move_page_tables() directly and in this case the<br />&gt; source and destination overlap often. It<br /><br />Actually, before we do this patch (which I think is a good idea), I'd<br />like Naresh to test the attached patch.<br /><br />And Kirill, Joel, mind looking it over too.<br /><br />IT IS ENTIRELY UNTESTED.<br /><br />But I hope the concept (and the code) is fairly obvious: it makes<br />move_page_tables() try to align the range to be moved, if possible.<br /><br />That *should* actually remove the warning that Naresh sees, for the<br />simple reason that now the PMD moving case will *always* trigger when<br />the stack movement is PMD-aligned, and you never see the "first do a<br />few small pages, then do the PMD optimization" case.<br /><br />And that should mean that we don't ever hit the "oh, we already have a<br />target pmd" thing, because the "move the whole pmd" case will clear<br />the ones it has already taken care of, and you never have that "oh,<br />there's an empty pmd where the pages were moved away one by one".<br /><br />And that means that for this case, it's _ok_ to overlap (as long as we<br />copy downwards).<br /><br />What do you think?<br /><br />Ok, so I could easily have screwed up the patch, even if it's<br />conceptually fairly simple. The details are small, but they needed<br />some care. The thing _looks_ fine to me, both on a source level and<br />when looking at the generated code, and I made sure to try to use a<br />lot of small helper functions and couple of helper macros to make each<br />individual piece look clear and obvious.<br /><br />But obviously a single "Oh, that test is the wrong way around", or a<br />missing mask inversion, or whatever, could completely break the code.<br />So no guarantees, but it looks fairly straightforward to me.<br /><br />Naresh - this patch does *NOT* make sense to test together with<br />Kirill's (or Joel's) patch that says "don't do the PMD optimization at<br />all for overlapping cases". Those patches will hide the issue, and<br />make the new code only work for mremap(), not for the initial stack<br />setup that caused the original warning.<br /><br />Joel - I think this patch makes sense _regardless_ of the special<br />execve() usage case, in that it extends your "let's just copy things<br />at a whole PMD level" logic to even the case where the beginning<br />wasn't PMD-aligned (or the length wasn't sufficient).<br /><br />Obviously it only triggers when the source and destination are<br />mutually aligned, and if there are no other vma's around those<br />first/last PMD entries. Which might mean that it almost never triggers<br />in practice, but looking at the generated code, it sure looks like<br />it's cheap enough to test.<br /><br />Didn't you have some test-cases for your pmd optimized movement cases,<br />at least for timing?<br /><br />               Linus<br />[unhandled content-type:application/octet-stream]</pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
