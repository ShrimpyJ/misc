    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2020/9/21/1969">First message in thread</a></li><li><a href="/lkml/2020/9/26/387">Linus Torvalds</a><ul><li><a href="/lkml/2020/9/27/39">Leon Romanovsky</a><ul><li class="origin"><a href="/lkml/2020/9/27/319">Linus Torvalds</a><ul><li><a href="/lkml/2020/9/27/319">Linus Torvalds</a><ul><li><a href="/lkml/2020/9/28/589">Jason Gunthorpe</a></li></ul></li><li><a href="/lkml/2020/9/28/911">Peter Xu</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sun, 27 Sep 2020 11:16:34 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 1/5] mm: Introduce mm_struct.has_pinned</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Sat, Sep 26, 2020 at 11:24 PM Leon Romanovsky &lt;leonro&#64;nvidia.com&gt; wrote:<br />&gt;<br />&gt; We won't be able to test the series till Tuesday due to religious holidays.<br /><br />That's fine. I've merged the series up, and it will be in rc7 later<br />today, and with an rc8 next week we'll have two weeks to find any<br />issues.<br /><br />I did edit Peter's patch 3/4 quite a bit:<br /><br /> - remove the pte_mkyoung(), because there's no _access_ at fork()<br />time (so it's very different in that respect to the fault case)<br /><br /> - added the lru_cache_add_inactive_or_unevictable() call that I think<br />is needed and Peter's patch was missing<br /><br /> - split up the "copy page" into its own function kind of like I had<br />done for my minimal patch<br /><br /> - changed the comments around a bit (mostly due to that split-up<br />changing some of the flow)<br /><br />but it should be otherwise the same and I think Peter will still<br />recognize it as his patch (and I left it with his authorship and<br />sign-off).<br /><br />Anyway, it's merged locally in my tree, I'll do some local testing<br />(and I have a few other pull requests), but I'll push out the end<br />result soonish assuming nothing shows up (and considering that I don't<br />have any pinning loads, I seriously doubt it will, since I won't see<br />any of the interesting cases).<br /><br />So if we can get the actual rdma cases tested early next week, we'll<br />be in good shape, I think.<br /><br />Btw, I'm not convinced about the whole "turn the pte read-only and<br />then back". If the fork races with another thread doing a pinning<br />fast-GUP on another CPU, there are memory ordering issues etc too.<br />That's not necessarily visible on x86 (the "turn read-only being a<br />locked op will force serialization), but it all looks dodgy as heck.<br /><br />I'm also not convinced we really want to support that kind of insane<br />racy load, but whatever. I left the code in place, but it's something<br />where we might want to rethink things.<br /><br />              Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
