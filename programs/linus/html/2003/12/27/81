    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2003/12/27/73">First message in thread</a></li><li><a href="/lkml/2003/12/27/73">(Anton Ertl)</a><ul><li class="origin"><a href="/lkml/2003/12/27/95">Linus Torvalds</a><ul><li><a href="/lkml/2003/12/27/95">(Eric W. Biederman)</a><ul><li><a href="/lkml/2003/12/27/96">William Lee Irwin III</a></li><li><a href="/lkml/2003/12/27/105">"David S. Miller"</a></li><li><a href="/lkml/2003/12/27/135">Linus Torvalds</a><ul><li><a href="/lkml/2003/12/28/41">William Lee Irwin III</a></li><li><a href="/lkml/2003/12/29/184">(Eric W. Biederman)</a></li></ul></li></ul></li><li><a href="/lkml/2003/12/28/53">(Anton Ertl)</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 27 Dec 2003 12:56:56 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Page Colouring (was: 2.6.0 Huge pages not working as expected)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Sat, 27 Dec 2003, Anton Ertl wrote:<br />&gt; <br />&gt; And you probably mean "repeatable every time".  Ok, then a random<br />&gt; scheme has, by your definition, no pathological worst case.  I am not<br />&gt; sure that this is a consolation when I happen upon one of its<br />&gt; unpredictable and unrepeatable worst cases.<br /><br />Those "unpredictable" cases are so exceedingly rare that they aren't worth<br />worrying about.<br /><br />&gt; The points are:<br />&gt; <br />&gt; - repeatability<br />&gt; - predictability<br />&gt; - better average performance (you dispute that).<br /><br />I absolutely dispute that.<br /><br />And you should realize that I do not dispute it because the applications<br />themselves would run slower with cache coloring. Most applications don't<br />much care, they either fit in the cache, or the cache misses have random<br />enough access patterns that cache layout doesn't much matter.<br /><br />The test code in question is an anomaly, and doesn't matter. It's exactly<br />the same kind of strange case that sometimes shows cache coloring making a<br />huge difference.<br /><br />The real degradation comes in just the fact that cache coloring itself is<br />often expensive to implement and causes nasty side effects like bad memory <br />allocation patterns, and nasty special cases that you have to worry about <br />(ie special fallback code on non-colored pages when required).<br /><br />That expense is both a run-time expense _and_ a conceptual one (a<br />conceptual expense is somethign that complicates the internal workings of<br />the allocator so much that it becomes harder to think about and more<br />bugprone). So far nobody has shown a reasonable way to do it without<br />either of the two.<br /><br />&gt; Anyway, back to the performance effects of page colouring: Yes, there<br />&gt; are cases where it is not beneficial, and the huge-2^n-stride cases in<br />&gt; examples like the one above are one of them, but I don't think that<br />&gt; this is the kind of "real life" application that you mention<br />&gt; elsewhere, or is it?<br /><br />The "real life" application is something like running a normal server or<br />desktop, and having the cache coloring code _itself_ be the performance<br />problem.<br /><br />It's not that "apache" minds very much. Or "mozilla". They simply don't <br />care. The problem is the algorithm itself.<br /><br />&gt; &gt;Also, the work has been done to test things, and cache coloring definitely<br />&gt; &gt;makes performance _worse_. It does so exactly because it artifically<br />&gt; &gt;limits your page choices, causing problems at multiple levels (not just at<br />&gt; &gt;the cache, like this example, but also in page allocators and freeing).<br />&gt; <br />&gt; Sorry, I am not aware of the work you are referring to.  Where can I<br />&gt; read more about it?  Are you sure that these are fundamental problems<br />&gt; and not just artifacts of particular implementations?<br /><br />Hey, there have been at least four different major cache coloring trials <br />for the kernel over the years. This discussion has been going on since the <br />early nineties. And _none_ of them have worked well in practice.<br /><br />In other words, "artifacts of the particular implementation" is certainly <br />right, but the point I have is that the only thing that _matters_ is <br />implementation. You can argue about theory all you like, I won't care <br />until you show me an implementation that works and is robustly better.<br /><br />And it has to be better on average on _everything_ that Linux supports,<br />not just one particular braindamaged piece of hardware. I'm totally not<br />interested in something that makes performance on most machines go down,<br />if it then improves one or two braindead setups with direct-mapped caches.<br /><br />Basically: prove me wrong. People have tried before. They have failed. <br />Maybe you'll succeed. I doubt it, but hey, I'm not stopping you.<br /><br />		Linus<br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
