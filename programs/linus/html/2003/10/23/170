    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2003/10/20/264">First message in thread</a></li><li><a href="/lkml/2003/10/23/140">Eric Anholt</a><ul><li><a href="/lkml/2003/10/23/146">Jon Smirl</a><ul><li class="origin"><a href="/lkml/2003/10/23/178">Linus Torvalds</a><ul><li><a href="/lkml/2003/10/23/178">Eric Anholt</a></li><li><a href="/lkml/2003/10/23/195">Jeff Garzik</a><ul><li><a href="/lkml/2003/10/23/198">Jon Smirl</a></li><li><a href="/lkml/2003/10/23/210">Jon Smirl</a></li><li><a href="/lkml/2003/10/24/89">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2003/10/23/199">Jon Smirl</a></li><li><a href="/lkml/2003/10/25/42">Egbert Eich</a><ul><li><a href="/lkml/2003/10/25/49">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 23 Oct 2003 16:23:44 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [Dri-devel] Re: [Linux-fbdev-devel] DRM and pci_driver conversion</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />[ Jeff: is that PCI ROM enable _really_ that complicated? Ouch. Or is<br />  there some helper function I missed? ]<br /><br />On Thu, 23 Oct 2003, Jon Smirl wrote:<br />&gt;<br />&gt; I don't think DRM drivers are doing things correctly yet. DRM is missing the<br />&gt; code for marking PCI resources as being in use while DRM is using them. This<br />&gt; could lead to problems with hotplug.  XFree is also mapping PCI ROMs in without<br />&gt; informing the kernel and that can definitely cause problems.<br /><br />Absolutely. Changing PCI configurations without telling the kernel _will_ <br />cause problems. Especially for hotplug systems, but it's also very iffy to <br />do if the card is behind a PCI bridge, since you have to take bridge <br />resources into account (and know which bridges are transparent, which are <br />not, etc etc). <br /><br />The kernel spends a lot of effort on getting this right, and even so it <br />fails every once in a while (devices that use IO or memory regions without <br />announcing them in the standard BAR's are quite common, and the kernel has <br />to have special quirk entries for things like that).<br /><br />Few enough drivers actually want to enable the roms, but the code should <br />look something like<br /><br />	/* Assign space for ROM resource if not already assigned. Ugly. */<br />	if (!pci_resource_start(dev, PCI_ROM_RESOURCE))<br />		if (pci_assign_resource(dev, PCI_ROM_RESOURCE) &lt; 0)<br />			return -ENOMEM;<br /><br />	/* Enable it. This is too ugly */<br />	if (!(pci_resource_flags(dev, PCI_ROM_RESOURCE) &amp; PCI_ROM_ADDRESS_ENABLE)) {<br />		u32 val;<br />		pci_read_config_dword(dev, PCI_ROM_ADDRESS, &amp;val);<br />		val |= PCI_ROM_ADDRESS_ENABLE;<br />		pci_write_config_dword(dev, PCI_ROM_ADDRESS, val);<br />		pci_resource_flags(dev, PCI_ROM_RESOURCE) |= PCI_ROM_ADDRESS_ENABLE;<br />	}<br /><br /><br />	/* Enable the device, and regular resources */<br />	if (pci_enable_device(dev))<br />		return -ENODEV;<br /><br />	pci_set_master(dev);	/* If we want to */<br />	pci_set_mwi(dev);	/* If we want to */<br /><br />(Yeah, that is more complex than it really should need to be. That's just <br />a sign of exactly how few device drivers tend to want to do this: the <br />usual helper stuff is all geared for the normal case).<br /><br />&gt; new style probe<br />&gt; if (new probe has device)<br />&gt;    mark resources in use<br /><br />You shouldn't need to mark the resources in use. Just registering the <br />driver should do everything for you, including making sure that no other <br />driver will register that device.<br /><br />Of course, if you are worried about mixing with drivers that use the old<br />"find device and just use it", then yes, you'll need to mark the resources <br />in use. That can be as trivial as just doing a<br /><br />	if (pci_request_regions(dev, "drivername") &lt; 0)<br />		return -EAIIEEEE!;<br /><br />in the probe function (but then you need to remember to release them in <br />the drop function).<br /><br />			Linus<br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
