    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2003/10/11/65">First message in thread</a></li><li><a href="/lkml/2003/10/11/76">Ingo Molnar</a><ul><li><a href="/lkml/2003/10/11/75">Ingo Molnar</a></li><li><a href="/lkml/2003/10/11/82">Ingo Molnar</a><ul><li class="origin"><a href="/lkml/2003/10/15/160">Linus Torvalds</a><ul><li><a href="/lkml/2003/10/15/160">Ingo Molnar</a></li></ul></li></ul></li><li><a href="/lkml/2003/10/11/85">Manfred Spraul</a></li><li><a href="/lkml/2003/10/13/44">Andrew Morton</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 13 Oct 2003 21:24:48 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [patch] SMP races in the timer code, timer-fix-2.6.0-test7-A0</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />On Sat, 11 Oct 2003, Ingo Molnar wrote:<br />&gt; <br />&gt; i've implemented the timer-&gt;running field, and it's quite straightforward<br />&gt; and solves all 3 types of races. It also simplifies del_timer_sync() quite<br />&gt; visibly, and it's probably a fair del_timer_sync() speedup as well. I<br />&gt; tested the attached patch on SMP and UP x86 as well, works fine for me.<br /><br />This one is also buggy.<br /><br />It is _not_ ok to do this:<br /><br />&gt;  			list_del(&amp;timer-&gt;entry);<br />&gt;  			timer-&gt;base = NULL;<br />&gt; -			set_running_timer(base, timer);<br />&gt;  			spin_unlock_irq(&amp;base-&gt;lock);<br />&gt;  			fn(data);<br />&gt;  			spin_lock_irq(&amp;base-&gt;lock);<br />&gt; +#ifdef CONFIG_SMP<br />&gt; +			timer-&gt;running = 0;<br />&gt; +#endif<br /><br />since the timer may not even _exist_ any more - the act of running the <br />timer may well have free'd the timer structure, and you're now zeroing <br />memory that may have been re-allocated for something else.<br /><br />This is exactly why we load all the timer data into local variables before <br />we run the timer function, and we don't touch "timer" afterwards.<br /><br />In short, you really need to re-visit this whole thing.<br /><br />		Linus<br /><br />-<br />To unsubscribe from this list: send the line "unsubscribe linux-kernel" in<br />the body of a message to majordomo&#64;vger.kernel.org<br />More majordomo info at  <a href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a><br />Please read the FAQ at  <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
