    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/8/16/1185">First message in thread</a></li><li><a href="/lkml/2021/8/16/1185">David Hildenbrand</a><ul><li><a href="/lkml/2021/8/16/1186">David Hildenbrand</a><ul><li><a href="/lkml/2021/9/5/103">Guenter Roeck</a><ul><li><a href="/lkml/2021/9/5/127">Linus Torvalds</a><ul><li><a href="/lkml/2021/9/5/145">David Hildenbrand</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2021/8/16/1189">David Hildenbrand</a><ul><li class="origin"><a href="/lkml/2021/8/20/164">Linus Torvalds</a><ul><li><a href="/lkml/2021/8/20/164">David Hildenbrand</a><ul><li><a href="/lkml/2021/8/20/525">(Eric W. Biederman)</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2021/8/16/1190">David Hildenbrand</a></li><li><a href="/lkml/2021/8/16/1191">David Hildenbrand</a></li><li><a href="/lkml/2021/8/16/1192">David Hildenbrand</a></li><li><a href="/lkml/2021/8/16/1193">David Hildenbrand</a></li><li><a href="/lkml/2021/8/16/1194">David Hildenbrand</a></li><li><a href="/lkml/2021/8/17/352">=?UTF-8?Q?Christian_K=c3=b6nig?=</a></li><li><a href="/lkml/2021/9/3/293">David Hildenbrand</a><ul><li><a href="/lkml/2021/9/3/587">Linus Torvalds</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 19 Aug 2021 13:51:50 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH v2 2/7] kernel/fork: factor out replacing the current MM exe_file</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">So I like this series.<br /><br />However, logically, I think this part in replace_mm_exe_file() no<br />longer makes sense:<br /><br />On Mon, Aug 16, 2021 at 12:50 PM David Hildenbrand &lt;david&#64;redhat.com&gt; wrote:<br />&gt;<br />&gt; +       /* Forbid mm-&gt;exe_file change if old file still mapped. */<br />&gt; +       old_exe_file = get_mm_exe_file(mm);<br />&gt; +       if (old_exe_file) {<br />&gt; +               mmap_read_lock(mm);<br />&gt; +               for (vma = mm-&gt;mmap; vma &amp;&amp; !ret; vma = vma-&gt;vm_next) {<br />&gt; +                       if (!vma-&gt;vm_file)<br />&gt; +                               continue;<br />&gt; +                       if (path_equal(&amp;vma-&gt;vm_file-&gt;f_path,<br />&gt; +                                      &amp;old_exe_file-&gt;f_path))<br />&gt; +                               ret = -EBUSY;<br />&gt; +               }<br />&gt; +               mmap_read_unlock(mm);<br />&gt; +               fput(old_exe_file);<br />&gt; +               if (ret)<br />&gt; +                       return ret;<br />&gt; +       }<br /><br />and should just be removed.<br /><br />NOTE! I think it makes sense within the context of this patch (where<br />you just move code around), but that it should then be removed in the<br />next patch that does that "always deny write access to current MM<br />exe_file" thing.<br /><br />I just quoted it in the context of this patch, since the next patch<br />doesn't actually show this code any more.<br /><br />In the *old* model - where the ETXTBUSY was about the mmap() of the<br />file - the above tests make sense.<br /><br />But in the new model, walking the mappings just doesn't seem to be a<br />sensible operation any more. The mappings simply aren't what ETXTBUSY<br />is about in the new world order, and so doing that mapping walk seems<br />nonsensical.<br /><br />Hmm?<br /><br />                 Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
