    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/8/23/831">First message in thread</a></li><li><a href="/lkml/2021/8/23/960">Matthew Wilcox</a><ul><li><a href="/lkml/2021/8/24/1469">Johannes Weiner</a><ul><li class="origin"><a href="/lkml/2021/8/25/105">Linus Torvalds</a><ul><li><a href="/lkml/2021/8/25/105">Christoph Hellwig</a></li></ul></li><li><a href="/lkml/2021/8/24/1534">Matthew Wilcox</a><ul><li><a href="/lkml/2021/8/25/595">Johannes Weiner</a><ul><li><a href="/lkml/2021/8/25/1021">"Darrick J. Wong"</a></li></ul></li><li><a href="/lkml/2021/8/26/142">David Howells</a><ul><li><a href="/lkml/2021/8/27/255">Johannes Weiner</a></li><li><a href="/lkml/2021/8/27/281">David Howells</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 24 Aug 2021 11:59:52 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [GIT PULL] Memory folios for v5.15</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Aug 24, 2021 at 11:31 AM Johannes Weiner &lt;hannes&#64;cmpxchg.org&gt; wrote:<br />&gt;<br />&gt; Unlike the filesystem side, this seems like a lot of churn for very<br />&gt; little tangible value. And leaves us with an end result that nobody<br />&gt; appears to be terribly excited about.<br /><br />Well, there is actually some fairly well documented tangible value:<br />our page accessor helper functions spend an absolutely insane amount<br />of effort and time on just checking "is this a head page", and<br />following the "compound_head" pointer etc.<br /><br />Functions that *used* to be trivial - and are still used as if they<br />were - generate nasty complex code.<br /><br />I'm thinking things like "get_page()" - it increments the reference<br />count to the page. It's just a single atomic increment, right.<br /><br />Wrong..<br /><br />It's still inlined, but it generates these incredible gyrations with<br />testing the low bit of a field, doing two very different things based<br />on whether it is set, and now we have that "is it close to overflow"<br />test too (ok, that one is dependent on VM_DEBUG), so it actually<br />generates two conditional branches, odd bit tests, lots of extra calls<br />etc etc,<br /><br />So "get_page()" should probably not be an inline function any more.<br />And that's just the first thing I happened to look at. I think we have<br />those "head = compound_head(page)" all over the VM code,<br /><br />And no, that "look up the compound page header" is not necessarily the<br />biggest part of it, but it's definitely one part of it. And if we had<br />a "we know this page is a head page" that all just goes away.<br /><br />And in a lot of cases, we *do* know that. Which is exactly the kind of<br />static knowledge that the folio patches expose.<br /><br />But it is a lot of churn. And it basically duplicates all our page<br />functions, just to have those simplified versions. And It's very core<br />code, and while I appreciate the cleverness of the "folio" name, I do<br />think it makes the end result perhaps subtler than it needs to be.<br /><br />The one thing I do like about it is how it uses the type system to be<br />incremental.<br /><br />So I don't hate the patches. I think they are clever, I think they are<br />likely worthwhile, but I also certainly don't love them.<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
