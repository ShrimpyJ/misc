    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/11/11/397">First message in thread</a></li><li><a href="/lkml/2021/11/11/397">Sudip Mukherjee</a><ul><li><a href="/lkml/2021/11/11/706">Sudip Mukherjee</a><ul><li><a href="/lkml/2021/11/13/69">Sudip Mukherjee</a></li><li class="origin"><a href="/lkml/2021/11/13/238">Linus Torvalds</a><ul><li><a href="/lkml/2021/11/13/238">Sudip Mukherjee</a></li><li><a href="/lkml/2021/11/15/557">Daniel Vetter</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat, 13 Nov 2021 09:06:57 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: regression with mainline kernel</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">[ Hmm. This email was marked as spam for me. I see no obvious reason<br />for it being marked as spam, but it happens.. ]<br /><br />On Thu, Nov 11, 2021 at 12:52 PM Sudip Mukherjee<br />&lt;sudipm.mukherjee&#64;gmail.com&gt; wrote:<br />&gt;<br />&gt; # first bad commit: [cd7f5ca33585918febe5e2f6dc090a21cfa775b0]<br />&gt; drm/virtio: implement context init: add virtio_gpu_fence_event<br /><br />Hmm. Judging from your automated screenshots, the login never appears.<br /><br />&gt; And, indeed reverting cd7f5ca33585 on top of debe436e77c7 has fixed<br />&gt; the problem I was seeing on my qemu test of x86_64. The qemu image is<br />&gt; based on Ubuntu.<br /><br />Presumably either that commit is somehow buggy in itself - or it does<br />exactly what it means to do, and the new poll() semantics just<br />confuses the heck out of the X server (or wayland or whatever).<br /><br />And honestly, if I read that thing correctly, the patch is entirely<br />broken. The new poll function (virtio_gpu_poll()) will unconditionally<br />remove the first event from the event list, and then report "Yeah, I<br />had events".<br /><br />This is completely bogus for a few reasons:<br /><br /> - poll() really should be idempotent, because the poll function gets<br />called multiple times<br /><br /> - it doesn't even seem to check that the event that it removes is the<br />new VIRTGPU_EVENT_FENCE_SIGNALED_INTERNAL kind of event, so it will<br />unconditionally just remove random events.<br /><br /> - it does seem to check the "vfpriv-&gt;ring_idx_mask" and do the old<br />thing if that is zero, but I see absolutely no reason for that (and<br />that check itself has caused problems, see below)<br /><br />Honestly, my reaction to this all is that that commit is fundamentally<br />broken and probably should be reverted regardless as "this commit does<br />bad things".<br /><br />HOWEVER - it has had a fix for a NULL pointer dereference in the<br />meantime - can you check whether the current top of tree happens to<br />work for you? Maybe your problem isn't due to "that commit does<br />unnatural things", but simply due to the bug fixed in d89c0c8322ec<br />("drm/virtio: Fix NULL dereference error in virtio_gpu_poll").<br /><br />And if it's still broken with that commit, I'll happily revert it and<br />people need to go back to the drawing board.<br /><br />In fact, I would really suggest that people look at that<br />virtio_gpu_poll() function regardless. That odd "let's unconditionally<br />just drop events in the poll function is really REALLY broken<br />behavior.<br /><br />              Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
