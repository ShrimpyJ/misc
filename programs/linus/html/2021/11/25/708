    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/11/25/477">First message in thread</a></li><li><a href="/lkml/2021/11/25/477">kernel test robot</a><ul><li><a href="/lkml/2021/11/25/570">Johannes Berg</a><ul><li class="origin"><a href="/lkml/2021/11/25/832">Linus Torvalds</a><ul><li><a href="/lkml/2021/11/25/832">Johannes Berg</a></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 25 Nov 2021 09:48:17 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [gcov] 1391efa952: BUG:KASAN:slab-out-of-bounds_in_gcov_info_add</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Thu, Nov 25, 2021 at 7:45 AM Johannes Berg &lt;johannes&#64;sipsolutions.net&gt; wrote:<br />&gt;<br />&gt; In any case, reviewing my commit again I see nothing wrong there, and I<br />&gt; don't understand the code/clang well enough to see what might be the<br />&gt; issue.<br /><br />Yeah, looks like the kvmalloc() conversion simply tightened the<br />checking boundaries, now that it might be using kmalloc() instead of<br />full pages.<br /><br />The report isn't wonderful (the KASAN report is garbled, and the "code<br />disassembly" is not from the actual KASAN report, it's from the return<br />to user space code), but it blames a 8-byte read at<br /><br />    gcov_info_add (kernel/gcov/clang.c:328)<br /><br />which in that kernel version (1391efa952e8) is that<br /><br />        for (i = 0; i &lt; sfn_ptr-&gt;num_counters; i++)<br />-&gt;              dfn_ptr-&gt;counters[i] += sfn_ptr-&gt;counters[i];<br /><br />and so it looks like that 'sfn_ptr-&gt;counters[i]' access is the problem case.<br /><br />The allocation was<br /><br />    gcov_info_dup (include/linux/mm.h:804 kernel/gcov/clang.c:371<br />kernel/gcov/clang.c:404)<br /><br />and in particular, it's the inlined gcov_fn_info_dup() at line 371:<br /><br />        cv_size = fn-&gt;num_counters * sizeof(fn-&gt;counters[0]);<br />        fn_dup-&gt;counters = kvmalloc(cv_size, GFP_KERNEL);<br /><br />but I'm not seeing how that could fail.<br /><br />Sure, that code doesn't explicitly ever set "fn_dup-&gt;num_counters",<br />but it should get set thanks to the<br /><br />        fn_dup = kmemdup(fn, sizeof(*fn), GFP_KERNEL);<br /><br />so I don't see anything wrong there, but I'm adding some of the<br />involved people to the participants in case they see what's going on..<br /><br />                  Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
