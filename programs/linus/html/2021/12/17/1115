    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/12/17/298">First message in thread</a></li><li><a href="/lkml/2021/12/17/980">Jason Gunthorpe</a><ul><li><a href="/lkml/2021/12/17/987">Linus Torvalds</a><ul><li><a href="/lkml/2021/12/17/1000">David Hildenbrand</a></li></ul></li><li><a href="/lkml/2021/12/17/993">David Hildenbrand</a><ul><li><a href="/lkml/2021/12/17/1104">Jason Gunthorpe</a></li></ul></li><li><a href="/lkml/2021/12/17/999">Nadav Amit</a><ul><li><a href="/lkml/2021/12/17/1004">David Hildenbrand</a></li><li><a href="/lkml/2021/12/17/1105">Jason Gunthorpe</a></li><li class="origin"><a href="/lkml/2021/12/17/1122">Linus Torvalds</a><ul><li><a href="/lkml/2021/12/17/1122">Linus Torvalds</a><ul><li><a href="/lkml/2021/12/17/1126">Linus Torvalds</a></li></ul></li><li><a href="/lkml/2021/12/17/1130">Jason Gunthorpe</a><ul><li><a href="/lkml/2021/12/17/1142">Nadav Amit</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 17 Dec 2021 17:53:45 -0800</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH v1 06/11] mm: support GUP-triggered unsharing via FAULT_FLAG_UNSHARE (!hugetlb)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">[ Going back in the thread to this one ]<br /><br />On Fri, Dec 17, 2021 at 1:15 PM Nadav Amit &lt;namit&#64;vmware.com&gt; wrote:<br />&gt;<br />&gt; I think that there is an assumption that once a page is COW-broken,<br />&gt; it would never have another write-fault that might lead to COW<br />&gt; breaking later.<br /><br />Right. I do think there are problems in the current code, I just think<br />that the patches are a step back.<br /><br />The problems with the current code are of two kinds:<br /><br /> - I think the largepage code (either THP or explicit hugetlb) doesn't<br />do as good a job of this whole COW handling as the regular pages do<br /><br /> - some of the "you can make pages read-only again explicitly" kinds of loads.<br /><br />But honestly, at least for the second case, if somebody does a GUP,<br />and then starts playing mprotect games on the same virtual memory area<br />that they did a GUP on, and are surprised when they get another COW<br />fault that breaks their own connection with a page they did a GUP on<br />earlier, that's their own fault.<br /><br />So I think there's some of "If you broke it, you get to keep both<br />pieces". Literally, in this case. You have your GUP page that you<br />looked up, and you have your virtual address page that you caused COW<br />on with mprotect() by making it read-only and then read-write again,<br />then you have two different pages, and at some point it really is just<br />"Well, don't do that then".<br /><br />But yes, there's also some of "some code probably didn't get fully<br />converted to the new world order".  So if VFIO only uses<br />FOLL_LONGTERM, and didn't ask for the COW breaking, then yes, VFIO<br />will see page incoherencies. But that should be an issue of "VFIO<br />should do the right thing".<br /><br />So part of it is a combination of "if you do crazy things, you'll get<br />crazy results". And some of it is some kernel pinning code that<br />doesn't do the right thing to actually make sure it gets a shared page<br />to be pinned.<br /><br />And then there's THP and HUGETLB, that I do think needs fixing and<br />aren't about those two kinds of cases.<br /><br />I think we never got around to just doing the same thing we did for<br />regular pages. I think the hugepage code simply doesn't follow that<br />"COW on GUP, mark to not COW later" pattern.<br /><br />           Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
