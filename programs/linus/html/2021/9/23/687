    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/9/23/101">First message in thread</a></li><li><a href="/lkml/2021/9/23/101">Mike Rapoport</a><ul><li><a href="/lkml/2021/9/23/102">Mike Rapoport</a></li><li><a href="/lkml/2021/9/23/103">Mike Rapoport</a><ul><li><a href="/lkml/2021/9/23/132">Juergen Gross</a></li></ul></li><li><a href="/lkml/2021/9/23/104">Mike Rapoport</a><ul><li><a href="/lkml/2021/9/23/136">Juergen Gross</a></li><li><a href="/lkml/2021/9/23/206">Christophe Leroy</a><ul><li><a href="/lkml/2021/9/23/329">Mike Rapoport</a><ul><li><a href="/lkml/2021/9/23/523">Christophe Leroy</a></li></ul></li></ul></li><li><a href="/lkml/2021/9/23/399">Shahab Vahedi</a></li></ul></li><li class="origin"><a href="/lkml/2021/9/23/926">Linus Torvalds</a><ul><li><a href="/lkml/2021/9/23/926">Mike Rapoport</a></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 23 Sep 2021 09:01:46 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH 0/3] memblock: cleanup memblock_free interface</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Thu, Sep 23, 2021 at 12:43 AM Mike Rapoport &lt;rppt&#64;kernel.org&gt; wrote:<br />&gt;<br />&gt; The core change is in the third patch that makes memblock_free() a<br />&gt; counterpart of memblock_alloc() and adds memblock_phys_alloc() to be a<br /><br />^^^^^^^^^^^^^^^^^^^<br />&gt; counterpart of memblock_phys_alloc().<br /><br />That should be 'memblock_phys_free()'<br /><br />HOWEVER.<br /><br />The real reason I'm replying is that this patch is horribly buggy, and<br />will cause subtle problems that are nasty to debug.<br /><br />You need to be a LOT more careful.<br /><br />From a trivial check - exactly because I looked at doing it with a<br />script, and decided it's not so easy - I found cases like this:<br /><br />-               memblock_free(__pa(paca_ptrs) + new_ptrs_size,<br />+               memblock_free(paca_ptrs + new_ptrs_size,<br /><br />which is COMPLETELY wrong.<br /><br />Why? Because now that addition is done as _pointer_ addition, not as<br />an integer addition, and the end result is something completely<br />different.<br /><br />pcac_ptrs is of type 'struct paca_struct **', so when you add<br />new_ptrs_size to it, it will add it in terms of that many pointers,<br />not that many bytes.<br /><br />You need to use some smarter scripting, or some way to validate it.<br /><br />And no, making the scripting just replace '__pa(x)' with '(void *)(x)'<br />- which _would_ be mindless and get the same result - is not<br />acceptable either, because it avoids one of the big improvements from<br />using the right interface, namely having compiler type checking (and<br />saner code that people understand).<br /><br />So NAK. No broken automated scripting patches.<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
