    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2021/7/13/478">First message in thread</a></li><li class="origin"><a href="/lkml/2021/7/13/483">Linus Torvalds</a><ul><li><a href="/lkml/2021/7/13/483">Matthew Wilcox</a><ul><li><a href="/lkml/2021/7/13/539">Uladzislau Rezki</a></li></ul></li><li><a href="/lkml/2021/7/13/637">Mel Gorman</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 13 Jul 2021 11:19:29 -0700</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [mm/vmalloc] 5c1f4e690e: BUG:sleeping_function_called_from_invalid_context_at_mm/page_alloc.c</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody">On Tue, Jul 13, 2021 at 7:06 AM kernel test robot &lt;oliver.sang&#64;intel.com&gt; wrote:<br />&gt;<br />&gt; [  131.014885] BUG: sleeping function called from invalid context at mm/page_alloc.c:4992<br /><br />Strange. The call chain doesn't actually seem to be anything off: it's<br />writev -&gt; sock_write_iter -&gt; sock_sendmsg -&gt; netlink_sendmsg -&gt;<br />vmalloc.<br /><br />All good to sleep as far as I can tell. The warning itself seems to be just<br /><br />        might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);<br /><br />in prepare_alloc_pages().<br /><br />I don't see what's wrong with that commit, but it does seem to be very<br />consistent, in that the parent doesn't have it:<br /><br /> &gt; +----------------------------------------------------------------------+------------+------------+<br />&gt; |                                                                      | a2afc59fb2 | 5c1f4e690e |<br />&gt; +----------------------------------------------------------------------+------------+------------+<br />&gt; | BUG:sleeping_function_called_from_invalid_context_at_mm/page_alloc.c | 0          | 54         |<br />&gt; +----------------------------------------------------------------------+------------+------------+<br /><br />Does anybody see what the problem is there?<br /><br />There's an odd report _after_ the warning:<br /><br />[  131.345319] raw_local_irq_restore() called with IRQs enabled<br />[  131.366561] RIP: 0010:warn_bogus_irq_restore+0x1d/0x20<br />[  131.433334]  __alloc_pages_bulk+0xbb8/0xf20<br /><br />but I think that's might be a result of the BUG(). Maybe. But it might<br />also be indicative of some context confusion - do we end up nesting?<br />Because the BUG() has<br /><br />[  131.036625] hardirqs last disabled at (283042):<br />[&lt;ffffffff81656d71&gt;] __alloc_pages_bulk+0xae1/0xf20<br /><br />which means that the might_sleep_if() happens _after_<br />__alloc_pages_bulk() has disabled interrupts. That would explain it,<br />but the stack_depot_save() thing actually makes that call chain really<br />hard to read because it duplicates the addresses on the stack.<br /><br />I don't see the nesting there, but that's what it kind of smells like to me.<br /><br />Anybody?<br /><br />               Linus<br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
