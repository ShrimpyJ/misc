    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2009/11/17/284">First message in thread</a></li><li><a href="/lkml/2009/11/17/315">Linus Torvalds</a><ul><li><a href="/lkml/2009/11/17/332">Michael Buesch</a><ul><li class="origin"><a href="">Linus Torvalds</a></li><li><a href="/lkml/2009/11/17/365">Andreas Schwab</a></li></ul></li><li><a href="/lkml/2009/11/17/344">Uwe =?iso-8859-1?Q?Kleine-K=F6nig?=</a><ul><li><a href="/lkml/2009/11/17/348">Linus Torvalds</a><ul><li><a href="/lkml/2009/11/17/351">Linus Torvalds</a></li><li><a href="/lkml/2009/11/17/359">Joe Perches</a></li></ul></li></ul></li><li><a href="/lkml/2009/11/18/414">=?UTF-8?q?Uwe=20Kleine-K=C3=B6nig?=</a></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 17 Nov 2009 10:40:29 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [PATCH] strcmp: fix overflow error</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 17 Nov 2009, Michael Buesch wrote:<br />&gt; <br />&gt; Well, that doesn't actually return the difference at all. Is that allowed?<br /><br />It's in fact the common implementation. Returning -1/0/1 is kind of <br />polite, since it means that the sign now fits in a minimal type (ie you <br />can save the end result in a "signed char" and it will _work_, even <br />though it's not guaranteed by the standard.<br /><br />Returning any negative or positive number is certainly _allowed_ by the <br />standard, but I just checked, and glibc does the "polite" -1/0/1 thing. I <br />suspect many other libraries do too, and it's not like it costs you <br />anything more.<br /><br />In fact, the written-out-with-unsigned-char-variables version is also <br />likely to generate better code than the "clever" one that does just one <br />subtract, because now the code can do all the comparisons in just <br />'unsigned char' and never needs to sign-extend the result to 'int'.<br /><br />Not that it likely matters.<br /><br />I double-checked, and the code generated from my patch looks sane.<br /><br />	strcmp:<br />	        pushq   %rbp    #<br />	        movq    %rsp, %rbp      #,<br />	.L52:<br />	        movb    (%rdi), %al     #* cs, c1<br />	        movb    (%rsi), %dl     #* ct, c2<br />	        incq    %rdi    # cs<br />	        incq    %rsi    # ct<br />	        cmpb    %dl, %al        # c2, c1<br />	        je      .L49    #,<br />	        sbbl    %eax, %eax      # D.13150<br />	        orl     $1, %eax        #, D.13150<br />	        jmp     .L51    #<br />	.L49:<br />	        testb   %al, %al        # c1   <br />	        jne     .L52    #,<br />	        xorl    %eax, %eax      # D.13150<br />	.L51:<br />	        leave<br />	        ret<br /><br />which is not horrible (of course, depending on whether you expect to find <br />differences early or late you might want to have make the "L49" case be <br />the fallthrough etc).<br /><br />[ Using sbb+or is a standard x86 trick to get -1/1. You'll also find <br />  "sbb+and" to get 0/value, or "sbb+add" to get value/value+1 ]<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
