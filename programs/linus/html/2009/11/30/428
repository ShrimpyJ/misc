    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2009/11/23/225">First message in thread</a></li><li><a href="/lkml/2009/11/30/415">Linus Torvalds</a><ul><li><a href="/lkml/2009/11/30/424">Thomas Gleixner</a><ul><li class="origin"><a href="/lkml/2009/12/1/278">Linus Torvalds</a><ul><li><a href="/lkml/2009/12/1/278">Thomas Gleixner</a><ul><li><a href="/lkml/2009/12/1/304">Oleg Nesterov</a></li></ul></li><li><a href="/lkml/2009/12/5/156">(Eric W. Biederman)</a><ul><li><a href="/lkml/2009/12/7/359">"Paul E. McKenney"</a></li><li><a href="/lkml/2009/12/7/373">Oleg Nesterov</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 30 Nov 2009 14:49:10 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [rfc] "fair" rw spinlocks</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Mon, 30 Nov 2009, Thomas Gleixner wrote:<br />&gt; <br />&gt; I'm aware of that. The number of places where we read_lock<br />&gt; tasklist_lock is 79 in 36 files right now. That's not a horrible task<br />&gt; to go through them one by one and do a case by case conversion with a<br />&gt; proper changelog. That would only leave the write_lock sites. <br /><br />The write_lock sites should be fine, since just changing them to a <br />spinlock should be 100% semantically equivalent - except for the lack of <br />interrupt disable. And the lack of interrupt disable will result in a nice <br />big deadlock if some interrupt really does take the spinlock, which is <br />much easier to debug than a subtle race that would get the wrong read <br />value.<br /><br />&gt; We can then either do the rw_lock to spin_lock conversion or keep the<br />&gt; rw_lock which has no readers anymore and behaves like a spinlock for a<br />&gt; transition time so reverts of one of the read_lock -&gt; rcu patches<br />&gt; could be done to debug stuff.<br /><br />So as per the above, I wouldn't worry about the write lockers. Might as <br />well change it to a spinlock, since that's what it will act as. It's not <br />as if there is any chance that the spinlock code is subtly buggy.<br /><br />So the only reason to keep it as a rwlock would be if you decide to do the <br />read-locked cases one by one, and don't end up with all of them converted. <br />Which is a reasonable strategy too, of course. We don't _have_ to convert <br />them all - if the main problem is some starvation issue, it's sufficient <br />to convert just the main read-lock cases so that writers never get <br />starved.<br /><br />But converting it all would be nice, because that whole<br /><br />	write_lock_irq(&amp;tasklist_lock);<br /><br />to<br /><br />	spin_lock(&amp;tasklist_lock);<br /><br />conversion would likely be a measurable performance win. Both because <br />spinlocks are fundamentally faster (no atomic on unlock), and because you <br />get rid of the irq disable/enable. But in order to get there, you'd have <br />to convert _all_ the read-lockers, so you'd miss the opportunity to only <br />convert the easy cases.<br /><br />			Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
