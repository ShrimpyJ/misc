    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2009/9/15/413">First message in thread</a></li><li><a href="/lkml/2009/9/17/306">Jesse Barnes</a><ul><li><a href="/lkml/2009/9/18/65">Ingo Molnar</a><ul><li><a href="/lkml/2009/9/18/85">David Rientjes</a></li><li class="origin"><a href="/lkml/2009/9/18/205">Linus Torvalds</a><ul><li><a href="/lkml/2009/9/18/205">Jesse Barnes</a></li><li><a href="/lkml/2009/9/24/32">Rusty Russell</a><ul><li><a href="/lkml/2009/9/24/128">tip-bot for Rusty Russell</a></li></ul></li></ul></li><li><a href="/lkml/2009/9/18/220">Yinghai Lu</a><ul><li><a href="/lkml/2009/9/18/225">Jesse Barnes</a></li><li><a href="/lkml/2009/9/18/239">Linus Torvalds</a><ul><li><a href="/lkml/2009/9/18/248">Jesse Barnes</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Fri, 18 Sep 2009 08:38:02 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [crash] BUG: unable to handle kernel NULL pointer dereference at (null), last sysfs file: /sys/devices/pci0000:00/0000:00:01.0/local_cpus</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Fri, 18 Sep 2009, Ingo Molnar wrote:<br />&gt; <br />&gt; [  158.058140] warning: `dbus-daemon' uses 32-bit capabilities (legacy support in use)<br />&gt; [  159.370562] BUG: unable to handle kernel NULL pointer dereference at (null)<br />&gt; [  159.372694] IP: [&lt;ffffffff8143b722&gt;] bitmap_scnprintf+0x72/0xd0<br /><br />Hmm. The code is<br /><br />   a:	49 63 fc             	movslq %r12d,%rdi<br />   d:	0f 49 d3             	cmovns %ebx,%edx<br />  10:	c1 f8 1f             	sar    $0x1f,%eax<br />  13:	4c 01 ff             	add    %r15,%rdi<br />  16:	c1 e8 1a             	shr    $0x1a,%eax<br />  19:	c1 fa 06             	sar    $0x6,%edx<br />  1c:	41 c1 e8 02          	shr    $0x2,%r8d<br />  20:	8d 0c 03             	lea    (%rbx,%rax,1),%ecx<br />  23:	48 63 d2             	movslq %edx,%rdx<br />  26:	83 e1 3f             	and    $0x3f,%ecx<br />  29:	29 c1                	sub    %eax,%ecx<br />  2b:*	49 8b 44 d5 00       	mov    0x0(%r13,%rdx,8),%rax     &lt;-- trapping instruction<br />  30:	48 c7 c2 8c 37 16 82 	mov    $0xffffffff8216378c,%rdx<br />  37:	48 d3 e8             	shr    %cl,%rax<br />  3a:	89 f1                	mov    %esi,%ecx<br />  3c:	44 89 f6             	mov    %r14d,%esi<br /><br />and the obvious reason seems to be that 'maskp' is NULL (that faulting <br />thing is the code for "val = (maskp[word] &gt;&gt; bit) &amp; chunkmask;" with the <br />actual fault being the access of "maskp[word]".<br /><br />Now, the caller does<br /><br />	mask = cpumask_of_pcibus(to_pci_dev(dev)-&gt;bus);<br /><br />and then uses cpumask_scnprintf() that is just a wrapper that does<br /><br />	bitmap_scnprintf(buf, len, cpumask_bits(srcp), nr_cpumask_bits);<br /><br />So clearly we have "cpumask_of_pcibus()" being NULL (cpumask_bits() would <br />not change it).<br /><br />I assume this is the NUMA case? The non-NUMA case has just<br /><br />	static inline const struct cpumask *cpumask_of_node(int node)<br />	{<br />	        return cpu_online_mask;<br />	}<br /><br />so I don't think you can ever get NULL (if we have a NULL cpu_online_mask <br />we have bigger problems). <br /><br />[ Side note: looking closer, I think our headers are buggy, and I _know_ <br />  they are confusing. The above inline declaration of cpumask_of_node() <br />  seems to be then later overridden in &lt;asm-generic/topology.h&gt; by a <br />  #define! <br /><br />  And if I read that right, that will also override the debugging <br />  versions that we declared if CONFIG_DEBUG_PER_CPU_MAPS is on. Ingo? <br />  Rusty? Am I missing something?<br /><br />  That said, those overrides should only happen for non-NUMA ]<br /><br />The NUMA version of 'cpumask_of_node()' has all the debug code for show <br />it's not returning NULL, but only when CONFIG_DEBUG_PER_CPU_MAPS is <br />enabled. Otherwise it all seems to boil down to (through cpumask_of_pcibus <br />and __pcibus_to_node):<br /><br />	node_to_cpumask_map[bus-&gt;sysdata-&gt;node]<br /><br />and it can fail either because "node" isn't initialized, or <br />node_to_cpumask_map[] isn't.<br /><br />Probably 'node' is still -1, and it gets the NULL by going off the array <br />into la-la-land.<br /><br />			Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
