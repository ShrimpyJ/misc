    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2009/9/17/358">First message in thread</a></li><li><a href="/lkml/2009/9/17/358">Peter Volkov</a><ul><li class="origin"><a href="/lkml/2009/9/17/397">Linus Torvalds</a><ul><li><a href="/lkml/2009/9/17/397">Linus Torvalds</a><ul><li><a href="/lkml/2009/9/18/104">Peter Volkov</a><ul><li><a href="/lkml/2009/9/18/156">Linus Torvalds</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Thu, 17 Sep 2009 13:42:02 -0700 (PDT)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: 2.6.31 regression: system hang after pptp connection established</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Thu, 17 Sep 2009, Peter Volkov wrote:<br />&gt; <br />&gt; After pptp connection is established my 2.6.31 system freezes while<br />&gt; 2.6.30 works as expected. Bissecting gave me the following result:<br />&gt; <br />&gt; commit ac89a9174decf343de049a06fad75681f71890eb<br />&gt; Author: Linus Torvalds &lt;torvalds&#64;linux-foundation.org&gt;<br />&gt; Date:   Sat Sep 5 13:27:10 2009 -0700<br />&gt; <br />&gt;     pty: don't limit the writes to 'pty_space()' inside 'pty_write()'<br />&gt; <br />&gt; and looks like reverting this patch from 2.6.31 fixes the problem.<br /><br />Hmm. The only thing it should cause is that pty_write() will effectively <br />allow a larger buffer for writes (limited to ~64kB rather than 8kB).<br /><br />But considering how fragile ppp has been, I guess I shouldn't be surprised <br />that this can cause a hang in itself.<br /><br />&gt; In hope to get any oops I've started netconsole but at hang no new ouput<br />&gt; was there. I've managed to gather some information with SysRq (it's<br />&gt; gzipped in attachment) but I'm not sure how useful it is.<br /><br />It's interesting, but I don't know how _useful_ it is.<br /><br />What's interesting about it is that it shows a problem, but the problem it <br />shows would seem to have nothing at all to do with ppp or networking or <br />pty's. The problem seems to be processes stuck in disk-wait:<br /><br />	events/0      D ffff88007d0c7b50     0     7      2 0x00000000<br />	events/0      D ffff88007d0c7b50     0     7      2 0x00000000<br />	kacpi_notify  D ffff88007d2ffbe8     0   170      2 0x00000000<br />	khubd         D ffff88007d211ae8     0   260      2 0x00000000<br />	pdflush       D ffff88007d26bd40     0   326      2 0x00000000<br />	kjournald     D ffff88007b2f3df8     0  3361      2 0x00000000<br />	kjournald     D ffff88007c65ddf8     0  3362      2 0x00000000<br />	reiserfs/0    D [&lt;ffffffff810725f7&gt;] ? delayacct_end+0x81/0x8c<br />	events/0      D ffff88007d0c7b50     0     7      2 0x00000000<br />	kacpi_notify  D ffff88007d2ffbe8     0   170      2 0x00000000<br />	khubd         D ffff88007d211ae8     0   260      2 0x00000000<br />	pdflush       D ffff88007d26bd40     0   326      2 0x00000000<br />	kjournald     D ffff88007b2f3df8     0  3361      2 0x00000000<br />	kjournald     D ffff88007c65ddf8     0  3362      2 0x00000000<br /><br />which explains your symptoms - hung X (with just cursor moving) and ssh's <br />hanging.<br /><br />It's just that while it all explains your symptoms, none of the above <br />should have anything what-so-ever to do with pty's!<br /><br />pdflush, for example, seems to be stuck waiting for &amp;jl-&gt;j_commit_mutex in <br />reiserfs. Odd. It really looks like you have something stuck waiting for <br />IO.<br /><br />But your CPU 1 backtrace looks relevant, and seems hung on a spinlock in <br />tty_buffer_request_room() and has that pty_write() thing there. I'm not <br />seeing why the 'D' states above happen, though.<br /><br />&gt; I've tried to establish pptp connection both over wireless and wired<br />&gt; connections and system hanged with both, so it looks like networking<br />&gt; drivers are not the reason here. BTW, I'm using networkmanager to<br />&gt; establish connection.<br />&gt; <br />&gt; gzipped kernel config is in attachment.<br />&gt; <br />&gt; Is this problem known? Does anybody experience same problem? Do you have<br />&gt; a fix? :)<br /><br />Not a known problem, but it's entirely possible that there is some bug in <br />the "tty buffer out of memory" handling - that nobody has ever seen <br />because in practice everybody always hit other limits first.<br /><br />Let me look at it a bit, and see if I can come up with test patches for <br />you.<br /><br />		Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
