    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2009/12/5/107">First message in thread</a></li><li><a href="/lkml/2009/12/15/289">Alan Stern</a><ul><li><a href="/lkml/2009/12/15/300">Linus Torvalds</a><ul><li class="origin"><a href="">Linus Torvalds</a></li><li><a href="/lkml/2009/12/15/435">Alan Stern</a><ul><li><a href="/lkml/2009/12/15/470">"Rafael J. Wysocki"</a><ul><li><a href="/lkml/2009/12/15/492">Alan Stern</a></li></ul></li><li><a href="/lkml/2009/12/15/502">Linus Torvalds</a><ul><li><a href="/lkml/2009/12/15/507">Alan Stern</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><div id="bsap_1297613" class="bsarocks bsap_5aa49c00cc06c882289a1dd6a5e50b62"></div><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 15 Dec 2009 10:57:25 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: Async suspend-resume patch w/ completions (was: Re: Async suspend-resume patch w/ rwsems)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br /><br />On Tue, 15 Dec 2009, Linus Torvalds wrote:<br />&gt; <br />&gt; And even when you know it's PCI, our rules are actually not simple at all. <br />&gt; Our rules for PCI devices (and this strictly speaking is true for bridges <br />&gt; too) are rather complex:<br />&gt; <br />&gt;  - do we have _any_ legacy PM support (ie the "direct" driver <br />&gt;    suspend/resume functions in the driver ops, rather than having a <br />&gt;    "struct dev_pm_ops" pointer)? If so, call "-&gt;suspend()"<br />&gt; <br />&gt;  - If not - do we have that "dev_pm_ops" thing? If so, call it.<br />&gt; <br />&gt;  - If not - just disable the device entirely _UNLESS_ you're a PCI bridge.<br />&gt; <br />&gt; Notice? The way things are set up, if you have no suspend routine, you'll <br />&gt; not get suspended, but you will get disabled. <br /><br />Side note - what I think might be a clean solution for PCI at least is to <br />do something like the following:<br /><br /> - move that "disable the device entirely" thing to suspend_late, rather <br />   than the earlier suspend phase. Now PCI devices without drivers or PM <br />   will not be touched at all in the first suspend phase.<br /><br /> - initialize all PCI devices to have 'async_suspend = 1' on discovery<br /><br /> - whenever we bind a driver to the PCI device, we'd then look at whether <br />   that driver implements suspend/resume callbacks (legacy or new), and <br />   clear the async_suspend bit if so.<br /><br />That way we'd have the same old synchronous behavior for all PCI suspend <br />and resume events (unless the driver itself then sets the async_suspend <br />bit at device init time, which it could do, of course), while still always <br />doing async "no-op" events.<br /><br />That would avoid the ugly one-liner that just "knows" that PCI bridges are <br />special and don't do anything at suspend time (even though they aren't <br />really - a PCI bridge _could_ have a driver associated with it that does <br />something that might not be happy being asynchronous).<br /><br />			Linus<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
