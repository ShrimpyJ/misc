    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2009/12/17/243">First message in thread</a></li><li><a href="/lkml/2009/12/18/376">Linus Torvalds</a><ul><li><a href="/lkml/2009/12/22/129">Mark Hounschell</a><ul><li class="origin"><a href="/lkml/2009/12/22/183">Linus Torvalds</a><ul><li><a href="/lkml/2009/12/22/183">Mark Hounschell</a><ul><li><a href="/lkml/2009/12/22/275">"Pallipadi, Venkatesh"</a></li></ul></li></ul></li></ul></li></ul></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td colspan="2"><!--BuySellAds Zone Code--><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/show_ads.js"></script><!--End BuySellAds Zone Code--></td></tr><tr><td><table><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Tue, 22 Dec 2009 09:38:18 -0800 (PST)</td></tr><tr><td class="lp">From</td><td class="rp" itemprop="author">Linus Torvalds &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Re: [Fdutils] DMA cache consistency bug introduced in 2.6.28 (Was: Re: Cannot format floppies under kernel 2.6.*?)</td></tr></table></td><td><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></td></tr></table><pre itemprop="articleBody"><br />[ Ingo, Venki and Shaohua added to cc: see the whole thread on lkml for <br />  details, but Mark is basically chasing down a situation where the floppy <br />  driver seems to have trouble formatting floppies, and it happened <br />  between 2.6.27 and .28. The trouble seems to be that a DMA transfer of a <br />  memory block transfers the wrong value for the first byte of the block.<br /><br />  Which should be impossible, but whatever. Some part of the system has a <br />  cached buffer that isn't flushed.<br /><br />  What gets _you_ guys involved is that Mark cannot reproduce the bug if <br />  HPET is disabled in the BIOS or by using 'nohpet'. He found that out by <br />  pure luck while bisecting, because some time during his bisect, his <br />  machine wouldn't even boot with HPET.<br /><br />  So the problem is: with HPET enabled, 2.6.27.4 _used_ to work. But <br />  2.6.28 (and current -git) does not.  Any ideas? ]<br /><br />On Tue, 22 Dec 2009, Mark Hounschell wrote:<br />&gt; <br />&gt; Ok, I may have something that might help.<br />&gt; <br />&gt; # git bisect bad<br />&gt; 26afe5f2fbf06ea0765aaa316640c4dd472310c0 is the first bad commit<br />&gt; commit 26afe5f2fbf06ea0765aaa316640c4dd472310c0<br />&gt; Author: venkatesh.pallipadi&#64;intel.com &lt;venkatesh.pallipadi&#64;intel.com&gt;<br />&gt; Date:   Fri Sep 5 18:02:18 2008 -0700<br />&gt; <br />&gt;     x86: HPET_MSI Initialise per-cpu HPET timers<br />&gt; <br />&gt;     Initialize a per CPU HPET MSI timer when possible. We retain the HPET<br />&gt;     timer 0 (IRQ 0) and timer 1 (IRQ 8) as is when legacy mode is being used. We<br />&gt;     setup the remaining HPET timers as per CPU MSI based timers. This per CPU<br />&gt;     timer will eliminate the need for timer broadcasting with IRQ 0 when there<br />&gt;     is non-functional LAPIC timer across CPU deep C-states.<br />&gt; <br />&gt;     If there are more CPUs than number of available timers, CPUs that do not<br />&gt;     find any timer to use will continue using LAPIC and IRQ 0 broadcast.<br />&gt; <br />&gt;     Signed-off-by: Venkatesh Pallipadi &lt;venkatesh.pallipadi&#64;intel.com&gt;<br />&gt;     Signed-off-by: Shaohua Li &lt;shaohua.li&#64;intel.com&gt;<br />&gt;     Signed-off-by: Ingo Molnar &lt;mingo&#64;elte.hu&gt;<br />&gt; <br />&gt; And of coarse this was the first commit that I could not boot if I had hpet<br />&gt; enabled. To get this one to boot (single user mode only) I had to add the<br />&gt; the quiet cmdline option and following patch from to arch/x86/kernel/hpet.c<br />&gt; <br />&gt; commit  5ceb1a04187553e08c6ab60d30cee7c454ee139a<br />&gt; <br />&gt; &#64; -445,7 +445,7 &#64;&#64; static int hpet_setup_irq(struct hpet_dev *dev)<br />&gt;  {<br />&gt; <br />&gt;         if (request_irq(dev-&gt;irq, hpet_interrupt_handler,<br />&gt; -                       IRQF_SHARED|IRQF_NOBALANCING, dev-&gt;name, dev))<br />&gt; +                       IRQF_DISABLED|IRQF_NOBALANCING, dev-&gt;name, dev))<br />&gt;                 return -1;<br />&gt; <br />&gt;         disable_irq(dev-&gt;irq);<br />&gt; <br />&gt; AND add the quiet cmdline option.<br /><br />Ok, so we know why HPET didn't boot for you, and that was fixed later (by <br />that 5ceb1a04). But is this also when the floppy started mis-behaving?<br /><br />IOW, _if_ you boot with that fix from commit 5ceb1a04 (and the quiet <br />option - I wonder what that is about: do you have any ideas?), is the <br />per-CPU HPET timer commit also the commit that causes floppy problems, or <br />is this purely a "bisect when HPET became a boot-up problem"?<br /><br />			Linus<br /><br />---<br />&gt; Also, of all the machines it does work on with hpets enabled, I don't see<br />&gt; the HPET2 in /proc/interupts as below.<br />&gt; <br />&gt; <br />&gt; cat /proc/interrupts<br />&gt;            CPU0       CPU1       CPU2       CPU3<br />&gt;   0:         82          0          3          0   IO-APIC-edge      timer<br />&gt;   1:          0          0       1712          6   IO-APIC-edge      i8042<br />&gt;   3:          0          0          6          0   IO-APIC-edge<br />&gt;   4:          0          0          6          0   IO-APIC-edge<br />&gt;   6:          0          0          4          0   IO-APIC-edge      floppy<br />&gt;   8:          0          0         60          0   IO-APIC-edge      rtc0<br />&gt;   9:          0          0          0          0   IO-APIC-fasteoi   acpi<br />&gt;  12:          0          0      37798        179   IO-APIC-edge      i8042<br />&gt;  14:          0          0      16462         71   IO-APIC-edge      pata_atiixp<br />&gt;  15:          0          0       5713         17   IO-APIC-edge      pata_atiixp<br />&gt;  16:          0          0        904          2   IO-APIC-fasteoi   aic79xx, ohci_hcd:usb2, ohci_hcd:usb4, HDA Intel, ni-pci-gpib<br />&gt;  17:          0          0          2          0   IO-APIC-fasteoi   ehci_hcd:usb1, parport0, ni-pci-gpib<br />&gt;  18:          0          0      49940         90   IO-APIC-fasteoi   ohci_hcd:usb5, ohci_hcd:usb6, ohci_hcd:usb7, nvidia<br />&gt;  19:          0          0        703          2   IO-APIC-fasteoi   aic7xxx, ehci_hcd:usb3, ttySLG0, eth1<br />&gt;  22:          0          0       1303         15   IO-APIC-fasteoi   ahci<br />&gt; <br />&gt;  24:     261763          0          0          0  HPET_MSI-edge      hpet2<br />&gt; <br />&gt;  29:          0          0        220          5   PCI-MSI-edge      sky2&#64;pci:0000:04:00.0<br />&gt; NMI:          0          0          0          0   Non-maskable interrupts<br />&gt; LOC:        138     271356     264446     261050   Local timer interrupts<br />&gt; SPU:          0          0          0          0   Spurious interrupts<br />&gt; PMI:          0          0          0          0   Performance monitoring interrupts<br />&gt; PND:          0          0          0          0   Performance pending work<br />&gt; RES:       4511       9275       8470       8086   Rescheduling interrupts<br />&gt; CAL:       3624       8666        523       4543   Function call interrupts<br />&gt; TLB:        981       1111       1065       1058   TLB shootdowns<br />&gt; ERR:          0<br />&gt; MIS:          0<br /><br /><br /></pre><div align="center"><div class="shariff" data-services="[&quot;reddit&quot;]" data-theme="grey" data-lang="en" data-backend-url="//shariff.lkml.org/index.php"></div></div></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
